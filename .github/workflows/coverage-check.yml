name: Coverage Check

on:
  schedule:
    # æ¯å‘¨å…­ 00:00 UTC è¿è¡Œ
    - cron: '0 0 * * 6'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥æäº¤æŠ¥å‘Šåˆ°ä»“åº“ï¼ˆä½¿ç”¨ PATï¼‰
  issues: write  # åˆ›å»º Issue çš„æƒé™ï¼ˆä½¿ç”¨ GITHUB_TOKENï¼‰

jobs:
  coverage-check:
    name: ğŸ“Š Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ä»¥æ”¯æŒæ¨é€
          # ä½¿ç”¨ PAT ä»¥æ”¯æŒæ¨é€æŠ¥å‘Šåˆ°ä»“åº“
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-deps-
          enableCrossOsArchive: false

      - name: ğŸ’¾ Cache dev binary build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/release/dev
            target/release/deps/dev*
            target/release/.fingerprint/dev*
            target/release/incremental/dev-*
          key: ${{ runner.os }}-dev-bin-${{ hashFiles('src/lib/cli/dev.rs', 'src/bin/dev.rs', 'src/commands/dev/**/*.rs') }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-dev-bin-${{ hashFiles('src/lib/cli/dev.rs', 'src/bin/dev.rs', 'src/commands/dev/**/*.rs') }}-
            ${{ runner.os }}-dev-bin-
          enableCrossOsArchive: false

      - name: ğŸ”¨ Build dev binary
        run: cargo build --bin dev --release

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: ğŸ“¦ Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: ğŸ“Š Generate coverage report
        timeout-minutes: 50
        run: cargo tarpaulin --out Html --output-dir coverage --tests

      - name: ğŸ“‹ Check coverage threshold and generate report
        id: check
        continue-on-error: true
        run: |
          mkdir -p report
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          REPORT_FILE="report/coverage-check-${TIMESTAMP}.md"

          cargo run --bin dev --release tests check coverage \
            --threshold 80.0 \
            --ci \
            --output "$REPORT_FILE" \
            --check-type "å®šæœŸå®¡æŸ¥" || true

          if [ -f "$REPORT_FILE" ]; then
            echo "ğŸ“„ Report generated: $REPORT_FILE"
            echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Report file not generated"
          fi

      - name: ğŸ“¤ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      # æ³¨æ„ï¼šè¦†ç›–ç‡è¶‹åŠ¿åˆ†æå·²ç”± Codecov æä¾›
      # Codecov æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
      # - è¦†ç›–ç‡å†å²è¶‹åŠ¿å›¾ï¼ˆäº‘ç«¯ï¼‰
      # - PR è¯„è®ºä¸­çš„è¦†ç›–ç‡å˜åŒ–ï¼ˆè‡ªåŠ¨ï¼‰
      # - è¦†ç›–ç‡å›å½’æ£€æµ‹ï¼ˆè‡ªåŠ¨ï¼‰
      # - æ¨¡å—çº§åˆ«çš„è¦†ç›–ç‡å¯¹æ¯”ï¼ˆå¯è§†åŒ–ï¼‰
      # å› æ­¤ä¸å†éœ€è¦æœ¬åœ°è¶‹åŠ¿åˆ†æè„šæœ¬

      - name: ğŸ“¤ Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true


      - name: ğŸ“¤ Upload check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-check-report
          path: report/coverage-check-*.md
          retention-days: 90

      - name: âš™ï¸ Configure Git for report commit
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¤ Commit and push report to repository
        if: always() && steps.check.outputs.report_file != ''
        run: |
          REPORT_FILE="${{ steps.check.outputs.report_file }}"

          if [ -z "$REPORT_FILE" ] || [ ! -f "$REPORT_FILE" ]; then
            echo "âš ï¸  Report file not found, skipping commit"
            exit 0
          fi

          echo "ğŸ“¤ Committing report to repository..."
          echo "Report file: $REPORT_FILE"

          # æ·»åŠ æŠ¥å‘Šæ–‡ä»¶
          git add "$REPORT_FILE"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit. Report file may already be committed."
            exit 0
          fi

          # æäº¤æ›´æ”¹
          COMMIT_MESSAGE="docs(report): add coverage check report $(date +%Y-%m-%d)"
          git commit -m "$COMMIT_MESSAGE"

          # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ master/mainï¼‰
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD || echo "master")
          echo "Pushing to branch: $CURRENT_BRANCH"

          if git push origin "$CURRENT_BRANCH"; then
            echo "âœ… Successfully pushed report to $CURRENT_BRANCH branch"
            echo "ğŸ“„ Report available at: $REPORT_FILE"
          else
            echo "âš ï¸  Failed to push report to repository"
            echo "   This may be due to:"
            echo "   1. WORKFLOW_PAT may not have write access"
            echo "   2. Branch protection rules may prevent direct push"
            echo "   Report is still available as artifact"
          fi

      # åˆ›å»º Issue æ±‡æ€»é—®é¢˜ï¼ˆä»…åœ¨è¦†ç›–ç‡æœªè¾¾æ ‡æ—¶ï¼‰
      # æ³¨æ„ï¼šä½¿ç”¨ GITHUB_TOKENï¼ˆactions/github-script é»˜è®¤ä½¿ç”¨ï¼‰ï¼Œä¸éœ€è¦ PAT
      - name: ğŸ“ Create issue if coverage below threshold
        if: failure() && steps.check.outputs.coverage_status == 'fail'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().split('T')[0];
            const checkDate = new Date().toISOString();
            const coverageValue = '${{ steps.check.outputs.coverage_value }}';
            const targetCoverage = '${{ steps.check.outputs.target_coverage }}';

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'coverage-check'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('[Coverage Check]') &&
              issue.title.includes(timestamp)
            );

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Coverage Check] Test coverage below threshold - ${timestamp}`,
              body: `## æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥å‘ç°é—®é¢˜

              å®šæœŸæ£€æŸ¥å‘ç°æµ‹è¯•è¦†ç›–ç‡æœªè¾¾åˆ°ç›®æ ‡é˜ˆå€¼ï¼Œè¯·æŸ¥çœ‹æ£€æŸ¥æŠ¥å‘Šã€‚

              **æ£€æŸ¥æ—¥æœŸ**ï¼š${checkDate}
              **å½“å‰è¦†ç›–ç‡**ï¼š${coverageValue}%
              **ç›®æ ‡è¦†ç›–ç‡**ï¼š${targetCoverage}%
              **æŠ¥å‘Šä½ç½®**ï¼š\`report/coverage-check-*.md\`

              è¯·å‚è€ƒä»¥ä¸‹æ–‡æ¡£è¿›è¡Œæ”¹è¿›ï¼š
              - [æµ‹è¯•è¦†ç›–ç‡æ”¹è¿›åˆ†æ](docs/requirements/coverage-improvement.md)
              - [å¿«é€Ÿè¦†ç›–ç‡æå‡æ¨¡å—](docs/requirements/QUICK_COVERAGE_MODULES.md)
              - [æµ‹è¯•è§„èŒƒ](docs/guidelines/testing.md)

              ---

              **æ³¨æ„**ï¼šæ­¤ Issue ç”±è‡ªåŠ¨åŒ–æ£€æŸ¥åˆ›å»ºï¼Œè¯·åŠæ—¶å¤„ç†ã€‚
              `,
              labels: ['coverage-check', 'testing', 'documentation']
            });

      - name: ğŸ“‹ Coverage check summary
        if: always()
        run: |
          echo "ğŸ“Š Coverage check completed"
          echo "Coverage report has been uploaded as an artifact"
          echo "Check report has been generated and uploaded"

