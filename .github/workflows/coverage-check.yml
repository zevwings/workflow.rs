name: Coverage Check

on:
  schedule:
    # æ¯å‘¨å…­ 00:00 UTC è¿è¡Œ
    - cron: '0 0 * * 6'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥æäº¤æŠ¥å‘Šåˆ°ä»“åº“ï¼ˆä½¿ç”¨ PATï¼‰
  issues: write  # åˆ›å»º Issue çš„æƒé™ï¼ˆä½¿ç”¨ GITHUB_TOKENï¼‰

jobs:
  coverage-check:
    name: ğŸ“Š Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ä»¥æ”¯æŒæ¨é€
          # ä½¿ç”¨ PAT ä»¥æ”¯æŒæ¨é€æŠ¥å‘Šåˆ°ä»“åº“
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: ğŸ“¦ Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: ğŸ“Š Generate coverage report
        run: cargo tarpaulin --out Html --output-dir coverage --tests

      - name: ğŸ“‹ Check coverage threshold
        id: check
        continue-on-error: true
        run: |
          echo "ğŸ“Š Checking coverage threshold..."
          # ç”Ÿæˆ JSON æ ¼å¼çš„è¦†ç›–ç‡æŠ¥å‘Šç”¨äºè§£æ
          cargo tarpaulin --out Json --output-dir coverage --tests > coverage/coverage.json 2>/dev/null || true

          # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ï¼ˆ80%ï¼‰
          COVERAGE_STATUS="pass"
          COVERAGE_VALUE="0"
          TARGET_COVERAGE=80.0

          if [ -f "coverage/coverage.json" ]; then
            # ä½¿ç”¨ Python è§£æ JSONï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if command -v python3 >/dev/null 2>&1; then
              COVERAGE_VALUE=$(python3 -c "import json; data = json.load(open('coverage/coverage.json')); print(data.get('coverage_percent', 0))" 2>/dev/null || echo "0")

              echo "å½“å‰è¦†ç›–ç‡: ${COVERAGE_VALUE}%"
              echo "ç›®æ ‡è¦†ç›–ç‡: ${TARGET_COVERAGE}%"

              # ä½¿ç”¨ awk è¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒ
              if awk "BEGIN {exit !($COVERAGE_VALUE >= $TARGET_COVERAGE)}"; then
                echo "âœ… è¦†ç›–ç‡å·²è¾¾åˆ°ç›®æ ‡é˜ˆå€¼"
                echo "coverage_status=pass" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸  è¦†ç›–ç‡æœªè¾¾åˆ°ç›®æ ‡é˜ˆå€¼"
                echo "   å½“å‰è¦†ç›–ç‡: ${COVERAGE_VALUE}%"
                echo "   ç›®æ ‡è¦†ç›–ç‡: ${TARGET_COVERAGE}%"
                echo "   è¯·è€ƒè™‘æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹ä»¥æé«˜è¦†ç›–ç‡"
                echo "::warning::Coverage ${COVERAGE_VALUE}% is below target ${TARGET_COVERAGE}%"
                COVERAGE_STATUS="fail"
                echo "coverage_status=fail" >> $GITHUB_OUTPUT
              fi
              echo "coverage_value=${COVERAGE_VALUE}" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Python3 ä¸å¯ç”¨ï¼Œæ— æ³•è§£æè¦†ç›–ç‡æ•°æ®"
              echo "coverage_status=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸  æ— æ³•ç”Ÿæˆè¦†ç›–ç‡ JSON æŠ¥å‘Š"
            echo "coverage_status=unknown" >> $GITHUB_OUTPUT
          fi

          echo "target_coverage=${TARGET_COVERAGE}" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate report
        id: generate_report
        if: always()
        run: |
          mkdir -p report
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          REPORT_FILE="report/coverage-check-${TIMESTAMP}.md"
          CHECK_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          UPDATE_DATE=$(date '+%Y-%m-%d')

          # ä» JSON æ–‡ä»¶è¯»å–è¦†ç›–ç‡æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          COVERAGE_VALUE="0"
          TARGET_COVERAGE="80.0"
          COVERAGE_STATUS="unknown"

          if [ -f "coverage/coverage.json" ] && command -v python3 >/dev/null 2>&1; then
            COVERAGE_VALUE=$(python3 -c "import json; data = json.load(open('coverage/coverage.json')); print(data.get('coverage_percent', 0))" 2>/dev/null || echo "0")
            if awk "BEGIN {exit !($COVERAGE_VALUE >= $TARGET_COVERAGE)}"; then
              COVERAGE_STATUS="pass"
            else
              COVERAGE_STATUS="fail"
            fi
          fi

          # ç¡®å®šçŠ¶æ€
          if [ "$COVERAGE_STATUS" = "pass" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="é€šè¿‡"
          elif [ "$COVERAGE_STATUS" = "fail" ]; then
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="æœªè¾¾æ ‡"
            GAP=$(awk "BEGIN {printf \"%.2f\", $TARGET_COVERAGE - $COVERAGE_VALUE}")
          else
            STATUS_EMOJI="â“"
            STATUS_TEXT="æœªçŸ¥"
          fi

          cat > "$REPORT_FILE" << EOF
          # æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥æŠ¥å‘Š

          **æ£€æŸ¥æ—¥æœŸ**ï¼š${CHECK_DATE}
          **æ£€æŸ¥ç±»å‹**ï¼šå®šæœŸå®¡æŸ¥

          ## æ£€æŸ¥ç»“æœ

          ### è¦†ç›–ç‡ç»Ÿè®¡

          - **å½“å‰è¦†ç›–ç‡**ï¼š${COVERAGE_VALUE}%
          - **ç›®æ ‡è¦†ç›–ç‡**ï¼š${TARGET_COVERAGE}%
          - **æ£€æŸ¥çŠ¶æ€**ï¼š${STATUS_EMOJI} ${STATUS_TEXT}

          ### è¯¦ç»†è¯´æ˜

          $(if [ "$COVERAGE_STATUS" = "pass" ]; then
            echo "âœ… æµ‹è¯•è¦†ç›–ç‡å·²è¾¾åˆ°ç›®æ ‡é˜ˆå€¼ï¼ˆ${TARGET_COVERAGE}%ï¼‰ã€‚"
          elif [ "$COVERAGE_STATUS" = "fail" ]; then
            echo "âš ï¸  æµ‹è¯•è¦†ç›–ç‡æœªè¾¾åˆ°ç›®æ ‡é˜ˆå€¼ã€‚"
            echo ""
            echo "**å½“å‰è¦†ç›–ç‡**ï¼š${COVERAGE_VALUE}%"
            echo "**ç›®æ ‡è¦†ç›–ç‡**ï¼š${TARGET_COVERAGE}%"
            echo "**å·®è·**ï¼š${GAP}%"
            echo ""
            echo "å»ºè®®ï¼š"
            echo "1. æ£€æŸ¥æœªè¦†ç›–çš„ä»£ç æ¨¡å—"
            echo "2. ä¸ºå…³é”®ä¸šåŠ¡é€»è¾‘æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹"
            echo "3. å‚è€ƒ \`docs/requirements/QUICK_COVERAGE_MODULES.md\` äº†è§£å¿«é€Ÿæå‡è¦†ç›–ç‡çš„æ¨¡å—"
          else
            echo "â“ æ— æ³•è·å–è¦†ç›–ç‡æ•°æ®ï¼Œè¯·æ£€æŸ¥æ£€æŸ¥æ—¥å¿—ã€‚"
          fi)

          ## æŠ¥å‘Šæ–‡ä»¶

          - HTML æŠ¥å‘Šå·²ä¸Šä¼ ä¸º Artifactï¼š\`coverage-report\`
          - æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æ•°æ®ï¼šä¸‹è½½ Artifact ä¸­çš„ \`coverage/tarpaulin-report.html\`

          ## æ”¹è¿›å»ºè®®

          1. ç¡®ä¿å…³é”®ä¸šåŠ¡é€»è¾‘çš„æµ‹è¯•è¦†ç›–ç‡ > 90%
          2. å®šæœŸå®¡æŸ¥æœªè¦†ç›–çš„ä»£ç æ¨¡å—
          3. ä¸ºæ–°åŠŸèƒ½æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹

          å‚è€ƒæ–‡æ¡£ï¼š
          - [æµ‹è¯•è¦†ç›–ç‡æ”¹è¿›åˆ†æ](docs/requirements/coverage-improvement.md)
          - [å¿«é€Ÿè¦†ç›–ç‡æå‡æ¨¡å—](docs/requirements/QUICK_COVERAGE_MODULES.md)
          - [æµ‹è¯•è§„èŒƒ](docs/guidelines/testing.md)

          ---

          **æœ€åæ›´æ–°**: ${UPDATE_DATE}
          EOF

          echo "ğŸ“„ Report generated: $REPORT_FILE"
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: ğŸ“¤ Upload check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-check-report
          path: report/coverage-check-*.md
          retention-days: 90

      - name: âš™ï¸ Configure Git for report commit
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¤ Commit and push report to repository
        if: always() && steps.generate_report.outputs.report_file != ''
        run: |
          REPORT_FILE="${{ steps.generate_report.outputs.report_file }}"

          if [ -z "$REPORT_FILE" ] || [ ! -f "$REPORT_FILE" ]; then
            echo "âš ï¸  Report file not found, skipping commit"
            exit 0
          fi

          echo "ğŸ“¤ Committing report to repository..."
          echo "Report file: $REPORT_FILE"

          # æ·»åŠ æŠ¥å‘Šæ–‡ä»¶
          git add "$REPORT_FILE"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit. Report file may already be committed."
            exit 0
          fi

          # æäº¤æ›´æ”¹
          COMMIT_MESSAGE="docs(report): add coverage check report $(date +%Y-%m-%d)"
          git commit -m "$COMMIT_MESSAGE"

          # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ master/mainï¼‰
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD || echo "master")
          echo "Pushing to branch: $CURRENT_BRANCH"

          if git push origin "$CURRENT_BRANCH"; then
            echo "âœ… Successfully pushed report to $CURRENT_BRANCH branch"
            echo "ğŸ“„ Report available at: $REPORT_FILE"
          else
            echo "âš ï¸  Failed to push report to repository"
            echo "   This may be due to:"
            echo "   1. WORKFLOW_PAT may not have write access"
            echo "   2. Branch protection rules may prevent direct push"
            echo "   Report is still available as artifact"
          fi

      # åˆ›å»º Issue æ±‡æ€»é—®é¢˜ï¼ˆä»…åœ¨è¦†ç›–ç‡æœªè¾¾æ ‡æ—¶ï¼‰
      # æ³¨æ„ï¼šä½¿ç”¨ GITHUB_TOKENï¼ˆactions/github-script é»˜è®¤ä½¿ç”¨ï¼‰ï¼Œä¸éœ€è¦ PAT
      - name: ğŸ“ Create issue if coverage below threshold
        if: failure() && steps.check.outputs.coverage_status == 'fail'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().split('T')[0];
            const checkDate = new Date().toISOString();
            const coverageValue = '${{ steps.check.outputs.coverage_value }}';
            const targetCoverage = '${{ steps.check.outputs.target_coverage }}';

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'coverage-check'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('[Coverage Check]') &&
              issue.title.includes(timestamp)
            );

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Coverage Check] Test coverage below threshold - ${timestamp}`,
              body: `## æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥å‘ç°é—®é¢˜

              å®šæœŸæ£€æŸ¥å‘ç°æµ‹è¯•è¦†ç›–ç‡æœªè¾¾åˆ°ç›®æ ‡é˜ˆå€¼ï¼Œè¯·æŸ¥çœ‹æ£€æŸ¥æŠ¥å‘Šã€‚

              **æ£€æŸ¥æ—¥æœŸ**ï¼š${checkDate}
              **å½“å‰è¦†ç›–ç‡**ï¼š${coverageValue}%
              **ç›®æ ‡è¦†ç›–ç‡**ï¼š${targetCoverage}%
              **æŠ¥å‘Šä½ç½®**ï¼š\`report/coverage-check-*.md\`

              è¯·å‚è€ƒä»¥ä¸‹æ–‡æ¡£è¿›è¡Œæ”¹è¿›ï¼š
              - [æµ‹è¯•è¦†ç›–ç‡æ”¹è¿›åˆ†æ](docs/requirements/coverage-improvement.md)
              - [å¿«é€Ÿè¦†ç›–ç‡æå‡æ¨¡å—](docs/requirements/QUICK_COVERAGE_MODULES.md)
              - [æµ‹è¯•è§„èŒƒ](docs/guidelines/testing.md)

              ---

              **æ³¨æ„**ï¼šæ­¤ Issue ç”±è‡ªåŠ¨åŒ–æ£€æŸ¥åˆ›å»ºï¼Œè¯·åŠæ—¶å¤„ç†ã€‚
              `,
              labels: ['coverage-check', 'testing', 'documentation']
            });

      - name: ğŸ“‹ Coverage check summary
        if: always()
        run: |
          echo "ğŸ“Š Coverage check completed"
          echo "Coverage report has been uploaded as an artifact"
          echo "Check report has been generated and uploaded"

