name: Coverage Check

on:
  schedule:
    # æ¯å‘¨ä¸€è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  coverage-check:
    name: ğŸ“Š Weekly Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: ğŸ“¦ Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: ğŸ“Š Generate coverage report
        run: cargo tarpaulin --out Html --output-dir coverage

      - name: ğŸ“‹ Check coverage threshold
        run: |
          echo "ğŸ“Š Checking coverage threshold..."
          # ç”Ÿæˆ JSON æ ¼å¼çš„è¦†ç›–ç‡æŠ¥å‘Šç”¨äºè§£æ
          cargo tarpaulin --out Json --output-dir coverage > coverage/coverage.json 2>/dev/null || true

          # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ï¼ˆ80%ï¼‰
          if [ -f "coverage/coverage.json" ]; then
            # ä½¿ç”¨ Python è§£æ JSONï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if command -v python3 >/dev/null 2>&1; then
              COVERAGE=$(python3 -c "import json; data = json.load(open('coverage/coverage.json')); print(data.get('coverage_percent', 0))" 2>/dev/null || echo "0")
              TARGET_COVERAGE=80.0

              echo "å½“å‰è¦†ç›–ç‡: ${COVERAGE}%"
              echo "ç›®æ ‡è¦†ç›–ç‡: ${TARGET_COVERAGE}%"

              # ä½¿ç”¨ awk è¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒ
              if awk "BEGIN {exit !($COVERAGE >= $TARGET_COVERAGE)}"; then
                echo "âœ… è¦†ç›–ç‡å·²è¾¾åˆ°ç›®æ ‡é˜ˆå€¼"
              else
                echo "âš ï¸  è¦†ç›–ç‡æœªè¾¾åˆ°ç›®æ ‡é˜ˆå€¼"
                echo "   å½“å‰è¦†ç›–ç‡: ${COVERAGE}%"
                echo "   ç›®æ ‡è¦†ç›–ç‡: ${TARGET_COVERAGE}%"
                echo "   è¯·è€ƒè™‘æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹ä»¥æé«˜è¦†ç›–ç‡"
              fi
            else
              echo "âš ï¸  Python3 ä¸å¯ç”¨ï¼Œæ— æ³•è§£æè¦†ç›–ç‡æ•°æ®"
            fi
          else
            echo "âš ï¸  æ— æ³•ç”Ÿæˆè¦†ç›–ç‡ JSON æŠ¥å‘Š"
          fi

      - name: ğŸ“¤ Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: ğŸ“‹ Coverage check summary
        if: always()
        run: |
          echo "ğŸ“Š Weekly coverage check completed"
          echo "Coverage report has been uploaded as an artifact"

