name: Release Publish (Reusable)

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number'
        required: true
        type: string
      tag:
        description: 'Tag name'
        required: true
        type: string
      is_master_branch:
        description: 'Whether this is master branch'
        required: true
        type: boolean

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: üöÄ Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Get version and tag from inputs
        id: version
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          TAG="${{ inputs.tag }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Version: $VERSION"
          echo "‚úÖ Tag: $TAG"

      - name: üì• Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: üìù Prepare release info
        id: release_info
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IS_MASTER="${{ inputs.is_master_branch }}"

          if [ "$IS_MASTER" == "true" ]; then
            RELEASE_NAME="Release $VERSION"
            RELEASE_BODY="## Release $VERSION

            See the [changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details."
          else
            RELEASE_NAME="Pre-release $VERSION"
            RELEASE_BODY="## Pre-release $VERSION

            ‚ö†Ô∏è **This is a pre-release version** (alpha build)

            See the [changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details."
          fi

          {
            echo "name<<EOF"
            echo "$RELEASE_NAME"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "body<<EOF"
            echo "$RELEASE_BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo "‚úÖ Release name: $RELEASE_NAME"
          echo "‚úÖ Is pre-release: $([ "$IS_MASTER" != "true" ] && echo "true" || echo "false")"

      - name: üöÄ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.release_info.outputs.name }}
          body: ${{ steps.release_info.outputs.body }}
          files: |
            artifacts/**/*
          draft: false
          prerelease: ${{ inputs.is_master_branch != true }}
