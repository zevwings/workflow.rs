name: Version Management (Reusable)

on:
  workflow_call:
    inputs:
      is_master_branch:
        description: 'Whether this is master branch'
        required: true
        type: boolean
      event_name:
        description: 'GitHub event name'
        required: true
        type: string
    outputs:
      version:
        description: 'Generated version number'
        value: ${{ jobs.update-version.outputs.version }}
      tag:
        description: 'Generated tag name'
        value: ${{ jobs.update-version.outputs.tag }}
      needs_increment:
        description: 'Whether version needs increment'
        value: ${{ jobs.update-version.outputs.needs_increment }}
      is_master_branch:
        description: 'Whether this is master branch'
        value: ${{ jobs.update-version.outputs.is_master_branch }}

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  update-version:
    name: ğŸ“¦ Generate Version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.generate_version.outputs.version }}
      tag: ${{ steps.generate_version.outputs.tag }}
      needs_increment: ${{ steps.generate_version.outputs.needs_increment }}
      is_master_branch: ${{ steps.detect_mode.outputs.is_master_branch }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Get latest version from git tags
        id: get_latest_version
        shell: bash
        run: |
          # ä» git tags è·å–æœ€æ–°çš„æ ‡å‡†ç‰ˆæœ¬å·ï¼ˆæ’é™¤ alpha/beta é¢„å‘å¸ƒç‰ˆæœ¬ï¼‰
          # è·å–æ‰€æœ‰æ ‡å‡†ç‰ˆæœ¬ tagï¼ˆæ ¼å¼ï¼švx.x.xï¼‰ï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åº
          LATEST_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†ç‰ˆæœ¬ tagï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
            LATEST_VERSION="0.0.0"
            echo "âš ï¸  No standard version tag found, using default: $LATEST_VERSION"
          else
            # ç§»é™¤ v å‰ç¼€
            LATEST_VERSION=${LATEST_TAG#v}
            echo "âœ… Latest standard version from git tags: $LATEST_TAG ($LATEST_VERSION)"
          fi

          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Detect branch type and trigger mode
        id: detect_mode
        shell: bash
        run: |
          set -e
          # ä½¿ç”¨è¾“å…¥å‚æ•°
          IS_MASTER_BRANCH="${{ inputs.is_master_branch }}"
          IS_MANUAL_TRIGGER="${{ inputs.event_name == 'workflow_dispatch' }}"

          echo "is_master_branch=$IS_MASTER_BRANCH" >> $GITHUB_OUTPUT
          echo "is_manual_trigger=$IS_MANUAL_TRIGGER" >> $GITHUB_OUTPUT

          echo "âœ… Branch detection completed:"
          echo "   Is Master: $IS_MASTER_BRANCH"
          echo "   Event: ${{ inputs.event_name }}"
          echo "   Is Manual: $IS_MANUAL_TRIGGER"

      - name: ğŸ“¦ Generate version number
        id: generate_version
        shell: bash
        run: |
          set -e
          LATEST_VERSION="${{ steps.get_latest_version.outputs.latest_version }}"
          IS_MASTER="${{ steps.detect_mode.outputs.is_master_branch }}"

          # éªŒè¯ LATEST_VERSION ä¸ä¸ºç©º
          if [ -z "$LATEST_VERSION" ]; then
            echo "âŒ Error: LATEST_VERSION is empty"
            exit 1
          fi

          echo "ğŸ“‹ Version generation inputs:"
          echo "   LATEST_VERSION: $LATEST_VERSION"
          echo "   IS_MASTER: $IS_MASTER"

          if [[ "$IS_MASTER" == "true" ]]; then
            # Master åˆ†æ”¯ï¼šç”Ÿæˆæ ‡å‡†ç‰ˆæœ¬å·
            # è§£ææœ€æ–°ç‰ˆæœ¬å·
            IFS='.' read -ra VERSION_PARTS <<< "$LATEST_VERSION"
            MAJOR="${VERSION_PARTS[0]:-0}"
            MINOR="${VERSION_PARTS[1]:-0}"
            PATCH="${VERSION_PARTS[2]:-0}"

            # é¦–å…ˆæ£€æŸ¥å½“å‰ commit æ˜¯å¦å·²ç»æœ‰ä»»ä½•æ ‡å‡†ç‰ˆæœ¬ tag æŒ‡å‘å®ƒ
            CURRENT_COMMIT_SHA=$(git rev-parse HEAD)
            EXISTING_TAG_ON_COMMIT=$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1 || true)

            if [ -n "$EXISTING_TAG_ON_COMMIT" ]; then
              # å½“å‰ commit å·²ç»æœ‰ tagï¼Œä½¿ç”¨è¯¥ tag çš„ç‰ˆæœ¬å·
              VERSION=${EXISTING_TAG_ON_COMMIT#v}
              TAG="$EXISTING_TAG_ON_COMMIT"
              NEEDS_INCREMENT="false"
              echo "âœ… Found existing tag $TAG on current commit, reusing it"
            else
              # å½“å‰ commit æ²¡æœ‰ tagï¼Œéœ€è¦æ ¹æ® Conventional Commits è§„èŒƒç¡®å®šç‰ˆæœ¬æ›´æ–°ç±»å‹
              # è·å–ä»æœ€æ–° tag åˆ°å½“å‰ commit çš„æ‰€æœ‰ commit messages
              LATEST_TAG="${{ steps.get_latest_version.outputs.latest_tag }}"

              if [ -n "$LATEST_TAG" ] && git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
                # ä»æœ€æ–° tag åˆ°å½“å‰ commit çš„æ‰€æœ‰æäº¤
                COMMITS=$(git log ${LATEST_TAG}..HEAD --format="%s" --no-merges || echo "")
              else
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ° tagï¼Œä½¿ç”¨æœ€è¿‘çš„æäº¤
                COMMITS=$(git log -10 --format="%s" --no-merges || echo "")
              fi

              # æ ¹æ® Conventional Commits è§„èŒƒç¡®å®šç‰ˆæœ¬æ›´æ–°ç±»å‹
              # ä¼˜å…ˆçº§ï¼šBREAKING CHANGE > patch >= 9 > feat: > å…¶ä»–
              VERSION_INCREMENT_TYPE="patch"  # é»˜è®¤æ˜¯ patch

              if echo "$COMMITS" | grep -qE "(BREAKING CHANGE|BREAKING:)" || echo "$COMMITS" | grep -qE "^[^:]*!:"; then
                # æ£€æµ‹åˆ° BREAKING CHANGE æˆ– ! æ ‡è®°ï¼Œé€’å¢ major ç‰ˆæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                VERSION_INCREMENT_TYPE="major"
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                echo "ğŸ”´ Detected BREAKING CHANGE, incrementing MAJOR version"
              elif [ "$PATCH" -ge 9 ]; then
                # è§„åˆ™ï¼šå¦‚æœ patch ç‰ˆæœ¬è¾¾åˆ° 9ï¼Œè‡ªåŠ¨é€’å¢ minor ç‰ˆæœ¬ï¼ˆå¦‚ v1.5.9 â†’ v1.6.0ï¼‰
                VERSION_INCREMENT_TYPE="minor"
                MINOR=$((MINOR + 1))
                PATCH=0
                echo "ğŸŸ¡ Patch version reached 9, incrementing MINOR version (v${MAJOR}.${MINOR}.${PATCH})"
              elif echo "$COMMITS" | grep -qE "^(feat|feature):"; then
                # æ£€æµ‹åˆ° feat: æˆ– feature:ï¼Œé€’å¢ minor ç‰ˆæœ¬
                VERSION_INCREMENT_TYPE="minor"
                MINOR=$((MINOR + 1))
                PATCH=0
                echo "ğŸŸ¢ Detected feat: commit, incrementing MINOR version"
              else
                # å…¶ä»–æƒ…å†µï¼ˆfixã€choreã€docs ç­‰ï¼‰ï¼Œé€’å¢ patch ç‰ˆæœ¬
                VERSION_INCREMENT_TYPE="patch"
                PATCH=$((PATCH + 1))
                echo "ğŸ”µ No feat: or BREAKING CHANGE detected, incrementing PATCH version"
              fi

              VERSION="$MAJOR.$MINOR.$PATCH"
              TAG="v$VERSION"
              NEEDS_INCREMENT="true"

              echo "âœ… Version increment type: $VERSION_INCREMENT_TYPE"
              echo "âœ… Generated version $VERSION ($TAG) based on Conventional Commits"
            fi

            echo "âœ… Master branch: Generated version $VERSION ($TAG)"
          else
            # é Master åˆ†æ”¯ï¼šç”Ÿæˆé¢„å‘å¸ƒç‰ˆæœ¬å· (vx.x.x.alpha-xxx)
            # åº”ç”¨ä¸ master åˆ†æ”¯ç›¸åŒçš„ç‰ˆæœ¬é€’å¢è§„åˆ™
            IFS='.' read -ra VERSION_PARTS <<< "$LATEST_VERSION"
            MAJOR="${VERSION_PARTS[0]:-0}"
            MINOR="${VERSION_PARTS[1]:-0}"
            PATCH="${VERSION_PARTS[2]:-0}"

            # è·å–ä»æœ€æ–° tag åˆ°å½“å‰ commit çš„æ‰€æœ‰ commit messages
            LATEST_TAG="${{ steps.get_latest_version.outputs.latest_tag }}"

            if [ -n "$LATEST_TAG" ] && git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
              # ä»æœ€æ–° tag åˆ°å½“å‰ commit çš„æ‰€æœ‰æäº¤
              COMMITS=$(git log ${LATEST_TAG}..HEAD --format="%s" --no-merges || echo "")
            else
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ° tagï¼Œä½¿ç”¨æœ€è¿‘çš„æäº¤
              COMMITS=$(git log -10 --format="%s" --no-merges || echo "")
            fi

            # æ ¹æ® Conventional Commits è§„èŒƒç¡®å®šç‰ˆæœ¬æ›´æ–°ç±»å‹
            # ä¼˜å…ˆçº§ï¼šBREAKING CHANGE > patch >= 9 > feat: > å…¶ä»–
            VERSION_INCREMENT_TYPE="patch"  # é»˜è®¤æ˜¯ patch

            if echo "$COMMITS" | grep -qE "(BREAKING CHANGE|BREAKING:)" || echo "$COMMITS" | grep -qE "^[^:]*!:"; then
              # æ£€æµ‹åˆ° BREAKING CHANGE æˆ– ! æ ‡è®°ï¼Œé€’å¢ major ç‰ˆæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
              VERSION_INCREMENT_TYPE="major"
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "ğŸ”´ Detected BREAKING CHANGE, incrementing MAJOR version"
            elif [ "$PATCH" -ge 9 ]; then
              # è§„åˆ™ï¼šå¦‚æœ patch ç‰ˆæœ¬è¾¾åˆ° 9ï¼Œè‡ªåŠ¨é€’å¢ minor ç‰ˆæœ¬ï¼ˆå¦‚ v1.5.9 â†’ v1.6.0ï¼‰
              VERSION_INCREMENT_TYPE="minor"
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "ğŸŸ¡ Patch version reached 9, incrementing MINOR version (v${MAJOR}.${MINOR}.${PATCH})"
            elif echo "$COMMITS" | grep -qE "^(feat|feature):"; then
              # æ£€æµ‹åˆ° feat: æˆ– feature:ï¼Œé€’å¢ minor ç‰ˆæœ¬
              VERSION_INCREMENT_TYPE="minor"
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "ğŸŸ¢ Detected feat: commit, incrementing MINOR version"
            else
              # å…¶ä»–æƒ…å†µï¼ˆfixã€choreã€docs ç­‰ï¼‰ï¼Œé€’å¢ patch ç‰ˆæœ¬
              VERSION_INCREMENT_TYPE="patch"
              PATCH=$((PATCH + 1))
              echo "ğŸ”µ No feat: or BREAKING CHANGE detected, incrementing PATCH version"
            fi

            BASE_VERSION="$MAJOR.$MINOR.$PATCH"

            # ä½¿ç”¨æ—¶é—´æˆ³æ ¼å¼ç¡®ä¿å”¯ä¸€æ€§ï¼šYYYYMMDDHHmmssSSS
            # æ ¼å¼ï¼švx.x.x.alpha-YYYYMMDDHHmmssSSS
            # ç¤ºä¾‹ï¼šv1.6.1.alpha-20251216101712000
            # æ³¨æ„ï¼šæ­¤ job è¿è¡Œåœ¨ ubuntu-latest ä¸Šï¼Œdate æ”¯æŒ %3Nï¼ˆæ¯«ç§’ï¼‰
            TIMESTAMP=$(date +%Y%m%d%H%M%S%3N)

            VERSION="${BASE_VERSION}.alpha-${TIMESTAMP}"
            TAG="v$VERSION"
            NEEDS_INCREMENT="false"

            echo "âœ… Non-master branch: Generated pre-release version $VERSION ($TAG)"
            echo "   Timestamp format: YYYYMMDDHHmmssSSS"
            echo "   Example: v1.6.1.alpha-20251216101712000"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "needs_increment=$NEEDS_INCREMENT" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Rust toolchain
        if: steps.generate_version.outputs.needs_increment == 'true' && steps.detect_mode.outputs.is_master_branch == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“ Update Cargo.toml and Cargo.lock version
        if: steps.generate_version.outputs.needs_increment == 'true' && steps.detect_mode.outputs.is_master_branch == 'true'
        shell: bash
        run: |
          NEW_VERSION="${{ steps.generate_version.outputs.version }}"

          # æ›´æ–° Cargo.toml ä¸­çš„ç‰ˆæœ¬å·
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          else
            sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          fi

          # éªŒè¯ Cargo.toml æ›´æ–°
          UPDATED_VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
          if [ "$UPDATED_VERSION" != "$NEW_VERSION" ]; then
            echo "âŒ Error: Failed to update version in Cargo.toml"
            exit 1
          fi

          # æ›´æ–° Cargo.lock ä¸­çš„ç‰ˆæœ¬å·
          if grep -q 'name = "workflow"' Cargo.lock; then
            if [[ "$OSTYPE" == "darwin"* ]]; then
              sed -i '' '/^name = "workflow"$/,/^version = /{
                /^version = /s/version = "[^"]*"/version = "'"$NEW_VERSION"'"/
              }' Cargo.lock
            else
              sed -i '/^name = "workflow"$/,/^version = /{
                /^version = /s/version = "[^"]*"/version = "'"$NEW_VERSION"'"/
              }' Cargo.lock
            fi
          fi

          echo "âœ… Version updated to $NEW_VERSION in Cargo.toml and Cargo.lock"

      - name: ğŸ“¤ Upload updated version files
        if: steps.generate_version.outputs.needs_increment == 'true' && steps.detect_mode.outputs.is_master_branch == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: updated-version-files
          path: |
            Cargo.toml
            Cargo.lock
          retention-days: 1
