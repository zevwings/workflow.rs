name: Code Quality Check (Reusable)

on:
  workflow_call:
    inputs:
      skip_condition:
        description: 'Condition to skip checks (e.g., should_skip)'
        required: false
        type: string
      skip_ci_result:
        description: 'Result of skip CI check'
        required: false
        type: string
    outputs:
      lint_result:
        description: 'Result of lint check'
        value: ${{ jobs.check-lint.outputs.result }}
      test_result:
        description: 'Result of test check'
        value: ${{ jobs.tests.outputs.result }}
      all_passed:
        description: 'Whether all checks passed'
        value: ${{ jobs.check-status.outputs.all_passed }}

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆLintï¼‰
  check-lint:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_condition != 'true' }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ðŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: âœ¨ Check code formatting
        run: cargo fmt --check

      - name: ðŸ” Run Clippy linter
        run: cargo clippy -- -D warnings

      - name: âœ… Verify compilation
        run: cargo check
    outputs:
      result: ${{ job.status }}

  # è¿è¡Œæµ‹è¯•
  tests:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_condition != 'true' }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ðŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: ðŸ§ª Run tests
        run: cargo test --verbose
    outputs:
      result: ${{ job.status }}

  # ç¡®ä¿æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼ˆæ±‡æ€» jobï¼‰
  check-status:
    name: âœ… Verify All Checks
    runs-on: ubuntu-latest
    needs: [check-lint, tests]
    if: always()
    steps:
      - name: âœ… Check lint and test status
        id: status_check
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

          # èŽ·å–æ‰€æœ‰ç›¸å…³ job çš„ç»“æžœ
          SKIP_CI_RESULT="${{ inputs.skip_ci_result }}"
          SKIP_CI_SHOULD_SKIP="${{ inputs.skip_condition }}"
          LINT_RESULT="${{ needs.check-lint.result }}"
          TEST_RESULT="${{ needs.tests.result }}"

          echo "ðŸ“Š Checking job status:"
          echo "  skip_ci_result: $SKIP_CI_RESULT"
          echo "  skip_condition: $SKIP_CI_SHOULD_SKIP"
          echo "  check-lint: $LINT_RESULT"
          echo "  tests: $TEST_RESULT"

          # ä¼˜å…ˆçº§1: å¦‚æžœ skip_condition ä¸º trueï¼Œè¯´æ˜Žåº”è¯¥è·³è¿‡ CI
          if [ "$SKIP_CI_SHOULD_SKIP" == "true" ]; then
            echo "âœ… CI should be skipped"
            echo "all_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ä¼˜å…ˆçº§2: å¦‚æžœ check-lint å’Œ tests éƒ½è¢«è·³è¿‡ï¼Œè¯´æ˜Žåº”è¯¥è·³è¿‡ CI
          if [ "$LINT_RESULT" == "skipped" ] && [ "$TEST_RESULT" == "skipped" ]; then
            echo "âœ… CI checks were skipped"
            echo "all_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥ check-lint çŠ¶æ€
          if [ -n "$LINT_RESULT" ]; then
            if [ "$LINT_RESULT" == "failure" ] || [ "$LINT_RESULT" == "cancelled" ]; then
              echo "âŒ Lint check failed: $LINT_RESULT"
              echo "all_passed=false" >> $GITHUB_OUTPUT
              exit 1
            elif [ "$LINT_RESULT" != "success" ] && [ "$LINT_RESULT" != "skipped" ]; then
              echo "âŒ Lint check has unexpected status: $LINT_RESULT"
              echo "all_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # æ£€æŸ¥ tests çŠ¶æ€
          if [ -n "$TEST_RESULT" ]; then
            if [ "$TEST_RESULT" == "failure" ] || [ "$TEST_RESULT" == "cancelled" ]; then
              echo "âŒ Test check failed: $TEST_RESULT"
              echo "all_passed=false" >> $GITHUB_OUTPUT
              exit 1
            elif [ "$TEST_RESULT" != "success" ] && [ "$TEST_RESULT" != "skipped" ]; then
              echo "âŒ Test check has unexpected status: $TEST_RESULT"
              echo "all_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # å¦‚æžœ check-lint å’Œ tests éƒ½æˆåŠŸæˆ–è¢«è·³è¿‡ï¼Œåˆ™é€šè¿‡
          if [ "$LINT_RESULT" == "success" ] || [ "$LINT_RESULT" == "skipped" ]; then
            if [ "$TEST_RESULT" == "success" ] || [ "$TEST_RESULT" == "skipped" ]; then
              echo "âœ… All checks passed or were skipped"
              echo "all_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # å¦‚æžœåˆ°è¾¾è¿™é‡Œï¼Œè¯´æ˜Žæœ‰æœªå¤„ç†çš„çŠ¶å†µ
          echo "âš ï¸  Unexpected state: lint=$LINT_RESULT, test=$TEST_RESULT"
          echo "   This should not happen. Please check the workflow configuration."
          echo "all_passed=false" >> $GITHUB_OUTPUT
          exit 1
    outputs:
      all_passed: ${{ steps.status_check.outputs.all_passed }}
