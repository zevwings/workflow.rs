name: CI

on:
  pull_request:
    branches:
      - master
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘ CIï¼ˆç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šæƒ…å†µï¼‰
  workflow_dispatch:

# é…ç½®å·¥ä½œæµæƒé™ï¼Œå…è®¸è¯»å– PR ä¿¡æ¯å’Œå†™å…¥è¯„è®º
permissions:
  contents: read
  pull-requests: write  # éœ€è¦å†™å…¥æƒé™ä»¥æ·»åŠ  PR è¯„è®º
  issues: write         # PR è¯„è®ºä½¿ç”¨ issues API

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡ CIï¼ˆåªæ£€æŸ¥ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼‰
  check-skip-ci:
    name: â­ï¸ Check Skip CI
    env:
      # ä½¿ç”¨ WORKFLOW_PAT åˆ›å»º PRï¼Œè¿™æ ·å¯ä»¥è§¦å‘åç»­çš„ workflow
      WORKFLOW_USER_NAME: ${{ secrets.WORKFLOW_USER_NAME }}
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥æ£€æŸ¥æäº¤è€…

      - name: ğŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: ğŸ” Check if version bump branch
        id: check
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_PR_CREATOR: ${{ github.event.pull_request.user.login }}
          WORKFLOW_USER_NAME: ${{ env.WORKFLOW_USER_NAME }}
        run: |
          # ä½¿ç”¨ Python dev å·¥å…·
                 python3 scripts/dev/py/dev.py ci check-skip \
            --branch "${{ github.head_ref || github.ref_name }}" \
            --pr-creator "${{ github.event.pull_request.user.login }}" \
            --expected-user "${{ env.WORKFLOW_USER_NAME }}" \
            --ci

  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆLintï¼‰
  check-lint:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    needs: [check-skip-ci]
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: âœ¨ Check code formatting
        run: cargo fmt --check

      - name: ğŸ” Run Clippy linter
        run: cargo clippy -- -D warnings

      - name: âœ… Verify compilation
        run: cargo check

  # è¿è¡Œå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæ–‡æ¡£æµ‹è¯•ï¼ˆè·¨å¹³å°å¹¶è¡Œæ‰§è¡Œï¼Œåˆ†å±‚æµ‹è¯•ç­–ç•¥ï¼‰
  tests:
    name: ğŸ§ª Run Tests (${{ matrix.test_type }}) (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [check-skip-ci]
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # å•å…ƒæµ‹è¯•
          - os: ubuntu-latest
            platform: Linux-x86_64
            test_type: unit
            test_timeout: 20
            test_command: cargo test --lib --verbose
          - os: macos-latest
            platform: macOS
            test_type: unit
            test_timeout: 25
            test_command: cargo test --lib --verbose
          - os: windows-latest
            platform: Windows-x86_64
            test_type: unit
            test_timeout: 25
            test_command: cargo test --lib --verbose
          # é›†æˆæµ‹è¯•
          - os: ubuntu-latest
            platform: Linux-x86_64
            test_type: integration
            test_timeout: 25
            test_command: cargo test --test integration_test --verbose
          - os: macos-latest
            platform: macOS
            test_type: integration
            test_timeout: 35
            test_command: cargo test --test integration_test --verbose
          - os: windows-latest
            platform: Windows-x86_64
            test_type: integration
            test_timeout: 30
            test_command: cargo test --test integration_test --verbose
          # æ–‡æ¡£æµ‹è¯•
          - os: ubuntu-latest
            platform: Linux-x86_64
            test_type: doctest
            test_timeout: 12
            test_command: cargo test --doc --verbose
          - os: macos-latest
            platform: macOS
            test_type: doctest
            test_timeout: 12
            test_command: cargo test --doc --verbose
          - os: windows-latest
            platform: Windows-x86_64
            test_type: doctest
            test_timeout: 12
            test_command: cargo test --doc --verbose
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: ğŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ğŸ§ª Run ${{ matrix.test_type }} tests
        timeout-minutes: ${{ matrix.test_timeout }}
        id: test_run
        shell: bash
        run: |
          echo "ğŸ§ª Running ${{ matrix.test_type }} tests on ${{ matrix.platform }}..."
          # è®°å½•æµ‹è¯•å¼€å§‹æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
          START_TIME=$(date +%s 2>/dev/null || echo "0")
          # è¿è¡Œæµ‹è¯•å¹¶è®°å½•è¾“å‡ºåˆ°æ–‡ä»¶ï¼ˆç”¨äºæ€§èƒ½åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆï¼‰
          # ä½¿ç”¨ --message-format=json ä»¥ä¾¿ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
          ${{ matrix.test_command }} --message-format=json 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          # è®°å½•æµ‹è¯•ç»“æŸæ—¶é—´å¹¶è®¡ç®—æŒç»­æ—¶é—´
          END_TIME=$(date +%s 2>/dev/null || echo "0")
          if [ "$START_TIME" != "0" ] && [ "$END_TIME" != "0" ]; then
            DURATION=$((END_TIME - START_TIME))
            echo "â±ï¸  Test duration: ${DURATION} seconds"
            echo "duration=${DURATION}" >> $GITHUB_OUTPUT
          else
            echo "â±ï¸  Test duration: Unable to calculate (platform: ${{ runner.os }})"
            echo "duration=0" >> $GITHUB_OUTPUT
          fi
          # æ£€æŸ¥æ˜¯å¦æœ‰æ…¢æµ‹è¯•ï¼ˆè¶…è¿‡50ç§’çš„æµ‹è¯•ï¼‰
          if grep -E "test.*took.*[5-9][0-9]\.|test.*took.*[0-9]{3,}\." test-output.log 2>/dev/null; then
            echo "âš ï¸  Warning: Found slow tests (>50 seconds)"
            echo "slow_tests=true" >> $GITHUB_OUTPUT
          else
            echo "slow_tests=false" >> $GITHUB_OUTPUT
          fi
          exit $TEST_EXIT_CODE

      - name: âš ï¸  Report slow tests
        if: steps.test_run.outputs.slow_tests == 'true'
        run: |
          echo "::warning::Found slow tests in ${{ matrix.test_type }} tests"
          echo "Test duration: ${{ steps.test_run.outputs.duration }} seconds"
          echo "Please review slow tests and consider optimization"

      - name: ğŸ“Š Generate test report
        if: always()
        continue-on-error: true
        shell: bash
        env:
          PYTHONIOENCODING: utf-8
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        run: |
          echo "ğŸ“Š Generating test report..."
          # æ£€æŸ¥ Python æ˜¯å¦å¯ç”¨
          if ! command -v python3 >/dev/null 2>&1; then
            echo "âš ï¸  Python3 not found, skipping test report generation"
            exit 0
          fi
          # ä» test-output.log ä¸­æå– JSON æ ¼å¼çš„æµ‹è¯•è¾“å‡ºå¹¶ç”ŸæˆæŠ¥å‘Š
          REPORT_FILE="test-report-${{ matrix.test_type }}-${{ matrix.platform }}.html"
          JSON_REPORT_FILE="test-report-${{ matrix.test_type }}-${{ matrix.platform }}.json"

          # ä½¿ç”¨ Python dev å·¥å…·
          grep '^{' test-output.log 2>/dev/null | \
            python3 scripts/dev/py/dev.py tests report generate \
              --format html \
              --output "$REPORT_FILE" || {
            echo "âš ï¸  Failed to generate test report, continuing..."
            exit 0
          }
          # åŒæ—¶ç”Ÿæˆ JSON æŠ¥å‘Šç”¨äº PR è¯„è®º
          grep '^{' test-output.log 2>/dev/null | \
            python3 scripts/dev/py/dev.py tests report generate \
              --format json \
              --output "$JSON_REPORT_FILE" || {
            echo "âš ï¸  Failed to generate JSON report, continuing..."
          }
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "json_report_file=$JSON_REPORT_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload test report
        if: always() && steps.test_run.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ matrix.test_type }}-${{ matrix.platform }}
          path: test-report-*.html
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ“¤ Upload JSON test report
        if: always() && steps.test_run.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: test-report-json-${{ matrix.test_type }}-${{ matrix.platform }}
          path: test-report-*.json
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ“Š Collect test metrics
        if: always()
        continue-on-error: true
        shell: bash
        run: |
          echo "ğŸ“Š Collecting test metrics..."

          if ! command -v python3 >/dev/null 2>&1; then
            echo "âš ï¸  Python3 not found, skipping metrics collection"
            exit 0
          fi

          # æ”¶é›†æŒ‡æ ‡
          METRICS_DIR="test-metrics"
          mkdir -p "$METRICS_DIR"

          JSON_REPORT_FILE="test-report-${{ matrix.test_type }}-${{ matrix.platform }}.json"
          if [ -f "$JSON_REPORT_FILE" ]; then
            # ä½¿ç”¨ Python dev å·¥å…·
            python3 scripts/dev/py/dev.py tests metrics collect \
              --report "$JSON_REPORT_FILE" \
              --output "$METRICS_DIR/metrics-${{ matrix.test_type }}-${{ matrix.platform }}-${{ github.run_id }}.json"
          fi

          echo "metrics_dir=$METRICS_DIR" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload test metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-metrics-${{ matrix.test_type }}-${{ matrix.platform }}
          path: test-metrics/*.json
          retention-days: 90
          if-no-files-found: ignore

      - name: âš¡ Analyze performance regression
        if: always()
        continue-on-error: true
        shell: bash
        run: |
          echo "âš¡ Analyzing performance regression..."

          if ! command -v python3 >/dev/null 2>&1; then
            echo "âš ï¸  Python3 not found, skipping performance analysis"
            exit 0
          fi

          JSON_REPORT_FILE="test-report-${{ matrix.test_type }}-${{ matrix.platform }}.json"
          if [ ! -f "$JSON_REPORT_FILE" ]; then
            echo "âš ï¸  Test report not found, skipping"
            exit 0
          fi

          # åŸºå‡†æ–‡ä»¶è·¯å¾„ï¼ˆä» Artifacts ä¸‹è½½æˆ–ä½¿ç”¨å½“å‰ä½œä¸ºåŸºå‡†ï¼‰
          BASELINE_FILE="performance-baseline-${{ matrix.test_type }}-${{ matrix.platform }}.json"

          # ä½¿ç”¨ Python dev å·¥å…·
          python3 scripts/dev/py/dev.py performance analyze \
            --current "$JSON_REPORT_FILE" \
            --baseline "$BASELINE_FILE" \
            --output "performance-regression-report.md" \
            --threshold 0.2 || {
            echo "âš ï¸  Performance regression detected, but continuing..."
          }

          # æ›´æ–°åŸºå‡†ï¼ˆå¦‚æœå½“å‰æ€§èƒ½æ›´å¥½æˆ–é¦–æ¬¡è¿è¡Œï¼‰
          if [ ! -f "$BASELINE_FILE" ] || [ "${{ steps.test_run.outcome }}" == "success" ]; then
            cp "$JSON_REPORT_FILE" "$BASELINE_FILE"
            echo "âœ… Performance baseline updated"
          fi

      - name: ğŸ“¤ Upload performance baseline
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline-${{ matrix.test_type }}-${{ matrix.platform }}
          path: performance-baseline-*.json
          retention-days: 90
          if-no-files-found: ignore

      - name: âœ… Run completion completeness tests
        if: matrix.test_type == 'unit'
        timeout-minutes: ${{ matrix.test_timeout }}
        run: cargo test --test completeness --verbose

  # æ³¨æ„ï¼šæµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥å·²ç§»è‡³ coverage-check.yml workflowï¼ˆå®šæ—¶è¿è¡Œï¼‰
  # æ³¨æ„ï¼šè¢«å¿½ç•¥çš„æµ‹è¯•éœ€è¦äº¤äº’ï¼Œä¸é€‚åˆåœ¨ CI ä¸­è¿è¡Œ
  # æ³¨æ„ï¼šæ–‡æ¡£æ£€æŸ¥ï¼ˆcheck-docs å’Œ check-linksï¼‰å·²ç§»è‡³ doc-consistency-check.yml workflow
  # è¯¥ workflow æ”¯æŒ PR è§¦å‘å’Œå®šæœŸæ£€æŸ¥ï¼ŒåŠŸèƒ½æ›´å®Œæ•´

  # æ„å»ºéªŒè¯ï¼šéªŒè¯ä»£ç å¯ä»¥åœ¨æ‰€æœ‰å¹³å°ä¸Šæ­£ç¡®æ„å»º
  build:
    name: ğŸ”¨ Build (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: [check-skip-ci, tests]
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macOS-Intel
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macOS-AppleSilicon
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: Linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: Linux-ARM64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            platform: Linux-x86_64-static
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: Windows-x86_64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: Windows-ARM64
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust for ${{ matrix.target }}
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: ğŸ“¦ Install musl target
        if: contains(matrix.target, 'musl')
        run: |
          rustup target add ${{ matrix.target }}
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: ğŸ“¦ Install cross-compilation toolchain (Linux ARM64)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu python3
          # æ³¨æ„ï¼šclipboard åŠŸèƒ½åœ¨ Linux ARM64 ä¸Šå·²ç¦ç”¨ï¼ˆCargo.toml ä¸­é…ç½®ï¼‰
          # å› æ­¤ä¸éœ€è¦å®‰è£… XCB å¼€å‘åº“ï¼Œç®€åŒ–æ„å»ºæµç¨‹
          # ä½†éœ€è¦å®‰è£… Python3 ç”¨äºå¤„ç† Cargo.lock è„šæœ¬

      - name: ğŸ“¦ Install system dependencies (Linux x86_64)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—ï¼ˆxproto, big_requests, etc.ï¼‰
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            python3-pip \
            python3-xcbgen \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            pkg-config
          # åŸºæœ¬éªŒè¯ï¼šæ£€æŸ¥å…³é”®ä¾èµ–æ˜¯å¦å¯ç”¨
          python3 -c "import xcbgen" || (echo "âŒ Error: xcbgen module not available" && exit 1)
          pkg-config --exists xcb || (echo "âŒ Error: xcb pkg-config not found" && exit 1)
          echo "âœ… xcb dependencies verified"

      - name: ğŸ“¦ Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # æ£€æŸ¥ pkg-config æ˜¯å¦å·²å®‰è£…ï¼Œé¿å…é‡å¤å®‰è£…è­¦å‘Š
          if ! command -v pkg-config >/dev/null 2>&1; then
            brew install pkg-config
          else
            echo "âœ… pkg-config is already installed"
          fi

      - name: ğŸ” Get Cargo.lock hash
        id: cargo_lock
        shell: bash
        run: |
          if [ -f "Cargo.lock" ]; then
            # macOS ä½¿ç”¨ shasumï¼ŒLinux ä½¿ç”¨ sha256sum
            if command -v shasum >/dev/null 2>&1; then
              HASH=$(shasum -a 256 Cargo.lock | cut -d' ' -f1 | head -c 16)
            else
              HASH=$(sha256sum Cargo.lock | cut -d' ' -f1 | head -c 16)
            fi
            echo "hash=$HASH" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ steps.cargo_lock.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ”¨ Build binaries (éªŒè¯æ„å»º)
        shell: bash
        run: |
          # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡ï¼ˆä»… Linux ARM64ï¼‰
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            echo "ğŸ”§ Cross-compiling for Linux ARM64"
            echo "   CC: $CC_aarch64_unknown_linux_gnu"
            echo "   LINKER: $CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER"
            # éªŒè¯äº¤å‰ç¼–è¯‘å·¥å…·é“¾
            if command -v aarch64-linux-gnu-gcc >/dev/null 2>&1; then
              echo "âœ… aarch64-linux-gnu-gcc found: $(which aarch64-linux-gnu-gcc)"
              aarch64-linux-gnu-gcc --version || true
            else
              echo "âŒ Error: aarch64-linux-gnu-gcc not found"
              exit 1
            fi
          fi

          # å¯¹äº Linux x86_64ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ä»¥æ”¯æŒ xcb æ„å»º
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-gnu" ]]; then
            export XCB_PROTO_DIR="${XCB_PROTO_DIR:-/usr/share/xcb}"
            export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
            # ç¡®ä¿ PYTHONPATH åŒ…å« xcbgen æ¨¡å—è·¯å¾„
            if ! python3 -c "import xcbgen" 2>/dev/null; then
              XCBGEN_DIR=$(python3 -c "import xcbgen; import os; print(os.path.dirname(xcbgen.__file__))" 2>/dev/null || find /usr -name "xcbgen" -type d 2>/dev/null | head -1)
              if [ -n "$XCBGEN_DIR" ]; then
                export PYTHONPATH="$(dirname $XCBGEN_DIR):${PYTHONPATH:-}"
              fi
            fi
            # åŸºæœ¬éªŒè¯
            python3 -c "import xcbgen" || (echo "âŒ Error: xcbgen module not available" && exit 1)
            pkg-config --exists xcb || (echo "âŒ Error: xcb pkg-config not found" && exit 1)
          fi

          # æ„å»ºé¡¹ç›®ï¼ˆåªéªŒè¯æ„å»ºï¼Œä¸æ‰“åŒ…ï¼‰
          echo "ğŸ”¨ Building for ${{ matrix.platform }} (${{ matrix.target }})..."
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-gnu" ]]; then
            # Linux x86_64 ä½¿ç”¨è¯¦ç»†è¾“å‡ºä»¥ä¾¿è°ƒè¯•
            if cargo build --release --target ${{ matrix.target }} --bin workflow --bin install -vv 2>&1 | tee build.log; then
              BUILD_SUCCESS=true
            else
              BUILD_SUCCESS=false
              echo "âŒ Build failed. Checking build log for xcb-related errors..."
              grep -i "xcb\|xproto\|xcbgen" build.log | head -20 || true
            fi
          elif [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            # Linux ARM64 äº¤å‰ç¼–è¯‘
            echo "ğŸ”¨ Building for Linux ARM64..."
            # ç¡®ä¿ç¯å¢ƒå˜é‡å·²è®¾ç½®
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            if cargo build --release --target ${{ matrix.target }} --bin workflow --bin install; then
              BUILD_SUCCESS=true
            else
              BUILD_SUCCESS=false
              echo "âŒ Build failed for Linux ARM64"
            fi
          else
            # å…¶ä»–ç›®æ ‡ï¼ˆmacOS, Windows, muslï¼‰
            if cargo build --release --target ${{ matrix.target }} --bin workflow --bin install; then
              BUILD_SUCCESS=true
            else
              BUILD_SUCCESS=false
            fi
          fi

          # å¦‚æœæ„å»ºå¤±è´¥ï¼Œé€€å‡ºå¹¶è¿”å›é”™è¯¯ç 
          if [ "$BUILD_SUCCESS" != "true" ]; then
            echo "âŒ Build verification failed for ${{ matrix.platform }}"
            exit 1
          fi

          echo "âœ… Build verification passed for ${{ matrix.platform }}"

  # ç”Ÿæˆ PR è¯„è®ºï¼ˆæ±‡æ€»æ‰€æœ‰æµ‹è¯•ç»“æœï¼‰
  # è¿™ä¸ª job åœ¨æ‰€æœ‰æµ‹è¯•å®Œæˆåè¿è¡Œï¼Œæ±‡æ€»ç»“æœå¹¶æ·»åŠ  PR è¯„è®º
  pr-comment:
    name: ğŸ’¬ Comment Test Results on PR
    runs-on: ubuntu-latest
    needs: [tests]
    if: github.event_name == 'pull_request' && always()
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: ğŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ğŸ“¥ Download all test reports
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: test-report-json-*
          merge-multiple: false

      - name: ğŸ“Š Generate PR comment
        id: generate_comment
        continue-on-error: true
        shell: bash
        run: |
          echo "ğŸ“Š Generating PR comment..."

          # æ£€æŸ¥ Python æ˜¯å¦å¯ç”¨
          if ! command -v python3 >/dev/null 2>&1; then
            echo "âš ï¸  Python3 not found, skipping PR comment generation"
            exit 0
          fi

          # æŸ¥æ‰¾æ‰€æœ‰ JSON æŠ¥å‘Šæ–‡ä»¶
          JSON_FILES=$(find . -name "test-report-*.json" -type f 2>/dev/null)

          if [ -z "$JSON_FILES" ]; then
            echo "âš ï¸  No JSON test reports found, skipping PR comment"
            exit 0
          fi

          # åˆå¹¶æ‰€æœ‰æŠ¥å‘Šï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
          echo "Found JSON reports:"
          echo "$JSON_FILES"

          # ç”Ÿæˆ PR è¯„è®ºå†…å®¹ï¼ˆåˆå¹¶æ‰€æœ‰æŠ¥å‘Šï¼‰
          COMMENT_FILE="pr-comment.md"
          # æ„å»ºå‘½ä»¤å‚æ•°ï¼ˆæ¯ä¸ªæŠ¥å‘Šæ–‡ä»¶éƒ½éœ€è¦ --report å‰ç¼€ï¼‰
          CMD_ARGS="--comment --format markdown --output $COMMENT_FILE"
          for json_file in $JSON_FILES; do
            CMD_ARGS="$CMD_ARGS --report $json_file"
          done

          # ä½¿ç”¨ Python dev å·¥å…·
          python3 scripts/dev/py/dev.py tests report generate $CMD_ARGS || {
            echo "âš ï¸  Failed to generate PR comment, continuing..."
            exit 0
          }

          # å°†è¯„è®ºå†…å®¹ä¿å­˜åˆ°è¾“å‡ºï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          echo "comment_file=$COMMENT_FILE" >> $GITHUB_OUTPUT
          echo "âœ… PR comment generated"

      - name: ğŸ’¬ Comment on PR
        if: steps.generate_comment.outputs.comment_file != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentFile = '${{ steps.generate_comment.outputs.comment_file }}';

            if (!fs.existsSync(commentFile)) {
              console.log('âš ï¸  Comment file not found, skipping');
              return;
            }

            const commentBody = fs.readFileSync(commentFile, 'utf8');
            const prNumber = context.issue.number;

            console.log(`ğŸ“ Posting comment on PR #${prNumber}`);

            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰æµ‹è¯•ç»“æœè¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            // æŸ¥æ‰¾ç”± bot åˆ›å»ºçš„æµ‹è¯•ç»“æœè¯„è®º
            const botComment = comments.data.find(
              comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Test Results Summary')
            );

            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              console.log(`ğŸ”„ Updating existing comment #${botComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
              console.log('âœ… Comment updated');
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              console.log('âœ¨ Creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
              console.log('âœ… Comment created');
            }

  # æµ‹è¯•è¶‹åŠ¿åˆ†æï¼ˆåœ¨æ‰€æœ‰æµ‹è¯•å®Œæˆåè¿è¡Œï¼‰
  # åªåœ¨æ‰€æœ‰æµ‹è¯•æˆåŠŸæ—¶è¿è¡Œï¼Œå› ä¸ºæµ‹è¯•å¤±è´¥æ—¶è¶‹åŠ¿åˆ†ææ„ä¹‰ä¸å¤§
  test-trends:
    name: ğŸ“ˆ Analyze Test Trends
    runs-on: ubuntu-latest
    needs: [tests]
    if: needs.tests.result == 'success'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: ğŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ğŸ“¥ Download test metrics
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: test-metrics-*
          merge-multiple: false

      - name: ğŸ“Š Analyze trends
        continue-on-error: true
        shell: bash
        run: |
          echo "ğŸ“Š Analyzing test trends..."

          if ! command -v python3 >/dev/null 2>&1; then
            echo "âš ï¸  Python3 not found, skipping trend analysis"
            exit 0
          fi

          # æ”¶é›†æ‰€æœ‰æŒ‡æ ‡æ–‡ä»¶
          METRICS_DIR="all-metrics"
          mkdir -p "$METRICS_DIR"
          find . -name "metrics-*.json" -type f -exec cp {} "$METRICS_DIR/" \; 2>/dev/null || true

          if [ -z "$(ls -A $METRICS_DIR 2>/dev/null)" ]; then
            echo "âš ï¸  No metrics found, skipping analysis"
            exit 0
          fi

          # ä½¿ç”¨ Python dev å·¥å…·
          python3 scripts/dev/py/dev.py tests trends analyze \
            --metrics-dir "$METRICS_DIR" \
            --output "test-trends-report.md" || {
            echo "âš ï¸  Failed to generate trend report, continuing..."
            exit 0
          }

          echo "trend_report=test-trends-report.md" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload trend report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-trends-report
          path: test-trends-report.md
          retention-days: 30
          if-no-files-found: ignore

  # ç¡®ä¿æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼ˆæ±‡æ€» jobï¼‰
  # è¿™ä¸ª job ä¾èµ–äº check-lint å’Œ testsï¼Œæ£€æŸ¥æ‰€æœ‰å¿…éœ€æ£€æŸ¥çš„çŠ¶æ€
  # å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œæ­¤ job ä¼šå¤±è´¥ï¼Œä»è€Œé˜»æ­¢ PR åˆå¹¶
  # æ³¨æ„ï¼šéœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼Œå°†æ­¤å·¥ä½œæµè®¾ä¸ºå¿…éœ€çš„çŠ¶æ€æ£€æŸ¥
  # çŠ¶æ€æ£€æŸ¥åç§°ï¼šCI / âœ… Verify All Checks
  # æ³¨æ„ï¼šjob åç§°å¿…é¡»ä¸åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­é…ç½®çš„çŠ¶æ€æ£€æŸ¥åç§°åŒ¹é…
  # æ³¨æ„ï¼šæ–‡æ¡£æ£€æŸ¥å·²ç§»è‡³ doc-consistency-check.yml workflow
  check-status:
    name: âœ… Verify All Checks
    runs-on: ubuntu-latest
    # å¯¹äºæ‰€æœ‰ PR éƒ½è¿è¡Œæ­¤ jobï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯çš„æƒ…å†µ
    # è¿™æ · GitHub ä¼šæŠ¥å‘ŠçŠ¶æ€ï¼Œæ»¡è¶³åˆ†æ”¯ä¿æŠ¤è§„åˆ™çš„è¦æ±‚
    # ä½¿ç”¨ always() ç¡®ä¿å³ä½¿ä¾èµ–çš„ job å¤±è´¥æˆ–è·³è¿‡ï¼Œæ­¤ job ä¹Ÿä¼šè¿è¡Œ
    needs: [check-skip-ci, check-lint, tests, build]
    if: always()
    steps:
      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: ğŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: âœ… Check lint and test status
        id: status_check
        env:
          should_skip: ${{ needs.check-skip-ci.outputs.should_skip }}
          CHECK_LINT_RESULT: ${{ needs.check-lint.result }}
          TESTS_RESULT: ${{ needs.tests.result }}
          BUILD_RESULT: ${{ needs.build.result }}
        run: |
          # ä½¿ç”¨ Python dev å·¥å…·
          python3 scripts/dev/py/dev.py ci verify \
            --should-skip ${{ needs.check-skip-ci.outputs.should_skip == 'true' }} \
            --jobs "check-lint,tests,build"
