name: CI

on:
  pull_request:
    branches:
      - master
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘ CIï¼ˆç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šæƒ…å†µï¼‰
  workflow_dispatch:

# é…ç½®å·¥ä½œæµæƒé™ï¼Œå…è®¸è¯»å– PR ä¿¡æ¯
permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡ CIï¼ˆåªæ£€æŸ¥ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼‰
  check-skip-ci:
    name: â­ï¸ Check Skip CI
    env:
      # ä½¿ç”¨ WORKFLOW_PAT åˆ›å»º PRï¼Œè¿™æ ·å¯ä»¥è§¦å‘åç»­çš„ workflow
      WORKFLOW_USER_NAME: ${{ secrets.WORKFLOW_USER_NAME }}
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥æ£€æŸ¥æäº¤è€…

      - name: ğŸ” Check if version bump branch
        id: check
        run: |
          # è·å–åˆ†æ”¯åç§°ï¼ˆå¯¹äº PR äº‹ä»¶ä½¿ç”¨ head_refï¼Œå¯¹äºå…¶ä»–äº‹ä»¶ä½¿ç”¨ refï¼‰
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"

          echo "ğŸ” Checking branch: $BRANCH_NAME"
          echo "   Event: ${{ github.event_name }}"
          echo "   Head ref: ${{ github.head_ref }}"
          echo "   Ref name: ${{ github.ref_name }}"

          # åªæ£€æŸ¥æ˜¯å¦æ˜¯ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
          if [[ "$BRANCH_NAME" =~ ^bump-version- ]]; then
            echo "âœ… Detected bump-version-* branch: $BRANCH_NAME"

            # å¯¹äº PR äº‹ä»¶ï¼ŒéªŒè¯åˆ†æ”¯æ˜¯å¦ç”± CI åˆ›å»º
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              PR_CREATOR="${{ github.event.pull_request.user.login }}"
              WORKFLOW_USER_NAME="${{ env.WORKFLOW_USER_NAME }}"

              echo "   PR creator: ${PR_CREATOR:-'unknown'}"
              echo "   Expected user: $WORKFLOW_USER_NAME"

              if [[ "$PR_CREATOR" != "$WORKFLOW_USER_NAME" ]]; then
                echo "âŒ Error: bump-version-* branches can only be created by authorized user"
                echo "   PR creator: ${PR_CREATOR:-'unknown'}, expected: $WORKFLOW_USER_NAME"
                exit 1
              fi
            fi

            echo "âœ… Setting should_skip=true (bump-version-* branch detected)"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  Not a bump-version-* branch, CI will run normally"
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆLintï¼‰
  check-lint:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: âœ¨ Check code formatting
        run: cargo fmt --check

      - name: ğŸ” Run Clippy linter
        run: cargo clippy -- -D warnings

      - name: âœ… Verify compilation
        run: cargo check

  # è¿è¡Œæµ‹è¯•
  tests:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: ğŸ§ª Run tests
        run: cargo test --verbose

      - name: ğŸ“ Run doctests
        run: cargo test --doc --verbose

      - name: âœ… Run completion completeness tests
        run: cargo test --test completeness

  # æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥ï¼ˆéé˜»å¡ï¼‰
  coverage:
    name: ğŸ“Š Test Coverage
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    continue-on-error: true  # éé˜»å¡æ¨¡å¼ï¼šè¦†ç›–ç‡æ£€æŸ¥å¤±è´¥ä¸é˜»æ­¢ PR åˆå¹¶
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: ğŸ“¦ Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: ğŸ“Š Generate coverage report
        run: cargo tarpaulin --out Lcov --output-dir coverage

      - name: ğŸ“¤ Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: ğŸ“‹ Coverage summary
        if: always()
        run: |
          echo "ğŸ“Š Coverage check completed"
          echo "Note: Coverage check is non-blocking. Please review the report above."

  # æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆæ¶æ„æ–‡æ¡£å­˜åœ¨æ€§ã€æ—¶é—´æˆ³æ ¼å¼ç­‰ï¼‰
  check-docs:
    name: ğŸ“š Document Consistency Check
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    continue-on-error: true  # éé˜»å¡æ¨¡å¼ï¼šå…è®¸å¤±è´¥ï¼Œä¸é˜»æ­¢ PR åˆå¹¶
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥æ¯”è¾ƒåˆ†æ”¯

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“š Run document consistency checks
        run: |
          echo "ğŸ“š Running document consistency checks..."

          # æ£€æŸ¥å˜æ›´æ–‡ä»¶çš„æ¶æ„æ–‡æ¡£å­˜åœ¨æ€§
          echo ""
          echo "ğŸ“ Checking architecture documents for changed files..."

          # è·å–å˜æ›´çš„æ–‡ä»¶ï¼ˆç›¸å¯¹äºåŸºç¡€åˆ†æ”¯ï¼‰
          BASE_REF="${{ github.event.pull_request.base.ref || 'master' }}"
          CHANGED_FILES=$(git diff --name-only origin/${BASE_REF}...HEAD 2>/dev/null | grep -E '^src/(lib|commands)/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "â„¹ï¸  No changed files in src/lib/ or src/commands/ directories"
          else
            # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç¼ºå¤±çš„æ–‡æ¡£
            MISSING_DOCS_FILE=$(mktemp)
            trap "rm -f $MISSING_DOCS_FILE" EXIT

            echo "$CHANGED_FILES" | while IFS= read -r file; do
              [ -z "$file" ] && continue

              # æå–æ¨¡å—å
              module=$(echo "$file" | sed 's|^src/lib/\([^/]*\).*|\1|')
              if [ "$module" = "$file" ]; then
                module=$(echo "$file" | sed 's|^src/commands/\([^/]*\).*|\1|')
              fi

              # è·³è¿‡ç©ºæ¨¡å—åæˆ–æ— æ•ˆè·¯å¾„
              [ -z "$module" ] || [ "$module" = "$file" ] && continue

              doc_path="docs/architecture/${module}.md"
              if [ ! -f "$doc_path" ]; then
                echo "âš ï¸  Warning: Module '$module' changed but architecture doc not found: $doc_path"
                echo "$doc_path" >> "$MISSING_DOCS_FILE"
              fi
            done

            # ç»Ÿè®¡ç¼ºå¤±çš„æ–‡æ¡£æ•°é‡
            MISSING_DOCS=0
            if [ -f "$MISSING_DOCS_FILE" ] && [ -s "$MISSING_DOCS_FILE" ]; then
              MISSING_DOCS=$(wc -l < "$MISSING_DOCS_FILE")
            fi

            if [ $MISSING_DOCS -gt 0 ]; then
              echo ""
              echo "ğŸ“‹ Found $MISSING_DOCS module(s) missing architecture documentation"
              echo "::warning::Found $MISSING_DOCS module(s) missing architecture documentation"
            else
              echo ""
              echo "âœ… All changed modules have architecture documentation"
            fi
          fi

          # æ£€æŸ¥æ–‡æ¡£æ—¶é—´æˆ³æ ¼å¼
          echo ""
          echo "ğŸ“… Checking document timestamp format..."
          INVALID_TIMESTAMPS=0
          while IFS= read -r file; do
            if ! tail -5 "$file" | grep -qE '\*\*æœ€åæ›´æ–°\*\*: [0-9]{4}-[0-9]{2}-[0-9]{2}'; then
              echo "âš ï¸  Invalid timestamp format: $file"
              INVALID_TIMESTAMPS=$((INVALID_TIMESTAMPS + 1))
            fi
          done < <(find docs -name "*.md" -type f ! -path "*/templates/*" ! -name "README.md")

          if [ $INVALID_TIMESTAMPS -gt 0 ]; then
            echo "ğŸ“‹ Found $INVALID_TIMESTAMPS document(s) with invalid timestamp format"
            echo "::warning::Found $INVALID_TIMESTAMPS document(s) with invalid timestamp format"
          else
            echo "âœ… All documents have valid timestamp format"
          fi

          echo ""
          echo "âœ… Document consistency checks completed"

      - name: ğŸ“¤ Upload document check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: document-consistency-reports
          path: report/doc-consistency-check-test-*.md
          retention-days: 7
          if-no-files-found: ignore

      - name: âœ… Document consistency check summary
        if: always()
        run: |
          echo "âœ… Document consistency check completed"
          echo "Note: Document consistency checks are non-blocking. Please review warnings above."

  # æ–‡æ¡£é“¾æ¥éªŒè¯ï¼ˆå†…éƒ¨é“¾æ¥å’Œå¤–éƒ¨é“¾æ¥ï¼‰
  check-links:
    name: ğŸ”— Document Link Validation
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    continue-on-error: true  # éé˜»å¡æ¨¡å¼ï¼šå…è®¸å¤±è´¥ï¼Œä¸é˜»æ­¢ PR åˆå¹¶
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install lychee
        continue-on-error: true
        run: |
          echo "ğŸ“¦ Installing lychee for external link checking..."
          cargo install lychee || echo "âš ï¸ Failed to install lychee, external link checking will be skipped"

      - name: ğŸ”— Run document link validation
        run: |
          echo "ğŸ”— Running document link validation..."

          # æ£€æŸ¥å†…éƒ¨é“¾æ¥
          echo ""
          echo "ğŸ“‹ Checking internal links..."

          # ä¸´æ—¶æ–‡ä»¶å­˜å‚¨æ–­é“¾ä¿¡æ¯
          BROKEN_LINKS_FILE=$(mktemp)
          trap "rm -f $BROKEN_LINKS_FILE" EXIT

          find docs -name "*.md" -type f ! -path "*/templates/*" | while read -r file; do
            # æå–æ‰€æœ‰å†…éƒ¨é“¾æ¥ï¼ˆæ ¼å¼ï¼š](path/to/file.md) æˆ– [text](path/to/file.md#anchor)ï¼‰
            grep -oP '\]\([^)]+\)' "$file" 2>/dev/null | sed 's/](//;s/)//' | while read -r link; do
              # è·³è¿‡ç©ºé“¾æ¥
              [ -z "$link" ] && continue

              # è·³è¿‡å¤–éƒ¨é“¾æ¥
              [[ "$link" =~ ^https?:// ]] && continue

              # è·³è¿‡é”šç‚¹é“¾æ¥ï¼ˆåªæ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§ï¼Œä¸æ£€æŸ¥é”šç‚¹ï¼‰
              if [[ "$link" =~ ^# ]]; then
                continue
              fi

              # è§£æé“¾æ¥è·¯å¾„
              if [[ "$link" =~ ^/ ]]; then
                # ç»å¯¹è·¯å¾„ï¼ˆä»é¡¹ç›®æ ¹ç›®å½•å¼€å§‹ï¼‰
                target_file="${link#/}"
              else
                # ç›¸å¯¹è·¯å¾„
                file_dir=$(dirname "$file")
                target_file="$file_dir/$link"
              fi

              # ç§»é™¤é”šç‚¹éƒ¨åˆ†ï¼ˆ#anchorï¼‰
              target_file="${target_file%%#*}"

              # è§„èŒƒåŒ–è·¯å¾„ï¼ˆç§»é™¤å¤šä½™çš„ ./ å’Œ ..ï¼‰
              target_file=$(echo "$target_file" | sed 's|^\./||' | sed 's|/\./|/|g')

              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if [ ! -f "$target_file" ]; then
                echo "âŒ Broken link: $file -> $link (target file: $target_file)" >> "$BROKEN_LINKS_FILE"
              fi
            done
          done

          # ç»Ÿè®¡æ–­é“¾æ•°é‡
          BROKEN_LINKS=0
          if [ -f "$BROKEN_LINKS_FILE" ] && [ -s "$BROKEN_LINKS_FILE" ]; then
            BROKEN_LINKS=$(wc -l < "$BROKEN_LINKS_FILE")
            echo ""
            echo "Found broken links:"
            cat "$BROKEN_LINKS_FILE"
            echo ""
            echo "::warning::Found $BROKEN_LINKS broken internal link(s)"
          fi

          if [ $BROKEN_LINKS -gt 0 ]; then
            echo "âŒ Found $BROKEN_LINKS broken link(s)"
          else
            echo "âœ… All internal links are valid"
          fi

          # æ£€æŸ¥å¤–éƒ¨é“¾æ¥ï¼ˆå¦‚æœ lychee å¯ç”¨ï¼‰
          if command -v lychee >/dev/null 2>&1; then
            echo ""
            echo "ğŸ“‹ Checking external links..."
            lychee docs/**/*.md --exclude-all-private --exclude-loopback || {
              echo "âš ï¸  Found external link issues (non-blocking)"
              echo "   Please review the output above for details"
            }
          else
            echo ""
            echo "â„¹ï¸  lychee not installed, skipping external link check"
          fi

          echo ""
          echo "âœ… Document link validation completed"

      - name: âœ… Document link validation summary
        if: always()
        run: |
          echo "âœ… Document link validation completed"
          echo "Note: Document link validation is non-blocking. Please review warnings above."

  # ç¡®ä¿æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼ˆæ±‡æ€» jobï¼‰
  # è¿™ä¸ª job ä¾èµ–äº check-lint å’Œ testsï¼Œæ£€æŸ¥æ‰€æœ‰å¿…éœ€æ£€æŸ¥çš„çŠ¶æ€
  # å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œæ­¤ job ä¼šå¤±è´¥ï¼Œä»è€Œé˜»æ­¢ PR åˆå¹¶
  # æ³¨æ„ï¼šéœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼Œå°†æ­¤å·¥ä½œæµè®¾ä¸ºå¿…éœ€çš„çŠ¶æ€æ£€æŸ¥
  # çŠ¶æ€æ£€æŸ¥åç§°ï¼šCI / âœ… Verify All Checks
  # æ³¨æ„ï¼šjob åç§°å¿…é¡»ä¸åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­é…ç½®çš„çŠ¶æ€æ£€æŸ¥åç§°åŒ¹é…
  check-status:
    name: âœ… Verify All Checks
    runs-on: ubuntu-latest
    # å¯¹äºæ‰€æœ‰ PR éƒ½è¿è¡Œæ­¤ jobï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯çš„æƒ…å†µ
    # è¿™æ · GitHub ä¼šæŠ¥å‘ŠçŠ¶æ€ï¼Œæ»¡è¶³åˆ†æ”¯ä¿æŠ¤è§„åˆ™çš„è¦æ±‚
    # ä½¿ç”¨ always() ç¡®ä¿å³ä½¿ä¾èµ–çš„ job å¤±è´¥æˆ–è·³è¿‡ï¼Œæ­¤ job ä¹Ÿä¼šè¿è¡Œ
    needs: [check-skip-ci, check-lint, tests, check-docs, check-links]
    if: always()
    steps:
      - name: âœ… Check lint and test status
        id: status_check
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

          # è·å–æ‰€æœ‰ç›¸å…³ job çš„ç»“æœï¼ˆå¦‚æœ job æœªè¿è¡Œï¼Œresult å¯èƒ½ä¸ºç©ºï¼‰
          SKIP_CI_RESULT="${{ needs.check-skip-ci.result }}"
          SKIP_CI_SHOULD_SKIP="${{ needs.check-skip-ci.outputs.should_skip }}"
          LINT_RESULT="${{ needs.check-lint.result }}"
          TEST_RESULT="${{ needs.tests.result }}"
          DOCS_RESULT="${{ needs.check-docs.result }}"
          LINKS_RESULT="${{ needs.check-links.result }}"

          echo "ğŸ“Š Checking job status:"
          echo "  check-skip-ci: $SKIP_CI_RESULT (should_skip: $SKIP_CI_SHOULD_SKIP)"
          echo "  check-lint: $LINT_RESULT"
          echo "  tests: $TEST_RESULT"
          echo "  check-docs: $DOCS_RESULT (non-blocking)"
          echo "  check-links: $LINKS_RESULT (non-blocking)"

          # ä¼˜å…ˆçº§1: å¦‚æœ check-skip-ci æˆåŠŸä¸” should_skip ä¸º trueï¼Œè¯´æ˜åº”è¯¥è·³è¿‡ CI
          if [ "$SKIP_CI_RESULT" == "success" ] && [ "$SKIP_CI_SHOULD_SKIP" == "true" ]; then
            echo "âœ… CI should be skipped for version bump branch"
            exit 0
          fi

          # ä¼˜å…ˆçº§2: å¦‚æœ check-lint å’Œ tests éƒ½è¢«è·³è¿‡ï¼Œè¯´æ˜åº”è¯¥è·³è¿‡ CI
          if [ "$LINT_RESULT" == "skipped" ] && [ "$TEST_RESULT" == "skipped" ]; then
            echo "âœ… CI checks were skipped"
            exit 0
          fi

          # æ£€æŸ¥ check-skip-ci æ˜¯å¦å¤±è´¥ï¼ˆè¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†éœ€è¦å¤„ç†ï¼‰
          if [ "$SKIP_CI_RESULT" == "failure" ]; then
            echo "âŒ check-skip-ci failed"
            exit 1
          fi

          # æ£€æŸ¥ check-lint çŠ¶æ€
          if [ -n "$LINT_RESULT" ]; then
            if [ "$LINT_RESULT" == "failure" ] || [ "$LINT_RESULT" == "cancelled" ]; then
              echo "âŒ Lint check failed: $LINT_RESULT"
              exit 1
            elif [ "$LINT_RESULT" != "success" ] && [ "$LINT_RESULT" != "skipped" ]; then
              echo "âŒ Lint check has unexpected status: $LINT_RESULT"
              exit 1
            fi
          fi

          # æ£€æŸ¥ tests çŠ¶æ€
          if [ -n "$TEST_RESULT" ]; then
            if [ "$TEST_RESULT" == "failure" ] || [ "$TEST_RESULT" == "cancelled" ]; then
              echo "âŒ Test check failed: $TEST_RESULT"
              exit 1
            elif [ "$TEST_RESULT" != "success" ] && [ "$TEST_RESULT" != "skipped" ]; then
              echo "âŒ Test check has unexpected status: $TEST_RESULT"
              exit 1
            fi
          fi

          # æ£€æŸ¥ check-docs çŠ¶æ€ï¼ˆéé˜»å¡ï¼Œä»…è®°å½•ï¼‰
          if [ -n "$DOCS_RESULT" ]; then
            if [ "$DOCS_RESULT" == "failure" ]; then
              echo "âš ï¸  Document consistency check found issues (non-blocking): $DOCS_RESULT"
              echo "   Please review the warnings above"
            elif [ "$DOCS_RESULT" == "success" ]; then
              echo "âœ… Document consistency check passed: $DOCS_RESULT"
            fi
          fi

          # æ£€æŸ¥ check-links çŠ¶æ€ï¼ˆéé˜»å¡ï¼Œä»…è®°å½•ï¼‰
          if [ -n "$LINKS_RESULT" ]; then
            if [ "$LINKS_RESULT" == "failure" ]; then
              echo "âš ï¸  Document link validation found issues (non-blocking): $LINKS_RESULT"
              echo "   Please review the warnings above"
            elif [ "$LINKS_RESULT" == "success" ]; then
              echo "âœ… Document link validation passed: $LINKS_RESULT"
            fi
          fi

          # å¦‚æœ check-lint å’Œ tests éƒ½æˆåŠŸæˆ–è¢«è·³è¿‡ï¼Œåˆ™é€šè¿‡
          # æ³¨æ„ï¼šcheck-docs å’Œ check-links çš„ç»“æœä¸å½±å“æœ€ç»ˆçŠ¶æ€ï¼ˆéé˜»å¡ï¼‰
          if [ "$LINT_RESULT" == "success" ] || [ "$LINT_RESULT" == "skipped" ]; then
            if [ "$TEST_RESULT" == "success" ] || [ "$TEST_RESULT" == "skipped" ]; then
              echo "âœ… All required checks passed or were skipped"
              exit 0
            fi
          fi

          # å¦‚æœåˆ°è¾¾è¿™é‡Œï¼Œè¯´æ˜æœ‰æœªå¤„ç†çš„çŠ¶å†µ
          echo "âš ï¸  Unexpected state: lint=$LINT_RESULT, test=$TEST_RESULT"
          echo "   This should not happen. Please check the workflow configuration."
          exit 1
