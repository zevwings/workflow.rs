name: CI

on:
  pull_request:
    branches:
      - master
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘ CIï¼ˆç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šæƒ…å†µï¼‰
  workflow_dispatch:

# é…ç½®å·¥ä½œæµæƒé™ï¼Œå…è®¸è¯»å– PR ä¿¡æ¯
permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡ CIï¼ˆåªæ£€æŸ¥ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼‰
  check-skip-ci:
    name: â­ï¸ Check Skip CI
    env:
      # ä½¿ç”¨ WORKFLOW_PAT åˆ›å»º PRï¼Œè¿™æ ·å¯ä»¥è§¦å‘åç»­çš„ workflow
      WORKFLOW_USER_NAME: ${{ secrets.WORKFLOW_USER_NAME }}
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥æ£€æŸ¥æäº¤è€…

      - name: ğŸ” Check if version bump branch
        id: check
        run: |
          # è·å–åˆ†æ”¯åç§°ï¼ˆå¯¹äº PR äº‹ä»¶ä½¿ç”¨ head_refï¼Œå¯¹äºå…¶ä»–äº‹ä»¶ä½¿ç”¨ refï¼‰
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"

          echo "ğŸ” Checking branch: $BRANCH_NAME"
          echo "   Event: ${{ github.event_name }}"
          echo "   Head ref: ${{ github.head_ref }}"
          echo "   Ref name: ${{ github.ref_name }}"

          # åªæ£€æŸ¥æ˜¯å¦æ˜¯ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
          if [[ "$BRANCH_NAME" =~ ^bump-version- ]]; then
            echo "âœ… Detected bump-version-* branch: $BRANCH_NAME"

            # å¯¹äº PR äº‹ä»¶ï¼ŒéªŒè¯åˆ†æ”¯æ˜¯å¦ç”± CI åˆ›å»º
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              PR_CREATOR="${{ github.event.pull_request.user.login }}"
              WORKFLOW_USER_NAME="${{ env.WORKFLOW_USER_NAME }}"

              echo "   PR creator: ${PR_CREATOR:-'unknown'}"
              echo "   Expected user: $WORKFLOW_USER_NAME"

              if [[ "$PR_CREATOR" != "$WORKFLOW_USER_NAME" ]]; then
                echo "âŒ Error: bump-version-* branches can only be created by authorized user"
                echo "   PR creator: ${PR_CREATOR:-'unknown'}, expected: $WORKFLOW_USER_NAME"
                exit 1
              fi
            fi

            echo "âœ… Setting should_skip=true (bump-version-* branch detected)"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  Not a bump-version-* branch, CI will run normally"
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆLintï¼‰
  check-lint:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: âœ¨ Check code formatting
        run: cargo fmt --check

      - name: ğŸ” Run Clippy linter
        run: cargo clippy -- -D warnings

      - name: âœ… Verify compilation
        run: cargo check

  # è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼ˆè·¨å¹³å°å¹¶è¡Œæ‰§è¡Œï¼‰
  tests:
    name: ğŸ§ª Run Tests (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux-x86_64
          - os: macos-latest
            platform: macOS
          - os: windows-latest
            platform: Windows-x86_64
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: ğŸ§ª Run unit and integration tests
        run: cargo test --verbose

      - name: âœ… Run completion completeness tests
        run: cargo test --test completeness

  # è¿è¡Œæ–‡æ¡£æµ‹è¯•ï¼ˆä¸å•å…ƒæµ‹è¯•å¹¶è¡Œæ‰§è¡Œï¼‰
  doctests:
    name: ğŸ“ Run Doctests
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # è·³è¿‡ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯ï¼ˆbump-version-*ï¼‰
    if: needs.check-skip-ci.outputs.should_skip != 'true'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # ä¼˜åŒ– Windows ä¸Šçš„ç¼“å­˜æ€§èƒ½
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          # å®‰è£… XCB å¼€å‘åº“ï¼ˆclipboard ä¾èµ–ï¼‰
          # xcb crate éœ€è¦ xcb-proto æ¥ç”Ÿæˆä»£ç æ¨¡å—
          # xcb-proto éœ€è¦ Python æ¥è¿è¡Œä»£ç ç”Ÿæˆè„šæœ¬
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev
          # åŸºæœ¬éªŒè¯
          python3 --version || (echo "âŒ Error: Python3 not found" && exit 1)

      - name: ğŸ“ Run doctests
        run: cargo test --doc --verbose

  # æ³¨æ„ï¼šæ–‡æ¡£æ£€æŸ¥ï¼ˆcheck-docs å’Œ check-linksï¼‰å·²ç§»è‡³ doc-consistency-check.yml workflow
  # è¯¥ workflow æ”¯æŒ PR è§¦å‘å’Œå®šæœŸæ£€æŸ¥ï¼ŒåŠŸèƒ½æ›´å®Œæ•´

  # ç¡®ä¿æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼ˆæ±‡æ€» jobï¼‰
  # è¿™ä¸ª job ä¾èµ–äº check-lint å’Œ testsï¼Œæ£€æŸ¥æ‰€æœ‰å¿…éœ€æ£€æŸ¥çš„çŠ¶æ€
  # å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œæ­¤ job ä¼šå¤±è´¥ï¼Œä»è€Œé˜»æ­¢ PR åˆå¹¶
  # æ³¨æ„ï¼šéœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼Œå°†æ­¤å·¥ä½œæµè®¾ä¸ºå¿…éœ€çš„çŠ¶æ€æ£€æŸ¥
  # çŠ¶æ€æ£€æŸ¥åç§°ï¼šCI / âœ… Verify All Checks
  # æ³¨æ„ï¼šjob åç§°å¿…é¡»ä¸åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­é…ç½®çš„çŠ¶æ€æ£€æŸ¥åç§°åŒ¹é…
  # æ³¨æ„ï¼šæ–‡æ¡£æ£€æŸ¥å·²ç§»è‡³ doc-consistency-check.yml workflow
  check-status:
    name: âœ… Verify All Checks
    runs-on: ubuntu-latest
    # å¯¹äºæ‰€æœ‰ PR éƒ½è¿è¡Œæ­¤ jobï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ›´æ–°åˆ†æ”¯çš„æƒ…å†µ
    # è¿™æ · GitHub ä¼šæŠ¥å‘ŠçŠ¶æ€ï¼Œæ»¡è¶³åˆ†æ”¯ä¿æŠ¤è§„åˆ™çš„è¦æ±‚
    # ä½¿ç”¨ always() ç¡®ä¿å³ä½¿ä¾èµ–çš„ job å¤±è´¥æˆ–è·³è¿‡ï¼Œæ­¤ job ä¹Ÿä¼šè¿è¡Œ
    needs: [check-skip-ci, check-lint, tests, doctests]
    if: always()
    steps:
      - name: âœ… Check lint and test status
        id: status_check
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ

          # è·å–æ‰€æœ‰ç›¸å…³ job çš„ç»“æœï¼ˆå¦‚æœ job æœªè¿è¡Œï¼Œresult å¯èƒ½ä¸ºç©ºï¼‰
          SKIP_CI_RESULT="${{ needs.check-skip-ci.result }}"
          SKIP_CI_SHOULD_SKIP="${{ needs.check-skip-ci.outputs.should_skip }}"
          LINT_RESULT="${{ needs.check-lint.result }}"
          TEST_RESULT="${{ needs.tests.result }}"
          DOCTEST_RESULT="${{ needs.doctests.result }}"

          echo "ğŸ“Š Checking job status:"
          echo "  check-skip-ci: $SKIP_CI_RESULT (should_skip: $SKIP_CI_SHOULD_SKIP)"
          echo "  check-lint: $LINT_RESULT"
          echo "  tests: $TEST_RESULT"
          echo "  doctests: $DOCTEST_RESULT"
          echo "  Note: Document checks are handled by doc-consistency-check.yml workflow"

          # ä¼˜å…ˆçº§1: å¦‚æœ check-skip-ci æˆåŠŸä¸” should_skip ä¸º trueï¼Œè¯´æ˜åº”è¯¥è·³è¿‡ CI
          if [ "$SKIP_CI_RESULT" == "success" ] && [ "$SKIP_CI_SHOULD_SKIP" == "true" ]; then
            echo "âœ… CI should be skipped for version bump branch"
            exit 0
          fi

          # ä¼˜å…ˆçº§2: å¦‚æœ check-lintã€tests å’Œ doctests éƒ½è¢«è·³è¿‡ï¼Œè¯´æ˜åº”è¯¥è·³è¿‡ CI
          if [ "$LINT_RESULT" == "skipped" ] && [ "$TEST_RESULT" == "skipped" ] && [ "$DOCTEST_RESULT" == "skipped" ]; then
            echo "âœ… CI checks were skipped"
            exit 0
          fi

          # æ£€æŸ¥ check-skip-ci æ˜¯å¦å¤±è´¥ï¼ˆè¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†éœ€è¦å¤„ç†ï¼‰
          if [ "$SKIP_CI_RESULT" == "failure" ]; then
            echo "âŒ check-skip-ci failed"
            exit 1
          fi

          # æ£€æŸ¥ check-lint çŠ¶æ€
          if [ -n "$LINT_RESULT" ]; then
            if [ "$LINT_RESULT" == "failure" ] || [ "$LINT_RESULT" == "cancelled" ]; then
              echo "âŒ Lint check failed: $LINT_RESULT"
              exit 1
            elif [ "$LINT_RESULT" != "success" ] && [ "$LINT_RESULT" != "skipped" ]; then
              echo "âŒ Lint check has unexpected status: $LINT_RESULT"
              exit 1
            fi
          fi

          # æ£€æŸ¥ tests çŠ¶æ€
          if [ -n "$TEST_RESULT" ]; then
            if [ "$TEST_RESULT" == "failure" ] || [ "$TEST_RESULT" == "cancelled" ]; then
              echo "âŒ Test check failed: $TEST_RESULT"
              exit 1
            elif [ "$TEST_RESULT" != "success" ] && [ "$TEST_RESULT" != "skipped" ]; then
              echo "âŒ Test check has unexpected status: $TEST_RESULT"
              exit 1
            fi
          fi

          # æ£€æŸ¥ doctests çŠ¶æ€
          if [ -n "$DOCTEST_RESULT" ]; then
            if [ "$DOCTEST_RESULT" == "failure" ] || [ "$DOCTEST_RESULT" == "cancelled" ]; then
              echo "âŒ Doctest check failed: $DOCTEST_RESULT"
              exit 1
            elif [ "$DOCTEST_RESULT" != "success" ] && [ "$DOCTEST_RESULT" != "skipped" ]; then
              echo "âŒ Doctest check has unexpected status: $DOCTEST_RESULT"
              exit 1
            fi
          fi

          # å¦‚æœ check-lintã€tests å’Œ doctests éƒ½æˆåŠŸæˆ–è¢«è·³è¿‡ï¼Œåˆ™é€šè¿‡
          # æ³¨æ„ï¼šæ–‡æ¡£æ£€æŸ¥å·²ç§»è‡³ doc-consistency-check.yml workflow
          if [ "$LINT_RESULT" == "success" ] || [ "$LINT_RESULT" == "skipped" ]; then
            if [ "$TEST_RESULT" == "success" ] || [ "$TEST_RESULT" == "skipped" ]; then
              if [ "$DOCTEST_RESULT" == "success" ] || [ "$DOCTEST_RESULT" == "skipped" ]; then
                echo "âœ… All required checks passed or were skipped"
                exit 0
              fi
            fi
          fi

          # å¦‚æœåˆ°è¾¾è¿™é‡Œï¼Œè¯´æ˜æœ‰æœªå¤„ç†çš„çŠ¶å†µ
          echo "âš ï¸  Unexpected state: lint=$LINT_RESULT, test=$TEST_RESULT, doctest=$DOCTEST_RESULT"
          echo "   This should not happen. Please check the workflow configuration."
          exit 1
