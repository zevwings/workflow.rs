name: Alpha Cleanup (Reusable)

on:
  workflow_call:
    inputs:
      merge_commit_sha:
        description: 'Merge commit SHA'
        required: true
        type: string
      current_version:
        description: 'Current release version'
        required: true
        type: string
    secrets:
      WORKFLOW_PAT:
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  cleanup-alpha-tags:
    name: ðŸ§¹ Cleanup Alpha Tags
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: ðŸ§¹ Cleanup Alpha Tags
        id: cleanup
        shell: bash
        run: |
          set -e

          echo "ðŸ” Starting alpha tag cleanup..."

          MERGE_COMMIT_SHA="${{ inputs.merge_commit_sha }}"

          if [ -z "$MERGE_COMMIT_SHA" ]; then
            echo "âš ï¸  No merge commit SHA found, skipping cleanup"
            exit 0
          fi

          echo "ðŸ“Œ Merge commit SHA: $MERGE_COMMIT_SHA"

          CURRENT_VERSION="${{ inputs.current_version }}"
          CURRENT_VERSION=$(echo "$CURRENT_VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "ðŸ“Œ Current release version: $CURRENT_VERSION"

          FIRST_PARENT=$(git rev-parse ${MERGE_COMMIT_SHA}^1)
          echo "   First parent (master before merge): $FIRST_PARENT"

          MASTER_HEAD=$(git rev-parse HEAD)
          echo "   Master HEAD (after merge): $MASTER_HEAD"

          echo ""
          echo "ðŸ·ï¸  Finding alpha tags..."
          ALPHA_TAGS=$(git tag -l '*.alpha-*' | sort -V || echo "")

          if [ -z "$ALPHA_TAGS" ]; then
            echo "âœ… No alpha tags found, nothing to clean up"
            exit 0
          fi

          echo "ðŸ“‹ Found alpha tags:"
          echo "$ALPHA_TAGS" | while read tag; do
            echo "   - $tag"
          done

          TAGS_TO_DELETE=""
          DELETED_COUNT=0

          echo ""
          echo "ðŸ” Checking which alpha tags point to merged commits..."

          for tag in $ALPHA_TAGS; do
            TAG_COMMIT=$(git rev-parse "$tag" 2>/dev/null || echo "")

            if [ -z "$TAG_COMMIT" ]; then
              echo "   âš ï¸  Tag $tag: Could not resolve commit"
              continue
            fi

            TAG_VERSION=$(echo "$tag" | sed -E 's/^v?([0-9]+\.[0-9]+\.[0-9]+)\.alpha-.*/\1/' 2>/dev/null || echo "")
            if [ -n "$TAG_VERSION" ] && ! echo "$TAG_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              TAG_VERSION=""
            fi

            if git merge-base --is-ancestor "$TAG_COMMIT" "$FIRST_PARENT" 2>/dev/null; then
              echo "   â­ï¸  Tag $tag ($TAG_COMMIT) is in master branch first-parent path, keeping"
            elif git merge-base --is-ancestor "$TAG_COMMIT" "$MASTER_HEAD" 2>/dev/null; then
              if [ -n "$TAG_VERSION" ] && [ "$TAG_VERSION" == "$CURRENT_VERSION" ]; then
                echo "   âœ… Tag $tag ($TAG_COMMIT) version $TAG_VERSION matches current version $CURRENT_VERSION and is from merged branch, will delete"
              else
                echo "   âœ… Tag $tag ($TAG_COMMIT) is from merged branch, will delete"
              fi
              TAGS_TO_DELETE="$TAGS_TO_DELETE $tag"
            else
              if [ -n "$TAG_VERSION" ] && [ "$TAG_VERSION" == "$CURRENT_VERSION" ]; then
                echo "   âš ï¸  Tag $tag ($TAG_COMMIT) version $TAG_VERSION matches current version $CURRENT_VERSION but commit is not in merge ancestry"
                echo "   ðŸ’¡ Considering deletion due to version match..."
                TAGS_TO_DELETE="$TAGS_TO_DELETE $tag"
              else
                echo "   â­ï¸  Tag $tag ($TAG_COMMIT) is not related to this merge, keeping"
              fi
            fi
          done

          if [ -z "$TAGS_TO_DELETE" ]; then
            echo ""
            echo "âœ… No alpha tags to delete"
            exit 0
          fi

          echo ""
          echo "ðŸ—‘ï¸  Deleting alpha tags..."

          for tag in $TAGS_TO_DELETE; do
            echo "   Deleting local tag: $tag"
            git tag -d "$tag" || echo "   âš ï¸  Failed to delete local tag $tag (may not exist)"
          done

          echo ""
          echo "ðŸ—‘ï¸  Deleting remote tags..."
          for tag in $TAGS_TO_DELETE; do
            echo "   Deleting remote tag: $tag"
            git push origin --delete "$tag" || echo "   âš ï¸  Failed to delete remote tag $tag (may not exist or already deleted)"
            DELETED_COUNT=$((DELETED_COUNT + 1))
          done

          echo ""
          echo "âœ… Cleanup completed: Deleted $DELETED_COUNT alpha tag(s)"
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "deleted_tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS_TO_DELETE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
