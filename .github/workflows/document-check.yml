name: Document Check

on:
  schedule:
    # æ¯å‘¨å…­ 00:00 UTC è¿è¡Œ
    - cron: '0 0 * * 6'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  issues: write  # å¦‚æœéœ€è¦åˆ›å»º Issue

jobs:
  check-architecture-docs:
    name: ğŸ“š Document Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-deps-
          enableCrossOsArchive: false

      - name: ğŸ’¾ Cache dev binary build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/release/dev
            target/release/deps/dev*
            target/release/.fingerprint/dev*
            target/release/incremental/dev-*
          key: ${{ runner.os }}-dev-bin-${{ hashFiles('src/lib/cli/dev.rs', 'src/bin/dev.rs', 'src/commands/dev/**/*.rs') }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-dev-bin-${{ hashFiles('src/lib/cli/dev.rs', 'src/bin/dev.rs', 'src/commands/dev/**/*.rs') }}-
            ${{ runner.os }}-dev-bin-
          enableCrossOsArchive: false

      - name: ğŸ”¨ Build dev binary
        run: cargo build --bin dev --release

      - name: ğŸ“¦ Install lychee
        continue-on-error: true
        run: |
          echo "ğŸ“¦ Installing lychee for external link checking..."
          cargo install lychee || echo "âš ï¸ Failed to install lychee, external link checking will be skipped"

      - name: ğŸ” Run document checks
        id: check
        timeout-minutes: 15
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Running document checks..."

          HAS_ISSUES=false

          # æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§ï¼ˆæ¶æ„æ–‡æ¡£å’Œæ—¶é—´æˆ³ï¼‰
          echo ""
          echo "ğŸ“ Checking document integrity..."
          cargo run --bin dev --release docs check integrity --ci || {
            echo "âš ï¸  Document integrity check found issues"
            HAS_ISSUES=true
          }

          # æ£€æŸ¥æ–‡æ¡£é“¾æ¥
          echo ""
          echo "ğŸ”— Checking document links..."
          if command -v lychee >/dev/null 2>&1; then
            cargo run --bin dev --release docs check links --external --ci || {
              echo "âš ï¸  Document link check found issues"
              HAS_ISSUES=true
            }
          else
            cargo run --bin dev --release docs check links --ci || {
              echo "âš ï¸  Document link check found issues"
              HAS_ISSUES=true
            }
          fi

          # è¾“å‡ºæ˜¯å¦æœ‰é—®é¢˜çš„æ ‡å¿—
          if [ "$HAS_ISSUES" = true ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ Found issues that need to be addressed"
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… All checks passed"
          fi

          echo ""
          echo "âœ… Document checks completed"

      - name: ğŸ“Š Generate report
        if: always()
        run: |
          cargo run --bin dev --release docs report generate \
            --check-type "å®šæœŸå®¡æŸ¥"

      - name: ğŸ“¤ Upload document check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: document-reports
          path: report/doc-check-*.md
          retention-days: 7
          if-no-files-found: ignore

      # åˆ›å»º Issue æ±‡æ€»é—®é¢˜ï¼ˆä»…åœ¨å‘ç°é—®é¢˜æ—¶ï¼‰
      - name: ğŸ“ Create issue if problems found
        if: steps.check.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().split('T')[0];
            const checkDate = new Date().toISOString();

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'document-check'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('[Document Check]') &&
              issue.title.includes(timestamp)
            );

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Document Check] Document issues found - ${timestamp}`,
              body: `## æ–‡æ¡£æ£€æŸ¥å‘ç°é—®é¢˜

              å®šæœŸæ£€æŸ¥å‘ç°æ–‡æ¡£é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ£€æŸ¥æŠ¥å‘Šã€‚

              **æ£€æŸ¥æ—¥æœŸ**ï¼š${checkDate}
              **æŠ¥å‘Šä½ç½®**ï¼š\`report/doc-check-*.md\`

              è¯·å‚è€ƒä»¥ä¸‹æ–‡æ¡£è¿›è¡Œä¿®å¤ï¼š
              - [æ¶æ„æ–‡æ¡£å®¡æŸ¥æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/docs/guidelines/development/references/review-architecture-consistency.md)
              - [æ–‡æ¡£æ›´æ–°æ£€æŸ¥æ¸…å•](https://github.com/${{ github.repository }}/blob/main/docs/guidelines/development/code-review.md)

              ---

              **æ³¨æ„**ï¼šæ­¤ Issue ç”±è‡ªåŠ¨åŒ–æ£€æŸ¥åˆ›å»ºï¼Œè¯·åŠæ—¶å¤„ç†ã€‚
              `,
              labels: ['document-check', 'documentation']
            });

