name: Comprehensive Check

on:
  pull_request:
    branches:
      - master
      - main
  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶ÂèëÔºàÁî®‰∫éÊµãËØïÊàñÁâπÊÆäÊÉÖÂÜµÔºâ
  workflow_dispatch:

# ÈÖçÁΩÆÂ∑•‰ΩúÊµÅÊùÉÈôê
permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Âü∫Á°ÄÊµãËØï‰Ωú‰∏öÔºàË∑®Âπ≥Âè∞Âπ∂Ë°åÊâßË°åÔºâ
  # ============================================
  test:
    name: üß™ Run Tests (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux-x86_64
          - os: macos-latest
            platform: macOS
          - os: windows-latest
            platform: Windows-x86_64
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: üì¶ Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: üß™ Run unit and integration tests
        run: cargo test --verbose

      - name: ‚úÖ Run completion completeness tests
        run: cargo test --test completeness

      - name: üìù Run doctests
        run: cargo test --doc --verbose

  # ============================================
  # Ë¶ÜÁõñÁéáÊä•Âëä‰Ωú‰∏ö
  # ============================================
  coverage:
    name: üìä Coverage Report
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: üì¶ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: üì¶ Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: üìä Generate coverage report
        run: |
          cargo tarpaulin --out Html --output-dir coverage \
            --exclude-files "src/bin/*" \
            --exclude-files "tests/*" \
            --exclude-files "benches/*" \
            --exclude-files "src/*/mod.rs"
        continue-on-error: true

      - name: üìä Generate coverage JSON report
        run: |
          cargo tarpaulin --out Json --output-dir coverage \
            --exclude-files "src/bin/*" \
            --exclude-files "tests/*" \
            --exclude-files "benches/*" \
            --exclude-files "src/*/mod.rs" \
            > coverage/coverage.json 2>/dev/null || true
        continue-on-error: true

      - name: üì§ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: üì§ Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: üìã Coverage summary
        if: always()
        run: |
          if [ -f "coverage/coverage.json" ] && command -v python3 >/dev/null 2>&1; then \
            COVERAGE=$(python3 -c "import json; data = json.load(open('coverage/coverage.json')); print(data.get('coverage_percent', 0))" 2>/dev/null || echo "0"); \
            echo "üìä Coverage: ${COVERAGE}%"; \
            echo "::notice::Test coverage: ${COVERAGE}%"; \
          else \
            echo "‚ö†Ô∏è  Unable to parse coverage data"; \
          fi

  # ============================================
  # ÊÄßËÉΩÂü∫ÂáÜ‰Ωú‰∏ö
  # ============================================
  performance:
    name: ‚ö° Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: üì¶ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: ‚ö° Run performance benchmarks
        run: |
          cargo bench --bench cli_performance \
            --bench core_operations \
            --bench network_operations
        continue-on-error: true

      - name: üì§ Upload performance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: target/criterion/
          retention-days: 7
          if-no-files-found: ignore

      - name: üìã Performance summary
        if: always()
        run: |
          if [ -d "target/criterion" ]; then \
            echo "‚ö° Performance benchmarks completed"; \
            echo "Reports available in target/criterion/"; \
          else \
            echo "‚ö†Ô∏è  Performance benchmarks did not generate reports"; \
          fi

