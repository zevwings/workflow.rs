name: Release

on:
  push:
    branches:
      - master  # å½“åˆå¹¶åˆ° master åˆ†æ”¯æ—¶è§¦å‘
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥ v å¼€å¤´çš„ tagï¼Œå¦‚ v0.1.0, v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true

# é…ç½®å·¥ä½œæµæƒé™ï¼Œå…è®¸åˆ›å»º Release å’Œæ›´æ–°ä»“åº“
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  pull-requests: read  # è¯»å– PRï¼ˆå¦‚æœéœ€è¦ï¼‰

env:
  CARGO_TERM_COLOR: always

jobs:
  # å½“åˆå¹¶åˆ° master æ—¶è‡ªåŠ¨åˆ›å»º tag
  create-tag:
    name: Create Tag
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: write  # å…è®¸åˆ›å»ºå’Œæ¨é€ tag
    outputs:
      tag: ${{ steps.job_outputs.outputs.tag }}
      tag_created: ${{ steps.job_outputs.outputs.tag_created }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥æ£€æŸ¥ tag
          token: ${{ secrets.GITHUB_TOKEN }}  # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ token

      - name: Get version from Cargo.toml
        id: version
        shell: bash
        run: |
          # ä» Cargo.toml è¯»å–ç‰ˆæœ¬å·
          VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "âŒ Error: Cannot read version from Cargo.toml"
            exit 1
          fi
          TAG="v$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "âœ… Version from Cargo.toml: $VERSION"
          echo "âœ… Tag to create: $TAG"

      - name: Check if tag exists and increment version if needed
        id: check_tag
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $TAG already exists"
            echo "Current commit: $(git rev-parse HEAD)"
            echo "Tag commit: $(git rev-parse $TAG)"

            if [ "$(git rev-parse HEAD)" = "$(git rev-parse $TAG)" ]; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "needs_increment=false" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "tag=$TAG" >> $GITHUB_OUTPUT
              echo "âœ… Tag points to current commit, skipping tag creation"
            else
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "needs_increment=true" >> $GITHUB_OUTPUT
              echo "âš ï¸  Tag points to different commit, auto-incrementing patch version"

              # è‡ªåŠ¨é€’å¢ patch ç‰ˆæœ¬å· (0.0.1 -> 0.0.2)
              IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
              MAJOR="${VERSION_PARTS[0]:-0}"
              MINOR="${VERSION_PARTS[1]:-0}"
              PATCH="${VERSION_PARTS[2]:-0}"

              # é€’å¢ patch ç‰ˆæœ¬
              PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$PATCH"
              NEW_TAG="v$NEW_VERSION"

              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
              echo "old_version=$VERSION" >> $GITHUB_OUTPUT
              echo "old_tag=$TAG" >> $GITHUB_OUTPUT

              echo "âœ… Auto-incremented version: $VERSION -> $NEW_VERSION"
              echo "âœ… New tag: $NEW_TAG"
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "needs_increment=false" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG does not exist, will create it"
          fi

      - name: Update Cargo.toml version if needed
        if: steps.check_tag.outputs.needs_increment == 'true'
        shell: bash
        run: |
          NEW_VERSION="${{ steps.check_tag.outputs.version }}"
          echo "Updating Cargo.toml version to $NEW_VERSION"

          # æ›´æ–° Cargo.toml ä¸­çš„ç‰ˆæœ¬å·
          if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            sed -i '' "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          else
            # Linux
            sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          fi

          # éªŒè¯æ›´æ–°
          UPDATED_VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
          if [ "$UPDATED_VERSION" != "$NEW_VERSION" ]; then
            echo "âŒ Error: Failed to update version in Cargo.toml"
            exit 1
          fi

          echo "âœ… Cargo.toml updated: version = \"$NEW_VERSION\""

      - name: Commit version update
        if: steps.check_tag.outputs.needs_increment == 'true'
        shell: bash
        run: |
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æäº¤æ›´æ”¹
          git add Cargo.toml
          git commit -m "chore: bump version to ${{ steps.check_tag.outputs.version }}"

          # æ¨é€åˆ° master
          echo "Pushing version update to master"
          git push origin master

          echo "âœ… Version update committed and pushed"

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false' || steps.check_tag.outputs.needs_increment == 'true'
        shell: bash
        run: |
          TAG="${{ steps.check_tag.outputs.tag }}"
          echo "Creating tag: $TAG"

          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ›å»º tag
          git tag "$TAG"

          # æ¨é€ tag
          echo "Pushing tag: $TAG"
          git push origin "$TAG"

          echo "âœ… Successfully created and pushed tag: $TAG"
          echo "â„¹ï¸  This tag push should trigger a new workflow run for building and releasing"

      - name: Set job outputs
        id: job_outputs
        shell: bash
        run: |
          TAG="${{ steps.check_tag.outputs.tag }}"
          TAG_CREATED="false"
          if [ "${{ steps.check_tag.outputs.exists }}" == "false" ] || [ "${{ steps.check_tag.outputs.needs_increment }}" == "true" ]; then
            TAG_CREATED="true"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "tag_created=$TAG_CREATED" >> $GITHUB_OUTPUT
          echo "âœ… Job outputs set: tag=$TAG, tag_created=$TAG_CREATED"

      - name: Skip tag creation
        if: steps.check_tag.outputs.exists == 'true' && steps.check_tag.outputs.needs_increment == 'false'
        shell: bash
        run: |
          echo "â­ï¸  Skipping tag creation: tag ${{ steps.check_tag.outputs.tag }} already exists and points to current commit"

  # æ„å»ºæ‰€æœ‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    runs-on: ${{ matrix.os }}
    needs: create-tag
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.create-tag.outputs.tag_created == 'true')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macOS-Intel
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macOS-AppleSilicon
          # æš‚æ—¶è·³è¿‡ Linux æ„å»º
          # - os: ubuntu-latest
          #   target: x86_64-unknown-linux-gnu
          #   platform: x86_64-unknown-linux-gnu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
            VERSION=${VERSION#v}
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬å·
            VERSION=${GITHUB_REF#refs/tags/}
            # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
            VERSION=${VERSION#v}
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/master" ]]; then
            # ä» create-tag job çš„ outputs è·å–ç‰ˆæœ¬å·
            if [ -n "${{ needs.create-tag.outputs.tag }}" ]; then
              VERSION="${{ needs.create-tag.outputs.tag }}"
              # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
              VERSION=${VERSION#v}
            else
              # å¦‚æœ outputs ä¸å¯ç”¨ï¼Œä» Cargo.toml è¯»å–
              VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
              if [ -z "$VERSION" ]; then
                echo "âŒ Error: Cannot read version from Cargo.toml"
                exit 1
              fi
            fi
          else
            echo "âŒ Error: Cannot determine version from context"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install pkg-config || true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Build release binaries
        run: |
          cargo build --release --target ${{ matrix.target }} --bin workflow --bin pr --bin qk
        env:
          CARGO_BUILD_TARGET: ${{ matrix.target }}

      - name: Create package directory
        run: |
          mkdir -p package
          cp target/${{ matrix.target }}/release/workflow package/
          cp target/${{ matrix.target }}/release/pr package/
          cp target/${{ matrix.target }}/release/qk package/

      - name: Create archive
        shell: bash
        run: |
          cd package
          ARCHIVE_NAME="workflow-${{ steps.version.outputs.version }}-${{ matrix.platform }}.tar.gz"
          tar czf "../$ARCHIVE_NAME" workflow pr qk
          cd ..
          ls -lh "$ARCHIVE_NAME"

      - name: Calculate SHA256
        id: sha256
        shell: bash
        run: |
          ARCHIVE_NAME="workflow-${{ steps.version.outputs.version }}-${{ matrix.platform }}.tar.gz"
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            SHA256=$(shasum -a 256 "$ARCHIVE_NAME" | cut -d' ' -f1)
          else
            SHA256=$(sha256sum "$ARCHIVE_NAME" | cut -d' ' -f1)
          fi
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "platform=${{ matrix.platform }}" >> $GITHUB_OUTPUT
          echo "archive=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "SHA256 for ${{ matrix.platform }}: $SHA256"

      - name: Save SHA256 to file
        shell: bash
        run: |
          ARCHIVE_NAME="workflow-${{ steps.version.outputs.version }}-${{ matrix.platform }}.tar.gz"
          echo "${{ steps.sha256.outputs.sha256 }}" > sha256-${{ matrix.platform }}.txt
          echo "${{ matrix.platform }}" >> sha256-${{ matrix.platform }}.txt
          echo "$ARCHIVE_NAME" >> sha256-${{ matrix.platform }}.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: |
            workflow-${{ steps.version.outputs.version }}-${{ matrix.platform }}.tar.gz
          retention-days: 30

      - name: Upload SHA256
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.platform }}
          path: |
            sha256-${{ matrix.platform }}.txt
          retention-days: 30

  # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
  release:
    name: Create Release
    needs: [create-tag, build]
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.create-tag.outputs.tag_created == 'true')
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
      pull-requests: read  # è¯»å– PRï¼ˆå¦‚æœéœ€è¦ï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
            VERSION=${VERSION#v}
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬å·
            VERSION=${GITHUB_REF#refs/tags/}
            # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
            VERSION=${VERSION#v}
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/master" ]]; then
            # ä» create-tag job çš„ outputs è·å–ç‰ˆæœ¬å·
            if [ -n "${{ needs.create-tag.outputs.tag }}" ]; then
              VERSION="${{ needs.create-tag.outputs.tag }}"
              # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
              VERSION=${VERSION#v}
            else
              # å¦‚æœ outputs ä¸å¯ç”¨ï¼Œä» Cargo.toml è¯»å–
              VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
              if [ -z "$VERSION" ]; then
                echo "âŒ Error: Cannot read version from Cargo.toml"
                exit 1
              fi
            fi
          else
            echo "âŒ Error: Cannot determine version from context"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        shell: bash
        run: |
          mkdir -p release-assets
          find artifacts -name "workflow-*.tar.gz" -exec cp {} release-assets/ \;
          if [ -z "$(ls -A release-assets)" ]; then
            echo "Error: No release assets found!"
            exit 1
          fi
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          make_latest: true
          body: |
            ## Release ${{ steps.version.outputs.tag }}

            ### Downloads

            - **macOS Intel**: [workflow-${{ steps.version.outputs.version }}-macOS-Intel.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/workflow-${{ steps.version.outputs.version }}-macOS-Intel.tar.gz)
            - **macOS Apple Silicon**: [workflow-${{ steps.version.outputs.version }}-macOS-AppleSilicon.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/workflow-${{ steps.version.outputs.version }}-macOS-AppleSilicon.tar.gz)

            ### Installation

            ```bash
            # Download and extract (macOS)
            # For Intel Mac
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/workflow-${{ steps.version.outputs.version }}-macOS-Intel.tar.gz
            # For Apple Silicon Mac
            # curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/workflow-${{ steps.version.outputs.version }}-macOS-AppleSilicon.tar.gz
            tar xzf workflow-${{ steps.version.outputs.version }}-*.tar.gz
            sudo mv workflow pr qk /usr/local/bin/
            ```

            ### Homebrew

            Install via Homebrew:
            ```bash
            brew tap zevwings/workflow
            brew install workflow
            ```
          files: release-assets/*
          draft: false
          prerelease: false

  # è‡ªåŠ¨æ›´æ–° Homebrew Formula
  update-homebrew:
    name: Update Homebrew Formula
    needs: [create-tag, build, release]
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.create-tag.outputs.tag_created == 'true')
    permissions:
      contents: write  # å…è®¸æ¨é€åˆ° homebrew-workflow ä»“åº“

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version and detect install type
        id: version
        shell: bash
        run: |
          # æ£€æµ‹æ˜¯ tag è¿˜æ˜¯ branch
          # ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ä» create-tag job åˆ›å»ºçš„ tagï¼ˆåœ¨ master push æ—¶ï¼‰
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/master" ]]; then
            # åœ¨ master push æ—¶ï¼Œå¦‚æœ create-tag job åˆ›å»ºäº† tagï¼Œåº”è¯¥ä½¿ç”¨ tag
            if [ -n "${{ needs.create-tag.outputs.tag }}" ]; then
              INSTALL_TYPE="tag"
              VERSION_REF="${{ needs.create-tag.outputs.tag }}"
              VERSION="${VERSION_REF#v}"  # ç§»é™¤ v å‰ç¼€
              echo "âœ… Detected as TAG from create-tag job: $VERSION_REF"
            else
              # å¦‚æœæ²¡æœ‰åˆ›å»º tagï¼Œåˆ™ä½¿ç”¨ branch
              INSTALL_TYPE="branch"
              VERSION_REF="${GITHUB_REF#refs/heads/}"
              VERSION="0.0.0-dev"
              echo "âœ… Detected as BRANCH: $VERSION_REF"
              echo "â„¹ï¸  Using default version for branch: $VERSION"
            fi
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æ˜¯ tag push è§¦å‘çš„ workflow
            INSTALL_TYPE="tag"
            VERSION_REF="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION_REF#v}"  # ç§»é™¤ v å‰ç¼€
            echo "âœ… Detected as TAG: $VERSION_REF"
          elif [[ "${{ github.ref }}" == refs/heads/* ]]; then
            # æ˜¯ branch push è§¦å‘çš„ workflowï¼ˆé masterï¼Œæˆ– master ä½†æ²¡æœ‰åˆ›å»º tagï¼‰
            INSTALL_TYPE="branch"
            VERSION_REF="${GITHUB_REF#refs/heads/}"
            # å¯¹äº branchï¼Œç‰ˆæœ¬å·å¯ä»¥ä» workflow_dispatch input æˆ–ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              # å¯¹äº branchï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬å·ï¼ˆå› ä¸º branch åå¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œä¸é€‚åˆä½œä¸º versionï¼‰
              # å¯ä»¥å°† branch åè½¬æ¢ä¸ºæœ‰æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼ï¼Œæˆ–ä½¿ç”¨å›ºå®šçš„å¼€å‘ç‰ˆæœ¬å·
              # ä¾‹å¦‚ï¼šzw/update-completions -> 0.0.0-dev (æˆ–è€…ä½¿ç”¨æ—¥æœŸç­‰)
              VERSION="0.0.0-dev"
            fi
            echo "âœ… Detected as BRANCH: $VERSION_REF"
            echo "â„¹ï¸  Using default version for branch: $VERSION"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘ï¼Œé»˜è®¤ä½¿ç”¨ tag
            INSTALL_TYPE="tag"
            VERSION_REF="${{ github.event.inputs.version }}"
            VERSION="${VERSION_REF#v}"
            echo "âœ… Manual trigger, using as TAG: $VERSION_REF"
          else
            echo "âŒ Error: Cannot determine install type from ${{ github.ref }}"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "install_type=$INSTALL_TYPE" >> $GITHUB_OUTPUT
          echo "version_ref=$VERSION_REF" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo ""
          echo "Install Type: $INSTALL_TYPE"
          echo "Version Ref: $VERSION_REF"
          echo "Version: $VERSION"

      # æ³¨æ„ï¼šä½¿ç”¨ git tag æ–¹å¼æ—¶ï¼Œä¸éœ€è¦ SHA256 æ ¡éªŒ
      # å› ä¸º Homebrew ä¼šç›´æ¥ä» git ä»“åº“ checkout æŒ‡å®šçš„ tag

      - name: Check HOMEBREW_TAP_TOKEN
        id: check_token
        shell: bash
        run: |
          if [ -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]; then
            echo "âŒ Error: HOMEBREW_TAP_TOKEN secret is not configured"
            echo ""
            echo "Please configure HOMEBREW_TAP_TOKEN secret:"
            echo "1. Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: HOMEBREW_TAP_TOKEN"
            echo "4. Value: Your Personal Access Token (PAT) with 'repo' scope"
            echo ""
            echo "To create a PAT:"
            echo "1. Go to: https://github.com/settings/tokens"
            echo "2. Click 'Generate new token (classic)'"
            echo "3. Select 'repo' scope (full control of private repositories)"
            echo "4. Copy the token and add it as HOMEBREW_TAP_TOKEN secret"
            exit 1
          else
            echo "âœ… HOMEBREW_TAP_TOKEN is configured"
          fi

      - name: Checkout homebrew-workflow
        uses: actions/checkout@v4
        with:
          repository: zevwings/homebrew-workflow
          path: homebrew-workflow
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update Formula from template
        shell: bash
        run: |
          # æ¨¡æ¿æ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶è·¯å¾„
          TEMPLATE_FILE="homebrew/Formula.template"
          FORMULA_FILE="homebrew-workflow/Formula/workflow.rb"

          # æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "âŒ Error: Template file not found at $TEMPLATE_FILE"
            echo "Make sure homebrew/Formula.template exists in the source repository"
            exit 1
          fi

          # ç¡®ä¿ homebrew-workflow/Formula ç›®å½•å­˜åœ¨
          mkdir -p homebrew-workflow/Formula

          # å¤‡ä»½ç°æœ‰çš„ Formula æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "$FORMULA_FILE" ]; then
            cp "$FORMULA_FILE" "$FORMULA_FILE.bak"
            echo "ğŸ“¦ Backed up existing Formula file"
          fi

          # ä»æ¨¡æ¿ç”Ÿæˆ URL è¡Œ
          INSTALL_TYPE="${{ steps.version.outputs.install_type }}"
          VERSION_REF="${{ steps.version.outputs.version_ref }}"

          if [[ "$INSTALL_TYPE" == "tag" ]]; then
            URL_LINE="url \"https://github.com/zevwings/workflow.rs.git\", tag: \"$VERSION_REF\""
          elif [[ "$INSTALL_TYPE" == "branch" ]]; then
            URL_LINE="url \"https://github.com/zevwings/workflow.rs.git\", branch: \"$VERSION_REF\""
          else
            echo "âŒ Error: Invalid install type: $INSTALL_TYPE"
            exit 1
          fi

          echo "ğŸ”§ Generated URL line: $URL_LINE"

          # ä»æ¨¡æ¿ç”Ÿæˆ Formula æ–‡ä»¶
          echo "ğŸ“ Generating Formula file from template..."
          sed -e "s|{{VERSION}}|${{ steps.version.outputs.version }}|g" \
              -e "s|{{INSTALL_TYPE}}|$INSTALL_TYPE|g" \
              -e "s|{{VERSION_REF}}|$VERSION_REF|g" \
              -e "s|{{URL_LINE}}|$URL_LINE|g" \
              "$TEMPLATE_FILE" > "$FORMULA_FILE"

          echo "âœ… Formula file generated from template"

          cd homebrew-workflow

          # æ›´æ–°ä¸ºç›¸å¯¹äº homebrew-workflow ç›®å½•çš„è·¯å¾„
          FORMULA_FILE="Formula/workflow.rb"

          # éªŒè¯æ–‡ä»¶ç»“æ„ï¼ˆç¡®ä¿æ²¡æœ‰è¯­æ³•é”™è¯¯ï¼‰
          echo "ğŸ” Validating Formula file structure..."
          if ! ruby -c "$FORMULA_FILE" 2>/dev/null; then
            echo "âŒ Error: Formula file has syntax errors"
            ruby -c "$FORMULA_FILE" || true
            exit 1
          fi
          echo "âœ… Formula file syntax is valid"

          # æ˜¾ç¤ºç”Ÿæˆçš„ Formula æ–‡ä»¶
          echo ""
          echo "ğŸ“„ Generated Formula file:"
          echo "--- Formula/workflow.rb ---"
          cat "$FORMULA_FILE"
          echo ""

          # æ˜¾ç¤ºæ›´æ”¹ï¼ˆå¦‚æœæœ‰å¤‡ä»½ï¼‰
          if [ -f "$FORMULA_FILE.bak" ]; then
            echo "--- Diff (Before vs After) ---"
            diff "$FORMULA_FILE.bak" "$FORMULA_FILE" || true
          fi

      - name: Commit and push changes
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          cd homebrew-workflow

          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          git add Formula/workflow.rb

          if git diff --staged --quiet; then
            echo "No changes to commit. Formula file is already up to date."
            exit 0
          fi

          # éªŒè¯ Formula æ–‡ä»¶æ ¼å¼
          if ! brew audit --strict Formula/workflow.rb 2>/dev/null; then
            echo "Warning: brew audit failed, but continuing..."
          fi

          # æäº¤æ›´æ”¹
          git commit -m "Update workflow to ${{ steps.version.outputs.tag }}"

          # æ£€æµ‹å½“å‰åˆ†æ”¯åç§°
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"

          # actions/checkout@v4 å·²ç»è®¾ç½®äº†æ­£ç¡®çš„è¿œç¨‹ URLï¼Œç›´æ¥æ¨é€å³å¯
          # æ¨é€æ›´æ”¹åˆ°å½“å‰åˆ†æ”¯
          echo "Pushing to branch: $CURRENT_BRANCH"
          if git push origin "$CURRENT_BRANCH"; then
            echo "âœ… Successfully pushed to $CURRENT_BRANCH branch"
          else
            echo "âŒ Error: Failed to push changes to $CURRENT_BRANCH"
            echo "Remote URL: $(git remote get-url origin | sed 's|://.*@|://***@|')"
            echo "Branch: $CURRENT_BRANCH"
            echo "Git status:"
            git status
            echo "Git log:"
            git log --oneline -5
            echo ""
            echo "Possible issues:"
            echo "1. HOMEBREW_TAP_TOKEN may not have write access to zevwings/homebrew-workflow"
            echo "2. Token may have expired or been revoked"
            echo "3. Repository may not exist or be accessible"
            exit 1
          fi

          echo "âœ… Homebrew Formula updated successfully!"



