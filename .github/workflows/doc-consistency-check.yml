name: Document Consistency Check

on:
  schedule:
    # æ¯å‘¨æ—¥ 00:00 UTC è¿è¡Œ
    - cron: '0 0 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  issues: write  # å¦‚æœéœ€è¦åˆ›å»º Issue

jobs:
  check-architecture-docs:
    name: ğŸ“š Architecture Document Consistency Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ” Run basic document checks
        id: check
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Running basic document checks..."

          HAS_ISSUES=false

          # æ£€æŸ¥æ–‡æ¡£é“¾æ¥
          echo "ğŸ”— Checking document links..."
          BROKEN_LINKS=0
          if command -v lychee >/dev/null 2>&1; then
            echo "Using lychee to check document links..."
            if ! lychee docs/**/*.md --exclude-all-private --exclude-loopback; then
              echo "âš ï¸ Some document links may be broken"
              BROKEN_LINKS=1
              HAS_ISSUES=true
            fi
          else
            echo "â„¹ï¸  lychee not installed, skipping link check"
            echo "   To install: cargo install lychee"
          fi

          # æ£€æŸ¥æ¶æ„æ–‡æ¡£æ˜¯å¦å­˜åœ¨
          echo ""
          echo "ğŸ“ Checking architecture documents..."
          MISSING_DOCS=0

          # æ£€æŸ¥æ‰€æœ‰ lib å±‚æ¨¡å—
          for module_dir in src/lib/*/; do
            if [ -d "$module_dir" ]; then
              module=$(basename "$module_dir")
              doc_path="docs/architecture/${module}.md"
              if [ ! -f "$doc_path" ]; then
                echo "âš ï¸  Missing architecture doc: $doc_path (for module: $module)"
                MISSING_DOCS=$((MISSING_DOCS + 1))
              fi
            fi
          done

          # æ£€æŸ¥æ‰€æœ‰ commands å±‚æ¨¡å—
          for module_dir in src/commands/*/; do
            if [ -d "$module_dir" ]; then
              module=$(basename "$module_dir")
              doc_path="docs/architecture/${module}.md"
              if [ ! -f "$doc_path" ]; then
                echo "âš ï¸  Missing architecture doc: $doc_path (for module: $module)"
                MISSING_DOCS=$((MISSING_DOCS + 1))
              fi
            fi
          done

          if [ $MISSING_DOCS -gt 0 ]; then
            echo ""
            echo "ğŸ“‹ Found $MISSING_DOCS missing architecture document(s)"
            echo "::warning::Found $MISSING_DOCS missing architecture document(s)"
            HAS_ISSUES=true
          else
            echo "âœ… All modules have architecture documentation"
          fi

          # æ£€æŸ¥æ–‡æ¡£æ—¶é—´æˆ³æ ¼å¼
          echo ""
          echo "ğŸ“… Checking document timestamp format..."
          INVALID_TIMESTAMPS=0
          while IFS= read -r file; do
            if ! tail -5 "$file" | grep -qE '\*\*æœ€åæ›´æ–°\*\*: [0-9]{4}-[0-9]{2}-[0-9]{2}'; then
              echo "âš ï¸  Invalid timestamp format: $file"
              INVALID_TIMESTAMPS=$((INVALID_TIMESTAMPS + 1))
            fi
          done < <(find docs -name "*.md" -type f ! -path "*/templates/*" ! -name "README.md")

          if [ $INVALID_TIMESTAMPS -gt 0 ]; then
            echo "ğŸ“‹ Found $INVALID_TIMESTAMPS document(s) with invalid timestamp format"
            echo "::warning::Found $INVALID_TIMESTAMPS document(s) with invalid timestamp format"
            HAS_ISSUES=true
          else
            echo "âœ… All documents have valid timestamp format"
          fi

          # è¾“å‡ºæ˜¯å¦æœ‰é—®é¢˜çš„æ ‡å¿—
          if [ "$HAS_ISSUES" = true ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ Found issues that need to be addressed"
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… All checks passed"
          fi

      - name: ğŸ“Š Generate report
        if: always()
        run: |
          mkdir -p report
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          REPORT_FILE="report/doc-consistency-check-${TIMESTAMP}.md"
          CHECK_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          UPDATE_DATE=$(date '+%Y-%m-%d')

          cat > "$REPORT_FILE" << EOF
          # æ¶æ„æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š

          **æ£€æŸ¥æ—¥æœŸ**ï¼š${CHECK_DATE}
          **æ£€æŸ¥ç±»å‹**ï¼šå®šæœŸå®¡æŸ¥

          ## æ£€æŸ¥ç»“æœ

          ### æ–‡æ¡£é“¾æ¥æ£€æŸ¥

          å·²å®Œæˆæ–‡æ¡£é“¾æ¥æœ‰æ•ˆæ€§æ£€æŸ¥ã€‚

          ### æ¶æ„æ–‡æ¡£å­˜åœ¨æ€§æ£€æŸ¥

          å·²å®Œæˆæ¶æ„æ–‡æ¡£å­˜åœ¨æ€§æ£€æŸ¥ã€‚

          ### æ–‡æ¡£æ—¶é—´æˆ³æ ¼å¼æ£€æŸ¥

          å·²å®Œæˆæ–‡æ¡£æ—¶é—´æˆ³æ ¼å¼æ£€æŸ¥ã€‚

          ## é—®é¢˜æ±‡æ€»

          è¯·æŸ¥çœ‹ä¸Šæ–¹çš„æ£€æŸ¥è¾“å‡ºä»¥äº†è§£è¯¦ç»†é—®é¢˜ã€‚

          ## æ”¹è¿›å»ºè®®

          1. ç¡®ä¿æ‰€æœ‰æ¨¡å—éƒ½æœ‰å¯¹åº”çš„æ¶æ„æ–‡æ¡£
          2. ç¡®ä¿æ‰€æœ‰æ–‡æ¡£éƒ½æœ‰æ­£ç¡®çš„æ—¶é—´æˆ³æ ¼å¼
          3. ç¡®ä¿æ‰€æœ‰æ–‡æ¡£é“¾æ¥éƒ½æœ‰æ•ˆ

          å‚è€ƒæ–‡æ¡£ï¼š
          - [æ¶æ„æ–‡æ¡£å®¡æŸ¥æŒ‡å—](docs/guidelines/development/references/review-architecture-consistency.md)
          - [æ–‡æ¡£æ›´æ–°æ£€æŸ¥æ¸…å•](docs/guidelines/development/code-review.md)

          ---

          **æœ€åæ›´æ–°**: ${UPDATE_DATE}
          EOF

          echo "ğŸ“„ Report generated: $REPORT_FILE"
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      # åˆ›å»º Issue æ±‡æ€»é—®é¢˜ï¼ˆä»…åœ¨å‘ç°é—®é¢˜æ—¶ï¼‰
      - name: ğŸ“ Create issue if problems found
        if: steps.check.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().split('T')[0];
            const checkDate = new Date().toISOString();

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'document-check'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('[Document Check]') &&
              issue.title.includes(timestamp)
            );

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Document Check] Architecture document consistency issues found - ${timestamp}`,
              body: `## æ¶æ„æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥å‘ç°é—®é¢˜

              å®šæœŸæ£€æŸ¥å‘ç°æ¶æ„æ–‡æ¡£ä¸ä»£ç ä¸€è‡´æ€§é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ£€æŸ¥æŠ¥å‘Šã€‚

              **æ£€æŸ¥æ—¥æœŸ**ï¼š${checkDate}
              **æŠ¥å‘Šä½ç½®**ï¼š\`report/doc-consistency-check-*.md\`

              è¯·å‚è€ƒä»¥ä¸‹æ–‡æ¡£è¿›è¡Œä¿®å¤ï¼š
              - [æ¶æ„æ–‡æ¡£å®¡æŸ¥æŒ‡å—](docs/guidelines/development/references/review-architecture-consistency.md)
              - [æ–‡æ¡£æ›´æ–°æ£€æŸ¥æ¸…å•](docs/guidelines/development/code-review.md)

              ---

              **æ³¨æ„**ï¼šæ­¤ Issue ç”±è‡ªåŠ¨åŒ–æ£€æŸ¥åˆ›å»ºï¼Œè¯·åŠæ—¶å¤„ç†ã€‚
              `,
              labels: ['document-check', 'documentation']
            });

