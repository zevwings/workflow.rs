name: Performance Check

on:
  schedule:
    # æ¯å‘¨å…­ 00:00 UTC è¿è¡Œ
    - cron: '0 0 * * 6'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šæƒ…å†µï¼‰
  workflow_dispatch:

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  contents: read
  pages: write  # éœ€è¦å†™å…¥æƒé™ä»¥éƒ¨ç½²åˆ° GitHub Pages
  id-token: write  # éœ€è¦ OIDC æƒé™ä»¥éƒ¨ç½²åˆ° GitHub Pages

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # æ€§èƒ½åŸºå‡†ä½œä¸š
  # ============================================
  performance:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: bash scripts/dev/shell/dependencies/install-basic.sh

      - name: âš¡ Run performance benchmarks
        timeout-minutes: 40
        run: |
          cargo bench --bench cli_performance \
            --bench core_operations \
            --bench network_operations
        continue-on-error: true

      - name: ğŸ“¤ Upload performance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: target/criterion/
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ“‹ Performance summary
        if: always()
        run: |
          if [ -d "target/criterion" ]; then \
            echo "âš¡ Performance benchmarks completed"; \
            echo "Reports available in target/criterion/"; \
          else \
            echo "âš ï¸  Performance benchmarks did not generate reports"; \
          fi

      - name: ğŸ“¤ Upload performance reports to Pages
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: target/criterion/

  # ============================================
  # GitHub Pages éƒ¨ç½²ä½œä¸š
  # ============================================
  deploy-pages:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: performance
    if: always()
    permissions:
      pages: write
      id-token: write
    steps:
      - name: âš™ï¸ Configure Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¥ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

