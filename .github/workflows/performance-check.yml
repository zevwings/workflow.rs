name: Performance Check

on:
  schedule:
    # æ¯å‘¨å…­ 00:00 UTC è¿è¡Œ
    - cron: '0 0 * * 6'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šæƒ…å†µï¼‰
  workflow_dispatch:

# é…ç½®å·¥ä½œæµæƒé™
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # æ€§èƒ½åŸºå‡†ä½œä¸š
  # ============================================
  performance:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          enableCrossOsArchive: false

      - name: ğŸ“¦ Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            xcb-proto \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-util-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xinerama0-dev \
            libxcb-randr0-dev \
            libxcb-xinput-dev \
            libxcb-dri3-dev \
            libxcb-present-dev \
            libxcb-xv0-dev \
            libxcb-glx0-dev \
            libxcb-shm0-dev \
            libxcb-composite0-dev \
            libxcb-damage0-dev \
            libxcb-record0-dev \
            libxcb-screensaver0-dev \
            libxcb-res0-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev

      - name: âš¡ Run performance benchmarks
        run: |
          cargo bench --bench cli_performance \
            --bench core_operations \
            --bench network_operations
        continue-on-error: true

      - name: ğŸ“¤ Upload performance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: target/criterion/
          retention-days: 7
          if-no-files-found: ignore

      - name: ğŸ“‹ Performance summary
        if: always()
        run: |
          if [ -d "target/criterion" ]; then \
            echo "âš¡ Performance benchmarks completed"; \
            echo "Reports available in target/criterion/"; \
          else \
            echo "âš ï¸  Performance benchmarks did not generate reports"; \
          fi

