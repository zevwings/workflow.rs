name: Document Link Check

on:
  schedule:
    # æ¯å‘¨ä¸€è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  link-check:
    name: ğŸ”— Weekly Document Link Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Install lychee
        run: cargo install lychee

      - name: ğŸ” Check internal document links
        run: |
          chmod +x scripts/dev/check-links.sh
          ./scripts/dev/check-links.sh

      - name: ğŸ” Check external document links
        run: |
          echo "Checking external document links..."
          lychee docs/**/*.md --exclude-all-private --exclude-loopback || {
            echo "âš ï¸ Some external document links may be broken"
            exit 1
          }

      - name: ğŸ“‹ Create issue if broken links found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Broken document links detected',
              body: 'Weekly document link check found broken links. Please check the workflow run for details: ' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId
            })

      - name: ğŸ“‹ Link check summary
        if: always()
        run: |
          echo "ğŸ”— Weekly document link check completed"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All document links are valid"
          else
            echo "âš ï¸ Some document links may be broken. Please check the output above."
          fi

