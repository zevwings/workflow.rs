//! Template å¼•æ“æµ‹è¯•
//!
//! æµ‹è¯• Template å¼•æ“çš„æ¨¡æ¿æ³¨å†Œã€æ¸²æŸ“å’Œå˜é‡å¤„ç†åŠŸèƒ½ã€‚

use pretty_assertions::assert_eq;
use rstest::{fixture, rstest};
use serde_json::json;
// use std::collections::HashMap;
use workflow::template::{TemplateEngine, TemplateEngineType};

// ==================== Fixtures ====================

/// åˆ›å»ºåŸºç¡€æ¨¡æ¿å¼•æ“
#[fixture]
fn template_engine() -> TemplateEngine {
    TemplateEngine::new()
}

/// åˆ›å»ºå¸¦æœ‰é¢„æ³¨å†Œæ¨¡æ¿çš„å¼•æ“
#[fixture]
fn engine_with_templates() -> TemplateEngine {
    let mut engine = TemplateEngine::new();

    // æ³¨å†Œä¸€äº›æµ‹è¯•æ¨¡æ¿
    engine.register_template("simple", "Hello {{name}}!").unwrap();
    engine.register_template("branch", "{{prefix}}/{{ticket}}-{{slug}}").unwrap();
    engine.register_template("pr_title", "{{type}}: {{summary}}").unwrap();

    engine
}

// ==================== æ¨¡æ¿å¼•æ“åˆ›å»ºæµ‹è¯• ====================

#[test]
fn test_template_engine_new() {
    let engine = TemplateEngine::new();

    // éªŒè¯å¼•æ“åˆ›å»ºæˆåŠŸï¼ˆé€šè¿‡ç¼–è¯‘éªŒè¯ï¼‰
    // ç”±äº TemplateEngine çš„å†…éƒ¨å­—æ®µæ˜¯ç§æœ‰çš„ï¼Œæˆ‘ä»¬ä¸»è¦é€šè¿‡åŠŸèƒ½æµ‹è¯•éªŒè¯
}

#[test]
fn test_template_engine_type_enum() {
    // æµ‹è¯•æ¨¡æ¿å¼•æ“ç±»å‹æšä¸¾
    let engine_type = TemplateEngineType::Handlebars;

    // éªŒè¯æšä¸¾å¯ä»¥æ­£å¸¸ä½¿ç”¨
    let debug_str = format!("{:?}", engine_type);
    assert!(!debug_str.is_empty());
}

// ==================== æ¨¡æ¿æ³¨å†Œæµ‹è¯• ====================

#[rstest]
fn test_register_simple_template(mut template_engine: TemplateEngine) {
    let result = template_engine.register_template("test", "Hello {{name}}!");
    assert!(result.is_ok(), "Failed to register template: {:?}", result);
}

#[rstest]
fn test_register_complex_template(mut template_engine: TemplateEngine) {
    let complex_template = r#"
{{#if jira_key}}
{{prefix}}/{{jira_key}}-{{summary_slug}}
{{else}}
{{prefix}}/{{summary_slug}}
{{/if}}
"#
    .trim();

    let result = template_engine.register_template("complex", complex_template);
    assert!(
        result.is_ok(),
        "Failed to register complex template: {:?}",
        result
    );
}

#[rstest]
fn test_register_invalid_template(mut template_engine: TemplateEngine) {
    // æµ‹è¯•æ— æ•ˆçš„æ¨¡æ¿è¯­æ³•
    let invalid_template = "{{#if unclosed";

    let result = template_engine.register_template("invalid", invalid_template);
    assert!(result.is_err(), "Invalid template should fail to register");
}

#[rstest]
fn test_register_duplicate_template(mut template_engine: TemplateEngine) {
    // æ³¨å†Œç¬¬ä¸€ä¸ªæ¨¡æ¿
    template_engine.register_template("duplicate", "First template").unwrap();

    // æ³¨å†ŒåŒåæ¨¡æ¿åº”è¯¥è¦†ç›–
    let result = template_engine.register_template("duplicate", "Second template");
    assert!(
        result.is_ok(),
        "Duplicate template registration should succeed"
    );
}

#[rstest]
fn test_register_empty_template(mut template_engine: TemplateEngine) {
    let result = template_engine.register_template("empty", "");
    assert!(result.is_ok(), "Empty template should be valid");
}

// ==================== æ¨¡æ¿æ¸²æŸ“æµ‹è¯• ====================

#[rstest]
fn test_render_simple_template(engine_with_templates: TemplateEngine) {
    let data = json!({"name": "World"});

    let result = engine_with_templates.render("simple", &data);
    assert!(result.is_ok(), "Failed to render template: {:?}", result);

    let rendered = result.unwrap();
    assert_eq!(rendered, "Hello World!");
}

#[rstest]
fn test_render_branch_template(engine_with_templates: TemplateEngine) {
    let data = json!({
        "prefix": "feature",
        "ticket": "PROJ-123",
        "slug": "user-authentication"
    });

    let result = engine_with_templates.render("branch", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    assert_eq!(rendered, "feature/PROJ-123-user-authentication");
}

#[rstest]
fn test_render_with_missing_variable(engine_with_templates: TemplateEngine) {
    let data = json!({"name": "World"}); // ç¼ºå°‘å…¶ä»–å˜é‡

    let result = engine_with_templates.render("branch", &data);
    assert!(result.is_ok()); // Handlebars åœ¨ non-strict æ¨¡å¼ä¸‹åº”è¯¥æˆåŠŸ

    let rendered = result.unwrap();
    // ç¼ºå°‘çš„å˜é‡åº”è¯¥è¢«æ¸²æŸ“ä¸ºç©ºå­—ç¬¦ä¸²
    assert_eq!(rendered, "/-");
}

#[rstest]
fn test_render_nonexistent_template(engine_with_templates: TemplateEngine) {
    let data = json!({"name": "World"});

    let result = engine_with_templates.render("nonexistent", &data);
    assert!(
        result.is_err(),
        "Rendering nonexistent template should fail"
    );
}

#[rstest]
fn test_render_with_empty_data(engine_with_templates: TemplateEngine) {
    let data = json!({});

    let result = engine_with_templates.render("simple", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    assert_eq!(rendered, "Hello !"); // ç¼ºå°‘ name å˜é‡
}

// ==================== å¤æ‚æ¨¡æ¿æµ‹è¯• ====================

#[rstest]
fn test_conditional_template(mut template_engine: TemplateEngine) {
    let template = r#"
{{#if has_jira}}
JIRA: {{jira_id}} - {{title}}
{{else}}
Feature: {{title}}
{{/if}}
"#
    .trim();

    template_engine.register_template("conditional", template).unwrap();

    // æµ‹è¯•æœ‰ JIRA çš„æƒ…å†µ
    let data_with_jira = json!({
        "has_jira": true,
        "jira_id": "PROJ-123",
        "title": "User Authentication"
    });

    let result = template_engine.render("conditional", &data_with_jira);
    assert!(result.is_ok());
    assert_eq!(result.unwrap(), "JIRA: PROJ-123 - User Authentication");

    // æµ‹è¯•æ²¡æœ‰ JIRA çš„æƒ…å†µ
    let data_without_jira = json!({
        "has_jira": false,
        "title": "User Authentication"
    });

    let result = template_engine.render("conditional", &data_without_jira);
    assert!(result.is_ok());
    assert_eq!(result.unwrap(), "Feature: User Authentication");
}

#[rstest]
fn test_loop_template(mut template_engine: TemplateEngine) {
    let template = r#"
Files:
{{#each files}}
- {{this}}
{{/each}}
"#
    .trim();

    template_engine.register_template("loop", template).unwrap();

    let data = json!({
        "files": ["src/main.rs", "src/lib.rs", "tests/mod.rs"]
    });

    let result = template_engine.render("loop", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    let expected = "Files:\n- src/main.rs\n- src/lib.rs\n- tests/mod.rs";
    assert_eq!(rendered, expected);
}

#[rstest]
fn test_nested_object_template(mut template_engine: TemplateEngine) {
    let template = "{{user.name}} ({{user.email}}) - {{project.name}}";

    template_engine.register_template("nested", template).unwrap();

    let data = json!({
        "user": {
            "name": "John Doe",
            "email": "john@example.com"
        },
        "project": {
            "name": "Workflow CLI"
        }
    });

    let result = template_engine.render("nested", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    assert_eq!(rendered, "John Doe (john@example.com) - Workflow CLI");
}

// ==================== ç‰¹æ®Šå­—ç¬¦å’Œè½¬ä¹‰æµ‹è¯• ====================

#[rstest]
fn test_html_no_escape(mut template_engine: TemplateEngine) {
    let template = "Content: {{html_content}}";

    template_engine.register_template("html", template).unwrap();

    let data = json!({
        "html_content": "<div>Hello & Goodbye</div>"
    });

    let result = template_engine.render("html", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    // ç”±äºè®¾ç½®äº† no_escapeï¼ŒHTML åº”è¯¥ä¸è¢«è½¬ä¹‰
    assert_eq!(rendered, "Content: <div>Hello & Goodbye</div>");
}

#[rstest]
fn test_special_characters(mut template_engine: TemplateEngine) {
    let template = "{{message}}";

    template_engine.register_template("special", template).unwrap();

    let data = json!({
        "message": "Hello ä¸–ç•Œ! ğŸŒ Ã‰mojis & Ã‘oÃ±Ã³"
    });

    let result = template_engine.render("special", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    assert_eq!(rendered, "Hello ä¸–ç•Œ! ğŸŒ Ã‰mojis & Ã‘oÃ±Ã³");
}

#[rstest]
fn test_multiline_template(mut template_engine: TemplateEngine) {
    let template = r#"
Title: {{title}}
Description:
{{description}}

Author: {{author}}
"#
    .trim();

    template_engine.register_template("multiline", template).unwrap();

    let data = json!({
        "title": "Test PR",
        "description": "This is a test\nwith multiple lines",
        "author": "John Doe"
    });

    let result = template_engine.render("multiline", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    let expected =
        "Title: Test PR\nDescription:\nThis is a test\nwith multiple lines\n\nAuthor: John Doe";
    assert_eq!(rendered, expected);
}

// ==================== è¾¹ç•Œæ¡ä»¶æµ‹è¯• ====================

#[rstest]
fn test_very_long_template(mut template_engine: TemplateEngine) {
    // åˆ›å»ºå¾ˆé•¿çš„æ¨¡æ¿
    let long_template = "Hello ".repeat(1000) + "{{name}}!";

    let result = template_engine.register_template("long", &long_template);
    assert!(result.is_ok(), "Long template should be registerable");

    let data = json!({"name": "World"});
    let render_result = template_engine.render("long", &data);
    assert!(render_result.is_ok(), "Long template should be renderable");
}

#[rstest]
fn test_many_variables_template(mut template_engine: TemplateEngine) {
    // åˆ›å»ºåŒ…å«å¾ˆå¤šå˜é‡çš„æ¨¡æ¿
    let mut template_parts = Vec::new();
    let mut data_map = serde_json::Map::new();

    for i in 0..50 {
        template_parts.push(format!("{{{{var{}}}}}", i));
        data_map.insert(format!("var{}", i), json!(format!("value{}", i)));
    }

    let template = template_parts.join(" ");
    template_engine.register_template("many_vars", &template).unwrap();

    let data = json!(data_map);
    let result = template_engine.render("many_vars", &data);
    assert!(result.is_ok(), "Template with many variables should render");
}

#[rstest]
fn test_empty_variable_values(mut template_engine: TemplateEngine) {
    let template = "Start-{{empty}}-{{null}}-{{zero}}-End";

    template_engine.register_template("empty_vars", template).unwrap();

    let data = json!({
        "empty": "",
        "null": null,
        "zero": 0
    });

    let result = template_engine.render("empty_vars", &data);
    assert!(result.is_ok());

    let rendered = result.unwrap();
    assert_eq!(rendered, "Start---0-End");
}

// ==================== é”™è¯¯å¤„ç†æµ‹è¯• ====================

#[rstest]
fn test_invalid_json_data(engine_with_templates: TemplateEngine) {
    // æµ‹è¯•æ— æ•ˆçš„æ•°æ®ç±»å‹
    let invalid_data = "not json";

    // æ³¨æ„ï¼šè¿™ä¸ªæµ‹è¯•å–å†³äº render æ–¹æ³•çš„å®ç°
    // å¦‚æœ render æ–¹æ³•æ¥å— &impl Serializeï¼Œè¿™ä¸ªæµ‹è¯•å¯èƒ½éœ€è¦è°ƒæ•´
}

#[rstest]
fn test_circular_reference_template(mut template_engine: TemplateEngine) {
    // æµ‹è¯•å¯èƒ½å¯¼è‡´å¾ªç¯å¼•ç”¨çš„æ¨¡æ¿
    let template = "{{#with self}}{{name}}{{/with}}";

    template_engine.register_template("circular", template).unwrap();

    let data = json!({
        "name": "Test",
        "self": {"name": "Nested"}
    });

    let result = template_engine.render("circular", &data);
    assert!(result.is_ok()); // Handlebars åº”è¯¥èƒ½å¤„ç†è¿™ç§æƒ…å†µ
}

// ==================== æ€§èƒ½æµ‹è¯• ====================

#[rstest]
fn test_template_registration_performance(mut template_engine: TemplateEngine) {
    use std::time::Instant;

    let start = Instant::now();

    // æ³¨å†Œå¤šä¸ªæ¨¡æ¿
    for i in 0..100 {
        let template_name = format!("template_{}", i);
        let template_content = format!("Hello {{{{name{}}}}}!", i);

        template_engine.register_template(&template_name, &template_content).unwrap();
    }

    let duration = start.elapsed();

    // æ¨¡æ¿æ³¨å†Œåº”è¯¥ç›¸å¯¹å¿«é€Ÿ
    assert!(
        duration.as_millis() < 1000,
        "Template registration too slow: {:?}",
        duration
    );
}

#[rstest]
fn test_template_rendering_performance(engine_with_templates: TemplateEngine) {
    use std::time::Instant;

    let data = json!({"name": "World"});

    let start = Instant::now();

    // æ¸²æŸ“æ¨¡æ¿å¤šæ¬¡
    for _ in 0..1000 {
        let _ = engine_with_templates.render("simple", &data);
    }

    let duration = start.elapsed();

    // æ¨¡æ¿æ¸²æŸ“åº”è¯¥å¾ˆå¿«
    assert!(
        duration.as_millis() < 1000,
        "Template rendering too slow: {:?}",
        duration
    );
}

// ==================== é›†æˆæµ‹è¯• ====================

#[rstest]
fn test_complete_template_workflow(mut template_engine: TemplateEngine) {
    // 1. æ³¨å†Œåˆ†æ”¯æ¨¡æ¿
    let branch_template = "{{prefix}}/{{#if jira_key}}{{jira_key}}-{{/if}}{{summary_slug}}";
    template_engine.register_template("branch", branch_template).unwrap();

    // 2. æ³¨å†Œ PR æ ‡é¢˜æ¨¡æ¿
    let pr_template = "{{type}}{{#if scope}}({{scope}}){{/if}}: {{subject}}";
    template_engine.register_template("pr_title", pr_template).unwrap();

    // 3. æ¸²æŸ“åˆ†æ”¯å
    let branch_data = json!({
        "prefix": "feature",
        "jira_key": "PROJ-123",
        "summary_slug": "user-authentication"
    });

    let branch_result = template_engine.render("branch", &branch_data);
    assert!(branch_result.is_ok());
    assert_eq!(
        branch_result.unwrap(),
        "feature/PROJ-123-user-authentication"
    );

    // 4. æ¸²æŸ“ PR æ ‡é¢˜
    let pr_data = json!({
        "type": "feat",
        "scope": "auth",
        "subject": "add user authentication system"
    });

    let pr_result = template_engine.render("pr_title", &pr_data);
    assert!(pr_result.is_ok());
    assert_eq!(
        pr_result.unwrap(),
        "feat(auth): add user authentication system"
    );

    // 5. æ¸²æŸ“æ²¡æœ‰ scope çš„ PR æ ‡é¢˜
    let pr_data_no_scope = json!({
        "type": "fix",
        "subject": "resolve login issue"
    });

    let pr_result_no_scope = template_engine.render("pr_title", &pr_data_no_scope);
    assert!(pr_result_no_scope.is_ok());
    assert_eq!(pr_result_no_scope.unwrap(), "fix: resolve login issue");
}
