//! Template é…ç½®æµ‹è¯•
//!
//! æµ‹è¯•æ¨¡æ¿é…ç½®çš„åŠ è½½ã€éªŒè¯å’Œç®¡ç†åŠŸèƒ½ã€‚

use pretty_assertions::assert_eq;
use rstest::{fixture, rstest};
use std::fs;
use tempfile::TempDir;
use workflow::template::TemplateConfig;

// ==================== Fixtures ====================

/// åˆ›å»ºä¸´æ—¶é…ç½®ç›®å½•
#[fixture]
fn temp_config_dir() -> TempDir {
    let temp_dir = tempfile::tempdir().expect("Failed to create temp dir");

    // åˆ›å»ºæ¨¡æ¿ç›®å½•ç»“æ„
    let templates_dir = temp_dir.path().join("templates");
    fs::create_dir_all(&templates_dir).expect("Failed to create templates dir");

    // åˆ›å»ºåˆ†æ”¯æ¨¡æ¿ç›®å½•
    let branch_dir = templates_dir.join("branch");
    fs::create_dir_all(&branch_dir).expect("Failed to create branch dir");

    temp_dir
}

/// åˆ›å»ºå¸¦æœ‰ç¤ºä¾‹æ¨¡æ¿çš„é…ç½®ç›®å½•
#[fixture]
fn config_dir_with_templates() -> TempDir {
    let temp_dir = temp_config_dir();
    let templates_dir = temp_dir.path().join("templates").join("branch");

    // åˆ›å»ºé»˜è®¤åˆ†æ”¯æ¨¡æ¿
    fs::write(
        templates_dir.join("default.hbs"),
        "{{prefix}}/{{#if jira_key}}{{jira_key}}-{{/if}}{{summary_slug}}",
    )
    .expect("Failed to write default template");

    // åˆ›å»º Feature ç±»å‹æ¨¡æ¿
    fs::write(
        templates_dir.join("feature.hbs"),
        "feature/{{jira_key}}-{{summary_slug}}",
    )
    .expect("Failed to write feature template");

    // åˆ›å»º Bug ç±»å‹æ¨¡æ¿
    fs::write(
        templates_dir.join("bug.hbs"),
        "hotfix/{{jira_key}}-{{summary_slug}}",
    )
    .expect("Failed to write bug template");

    temp_dir
}

// ==================== æ¨¡æ¿è·¯å¾„æµ‹è¯• ====================

#[test]
fn test_get_templates_dir() {
    let result = TemplateConfig::get_templates_dir();

    // åº”è¯¥èƒ½è·å–åˆ°æ¨¡æ¿ç›®å½•è·¯å¾„
    assert!(result.is_ok(), "Failed to get templates dir: {:?}", result);

    let templates_dir = result.unwrap();
    assert!(templates_dir.to_string_lossy().contains("templates"));
}

#[test]
fn test_get_branch_templates_dir() {
    let result = TemplateConfig::get_branch_templates_dir();

    assert!(
        result.is_ok(),
        "Failed to get branch templates dir: {:?}",
        result
    );

    let branch_dir = result.unwrap();
    assert!(branch_dir.to_string_lossy().contains("branch"));
}

// ==================== æ¨¡æ¿åŠ è½½æµ‹è¯• ====================

#[rstest]
fn test_load_default_branch_template(config_dir_with_templates: TempDir) {
    // ä¸´æ—¶è®¾ç½®é…ç½®ç›®å½•
    std::env::set_var("WORKFLOW_CONFIG_DIR", config_dir_with_templates.path());

    let result = TemplateConfig::load_branch_template(None);
    assert!(
        result.is_ok(),
        "Failed to load default template: {:?}",
        result
    );

    let template = result.unwrap();
    assert_eq!(
        template,
        "{{prefix}}/{{#if jira_key}}{{jira_key}}-{{/if}}{{summary_slug}}"
    );

    // æ¸…ç†ç¯å¢ƒå˜é‡
    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

#[rstest]
fn test_load_feature_branch_template(config_dir_with_templates: TempDir) {
    std::env::set_var("WORKFLOW_CONFIG_DIR", config_dir_with_templates.path());

    let result = TemplateConfig::load_branch_template(Some("Feature"));
    assert!(
        result.is_ok(),
        "Failed to load feature template: {:?}",
        result
    );

    let template = result.unwrap();
    assert_eq!(template, "feature/{{jira_key}}-{{summary_slug}}");

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

#[rstest]
fn test_load_bug_branch_template(config_dir_with_templates: TempDir) {
    std::env::set_var("WORKFLOW_CONFIG_DIR", config_dir_with_templates.path());

    let result = TemplateConfig::load_branch_template(Some("Bug"));
    assert!(result.is_ok(), "Failed to load bug template: {:?}", result);

    let template = result.unwrap();
    assert_eq!(template, "hotfix/{{jira_key}}-{{summary_slug}}");

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

#[rstest]
fn test_load_nonexistent_template_fallback(config_dir_with_templates: TempDir) {
    std::env::set_var("WORKFLOW_CONFIG_DIR", config_dir_with_templates.path());

    // å°è¯•åŠ è½½ä¸å­˜åœ¨çš„æ¨¡æ¿ç±»å‹ï¼Œåº”è¯¥å›é€€åˆ°é»˜è®¤æ¨¡æ¿
    let result = TemplateConfig::load_branch_template(Some("NonexistentType"));

    // æ ¹æ®å®ç°ï¼Œè¿™å¯èƒ½è¿”å›é”™è¯¯æˆ–å›é€€åˆ°é»˜è®¤æ¨¡æ¿
    // å¦‚æœå®ç°äº†å›é€€é€»è¾‘ï¼Œåº”è¯¥æˆåŠŸï¼›å¦åˆ™åº”è¯¥å¤±è´¥
    if result.is_ok() {
        let template = result.unwrap();
        assert_eq!(
            template,
            "{{prefix}}/{{#if jira_key}}{{jira_key}}-{{/if}}{{summary_slug}}"
        );
    } else {
        // å¦‚æœæ²¡æœ‰å›é€€é€»è¾‘ï¼Œåº”è¯¥è¿”å›é”™è¯¯
        assert!(result.is_err());
    }

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

// ==================== æ¨¡æ¿æ–‡ä»¶åæ˜ å°„æµ‹è¯• ====================

#[test]
fn test_jira_type_to_filename_mapping() {
    // æµ‹è¯• JIRA ç±»å‹åˆ°æ–‡ä»¶åçš„æ˜ å°„é€»è¾‘
    // è¿™äº›æµ‹è¯•åŸºäº TemplateConfig çš„å®ç°é€»è¾‘

    // å¸¸è§çš„ JIRA ç±»å‹åº”è¯¥æœ‰å¯¹åº”çš„æ–‡ä»¶å
    let test_cases = vec![
        ("Feature", "feature.hbs"),
        ("Bug", "bug.hbs"),
        ("Task", "task.hbs"),
        ("Story", "story.hbs"),
        ("Epic", "epic.hbs"),
    ];

    for (jira_type, expected_filename) in test_cases {
        // è¿™é‡Œæˆ‘ä»¬æµ‹è¯•æ–‡ä»¶åæ˜ å°„é€»è¾‘
        // å®é™…çš„æ˜ å°„é€»è¾‘å¯èƒ½åœ¨ TemplateConfig çš„ç§æœ‰æ–¹æ³•ä¸­
        let filename = format!("{}.hbs", jira_type.to_lowercase());
        assert_eq!(filename, expected_filename);
    }
}

// ==================== æ¨¡æ¿éªŒè¯æµ‹è¯• ====================

#[rstest]
fn test_validate_template_syntax(temp_config_dir: TempDir) {
    let templates_dir = temp_config_dir.path().join("templates").join("branch");

    // åˆ›å»ºæœ‰æ•ˆçš„æ¨¡æ¿
    fs::write(
        templates_dir.join("valid.hbs"),
        "{{prefix}}/{{jira_key}}-{{summary_slug}}",
    )
    .expect("Failed to write valid template");

    // åˆ›å»ºæ— æ•ˆçš„æ¨¡æ¿
    fs::write(templates_dir.join("invalid.hbs"), "{{#if unclosed")
        .expect("Failed to write invalid template");

    std::env::set_var("WORKFLOW_CONFIG_DIR", temp_config_dir.path());

    // æµ‹è¯•åŠ è½½æœ‰æ•ˆæ¨¡æ¿
    // æ³¨æ„ï¼šè¿™ä¸ªæµ‹è¯•å–å†³äº TemplateConfig æ˜¯å¦æœ‰éªŒè¯åŠŸèƒ½
    // å¦‚æœæ²¡æœ‰éªŒè¯åŠŸèƒ½ï¼Œå¯èƒ½éœ€è¦é€šè¿‡ TemplateEngine æ¥éªŒè¯

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

// ==================== æ¨¡æ¿ç›®å½•åˆ›å»ºæµ‹è¯• ====================

#[rstest]
fn test_ensure_templates_directory_exists(temp_config_dir: TempDir) {
    std::env::set_var("WORKFLOW_CONFIG_DIR", temp_config_dir.path());

    // åˆ é™¤æ¨¡æ¿ç›®å½•
    let templates_dir = temp_config_dir.path().join("templates");
    if templates_dir.exists() {
        fs::remove_dir_all(&templates_dir).expect("Failed to remove templates dir");
    }

    // å°è¯•è·å–æ¨¡æ¿ç›®å½•ï¼ˆåº”è¯¥ä¼šåˆ›å»ºç›®å½•ï¼‰
    let result = TemplateConfig::get_templates_dir();

    // æ ¹æ®å®ç°ï¼Œè¿™å¯èƒ½ä¼šè‡ªåŠ¨åˆ›å»ºç›®å½•æˆ–è¿”å›é”™è¯¯
    if result.is_ok() {
        assert!(
            templates_dir.exists(),
            "Templates directory should be created"
        );
    }

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

// ==================== è¾¹ç•Œæ¡ä»¶æµ‹è¯• ====================

#[rstest]
fn test_empty_template_file(temp_config_dir: TempDir) {
    let templates_dir = temp_config_dir.path().join("templates").join("branch");

    // åˆ›å»ºç©ºæ¨¡æ¿æ–‡ä»¶
    fs::write(templates_dir.join("empty.hbs"), "").expect("Failed to write empty template");

    std::env::set_var("WORKFLOW_CONFIG_DIR", temp_config_dir.path());

    // å°è¯•åŠ è½½ç©ºæ¨¡æ¿
    // æ ¹æ®å®ç°ï¼Œè¿™å¯èƒ½è¿”å›ç©ºå­—ç¬¦ä¸²æˆ–é”™è¯¯

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

#[rstest]
fn test_very_large_template_file(temp_config_dir: TempDir) {
    let templates_dir = temp_config_dir.path().join("templates").join("branch");

    // åˆ›å»ºå¾ˆå¤§çš„æ¨¡æ¿æ–‡ä»¶
    let large_template = "Hello ".repeat(10000) + "{{name}}";
    fs::write(templates_dir.join("large.hbs"), large_template)
        .expect("Failed to write large template");

    std::env::set_var("WORKFLOW_CONFIG_DIR", temp_config_dir.path());

    // å°è¯•åŠ è½½å¤§æ¨¡æ¿æ–‡ä»¶
    // åº”è¯¥èƒ½æ­£å¸¸åŠ è½½

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

#[rstest]
fn test_template_with_special_characters(temp_config_dir: TempDir) {
    let templates_dir = temp_config_dir.path().join("templates").join("branch");

    // åˆ›å»ºåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ¨¡æ¿
    let special_template = "{{prefix}}/{{jira_key}}-{{summary_slug}} ğŸš€ æµ‹è¯• Ã‘oÃ±Ã³";
    fs::write(templates_dir.join("special.hbs"), special_template)
        .expect("Failed to write special template");

    std::env::set_var("WORKFLOW_CONFIG_DIR", temp_config_dir.path());

    // å°è¯•åŠ è½½åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ¨¡æ¿
    // åº”è¯¥èƒ½æ­£å¸¸å¤„ç† UTF-8 å­—ç¬¦

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

// ==================== é”™è¯¯å¤„ç†æµ‹è¯• ====================

#[test]
fn test_load_template_no_config_dir() {
    // æµ‹è¯•åœ¨æ²¡æœ‰é…ç½®ç›®å½•çš„æƒ…å†µä¸‹åŠ è½½æ¨¡æ¿
    std::env::remove_var("WORKFLOW_CONFIG_DIR");

    let result = TemplateConfig::load_branch_template(None);

    // æ ¹æ®å®ç°ï¼Œè¿™å¯èƒ½è¿”å›é”™è¯¯æˆ–ä½¿ç”¨é»˜è®¤ä½ç½®
    // å¦‚æœä½¿ç”¨é»˜è®¤ä½ç½®ä¸”ç›®å½•ä¸å­˜åœ¨ï¼Œåº”è¯¥è¿”å›é”™è¯¯
}

#[rstest]
fn test_load_template_permission_denied(temp_config_dir: TempDir) {
    let templates_dir = temp_config_dir.path().join("templates").join("branch");

    // åˆ›å»ºæ¨¡æ¿æ–‡ä»¶
    fs::write(templates_dir.join("test.hbs"), "test template").expect("Failed to write template");

    // å°è¯•ç§»é™¤è¯»æƒé™ï¼ˆåœ¨æŸäº›ç³»ç»Ÿä¸Šå¯èƒ½ä¸èµ·ä½œç”¨ï¼‰
    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        let mut perms = fs::metadata(&templates_dir.join("test.hbs")).unwrap().permissions();
        perms.set_mode(0o000); // ç§»é™¤æ‰€æœ‰æƒé™
        fs::set_permissions(&templates_dir.join("test.hbs"), perms).ok();
    }

    std::env::set_var("WORKFLOW_CONFIG_DIR", temp_config_dir.path());

    // å°è¯•åŠ è½½æ— æƒé™çš„æ¨¡æ¿æ–‡ä»¶
    // åº”è¯¥è¿”å›æƒé™é”™è¯¯

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

// ==================== é›†æˆæµ‹è¯• ====================

#[rstest]
fn test_complete_template_config_workflow(config_dir_with_templates: TempDir) {
    std::env::set_var("WORKFLOW_CONFIG_DIR", config_dir_with_templates.path());

    // 1. è·å–æ¨¡æ¿ç›®å½•
    let templates_dir = TemplateConfig::get_templates_dir().unwrap();
    assert!(templates_dir.exists());

    // 2. è·å–åˆ†æ”¯æ¨¡æ¿ç›®å½•
    let branch_dir = TemplateConfig::get_branch_templates_dir().unwrap();
    assert!(branch_dir.exists());

    // 3. åŠ è½½ä¸åŒç±»å‹çš„æ¨¡æ¿
    let default_template = TemplateConfig::load_branch_template(None).unwrap();
    let feature_template = TemplateConfig::load_branch_template(Some("Feature")).unwrap();
    let bug_template = TemplateConfig::load_branch_template(Some("Bug")).unwrap();

    // 4. éªŒè¯æ¨¡æ¿å†…å®¹
    assert!(!default_template.is_empty());
    assert!(!feature_template.is_empty());
    assert!(!bug_template.is_empty());

    // 5. éªŒè¯æ¨¡æ¿å†…å®¹ä¸åŒ
    assert_ne!(default_template, feature_template);
    assert_ne!(feature_template, bug_template);

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}

// ==================== æ€§èƒ½æµ‹è¯• ====================

#[rstest]
fn test_template_loading_performance(config_dir_with_templates: TempDir) {
    use std::time::Instant;

    std::env::set_var("WORKFLOW_CONFIG_DIR", config_dir_with_templates.path());

    let start = Instant::now();

    // å¤šæ¬¡åŠ è½½æ¨¡æ¿
    for _ in 0..100 {
        let _ = TemplateConfig::load_branch_template(None);
        let _ = TemplateConfig::load_branch_template(Some("Feature"));
        let _ = TemplateConfig::load_branch_template(Some("Bug"));
    }

    let duration = start.elapsed();

    // æ¨¡æ¿åŠ è½½åº”è¯¥ç›¸å¯¹å¿«é€Ÿ
    assert!(
        duration.as_millis() < 1000,
        "Template loading too slow: {:?}",
        duration
    );

    std::env::remove_var("WORKFLOW_CONFIG_DIR");
}
