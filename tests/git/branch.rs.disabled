//! Git 分支管理测试
//!
//! 测试 Git 分支的创建、切换、合并、删除等操作。

use pretty_assertions::assert_eq;
use rstest::{fixture, rstest};
use std::fs;
use tempfile::TempDir;
use workflow::git::{GitBranch, MergeStrategy};

// ==================== Fixtures ====================

/// 创建带有初始提交的 Git 仓库
#[fixture]
fn git_repo_with_commit() -> TempDir {
    let temp_dir = tempfile::tempdir().expect("Failed to create temp dir");

    // 切换到临时目录
    std::env::set_current_dir(&temp_dir).expect("Failed to change dir");

    // 初始化 Git 仓库
    std::process::Command::new("git")
        .args(["init"])
        .output()
        .expect("Failed to init git repo");

    // 配置 Git 用户
    std::process::Command::new("git")
        .args(["config", "user.name", "Test User"])
        .output()
        .expect("Failed to set git user name");

    std::process::Command::new("git")
        .args(["config", "user.email", "test@example.com"])
        .output()
        .expect("Failed to set git user email");

    // 创建初始文件和提交
    fs::write("README.md", "# Test Repository").expect("Failed to write file");

    std::process::Command::new("git")
        .args(["add", "README.md"])
        .output()
        .expect("Failed to add file");

    std::process::Command::new("git")
        .args(["commit", "-m", "Initial commit"])
        .output()
        .expect("Failed to commit");

    temp_dir
}

// ==================== 分支前缀处理测试 ====================

#[test]
fn test_remove_branch_prefix_with_slash() {
    // 这是测试内部函数，需要通过公共API测试
    // 我们通过分支名称处理的相关功能来测试

    // 测试分支前缀移除逻辑（通过分支操作间接测试）
    // 注意：remove_branch_prefix 是私有函数，我们测试其效果
}

// ==================== 分支存在性检查测试 ====================

#[rstest]
fn test_exists_main_branch(git_repo_with_commit: TempDir) {
    // 检查默认分支是否存在
    // 注意：新的 Git 版本默认分支可能是 main 或 master
    let current_branch = std::process::Command::new("git")
        .args(["branch", "--show-current"])
        .output()
        .expect("Failed to get current branch");

    let branch_name = String::from_utf8_lossy(&current_branch.stdout).trim();

    if !branch_name.is_empty() {
        assert!(GitBranch::exists(branch_name).unwrap_or(false));
    }
}

#[rstest]
fn test_exists_nonexistent_branch(git_repo_with_commit: TempDir) {
    // 检查不存在的分支
    assert!(!GitBranch::exists("nonexistent-branch").unwrap_or(true));
}

#[rstest]
fn test_exists_with_special_characters(git_repo_with_commit: TempDir) {
    // 测试特殊字符分支名
    assert!(!GitBranch::exists("feature/test-123").unwrap_or(true));
    assert!(!GitBranch::exists("hotfix--urgent-fix").unwrap_or(true));
}

// ==================== 分支创建测试 ====================

#[rstest]
fn test_create_simple_branch(git_repo_with_commit: TempDir) {
    let branch_name = "feature/test-branch";

    // 创建分支
    let result = GitBranch::create(branch_name);
    assert!(result.is_ok(), "Failed to create branch: {:?}", result);

    // 验证分支存在
    assert!(GitBranch::exists(branch_name).unwrap_or(false));
}

#[rstest]
fn test_create_branch_with_prefix(git_repo_with_commit: TempDir) {
    let branch_name = "feature/user-authentication";

    let result = GitBranch::create(branch_name);
    assert!(result.is_ok());

    assert!(GitBranch::exists(branch_name).unwrap_or(false));
}

#[rstest]
fn test_create_branch_with_double_dash(git_repo_with_commit: TempDir) {
    let branch_name = "PROJ-123--implement-feature";

    let result = GitBranch::create(branch_name);
    assert!(result.is_ok());

    assert!(GitBranch::exists(branch_name).unwrap_or(false));
}

#[rstest]
fn test_create_duplicate_branch(git_repo_with_commit: TempDir) {
    let branch_name = "duplicate-branch";

    // 第一次创建应该成功
    let result1 = GitBranch::create(branch_name);
    assert!(result1.is_ok());

    // 第二次创建应该失败
    let result2 = GitBranch::create(branch_name);
    assert!(result2.is_err());

    // 错误消息应该包含相关信息
    let error_msg = result2.unwrap_err().to_string();
    assert!(error_msg.contains("already exists") || error_msg.contains("已存在"));
}

// ==================== 分支切换测试 ====================

#[rstest]
fn test_switch_to_existing_branch(git_repo_with_commit: TempDir) {
    let branch_name = "test-switch";

    // 创建分支
    GitBranch::create(branch_name).expect("Failed to create branch");

    // 切换到分支
    let result = GitBranch::switch(branch_name);
    assert!(result.is_ok(), "Failed to switch branch: {:?}", result);

    // 验证当前分支
    let current_branch = std::process::Command::new("git")
        .args(["branch", "--show-current"])
        .output()
        .expect("Failed to get current branch");

    let current = String::from_utf8_lossy(&current_branch.stdout).trim();
    assert_eq!(current, branch_name);
}

#[rstest]
fn test_switch_to_nonexistent_branch(git_repo_with_commit: TempDir) {
    let branch_name = "nonexistent-branch";

    // 切换到不存在的分支应该失败
    let result = GitBranch::switch(branch_name);
    assert!(result.is_err());
}

// ==================== 分支删除测试 ====================

#[rstest]
fn test_delete_existing_branch(git_repo_with_commit: TempDir) {
    let branch_name = "delete-me";

    // 创建分支
    GitBranch::create(branch_name).expect("Failed to create branch");
    assert!(GitBranch::exists(branch_name).unwrap_or(false));

    // 删除分支
    let result = GitBranch::delete(branch_name);
    assert!(result.is_ok(), "Failed to delete branch: {:?}", result);

    // 验证分支不存在
    assert!(!GitBranch::exists(branch_name).unwrap_or(true));
}

#[rstest]
fn test_delete_nonexistent_branch(git_repo_with_commit: TempDir) {
    let branch_name = "nonexistent-branch";

    // 删除不存在的分支应该失败
    let result = GitBranch::delete(branch_name);
    assert!(result.is_err());
}

#[rstest]
fn test_delete_current_branch(git_repo_with_commit: TempDir) {
    let branch_name = "current-branch";

    // 创建并切换到分支
    GitBranch::create(branch_name).expect("Failed to create branch");
    GitBranch::switch(branch_name).expect("Failed to switch branch");

    // 尝试删除当前分支应该失败
    let result = GitBranch::delete(branch_name);
    assert!(result.is_err());
}

// ==================== 默认分支检测测试 ====================

#[rstest]
fn test_get_default_branch(git_repo_with_commit: TempDir) {
    // 获取默认分支
    let result = GitBranch::get_default();

    // 应该能获取到默认分支（main 或 master）
    assert!(result.is_ok(), "Failed to get default branch: {:?}", result);

    let default_branch = result.unwrap();
    assert!(!default_branch.is_empty());

    // 默认分支应该是常见的分支名之一
    let common_defaults = ["main", "master", "develop", "dev"];
    assert!(
        common_defaults.contains(&default_branch.as_str()),
        "Unexpected default branch: {}",
        default_branch
    );
}

// ==================== 分支列表测试 ====================

#[rstest]
fn test_list_branches(git_repo_with_commit: TempDir) {
    // 创建几个测试分支
    let branches = ["feature/test1", "feature/test2", "hotfix/bug-fix"];

    for branch in &branches {
        GitBranch::create(branch).expect("Failed to create branch");
    }

    // 获取分支列表
    let result = GitBranch::list();
    assert!(result.is_ok(), "Failed to list branches: {:?}", result);

    let branch_list = result.unwrap();

    // 验证创建的分支都在列表中
    for branch in &branches {
        assert!(
            branch_list.iter().any(|b| b.name == *branch),
            "Branch {} not found in list",
            branch
        );
    }
}

// ==================== 合并策略测试 ====================

#[test]
fn test_merge_strategy_enum() {
    // 测试合并策略枚举的基本功能
    let strategies = [
        MergeStrategy::Merge,
        MergeStrategy::Squash,
        MergeStrategy::FastForwardOnly,
    ];

    // 验证枚举可以正常使用
    for strategy in &strategies {
        // 这里主要测试枚举的基本功能
        let debug_str = format!("{:?}", strategy);
        assert!(!debug_str.is_empty());
    }
}

// ==================== 边界条件测试 ====================

#[rstest]
fn test_empty_branch_name(git_repo_with_commit: TempDir) {
    // 测试空分支名
    let result = GitBranch::create("");
    assert!(result.is_err());
}

#[rstest]
fn test_invalid_branch_name_characters(git_repo_with_commit: TempDir) {
    // 测试无效字符的分支名
    let invalid_names = [
        "branch with spaces",
        "branch\nwith\nnewlines",
        "branch..with..dots",
        "branch~with~tildes",
    ];

    for name in &invalid_names {
        let result = GitBranch::create(name);
        // 大多数无效字符应该导致创建失败
        if result.is_ok() {
            // 如果创建成功，清理分支
            let _ = GitBranch::delete(name);
        }
    }
}

#[rstest]
fn test_very_long_branch_name(git_repo_with_commit: TempDir) {
    // 测试很长的分支名
    let long_name = "a".repeat(200);

    let result = GitBranch::create(&long_name);
    // Git 对分支名长度有限制，应该失败或成功（取决于系统）
    if result.is_ok() {
        // 如果创建成功，清理分支
        let _ = GitBranch::delete(&long_name);
    }
}

// ==================== 错误处理测试 ====================

#[test]
fn test_git_not_available() {
    // 测试 Git 不可用的情况
    // 注意：这个测试在有 Git 的环境中会跳过

    let original_path = std::env::var("PATH").unwrap_or_default();

    // 临时移除 PATH 中的 Git
    std::env::set_var("PATH", "");

    let result = GitBranch::exists("any-branch");

    // 恢复 PATH
    std::env::set_var("PATH", original_path);

    // 在没有 Git 的情况下应该返回错误
    // 注意：这个测试可能不会按预期工作，因为 Git 可能在其他位置
}

// ==================== 集成测试 ====================

#[rstest]
fn test_branch_workflow(git_repo_with_commit: TempDir) {
    let branch_name = "feature/complete-workflow";

    // 1. 创建分支
    let create_result = GitBranch::create(branch_name);
    assert!(create_result.is_ok(), "Failed to create branch");

    // 2. 验证分支存在
    assert!(GitBranch::exists(branch_name).unwrap_or(false));

    // 3. 切换到分支
    let switch_result = GitBranch::switch(branch_name);
    assert!(switch_result.is_ok(), "Failed to switch to branch");

    // 4. 在分支上做一些工作
    fs::write("feature.txt", "New feature implementation").expect("Failed to write file");

    std::process::Command::new("git")
        .args(["add", "feature.txt"])
        .output()
        .expect("Failed to add file");

    std::process::Command::new("git")
        .args(["commit", "-m", "Add new feature"])
        .output()
        .expect("Failed to commit");

    // 5. 切换回默认分支
    let default_branch = GitBranch::get_default().expect("Failed to get default branch");
    let switch_back_result = GitBranch::switch(&default_branch);
    assert!(switch_back_result.is_ok(), "Failed to switch back");

    // 6. 删除功能分支
    let delete_result = GitBranch::delete(branch_name);
    assert!(delete_result.is_ok(), "Failed to delete branch");

    // 7. 验证分支不存在
    assert!(!GitBranch::exists(branch_name).unwrap_or(true));
}

// ==================== 性能测试 ====================

#[rstest]
fn test_branch_operations_performance(git_repo_with_commit: TempDir) {
    use std::time::Instant;

    let start = Instant::now();

    // 执行一系列分支操作
    for i in 0..5 {
        let branch_name = format!("perf-test-{}", i);

        GitBranch::create(&branch_name).expect("Failed to create branch");
        assert!(GitBranch::exists(&branch_name).unwrap_or(false));
        GitBranch::delete(&branch_name).expect("Failed to delete branch");
    }

    let duration = start.elapsed();

    // 分支操作应该相对快速（5个分支操作 < 5秒）
    assert!(
        duration.as_secs() < 5,
        "Branch operations too slow: {:?}",
        duration
    );
}
