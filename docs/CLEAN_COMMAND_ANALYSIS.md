# Clean 命令可行性分析与优化建议

## 📋 需求分析

### 功能需求
1. `workflow clean` - 清除整个 `{log_download_base_dir}/` 目录
2. `qk {JIRA_ID} clean` - 清除 `{log_download_base_dir}/{JIRA_ID}/` 目录

### 技术可行性
✅ **完全可行**

- 现有代码结构支持轻松添加新命令
- 已有 `remove_dir_all` 的使用经验（在 `download_from_jira` 中）
- 已有确认提示的实现模式（在 `uninstall.rs` 中）
- 已有日志输出和错误处理模式

## 🎯 优化建议

### 1. 安全性优化 ⚠️
**必须添加确认提示，防止误删**

- ✅ 添加交互式确认（使用 `dialoguer::Confirm`，始终需要确认）
- ✅ 显示将要删除的目录路径和大小信息
- ✅ 添加 `--dry-run` 选项预览操作（不实际删除）

### 2. 用户体验优化 🎨
**提供清晰的反馈和进度信息**

- ✅ 显示目录路径和包含的文件数量
- ✅ 显示删除进度（如果目录很大）
- ✅ 提供详细的成功/失败消息
- ✅ 支持彩色输出（使用现有的日志系统）

### 3. 功能增强 💡
**提供更多实用功能**

- ✅ 支持批量清理（`qk clean --all` 清理所有 JIRA ID）
- ✅ 支持按时间过滤（`--older-than 30d` 只清理30天前的）
- ✅ 支持统计信息（显示清理前后磁盘空间变化）
- ✅ 支持列出将要删除的内容（`--list` 选项）

### 4. 错误处理 🛡️
**完善的错误处理和恢复机制**

- ✅ 检查目录是否存在
- ✅ 检查目录权限
- ✅ 处理部分删除失败的情况
- ✅ 提供详细的错误信息和建议

## 📐 实现方案

### 命令结构

#### 1. `workflow clean`
```bash
workflow clean [OPTIONS]

Options:
  --dry-run, -n   预览操作，不实际删除
  --list, -l      列出将要删除的目录
```

#### 2. `qk {JIRA_ID} clean`
```bash
qk <JIRA_ID> clean [OPTIONS]

Options:
  --dry-run, -n   预览操作，不实际删除
  --list, -l      列出将要删除的内容
```

### 实现步骤

1. **创建 `Logs::clean_base_dir()` 方法**
   - 清除整个 `{log_download_base_dir}/` 目录
   - 包含确认提示和错误处理

2. **创建 `Logs::clean_jira_dir(jira_id)` 方法**
   - 清除 `{log_download_base_dir}/{JIRA_ID}/` 目录
   - 包含确认提示和错误处理

3. **创建 `commands/qk/clean.rs` 命令模块**
   - 实现 `qk {JIRA_ID} clean` 命令
   - 处理命令行参数和用户交互

4. **在 `src/main.rs` 中添加 `Clean` 命令**
   - 实现 `workflow clean` 命令
   - 处理命令行参数和用户交互

5. **更新命令注册**
   - 在 `src/bin/qk.rs` 中添加 `Clean` 子命令
   - 在 `src/commands/qk/mod.rs` 中导出 `CleanCommand`

## 🔒 安全考虑

### 风险点
1. **误删重要数据** - 通过确认提示和 `--dry-run` 缓解
2. **权限问题** - 通过错误处理和提示缓解
3. **并发删除** - 通过文件锁或检查缓解

### 建议的安全措施
- ✅ 始终需要确认（无法跳过）
- ✅ 显示完整的目录路径
- ✅ 显示目录大小和文件数量
- ✅ 提供 `--dry-run` 预览功能
- ✅ 记录删除操作（可选）

## 📊 优先级建议

### 高优先级（MVP）
1. ✅ 基本删除功能
2. ✅ 确认提示（始终需要）
3. ✅ 错误处理

### 中优先级（增强）
1. ⚠️ `--dry-run` 选项
2. ⚠️ 显示目录信息（大小、文件数）
3. ⚠️ `--list` 选项

### 低优先级（未来）
1. 📌 批量清理
2. 📌 按时间过滤
3. 📌 统计信息
4. 📌 操作日志

## 🎬 使用示例

### 基本使用
```bash
# 清理特定 JIRA ticket 的日志（需要确认）
qk WEW-763 clean

# 清理所有日志（需要确认）
workflow clean

# 预览操作（不实际删除）
qk WEW-763 clean --dry-run
```

### 高级使用
```bash
# 列出将要删除的内容
qk WEW-763 clean --list

# 预览操作
workflow clean --dry-run
```

## ✅ 总结

**可行性：** ✅ 完全可行
**复杂度：** 🟢 低-中
**优先级：** 🟡 中-高
**风险：** 🟡 中等（需要安全措施）

建议先实现 MVP 版本（基本删除 + 确认提示），然后根据用户反馈逐步添加增强功能。

