# 模板系统工作流程图

## 📋 概述

本文档以流程图形式展示模板系统如何与各个命令配合使用。

---

## 🔄 完整工作流

### 场景：从 JIRA Ticket 创建完整 PR

```
┌─────────────────────────────────────────────────────────────────┐
│  用户执行: workflow branch create --from PROJ-123                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 获取 JIRA Ticket 信息                                        │
│     - 调用 Jira::get_ticket_info("PROJ-123")                    │
│     - 获取: key, summary, description, type, labels             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 选择分支命名模板                                             │
│     - 根据 ticket.type 选择模板                                 │
│     - Feature → feature/{{jira_key}}-{{summary_slug}}           │
│     - Bug → bugfix/{{jira_key}}-{{summary_slug}}                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 渲染分支名                                                   │
│     - 模板变量:                                                  │
│       * jira_key = "PROJ-123"                                   │
│       * summary_slug = "add-user-authentication"                │
│     - 渲染结果: "feature/PROJ-123-add-user-authentication"     │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 清理和规范化分支名                                            │
│     - 转换为小写                                                 │
│     - 移除特殊字符                                               │
│     - 验证 Git 分支名规范                                        │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 创建并切换到分支                                             │
│     - git checkout -b feature/PROJ-123-add-user-authentication  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    [用户进行开发工作]
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  用户执行: workflow commit                                       │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 检测当前分支                                                 │
│     - 提取 JIRA ID: "PROJ-123"                                  │
│     - 获取 JIRA ticket 信息（可选）                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 交互式收集 Commit 信息                                       │
│     - Type: feat / fix / docs / ...                              │
│     - Scope: auth (可选)                                         │
│     - Subject: "Add login form"                                  │
│     - Body: "Implement user login functionality"                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 加载 Commit 模板                                             │
│     - 从配置文件加载默认模板                                      │
│     - 模板: "{{type}}({{scope}}): {{subject}}\n\n{{body}}\n\n  │
│             Closes {{jira_key}}"                                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 渲染 Commit 消息                                             │
│     - 模板变量:                                                  │
│       * type = "feat"                                           │
│       * scope = "auth"                                          │
│       * subject = "Add login form"                              │
│       * body = "Implement user login functionality"             │
│       * jira_key = "PROJ-123"                                   │
│     - 渲染结果:                                                  │
│       "feat(auth): Add login form                               │
│                                                                  │
│       Implement user login functionality                         │
│                                                                  │
│       Closes PROJ-123"                                          │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 预览并确认提交                                               │
│     - 显示预览                                                   │
│     - 用户确认后执行: git commit -m "..."                       │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  用户执行: workflow pr create                                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 检测当前分支                                                 │
│     - 提取 JIRA ID: "PROJ-123"                                  │
│     - 获取 JIRA ticket 完整信息                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 收集用户输入                                                 │
│     - PR 标题（可选，默认使用 JIRA summary）                     │
│     - 简短描述（可选）                                           │
│     - 变更类型选择（复选框）                                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 加载 PR 模板                                                 │
│     - 从配置文件加载默认模板                                      │
│     - 支持自定义模板                                             │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 准备模板变量                                                 │
│     - jira_key = "PROJ-123"                                     │
│     - jira_summary = "Add user authentication"                   │
│     - jira_description = "Full description from JIRA..."        │
│     - jira_type = "Feature"                                     │
│     - change_types = [true, false, false, ...]                  │
│     - short_description = "User input description"              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 渲染 PR Body                                                 │
│     - 使用模板引擎渲染                                           │
│     - 生成完整的 PR 描述                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 创建 PR                                                      │
│     - 调用平台 API 创建 PR                                       │
│     - 使用渲染的 PR body                                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. 更新 JIRA Ticket                                            │
│     - 添加 PR 链接评论                                           │
│     - 更新 ticket 状态                                           │
│     - 记录工作历史                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔀 分支命名模板流程

```
┌─────────────────────────────────────────────────────────────┐
│  输入: JIRA Ticket (PROJ-123)                                 │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  获取 Ticket 信息                                            │
│  - key: PROJ-123                                            │
│  - type: Feature                                            │
│  - summary: "Add User Authentication"                       │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  根据 type 选择模板                                          │
│  - Feature → feature/{{jira_key}}-{{summary_slug}}         │
│  - Bug → bugfix/{{jira_key}}-{{summary_slug}}              │
│  - Hotfix → hotfix/{{jira_key}}-{{summary_slug}}           │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  生成 summary_slug                                           │
│  - "Add User Authentication"                                │
│  → "add-user-authentication"                                │
│  (转换为小写，空格替换为连字符)                                │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  渲染模板                                                    │
│  - jira_key = "PROJ-123"                                    │
│  - summary_slug = "add-user-authentication"                 │
│  - 结果: "feature/PROJ-123-add-user-authentication"         │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  清理和验证                                                  │
│  - 移除特殊字符                                              │
│  - 验证 Git 分支名规范                                       │
│  - 检查长度限制                                              │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  输出: "feature/PROJ-123-add-user-authentication"           │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 Commit 消息模板流程

```
┌─────────────────────────────────────────────────────────────┐
│  用户执行: workflow commit                                    │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  检测当前分支                                                 │
│  - 分支名: "feature/PROJ-123-add-user-authentication"       │
│  - 提取 JIRA ID: "PROJ-123"                                  │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  交互式收集信息                                               │
│  ┌─────────────────────────────────────────┐               │
│  │ Type: [feat] fix docs style refactor... │               │
│  │ Scope: [auth] (可选)                     │               │
│  │ Subject: Add login form                  │               │
│  │ Body: Implement user login... (可选)     │               │
│  └─────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  加载 Commit 模板                                            │
│  - 从配置文件读取                                             │
│  - 默认模板: "{{type}}({{scope}}): {{subject}}..."          │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  准备模板变量                                                 │
│  - type = "feat"                                            │
│  - scope = "auth"                                           │
│  - subject = "Add login form"                               │
│  - body = "Implement user login functionality"              │
│  - jira_key = "PROJ-123"                                    │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  渲染 Commit 消息                                            │
│  ┌─────────────────────────────────────────┐               │
│  │ feat(auth): Add login form              │               │
│  │                                         │               │
│  │ Implement user login functionality      │               │
│  │                                         │               │
│  │ Closes PROJ-123                        │               │
│  └─────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  预览并确认                                                   │
│  - 显示预览                                                   │
│  - 用户确认后提交                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📄 PR Body 模板流程

```
┌─────────────────────────────────────────────────────────────┐
│  用户执行: workflow pr create                                 │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  检测当前分支并提取 JIRA ID                                   │
│  - 分支名: "feature/PROJ-123-add-user-authentication"       │
│  - JIRA ID: "PROJ-123"                                       │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  获取 JIRA Ticket 完整信息                                    │
│  - key: PROJ-123                                            │
│  - summary: "Add user authentication"                       │
│  - description: "Full description..."                      │
│  - type: "Feature"                                          │
│  - labels: ["backend", "auth"]                              │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  收集用户输入                                                 │
│  - PR 标题（可选）                                           │
│  - 简短描述（可选）                                           │
│  - 变更类型选择（复选框）                                      │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  加载 PR 模板                                                │
│  - 从配置文件读取                                             │
│  - 支持条件渲染（handlebars/tera）                           │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  准备模板变量                                                 │
│  - jira_key = "PROJ-123"                                    │
│  - jira_summary = "Add user authentication"                 │
│  - jira_description = "Full description..."                 │
│  - jira_type = "Feature"                                    │
│  - change_types = [true, false, false, ...]                 │
│  - short_description = "User input"                         │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  渲染 PR Body                                                │
│  ┌─────────────────────────────────────────┐               │
│  │ ## Description                         │               │
│  │ Add user authentication                │               │
│  │                                         │               │
│  │ ## Related Ticket                      │               │
│  │ PROJ-123                               │               │
│  │                                         │               │
│  │ ## Changes                             │               │
│  │ - [x] Feature                          │               │
│  │ - [ ] Bug fix                         │               │
│  │ ...                                    │               │
│  └─────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  创建 PR                                                     │
│  - 使用渲染的 PR body                                         │
│  - 调用平台 API                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 模板配置加载流程

```
┌─────────────────────────────────────────────────────────────┐
│  需要加载模板配置                                              │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 加载全局配置                                              │
│     ~/.workflow/config.toml                                 │
│     - 默认模板                                                │
│     - 全局设置                                                │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 检查项目级配置                                            │
│     .workflow/config.toml (项目根目录)                       │
│     - 项目特定模板                                            │
│     - 项目特定设置                                            │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 合并配置                                                  │
│     - 项目配置覆盖全局配置                                     │
│     - 模板继承机制（如果支持）                                 │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 验证配置                                                  │
│     - 检查模板语法                                            │
│     - 验证模板变量                                            │
│     - 检查必需字段                                            │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 初始化模板引擎                                            │
│     - 加载模板                                               │
│     - 注册辅助函数（如果需要）                                 │
│     - 准备渲染上下文                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 📚 相关文档

- [模板系统需求文档](./TEMPLATE_SYSTEM.md)
- [模板系统使用分析](./TEMPLATE_SYSTEM_USAGE.md)
- [Git 工作流需求文档](./GIT_WORKFLOW.md)

---

**最后更新**: 2025-01-27
