# 测试覆盖率提升 TODO

## 📋 目录

- [当前覆盖率状态](#-当前覆盖率状态)
- [覆盖率提升目标](#-覆盖率提升目标)
- [模块覆盖率分析](#-模块覆盖率分析)
- [下一步行动计划](#-下一步行动计划)
- [实施建议](#-实施建议)
- [进度跟踪](#-进度跟踪)
- [工具和命令](#-工具和命令)
- [参考资源](#-参考资源)

---

## 📊 当前覆盖率状态

**整体覆盖率**: 15.66% (2382/15206 行)

**测试数量**: 939 个测试用例

**基线覆盖率**: 15.66% (2382/15206 行)

**目标覆盖率**: 75%+ (11405+ 行)

**需要提升**: +59.34% (+9023 行)

---

## 🎯 覆盖率提升目标

### 短期目标（当前阶段）
- **目标**: 提升到 **25%+**
- **策略**: 优先处理简单工具模块，快速提升覆盖率

### 中期目标
- **目标**: 提升到 **50%+**
- **策略**: 覆盖核心业务逻辑模块

### 长期目标
- **目标**: 提升到 **75%+**
- **策略**: 全面覆盖所有模块

---

## 📈 模块覆盖率分析

### 🔄 高覆盖率模块（90%+，接近完成）

- 🔄 `logger/log-_level.rs`: 37/38 (97%) - 还需 1 行（第 32 行，release 模式下的默认级别）

**优先级**: ⭐⭐⭐ 高 - 快速达到 100%

**注意**: `logger/log-_level.rs:32` 是 release 模式下的默认级别分支，需要在 release 模式下运行测试才能覆盖。可以使用 `cargo test --release` 来覆盖这一行。

---

### 📋 中等覆盖率模块（50-90%，需要补充）

#### util 层
- 🔄 `util/platform.rs`: 35/45 (78%) - 还需 10 行
  - ⚠️ 需要特殊环境测试：
    - 第 123-124 行：Alpine Linux 检测（需要 `/etc/os-release` 文件）
    - 第 132, 135-137, 139 行：`ldd` 命令检测（依赖于系统环境）
    - 第 147 行：最后的 `return false`（当所有条件都不满足时）
- 🔄 `util/file.rs`: 31/79 (39%) - 还需 48 行
  - ⚠️ 覆盖率工具显示未覆盖，但测试已存在，可能需要检查覆盖率工具配置
- 🔄 `util/directory.rs`: 5/42 (12%) - 还需 37 行
  - ⚠️ 覆盖率工具显示未覆盖，但测试已存在，可能需要检查覆盖率工具配置

#### logger 层
- 🔄 `logger/console.rs`: 93%+ - 需要进一步分析未覆盖的代码行
- 🔄 `logger/tracing.rs`: 85%+ - 需要进一步分析未覆盖的代码行

#### http 层
- 🔄 `http/retry.rs`: 54% → 90%+ - 需要进一步分析未覆盖的代码行

**优先级**: ⭐⭐ 中 - 逐步提升

---

### 🚧 低覆盖率模块（<50%，需要大量工作）

#### 核心业务逻辑模块
- 🚧 `git/` 模块: ~30% 覆盖率
  - `git/branch.rs`: 需要补充测试
  - `git/commit.rs`: 需要补充测试
  - `git/status.rs`: 需要补充测试

- 🚧 `jira/` 模块: ~20% 覆盖率
  - `jira/api/`: 需要补充测试
  - `jira/ticket.rs`: 3/57 (5%)
  - `jira/users.rs`: 0/37 (0%)
  - `jira/status.rs`: 33/68 (49%)
  - `jira/logs/`: 需要补充测试

- 🚧 `pr/` 模块: ~10% 覆盖率
  - `pr/github/platform.rs`: 28/383 (7%)
  - `pr/llm/`: 0% 覆盖率
  - `pr/helpers/`: 0% 覆盖率

- 🚧 `branch/` 模块: ~30% 覆盖率
  - `branch/naming.rs`: 已有部分测试
  - `branch/types.rs`: 需要补充测试

**优先级**: ⭐ 低 - 需要更多时间投入

---

## 🎯 下一步行动计划

### 阶段 1: 快速提升（目标：20%+）

**优先级**: ⭐⭐⭐ 最高

1. **完成高覆盖率模块** (预计 +0.1%)
   - [ ] `logger/log-_level.rs`: 37/38 → 38/38 (100%) - 需要在 release 模式下运行测试

2. **补充低覆盖率工具模块** (预计 +1.0%)
   - [ ] `util/directory.rs`: 5/42 → 30/42 (71%)
   - [ ] `util/file.rs`: 31/79 → 60/79 (76%)
   - [ ] `util/platform.rs`: 35/45 → 45/45 (100%) - 需要特殊环境测试

**预计提升**: +1.1% → **18.4%+**

---

### 阶段 2: 核心模块提升（目标：25%+）

**优先级**: ⭐⭐ 高

1. **logger 模块** (预计 +0.5%)
   - [ ] `logger/console.rs`: 93%+ → 100% - 分析并补充未覆盖的代码行
   - [ ] `logger/tracing.rs`: 85%+ → 100% - 分析并补充未覆盖的代码行

2. **http 模块** (预计 +0.5%)
   - [ ] `http/retry.rs`: 90%+ → 100% - 分析并补充未覆盖的代码行

**预计提升**: +1.0% → **19.4%+**

---

### 阶段 3: 业务逻辑模块（目标：30%+）

**优先级**: ⭐ 中

1. **git 模块** (预计 +1.0%)
   - [ ] `git/branch.rs`: 补充测试
   - [ ] `git/commit.rs`: 补充测试
   - [ ] `git/status.rs`: 补充测试

2. **jira 模块** (预计 +1.0%)
   - [ ] `jira/ticket.rs`: 3/57 → 30/57 (53%)
   - [ ] `jira/users.rs`: 0/37 → 20/37 (54%)
   - [ ] `jira/status.rs`: 33/68 → 50/68 (74%)

3. **branch 模块** (预计 +0.5%)
   - [ ] `branch/types.rs`: 补充测试

**预计提升**: +2.5% → **23%+**

---

## 📝 实施建议

### 快速提升策略（推荐）

1. **优先处理高覆盖率模块**
   - 投入产出比高，快速达到 100%
   - 预计每个模块 10-30 分钟

2. **使用 Mock 服务器测试网络模块**
   - `http/retry.rs` 需要 mock HTTP 请求
   - `jira/api/` 需要 mock Jira API

3. **补充边界情况测试**
   - 错误处理路径
   - 边界值测试
   - 空值/None 处理

### 测试编写指南

1. **单元测试优先**
   - 每个公共函数至少 1 个测试用例
   - 覆盖正常路径和错误路径

2. **使用测试工具**
   - `MockServerManager` 用于 HTTP 测试
   - `TestDataFactory` 用于生成测试数据
   - `tempfile` 用于临时文件测试

3. **测试组织**
   - 测试文件放在 `tests/` 目录
   - 按模块组织测试文件
   - 使用 `#[cfg(test)]` 模块测试

---

## 📊 进度跟踪

### 当前进度
- **整体覆盖率**: 待更新（运行 `make coverage` 查看最新数据）
- **待处理模块**: 20+ 个

### 里程碑

- [ ] **里程碑 1**: 达到 20% 覆盖率
  - 预计时间: 1-2 天
  - 需要完成: 阶段 1 任务

- [ ] **里程碑 2**: 达到 25% 覆盖率
  - 预计时间: 3-5 天
  - 需要完成: 阶段 1 + 阶段 2 任务

- [ ] **里程碑 3**: 达到 30% 覆盖率
  - 预计时间: 1-2 周
  - 需要完成: 阶段 1 + 阶段 2 + 阶段 3 任务

---

## 🔧 工具和命令

### 覆盖率相关命令

```bash
# 生成覆盖率报告
make coverage

# 打开覆盖率报告（HTML）
make coverage-open

# CI 环境覆盖率检查
make coverage-ci

# 查看覆盖率趋势
make coverage-trend
```

### 测试相关命令

```bash
# 运行所有测试
cargo test

# 运行特定模块测试
cargo test --test integration-_test base::util-_file

# 运行测试并显示输出
cargo test --test integration-_test -- --nocapture
```

---

## 📚 参考资源

- [cargo-tarpaulin 文档](https://github.com/xd009642/tarpaulin)
- [Rust 测试指南](https://doc.rust-lang.org/book/ch11-00-testing.html)
- [Mockito 文档](https://docs.rs/mockito/)
- [项目测试规范](../guidelines/testing.md)

---

---

**最后更新**: 2025-12-24

