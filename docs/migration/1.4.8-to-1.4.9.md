# 迁移指南：1.4.8 → 1.4.9

## 📋 迁移概述

本文档描述从 Workflow CLI 1.4.8 升级到 1.4.9 版本时需要执行的配置迁移。

### 迁移背景

在 1.4.8 版本中，我们引入了配置迁移系统（迁移版本 v1.0.0），将分支配置从 `branch.toml` 迁移到 `repositories.toml`。1.4.9 版本继续完善迁移系统，并可能包含新的配置格式变化。

### 迁移版本对应关系

- **软件版本**：1.4.8 → 1.4.9
- **迁移版本**：v1.0.0（在 1.4.8 中实现）

---

## 🔄 迁移内容

### 1. 配置迁移系统（v1.0.0）

如果你在 1.4.8 版本之前使用了旧的 `branch.toml` 配置文件，需要执行迁移到新的 `repositories.toml` 格式。

#### 迁移的配置项

- **旧配置文件**：`~/.workflow/config/branch.toml`
- **新配置文件**：`~/.workflow/config/repositories.toml`

#### 配置格式变化

**旧格式**（`branch.toml`）：
```toml
[owner/repo1]
ignore = ["branch1", "branch2"]

[owner/repo2]
ignore = ["branch3"]
```

**新格式**（`repositories.toml`）：
```toml
[owner/repo1]
branch_ignore = ["branch1", "branch2"]
branch_prefix = "feature"  # 可选，新增字段

[owner/repo2]
branch_ignore = ["branch3"]
branch_prefix = "fix"  # 可选，新增字段
```

#### 主要变化

1. **字段重命名**：`ignore` → `branch_ignore`
2. **新增字段**：`branch_prefix`（按仓库配置分支前缀）
3. **配置文件重命名**：`branch.toml` → `repositories.toml`

---

## 🚀 迁移步骤

### 步骤 1：预览迁移（推荐）

在正式执行迁移前，建议先预览迁移结果：

```bash
workflow migrate --dry-run
```

这将显示：
- 需要迁移的仓库列表
- 需要合并的仓库列表（如果新配置已存在）
- 迁移后的配置预览

### 步骤 2：执行迁移

执行迁移命令：

```bash
workflow migrate
```

迁移系统会：
1. 自动检测是否存在旧的 `branch.toml` 文件
2. 读取旧配置并转换为新格式
3. 合并到现有的 `repositories.toml`（如果已存在）
4. 保存新配置
5. 记录迁移历史（避免重复执行）

### 步骤 3：验证迁移结果

迁移完成后，可以验证配置是否正确：

```bash
workflow config show branch
```

或者直接查看配置文件：

```bash
cat ~/.workflow/config/repositories.toml
```

### 步骤 4：清理旧文件（可选）

如果迁移成功且确认新配置正确，可以删除旧的配置文件：

```bash
workflow migrate cleanup
```

**注意**：清理操作会永久删除 `branch.toml` 文件，请确保迁移成功后再执行。

---

## ⚠️ 注意事项

### 1. 备份配置文件

在执行迁移前，建议备份现有配置文件：

```bash
# 备份旧配置
cp ~/.workflow/config/branch.toml ~/.workflow/config/branch.toml.backup

# 备份新配置（如果已存在）
cp ~/.workflow/config/repositories.toml ~/.workflow/config/repositories.toml.backup
```

### 2. 配置合并策略

如果新配置（`repositories.toml`）已存在，迁移系统会：
- **保留**新配置中的 `branch_prefix` 字段
- **合并**新旧配置中的 `branch_ignore` 列表（去重）

### 3. 迁移幂等性

迁移系统会记录已执行的迁移版本，避免重复执行。如果迁移已完成，再次运行 `workflow migrate` 会提示无需迁移。

### 4. 向后兼容

1.4.9 版本仍然支持读取旧的 `branch.toml` 格式（通过 serde alias），但建议尽快迁移到新格式。

---

## 🔍 迁移前后对比示例

### 迁移前

**`branch.toml`**：
```toml
[zevwings/workflow.rs]
ignore = ["main", "master", "develop"]

[zevwings/another-repo]
ignore = ["main"]
```

### 迁移后

**`repositories.toml`**：
```toml
[zevwings/workflow.rs]
branch_ignore = ["main", "master", "develop"]
branch_prefix = "feature"  # 如果已配置

[zevwings/another-repo]
branch_ignore = ["main"]
branch_prefix = "fix"  # 如果已配置
```

---

## 🔄 回滚说明

如果需要回滚迁移，可以：

1. **恢复备份文件**：
   ```bash
   cp ~/.workflow/config/branch.toml.backup ~/.workflow/config/branch.toml
   ```

2. **删除迁移历史**（如果需要重新迁移）：
   ```bash
   rm ~/.workflow/config/migration-history.toml
   ```

3. **删除新配置文件**（如果不需要）：
   ```bash
   rm ~/.workflow/config/repositories.toml
   ```

**注意**：回滚后，新版本的功能（如按仓库配置 `branch_prefix`）将不可用。

---

## ❓ 常见问题

### Q: 迁移后旧配置会被删除吗？

A: 默认情况下，迁移不会删除旧配置文件。只有在使用 `workflow migrate cleanup` 命令时才会删除。

### Q: 如果迁移失败怎么办？

A: 迁移失败不会影响现有配置。可以检查错误信息，修复问题后重新执行迁移。

### Q: 可以手动迁移吗？

A: 可以，但建议使用 `workflow migrate` 命令，因为它会正确处理配置合并和迁移历史记录。

### Q: 迁移会影响现有功能吗？

A: 不会。迁移是向后兼容的，即使不迁移，旧配置仍然可以正常使用。但新功能（如按仓库配置 `branch_prefix`）需要新格式的配置。

---

## 📚 相关文档

- [迁移系统架构说明](../../src/commands/migrate/README.md) - 迁移系统的技术实现
- [分支命令架构](../architecture/commands/BRANCH_COMMAND_ARCHITECTURE.md) - 分支配置相关说明

---

**最后更新**: 2025-12-09
**适用版本**: 1.4.8 → 1.4.9
