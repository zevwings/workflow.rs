# 从 1.5.6 升级到 1.5.7 的迁移说明

## 📋 概述

本文档说明如何从 Workflow CLI 1.5.6 升级到 1.5.7，以及配置格式的变化。

**重要**：本次升级包含配置格式变化，需要**手动迁移**配置文件。

---

## 🔄 配置变化

### Jira 配置文件合并

在 1.5.7 版本中，我们将两个独立的 Jira 配置文件合并为一个：

**旧配置结构**（1.5.6 及之前）：
- `~/.workflow/config/jira-status.toml` - Jira 项目状态映射配置
- `~/.workflow/config/jira-users.toml` - Jira 用户缓存配置

**新配置结构**（1.5.7 及之后）：
- `~/.workflow/config/jira.toml` - 合并后的 Jira 配置（包含状态和用户）

### 配置格式对比

#### 旧格式：`jira-status.toml`
```toml
[WEW]
created-pr = "In Progress"
merged-pr = "In Review"

[NA]
created-pr = "In Progress"
merged-pr = "In Review"
```

#### 旧格式：`jira-users.toml`
```toml
[[users]]
email = "zhang.wei@brain.im"
account-_id = "628d9616269a9a0068f27e0c"
display-_name = "Zhang Wei"
```

#### 新格式：`jira.toml`
```toml
[[users]]
email = "zhang.wei@brain.im"
account-_id = "628d9616269a9a0068f27e0c"
display-_name = "Zhang Wei"

[status.WEW]
created-pr = "In Progress"
merged-pr = "In Review"

[status.NA]
created-pr = "In Progress"
merged-pr = "In Review"
```

---

## 🚀 迁移步骤

升级到 1.5.7 后，可以使用迁移脚本自动合并配置文件，或手动迁移。

### 方式一：使用迁移脚本（推荐）

我们提供了跨平台的迁移脚本来简化迁移过程：

#### macOS/Linux（Shell 脚本）

**方式一：直接下载执行（推荐）**

```bash
# 预览迁移（推荐，先查看将要执行的操作）
curl -fsSL https://raw.githubusercontent.com/zevwings/workflow.rs/master/scripts/migrate/1.5.6-to-1.5.7.sh | bash -s -- --dry-run

# 执行迁移
curl -fsSL https://raw.githubusercontent.com/zevwings/workflow.rs/master/scripts/migrate/1.5.6-to-1.5.7.sh | bash -s --

# 执行迁移并删除旧文件
curl -fsSL https://raw.githubusercontent.com/zevwings/workflow.rs/master/scripts/migrate/1.5.6-to-1.5.7.sh | bash -s -- --cleanup
```

**方式二：本地执行**

```bash
# 预览迁移
bash scripts/migrate/1.5.6-to-1.5.7.sh --dry-run

# 执行迁移
bash scripts/migrate/1.5.6-to-1.5.7.sh

# 执行迁移并删除旧文件
bash scripts/migrate/1.5.6-to-1.5.7.sh --cleanup
```

#### Windows（PowerShell 脚本）

```powershell
# 预览迁移
.\scripts\migrate\1.5.6-to-1.5.7.ps1 -DryRun

# 执行迁移
.\scripts\migrate\1.5.6-to-1.5.7.ps1

# 执行迁移并删除旧文件
.\scripts\migrate\1.5.6-to-1.5.7.ps1 -Cleanup
```

**脚本功能**：
- 自动检测配置文件位置（支持 macOS iCloud 路径）
- 自动备份旧配置文件（`.bak` 后缀）
- 自动合并配置内容
- 验证配置格式
- 支持预览模式（`--dry-run` / `-DryRun`）
- 支持清理旧文件（`--cleanup` / `-Cleanup`）
- **自动安装依赖**：如果 `toml` 库未安装，脚本会自动安装

### 方式二：手动迁移

如果您不想使用脚本，也可以手动合并配置文件：

1. **备份现有配置**（推荐）：
   ```bash
   cp ~/.workflow/config/jira-status.toml ~/.workflow/config/jira-status.toml.bak
   cp ~/.workflow/config/jira-users.toml ~/.workflow/config/jira-users.toml.bak
   ```

2. **创建新的 `jira.toml` 文件**：
   ```bash
   touch ~/.workflow/config/jira.toml
   ```

3. **合并配置内容**：
   - 将 `jira-users.toml` 中的 `[[users]]` 部分复制到 `jira.toml`
   - 将 `jira-status.toml` 中的项目配置转换为 `[status.PROJECT_KEY]` 格式并添加到 `jira.toml`

4. **验证配置正确性**：
   ```bash
   cat ~/.workflow/config/jira.toml
   ```
   确认配置格式正确。

5. **测试功能**：
   ```bash
   workflow jira status configure PROJ
   workflow jira users get
   ```
   确认功能正常工作。

6. **删除旧配置文件**（可选）：
   ```bash
   rm ~/.workflow/config/jira-status.toml
   rm ~/.workflow/config/jira-users.toml
   ```
   确认新配置正常工作后，可以删除旧文件。

---

## ✅ 迁移验证

迁移完成后，可以通过以下方式验证：

1. **检查新配置文件**：
   ```bash
   cat ~/.workflow/config/jira.toml
   ```
   确认配置已正确合并，格式符合新结构。

2. **测试 Jira 功能**：
   ```bash
   workflow jira status configure PROJ
   workflow jira users get
   ```
   确认功能正常工作。

---

## ⚠️ 注意事项

1. **数据安全**：
   - **强烈建议**在迁移前备份配置文件
   - 迁移完成后，确认新配置正常工作再删除旧文件

2. **配置格式**：
   - 确保 `jira.toml` 中的状态配置使用 `[status.PROJECT_KEY]` 格式
   - 用户配置使用 `[[users]]` 数组表格式

3. **多用户环境**：
   - 每个用户的配置目录需要独立迁移
   - 不会影响其他用户的配置

4. **旧配置文件**：
   - 1.5.7 版本**不再支持**从旧配置文件读取
   - 必须完成迁移才能正常使用 Jira 功能

---

## 🔙 回滚说明

如果需要回滚到 1.5.6：

1. **恢复旧配置文件**：
   - 如果旧文件还在，直接使用即可
   - 如果已删除，可以从备份恢复

2. **降级软件版本**：
   ```bash
   # 卸载 1.5.7
   workflow uninstall

   # 安装 1.5.6
   # （根据您的安装方式）
   ```

3. **删除新配置文件**（可选）：
   ```bash
   rm ~/.workflow/config/jira.toml
   ```

**注意**：回滚后，1.5.6 版本无法读取新的 `jira.toml` 格式，必须使用旧格式的配置文件。

---

## 📝 常见问题

### Q: 迁移失败怎么办？

A: 如果迁移过程中出现问题：
1. 检查 `jira.toml` 文件的格式是否正确
2. 从备份恢复旧配置文件（`.bak` 文件）
3. 参考配置格式对比部分重新迁移
4. 或使用迁移脚本重新执行迁移
5. 或联系支持团队

### Q: 迁移脚本报错 "需要安装 toml 库" 怎么办？

A: 安装 `toml` 库：
```bash
pip install toml
```

或者使用手动迁移方式。

### Q: 可以跳过迁移吗？

A: **不可以**。1.5.7 版本不再支持旧配置文件格式，必须完成迁移才能正常使用 Jira 功能。

### Q: 迁移会影响现有功能吗？

A: 迁移完成后，所有功能都会正常工作。迁移只是将配置从两个文件合并为一个文件，功能本身没有变化。

### Q: 迁移脚本报错 "需要安装 toml 库" 怎么办？

A: 安装 `toml` 库：
```bash
pip install toml
```

或者使用手动迁移方式。

### Q: 如何确认迁移是否成功？

A: 检查：
1. `jira.toml` 文件是否存在且包含完整配置
2. Jira 相关功能是否正常工作（使用 `workflow jira` 命令测试）
3. 配置文件格式是否符合新结构

---

## 🔗 相关文档

- [配置文件合并分析](../requirements/CONFIG_FILES_MERGE_ANALYSIS.md) - 详细的配置合并方案分析
- [迁移系统架构说明](../architecture/commands/MIGRATE_COMMAND_ARCHITECTURE.md) - 迁移系统的技术实现
- [Jira 模块架构文档](../architecture/lib/JIRA_ARCHITECTURE.md) - Jira 模块的详细说明

---

**最后更新**: 2025-01-27
**适用版本**: 1.5.6 → 1.5.7
