# 从 1.5.6 升级到 1.5.7 的迁移说明

## 📋 概述

本文档说明如何从 Workflow CLI 1.5.6 升级到 1.5.7，以及配置格式的变化。

**重要**：本次升级包含配置格式变化，但**不需要手动迁移**。系统会在首次运行时自动检测并执行迁移。

---

## 🔄 配置变化

### Jira 配置文件合并

在 1.5.7 版本中，我们将两个独立的 Jira 配置文件合并为一个：

**旧配置结构**（1.5.6 及之前）：
- `~/.workflow/config/jira-status.toml` - Jira 项目状态映射配置
- `~/.workflow/config/jira-users.toml` - Jira 用户缓存配置

**新配置结构**（1.5.7 及之后）：
- `~/.workflow/config/jira.toml` - 合并后的 Jira 配置（包含状态和用户）

### 配置格式对比

#### 旧格式：`jira-status.toml`
```toml
[WEW]
created-pr = "In Progress"
merged-pr = "In Review"

[NA]
created-pr = "In Progress"
merged-pr = "In Review"
```

#### 旧格式：`jira-users.toml`
```toml
[[users]]
email = "zhang.wei@brain.im"
account_id = "628d9616269a9a0068f27e0c"
display_name = "Zhang Wei"
```

#### 新格式：`jira.toml`
```toml
[[users]]
email = "zhang.wei@brain.im"
account_id = "628d9616269a9a0068f27e0c"
display_name = "Zhang Wei"

[status.WEW]
created-pr = "In Progress"
merged-pr = "In Review"

[status.NA]
created-pr = "In Progress"
merged-pr = "In Review"
```

---

## 🚀 迁移步骤

### 自动迁移（推荐）

升级到 1.5.7 后，系统会在首次运行时自动检测并执行迁移：

1. **预览迁移**（可选，推荐）：
   ```bash
   workflow migrate --dry-run
   ```
   这会显示将要执行的迁移操作，但不会实际修改文件。

2. **执行迁移**：
   ```bash
   workflow migrate
   ```
   系统会自动：
   - 检测是否存在旧配置文件（`jira-status.toml` 和 `jira-users.toml`）
   - 读取旧配置并合并到新的 `jira.toml` 文件
   - 保留旧文件（用于备份）

3. **清理旧文件**（可选）：
   ```bash
   workflow migrate --cleanup
   ```
   迁移完成后，如果确认新配置正常工作，可以使用此命令删除旧配置文件。

### 手动迁移（不推荐）

如果您不想使用自动迁移，也可以手动合并配置文件：

1. 创建新的 `jira.toml` 文件
2. 将 `jira-users.toml` 中的 `[[users]]` 部分复制到 `jira.toml`
3. 将 `jira-status.toml` 中的项目配置转换为 `[status.PROJECT_KEY]` 格式
4. 验证配置正确性
5. 删除旧配置文件

**注意**：手动迁移容易出错，强烈建议使用自动迁移。

---

## ✅ 迁移验证

迁移完成后，可以通过以下方式验证：

1. **检查新配置文件**：
   ```bash
   cat ~/.workflow/config/jira.toml
   ```
   确认配置已正确合并。

2. **测试 Jira 功能**：
   ```bash
   workflow jira status configure PROJ
   workflow jira users get
   ```
   确认功能正常工作。

3. **检查迁移历史**：
   ```bash
   cat ~/.workflow/config/migration-history.toml
   ```
   应该包含 `v1.0.0` 的迁移记录。

---

## ⚠️ 注意事项

1. **向后兼容**：
   - 1.5.7 版本仍然支持从旧配置文件读取（迁移期间）
   - 但新配置会优先写入 `jira.toml`

2. **数据安全**：
   - 迁移过程不会删除旧文件（除非使用 `--cleanup`）
   - 建议在迁移前备份配置文件

3. **迁移幂等性**：
   - 迁移可以安全地重复执行
   - 已迁移的配置不会重复处理

4. **多用户环境**：
   - 每个用户的配置目录独立迁移
   - 不会影响其他用户的配置

---

## 🔙 回滚说明

如果需要回滚到 1.5.6：

1. **恢复旧配置文件**：
   - 如果旧文件还在，直接使用即可
   - 如果已删除，可以从备份恢复

2. **降级软件版本**：
   ```bash
   # 卸载 1.5.7
   workflow uninstall

   # 安装 1.5.6
   # （根据您的安装方式）
   ```

3. **删除新配置文件**（可选）：
   ```bash
   rm ~/.workflow/config/jira.toml
   ```

**注意**：回滚后，1.5.6 版本无法读取新的 `jira.toml` 格式，必须使用旧格式的配置文件。

---

## 📝 常见问题

### Q: 迁移失败怎么办？

A: 迁移失败时，旧配置文件不会被修改。可以：
1. 检查错误信息
2. 修复问题后重新执行迁移
3. 或联系支持团队

### Q: 可以跳过迁移吗？

A: 可以，但不推荐。跳过迁移会导致：
- 新功能可能无法正常工作
- 配置管理变得复杂
- 未来版本可能不再支持旧格式

### Q: 迁移会影响现有功能吗？

A: 不会。迁移是向后兼容的，现有功能在迁移前后都能正常工作。

### Q: 如何确认迁移是否成功？

A: 检查：
1. `jira.toml` 文件是否存在且包含完整配置
2. Jira 相关功能是否正常工作
3. `migration-history.toml` 中是否有 `v1.0.0` 记录

---

## 🔗 相关文档

- [配置文件合并分析](../requirements/CONFIG_FILES_MERGE_ANALYSIS.md) - 详细的配置合并方案分析
- [迁移系统架构说明](../architecture/commands/MIGRATE_COMMAND_ARCHITECTURE.md) - 迁移系统的技术实现
- [Jira 模块架构文档](../architecture/lib/JIRA_ARCHITECTURE.md) - Jira 模块的详细说明

---

**最后更新**: 2025-01-27
**适用版本**: 1.5.6 → 1.5.7
