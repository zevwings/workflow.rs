# Checksum æ ¡éªŒå’Œå·¥å…·æ¨¡å—æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

Checksum æ¨¡å—æ˜¯ Workflow CLI çš„åŸºç¡€è®¾æ–½æ¨¡å—ä¹‹ä¸€ï¼Œæä¾›æ–‡ä»¶æ ¡éªŒå’Œè®¡ç®—å’ŒéªŒè¯åŠŸèƒ½ã€‚è¯¥æ¨¡å—æ”¯æŒ SHA256 å“ˆå¸Œè®¡ç®—ã€æ ¡éªŒå’Œæ–‡ä»¶è§£æã€æ–‡ä»¶å®Œæ•´æ€§éªŒè¯å’Œæ ¡éªŒå’Œ URL æ„å»ºï¼Œä¸»è¦ç”¨äºæ›´æ–°å’Œå®‰è£…æµç¨‹ä¸­çš„æ–‡ä»¶å®Œæ•´æ€§éªŒè¯ã€‚

**æ¨¡å—ç»Ÿè®¡ï¼š**
- æ€»ä»£ç è¡Œæ•°ï¼šçº¦ 188 è¡Œ
- æ–‡ä»¶æ•°é‡ï¼š1 ä¸ª
- ä¸»è¦ç»„ä»¶ï¼š2 ä¸ªï¼ˆ`Checksum`ã€`VerifyResult`ï¼‰
- æ”¯æŒæ–¹æ³•ï¼š4 ä¸ªï¼ˆ`calculate_file_sha256()`ã€`parse_hash_from_content()`ã€`verify()`ã€`build_url()`ï¼‰

---

## ğŸ“ Lib å±‚æ¶æ„ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰

### æ ¸å¿ƒæ¨¡å—æ–‡ä»¶

```
src/lib/base/checksum/
â””â”€â”€ mod.rs          # æ ¡éªŒå’Œå·¥å…·å®ç° (188è¡Œ)
```

### ä¾èµ–æ¨¡å—

- **`sha2`**ï¼šSHA256 å“ˆå¸Œè®¡ç®—
  - ç‰ˆæœ¬ï¼š`0.10`
  - ç”¨é€”ï¼šè®¡ç®—æ–‡ä»¶çš„ SHA256 å“ˆå¸Œå€¼
- **`std::fs::File`**ï¼šæ–‡ä»¶è¯»å–
- **`std::io::Read`**ï¼šæµå¼è¯»å–æ¥å£

### æ¨¡å—é›†æˆ

#### Lifecycle æ¨¡å—é›†æˆ

- **æ›´æ–°åŠŸèƒ½**ï¼š
  - `LifecycleUpdateCommand` ä½¿ç”¨ `Checksum::verify()` éªŒè¯ä¸‹è½½çš„æ›´æ–°åŒ…å®Œæ•´æ€§
  - `Checksum::build_url()` æ„å»ºæ ¡éªŒå’Œæ–‡ä»¶çš„ä¸‹è½½ URL
  - `Checksum::parse_hash_from_content()` è§£æä¸‹è½½çš„æ ¡éªŒå’Œæ–‡ä»¶å†…å®¹

**å…³é”®æ–¹æ³•**ï¼š
- `LifecycleUpdateCommand::verify_checksum()` - ä½¿ç”¨ `Checksum::verify()` éªŒè¯æ–‡ä»¶å®Œæ•´æ€§

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¾è®¡åŸåˆ™

1. **æµå¼å¤„ç†**ï¼šä½¿ç”¨ 8KB ç¼“å†²åŒºé€å—è¯»å–æ–‡ä»¶ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤§
2. **é”™è¯¯å¤„ç†**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
3. **æ ¼å¼å…¼å®¹**ï¼šæ”¯æŒå¤šç§æ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼ï¼ˆ`"hash  filename"` æˆ– `"hash"`ï¼‰
4. **å·¥å…·ç±»è®¾è®¡**ï¼šä½¿ç”¨é™æ€æ–¹æ³•ï¼Œæ— éœ€å®ä¾‹åŒ–

### æ ¸å¿ƒç»„ä»¶

#### 1. Checksum ç»“æ„ä½“

**èŒè´£**ï¼šæä¾›æ–‡ä»¶æ ¡éªŒå’Œè®¡ç®—å’ŒéªŒè¯åŠŸèƒ½

**ä¸»è¦æ–¹æ³•**ï¼š

##### `calculate_file_sha256(file_path: &Path) -> Result<String>`

**åŠŸèƒ½**ï¼šè®¡ç®—æ–‡ä»¶çš„ SHA256 å“ˆå¸Œå€¼

**å®ç°ç»†èŠ‚**ï¼š
- ä½¿ç”¨ 8KB ç¼“å†²åŒºé€å—è¯»å–æ–‡ä»¶
- ä½¿ç”¨ `sha2::Sha256` è®¡ç®—å“ˆå¸Œå€¼
- è¿”å›åå…­è¿›åˆ¶å­—ç¬¦ä¸²

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- æµå¼è¯»å–ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜
- å›ºå®šå¤§å°ç¼“å†²åŒºï¼ˆ8192 å­—èŠ‚ï¼‰ï¼Œå‡å°‘å†…å­˜åˆ†é…

**ç¤ºä¾‹**ï¼š
```rust
use workflow::base::checksum::Checksum;
use std::path::Path;

let hash = Checksum::calculate_file_sha256(Path::new("file.tar.gz"))?;
println!("SHA256: {}", hash);
```

##### `parse_hash_from_content(content: &str) -> Result<String>`

**åŠŸèƒ½**ï¼šä»æ ¡éªŒå’Œæ–‡ä»¶å†…å®¹ä¸­æå–å“ˆå¸Œå€¼

**æ”¯æŒæ ¼å¼**ï¼š
- `"hash  filename"` æ ¼å¼ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
- `"hash"` æ ¼å¼ï¼ˆåªæœ‰å“ˆå¸Œå€¼ï¼‰

**å®ç°ç»†èŠ‚**ï¼š
- è¯»å–ç¬¬ä¸€è¡Œ
- æå–ç¬¬ä¸€ä¸ªç©ºç™½å­—ç¬¦åˆ†éš”çš„å­—æ®µï¼ˆå“ˆå¸Œå€¼ï¼‰

**ç¤ºä¾‹**ï¼š
```rust
use workflow::base::checksum::Checksum;

let content = "abc123def456  file.tar.gz";
let hash = Checksum::parse_hash_from_content(content)?;
assert_eq!(hash, "abc123def456");
```

##### `verify(file_path: &Path, expected_hash: &str) -> Result<VerifyResult>`

**åŠŸèƒ½**ï¼šéªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆé€šè¿‡æ¯”è¾ƒå“ˆå¸Œå€¼ï¼‰

**æµç¨‹**ï¼š
1. è®¡ç®—æ–‡ä»¶çš„å®é™… SHA256 å“ˆå¸Œå€¼
2. ä¸æœŸæœ›å“ˆå¸Œå€¼è¿›è¡Œæ¯”è¾ƒ
3. è¿”å›éªŒè¯ç»“æœ

**è¿”å›å€¼**ï¼š
- `Ok(VerifyResult { verified: true, ... })` - éªŒè¯é€šè¿‡
- `Err(_)` - éªŒè¯å¤±è´¥ï¼ˆå“ˆå¸Œå€¼ä¸åŒ¹é…ï¼‰

**ç¤ºä¾‹**ï¼š
```rust
use workflow::base::checksum::Checksum;
use std::path::Path;

let file_path = Path::new("file.tar.gz");
let expected_hash = "abc123def456...";
let result = Checksum::verify(file_path, expected_hash)?;
```

##### `build_url(url: &str) -> String`

**åŠŸèƒ½**ï¼šä»ä¸‹è½½ URL æ„å»ºæ ¡éªŒå’Œ URL

**è§„åˆ™**ï¼šåœ¨ä¸‹è½½ URL åæ·»åŠ  `.sha256` åç¼€

**ç¤ºä¾‹**ï¼š
```rust
use workflow::base::checksum::Checksum;

let url = "https://example.com/file.tar.gz";
let checksum_url = Checksum::build_url(url);
assert_eq!(checksum_url, "https://example.com/file.tar.gz.sha256");
```

#### 2. VerifyResult ç»“æ„ä½“

**èŒè´£**ï¼šè¡¨ç¤ºæ ¡éªŒå’ŒéªŒè¯ç»“æœ

**å­—æ®µ**ï¼š
- `verified: bool` - æ˜¯å¦éªŒè¯é€šè¿‡
- `messages: Vec<String>` - æ¶ˆæ¯åˆ—è¡¨

**ä½¿ç”¨åœºæ™¯**ï¼š
- `Checksum::verify()` è¿”å›éªŒè¯ç»“æœå’Œæ¶ˆæ¯

---

## ğŸ”„ è°ƒç”¨æµç¨‹ä¸æ•°æ®æµ

### å…¸å‹è°ƒç”¨æµç¨‹ï¼ˆæ›´æ–°åŠŸèƒ½ï¼‰

```
1. ä¸‹è½½æ›´æ–°åŒ…æ–‡ä»¶
   â†“
2. æ„å»ºæ ¡éªŒå’Œ URLï¼ˆChecksum::build_url()ï¼‰
   â†“
3. ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶
   â†“
4. è§£ææ ¡éªŒå’Œæ–‡ä»¶å†…å®¹ï¼ˆChecksum::parse_hash_from_content()ï¼‰
   â†“
5. éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆChecksum::verify()ï¼‰
   â”œâ”€ è®¡ç®—æ–‡ä»¶ SHA256ï¼ˆChecksum::calculate_file_sha256()ï¼‰
   â”œâ”€ æ¯”è¾ƒå“ˆå¸Œå€¼
   â””â”€ è¿”å›éªŒè¯ç»“æœ
```

### æ•°æ®æµ

```
æ–‡ä»¶è·¯å¾„
  â†“
Checksum::calculate_file_sha256()
  â”œâ”€ æ‰“å¼€æ–‡ä»¶
  â”œâ”€ æµå¼è¯»å–ï¼ˆ8KB ç¼“å†²åŒºï¼‰
  â”œâ”€ æ›´æ–° SHA256 å“ˆå¸Œå™¨
  â””â”€ è¿”å›åå…­è¿›åˆ¶å“ˆå¸Œå­—ç¬¦ä¸²

æ ¡éªŒå’Œæ–‡ä»¶å†…å®¹
  â†“
Checksum::parse_hash_from_content()
  â”œâ”€ è¯»å–ç¬¬ä¸€è¡Œ
  â”œâ”€ æå–å“ˆå¸Œå€¼
  â””â”€ è¿”å›å“ˆå¸Œå­—ç¬¦ä¸²

æ–‡ä»¶è·¯å¾„ + æœŸæœ›å“ˆå¸Œå€¼
  â†“
Checksum::verify()
  â”œâ”€ è®¡ç®—å®é™…å“ˆå¸Œå€¼
  â”œâ”€ æ¯”è¾ƒå“ˆå¸Œå€¼
  â””â”€ è¿”å› VerifyResult
```

---

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```rust
use workflow::base::checksum::Checksum;
use std::path::Path;

// è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
let hash = Checksum::calculate_file_sha256(Path::new("file.tar.gz"))?;
println!("SHA256: {}", hash);

// è§£ææ ¡éªŒå’Œæ–‡ä»¶
let content = "abc123def456  file.tar.gz";
let hash = Checksum::parse_hash_from_content(content)?;

// éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
let result = Checksum::verify(Path::new("file.tar.gz"), &hash)?;
if result.verified {
    println!("File integrity verified");
}

// æ„å»ºæ ¡éªŒå’Œ URL
let url = "https://example.com/file.tar.gz";
let checksum_url = Checksum::build_url(url);
```

### åœ¨æ›´æ–°æµç¨‹ä¸­ä½¿ç”¨

```rust
use workflow::base::checksum::Checksum;
use workflow::base::http::HttpClient;

// 1. ä¸‹è½½æ–‡ä»¶
let download_url = "https://github.com/user/repo/releases/download/v1.0.0/file.tar.gz";
// ... ä¸‹è½½æ–‡ä»¶ ...

// 2. æ„å»ºæ ¡éªŒå’Œ URL
let checksum_url = Checksum::build_url(download_url);

// 3. ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶
let checksum_content = HttpClient::new().get(&checksum_url)?.text()?;

// 4. è§£æå“ˆå¸Œå€¼
let expected_hash = Checksum::parse_hash_from_content(&checksum_content)?;

// 5. éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
let result = Checksum::verify(Path::new("file.tar.gz"), &expected_hash)?;
if !result.verified {
    return Err(eyre!("File integrity verification failed"));
}
```

---

## ğŸ” é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹

1. **æ–‡ä»¶æ“ä½œé”™è¯¯**ï¼š
   - æ–‡ä»¶æ‰“å¼€å¤±è´¥
   - æ–‡ä»¶è¯»å–å¤±è´¥

2. **æ ¼å¼é”™è¯¯**ï¼š
   - æ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼æ— æ•ˆ

3. **éªŒè¯å¤±è´¥**ï¼š
   - å“ˆå¸Œå€¼ä¸åŒ¹é…

### å®¹é”™æœºåˆ¶

- **æ–‡ä»¶ä¸å­˜åœ¨**ï¼šè¿”å›æ–‡ä»¶æ“ä½œé”™è¯¯
- **æ ¼å¼æ— æ•ˆ**ï¼šè¿”å›æ ¼å¼é”™è¯¯ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥æ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼
- **å“ˆå¸Œå€¼ä¸åŒ¹é…**ï¼šè¿”å›éªŒè¯å¤±è´¥é”™è¯¯ï¼Œæ˜¾ç¤ºæœŸæœ›å€¼å’Œå®é™…å€¼

---

## ğŸ“ æ‰©å±•æ€§

### æ·»åŠ æ–°çš„å“ˆå¸Œç®—æ³•

1. åœ¨ `Checksum` å®ç°ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼ˆå¦‚ `calculate_file_sha512()`ï¼‰
2. ä½¿ç”¨ç›¸åº”çš„å“ˆå¸Œåº“ï¼ˆå¦‚ `sha2::Sha512`ï¼‰
3. æ›´æ–° `verify()` æ–¹æ³•æ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•

### æ·»åŠ æ–°çš„æ ¡éªŒå’Œæ ¼å¼æ”¯æŒ

1. æ‰©å±• `parse_hash_from_content()` æ–¹æ³•
2. æ”¯æŒæ›´å¤šæ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼ï¼ˆå¦‚ MD5ã€SHA1 ç­‰ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸»æ¶æ„æ–‡æ¡£](./architecture.md)
- [Lifecycle æ¨¡å—æ¶æ„æ–‡æ¡£](./lifecycle.md) - æ›´æ–°åŠŸèƒ½ä½¿ç”¨æ ¡éªŒå’ŒéªŒè¯
- [HTTP æ¨¡å—æ¶æ„æ–‡æ¡£](./http.md) - ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶

---

## âœ… æ€»ç»“

Checksum æ¨¡å—é‡‡ç”¨æ¸…æ™°çš„å·¥å…·ç±»è®¾è®¡ï¼š

1. **æµå¼å¤„ç†**ï¼šä½¿ç”¨ 8KB ç¼“å†²åŒºé€å—è¯»å–ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤§
2. **æ ¼å¼å…¼å®¹**ï¼šæ”¯æŒå¤šç§æ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼
3. **é”™è¯¯å¤„ç†**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
4. **å·¥å…·ç±»è®¾è®¡**ï¼šä½¿ç”¨é™æ€æ–¹æ³•ï¼Œæ— éœ€å®ä¾‹åŒ–

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼Œæµå¼å¤„ç†å¤§æ–‡ä»¶
- âœ… æ ¼å¼å…¼å®¹ï¼Œæ”¯æŒå¤šç§æ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼
- âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- âœ… æ˜“äºä½¿ç”¨ï¼Œç®€æ´çš„ API

**å½“å‰å®ç°çŠ¶æ€**ï¼š
- âœ… SHA256 å“ˆå¸Œè®¡ç®—åŠŸèƒ½å®Œæ•´å®ç°
- âœ… æ ¡éªŒå’Œæ–‡ä»¶è§£æåŠŸèƒ½å®Œæ•´å®ç°
- âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯åŠŸèƒ½å®Œæ•´å®ç°
- âœ… æ ¡éªŒå’Œ URL æ„å»ºåŠŸèƒ½å®Œæ•´å®ç°
- âœ… å·²åœ¨æ›´æ–°æµç¨‹ä¸­ä½¿ç”¨

---

**æœ€åæ›´æ–°**: 2025-12-27

