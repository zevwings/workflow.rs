# Settings æ¨¡å—æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° Workflow CLI çš„ Settings æ¨¡å—æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š
- TOML é…ç½®æ–‡ä»¶çš„åŠ è½½å’Œç®¡ç†
- é…ç½®ç»“æ„ä½“å®šä¹‰ï¼ˆJiraã€GitHubã€æ—¥å¿—ã€LLMã€Codeupï¼‰
- è·¯å¾„ç®¡ç†ï¼ˆé…ç½®æ–‡ä»¶è·¯å¾„ã€å®‰è£…è·¯å¾„ã€Shell è·¯å¾„ï¼‰
- é»˜è®¤å€¼ç®¡ç†
- é…ç½®éªŒè¯åŠŸèƒ½

è¯¥æ¨¡å—ä¸ºæ•´ä¸ªåº”ç”¨æä¾›ç»Ÿä¸€çš„é…ç½®ç®¡ç†åŸºç¡€è®¾æ–½ï¼Œæ‰€æœ‰æ¨¡å—éƒ½é€šè¿‡ `Settings::get()` è·å–é…ç½®ã€‚

**æ¨¡å—ç»Ÿè®¡ï¼š**
- æ€»ä»£ç è¡Œæ•°ï¼šçº¦ 950 è¡Œ
- æ–‡ä»¶æ•°é‡ï¼š4 ä¸ªæ ¸å¿ƒæ–‡ä»¶
- ä¸»è¦ç»„ä»¶ï¼š3 ä¸ªï¼ˆSettings, Paths, defaultsï¼‰
- é…ç½®æ–‡ä»¶ï¼šworkflow.toml, llm.toml
- ç‰¹æ®ŠåŠŸèƒ½ï¼šiCloud å­˜å‚¨æ”¯æŒï¼ˆmacOSï¼‰

---

## ğŸ“ æ¨¡å—ç»“æ„

### æ ¸å¿ƒæ¨¡å—æ–‡ä»¶

```
src/lib/base/settings/
â”œâ”€â”€ mod.rs          # æ¨¡å—å£°æ˜å’Œå¯¼å‡º (11è¡Œ)
â”œâ”€â”€ settings.rs     # Settings ç»“æ„ä½“å’Œé…ç½®åŠ è½½ (440è¡Œ)
â”œâ”€â”€ paths.rs        # è·¯å¾„ç®¡ç†ï¼ˆåŒ…å« iCloud æ”¯æŒï¼Œçº¦ 637è¡Œï¼‰
â””â”€â”€ defaults.rs     # é»˜è®¤å€¼è¾…åŠ©å‡½æ•° (52è¡Œ)
```

### ä¾èµ–æ¨¡å—

- **`lib/base/http/`**ï¼šHTTP å®¢æˆ·ç«¯ï¼ˆç”¨äºé…ç½®éªŒè¯ï¼‰
- **`lib/jira/`**ï¼šJira ç±»å‹å®šä¹‰ï¼ˆç”¨äºé…ç½®éªŒè¯ï¼‰
- **`lib/pr/`**ï¼šGitHub å®¢æˆ·ç«¯ï¼ˆç”¨äºé…ç½®éªŒè¯ï¼‰
- **`lib/base/util/`**ï¼šå·¥å…·å‡½æ•°ï¼ˆæ—¥å¿—å®ã€æ•æ„Ÿå€¼æ©ç ï¼‰

### æ¨¡å—é›†æˆ

#### ä½¿ç”¨åœºæ™¯

- **é…ç½®è¯»å–**ï¼šæ‰€æœ‰æ¨¡å—é€šè¿‡ `Settings::get()` è·å–é…ç½®
- **é…ç½®éªŒè¯**ï¼šä½¿ç”¨ `Settings::verify()` éªŒè¯é…ç½®æ­£ç¡®æ€§
- **è·¯å¾„è·å–**ï¼šä½¿ç”¨ `Paths::workflow-_config()` ç­‰è·å–é…ç½®æ–‡ä»¶è·¯å¾„

#### LLM æ¨¡å—

- **`lib/base/llm/`**ï¼šLLM å®¢æˆ·ç«¯
  - `Settings::get().llm` - è·å– LLM é…ç½®
  - `Paths::llm-_config()` - è·å– LLM é…ç½®æ–‡ä»¶è·¯å¾„

#### Jira æ¨¡å—

- **`lib/jira/`**ï¼šJira å®¢æˆ·ç«¯
  - `Settings::get().jira` - è·å– Jira é…ç½®
  - `Paths::jira-_status-_config()` - è·å– Jira çŠ¶æ€é…ç½®æ–‡ä»¶è·¯å¾„
  - `Paths::jira-_users-_config()` - è·å– Jira ç”¨æˆ·é…ç½®æ–‡ä»¶è·¯å¾„

#### PR æ¨¡å—

- **`lib/pr/`**ï¼šPR å¹³å°æŠ½è±¡
  - `Settings::get().github` - è·å– GitHub é…ç½®
  - `Settings::get().codeup` - è·å– Codeup é…ç½®

#### Shell æ¨¡å—

- **`lib/base/shell/`**ï¼šShell é…ç½®ç®¡ç†
  - `Paths::config-_file(shell)` - è·å– Shell é…ç½®æ–‡ä»¶è·¯å¾„
  - `Paths::completion-_dir()` - è·å– completion ç›®å½•è·¯å¾„

#### Completion æ¨¡å—

- **`lib/completion/`**ï¼šCompletion ç®¡ç†
  - `Paths::completion-_dir()` - è·å– completion ç›®å½•è·¯å¾„

#### Rollback æ¨¡å—

- **`lib/rollback/`**ï¼šå›æ»šç®¡ç†
  - `Paths::completion-_dir()` - è·å– completion ç›®å½•è·¯å¾„ï¼ˆç”¨äºå¤‡ä»½ï¼‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¾è®¡åŸåˆ™

1. **å•ä¾‹æ¨¡å¼**ï¼šä½¿ç”¨ `OnceLock` å®ç°çº¿ç¨‹å®‰å…¨çš„å…¨å±€å•ä¾‹ï¼Œé…ç½®åªåŠ è½½ä¸€æ¬¡
2. **é»˜è®¤å€¼ä¼˜å…ˆ**ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–å­—æ®µç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸ä¸­æ–­ç¨‹åºè¿è¡Œ
3. **ç»Ÿä¸€è·¯å¾„ç®¡ç†**ï¼šæ‰€æœ‰è·¯å¾„é€šè¿‡ `Paths` ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…ç¡¬ç¼–ç 
4. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Rust ç±»å‹ç³»ç»Ÿä¿è¯é…ç½®ç»“æ„ä½“çš„ç±»å‹å®‰å…¨
5. **é…ç½®éªŒè¯**ï¼šæä¾›é…ç½®éªŒè¯åŠŸèƒ½ï¼Œç¡®ä¿é…ç½®æ­£ç¡®æ€§

### æ ¸å¿ƒç»„ä»¶

#### 1. Settingsï¼ˆé…ç½®ç»“æ„ä½“ï¼‰

**èŒè´£**ï¼šå®šä¹‰æ‰€æœ‰é…ç½®ç»“æ„ä½“å’Œé…ç½®åŠ è½½é€»è¾‘

**ä½ç½®**ï¼š`src/lib/base/settings/settings.rs`

**ä¸»è¦ç»“æ„ä½“**ï¼š
- `Settings` - ä¸»é…ç½®ç»“æ„ä½“ï¼ˆåŒ…å«æ‰€æœ‰å­é…ç½®ï¼‰
- `JiraSettings` - Jira é…ç½®
- `GitHubSettings` - GitHub é…ç½®ï¼ˆæ”¯æŒå¤šè´¦å·ï¼‰
- `GitHubAccount` - GitHub è´¦å·é…ç½®
- `LogSettings` - æ—¥å¿—é…ç½®
- `LLMSettings` - LLM é…ç½®
- `CodeupSettings` - Codeup é…ç½®

**å…³é”®æ–¹æ³•**ï¼š
- `Settings::get()` - è·å–ç¼“å­˜çš„å…¨å±€å•ä¾‹ï¼ˆæ¨èä½¿ç”¨ï¼‰
- `Settings::load()` - ä» TOML æ–‡ä»¶åŠ è½½é…ç½®
- `Settings::verify()` - éªŒè¯å¹¶æ˜¾ç¤ºæ‰€æœ‰é…ç½®

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **å•ä¾‹æ¨¡å¼**ï¼šä½¿ç”¨ `OnceLock` å®ç°çº¿ç¨‹å®‰å…¨çš„å…¨å±€å•ä¾‹
- âœ… **è‡ªåŠ¨åŠ è½½**ï¼šé¦–æ¬¡è°ƒç”¨æ—¶è‡ªåŠ¨ä» TOML æ–‡ä»¶åŠ è½½
- âœ… **é»˜è®¤å€¼æ”¯æŒ**ï¼šä½¿ç”¨ `#[serde(default)]` å’Œ `Default` trait
- âœ… **é…ç½®éªŒè¯**ï¼šæä¾› Jira å’Œ GitHub é…ç½®éªŒè¯åŠŸèƒ½
- âœ… **æƒé™æ£€æŸ¥**ï¼šUnix ç³»ç»Ÿä¸‹æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™ï¼ˆå»ºè®® 600ï¼‰

#### 2. Pathsï¼ˆè·¯å¾„ç®¡ç†å™¨ï¼‰

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰è·¯å¾„ä¿¡æ¯

**ä½ç½®**ï¼š`src/lib/base/settings/paths.rs`

**è·¯å¾„åˆ†ç±»**ï¼š
- **é…ç½®è·¯å¾„**ï¼šé…ç½®æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶è·¯å¾„
- **å®‰è£…è·¯å¾„**ï¼šäºŒè¿›åˆ¶æ–‡ä»¶å’Œè¡¥å…¨è„šæœ¬è·¯å¾„
- **Shell è·¯å¾„**ï¼šShell é…ç½®æ–‡ä»¶å’Œ completion ç›®å½•

**å…³é”®æ–¹æ³•**ï¼š
- **é…ç½®è·¯å¾„**ï¼š
  - `config-_dir()` - è·å–é…ç½®ç›®å½•ï¼ˆ`~/.workflow/config/`ï¼‰
  - `workflow-_config()` - è·å–ä¸»é…ç½®æ–‡ä»¶è·¯å¾„
  - `llm-_config()` - è·å– LLM é…ç½®æ–‡ä»¶è·¯å¾„
  - `jira-_status-_config()` - è·å– Jira çŠ¶æ€é…ç½®æ–‡ä»¶è·¯å¾„
  - `jira-_users-_config()` - è·å– Jira ç”¨æˆ·é…ç½®æ–‡ä»¶è·¯å¾„
  - `workflow-_dir()` - è·å–å·¥ä½œæµç›®å½•ï¼ˆ`~/.workflow/`ï¼‰
  - `work-_history-_dir()` - è·å–å·¥ä½œå†å²è®°å½•ç›®å½•
- **å®‰è£…è·¯å¾„**ï¼š
  - `command-_names()` - è·å–æ‰€æœ‰å‘½ä»¤åç§°
  - `binary-_install-_dir()` - è·å–äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…ç›®å½•
  - `binary-_paths()` - è·å–æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å®Œæ•´è·¯å¾„
  - `completion-_dir()` - è·å– completion ç›®å½•è·¯å¾„
- **Shell è·¯å¾„**ï¼š
  - `config-_file(shell)` - è·å– Shell é…ç½®æ–‡ä»¶è·¯å¾„

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **è‡ªåŠ¨åˆ›å»ºç›®å½•**ï¼šè·¯å¾„ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»º
- âœ… **æƒé™ç®¡ç†**ï¼šUnix ç³»ç»Ÿä¸‹è‡ªåŠ¨è®¾ç½®ç›®å½•æƒé™ï¼ˆ700ï¼‰
- âœ… **å¤š Shell æ”¯æŒ**ï¼šæ”¯æŒ zshã€bashã€fishã€powershellã€elvish
- âœ… **è·¯å¾„ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰è·¯å¾„é›†ä¸­ç®¡ç†ï¼Œé¿å…ç¡¬ç¼–ç 
- âœ… **iCloud å­˜å‚¨æ”¯æŒ**ï¼šmacOS ä¸Šè‡ªåŠ¨ä½¿ç”¨ iCloud Drive å­˜å‚¨é…ç½®ï¼ˆå¯é€‰ï¼‰

#### iCloud å­˜å‚¨æ”¯æŒï¼ˆmacOSï¼‰

**åŠŸèƒ½æ¦‚è¿°**ï¼š
åœ¨ macOS ä¸Šï¼Œ`Paths` æ¨¡å—æ”¯æŒè‡ªåŠ¨å°†é…ç½®æ–‡ä»¶å­˜å‚¨åˆ° iCloud Driveï¼Œå®ç°è·¨è®¾å¤‡åŒæ­¥ã€‚è¯¥åŠŸèƒ½é€šè¿‡ `config-_base-_dir()` æ–¹æ³•å®ç°ï¼Œè‡ªåŠ¨åœ¨ iCloud å’Œæœ¬åœ°å­˜å‚¨ä¹‹é—´é€‰æ‹©æœ€ä½³ä½ç½®ã€‚

**è®¾è®¡åŸåˆ™**ï¼š
1. **è‡ªåŠ¨é€‰æ‹©**ï¼šç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³å­˜å‚¨ä½ç½®ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨é…ç½®
2. **é€æ˜å›é€€**ï¼šiCloud ä¸å¯ç”¨æ—¶è‡ªåŠ¨å›é€€åˆ°æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿åŠŸèƒ½å¯ç”¨
3. **é€‰æ‹©æ€§åŒæ­¥**ï¼šé…ç½®åŒæ­¥åˆ° iCloudï¼Œå·¥ä½œå†å²ç­‰ä¿æŒæœ¬åœ°ï¼ˆé¿å…å†²çªï¼‰
4. **å¹³å°å…¼å®¹**ï¼šé macOS å¹³å°è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†
5. **ç”¨æˆ·æ§åˆ¶**ï¼šæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `WORKFLOW_DISABLE_ICLOUD` å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨

**æ ¸å¿ƒæ–¹æ³•**ï¼š

- **`try-_icloud-_base-_dir()`** (ç§æœ‰æ–¹æ³•ï¼Œä»… macOS)ï¼š
  - æ£€æŸ¥ iCloud Drive æ˜¯å¦å¯ç”¨ï¼ˆ`~/Library/Mobile Documents/com~apple~CloudDocs`ï¼‰
  - å¦‚æœå¯ç”¨ï¼Œåˆ›å»ºå¹¶è¿”å› `~/.workflow/` ç›®å½•åœ¨ iCloud ä¸­çš„è·¯å¾„
  - è®¾ç½®ç›®å½•æƒé™ä¸º 700ï¼ˆä»…ç”¨æˆ·å¯è®¿é—®ï¼‰
  - å¦‚æœä¸å¯ç”¨æˆ–åˆ›å»ºå¤±è´¥ï¼Œè¿”å› `None`

- **`config-_base-_dir()`** (ç§æœ‰æ–¹æ³•)ï¼š
  - å†³ç­–é€»è¾‘ï¼š
    1. æ£€æŸ¥ç¯å¢ƒå˜é‡ `WORKFLOW_DISABLE_ICLOUD`ï¼Œå¦‚æœå·²è®¾ç½®åˆ™ä½¿ç”¨æœ¬åœ°å­˜å‚¨
    2. åœ¨ macOS ä¸Šå°è¯• iCloud å­˜å‚¨
    3. å¦‚æœ iCloud ä¸å¯ç”¨ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨
  - è¿”å›é…ç½®åŸºç¡€ç›®å½•è·¯å¾„

**å­˜å‚¨ä½ç½®å†³ç­–æµç¨‹**ï¼š

```
config-_base-_dir()
  â†“
æ£€æŸ¥ç¯å¢ƒå˜é‡ WORKFLOW_DISABLE_ICLOUD
  â”œâ”€ å·²è®¾ç½® â†’ ä½¿ç”¨æœ¬åœ°å­˜å‚¨ (~/.workflow/)
  â””â”€ æœªè®¾ç½® â†’ ç»§ç»­
  â†“
[ä»… macOS] å°è¯• iCloud å­˜å‚¨
  â”œâ”€ iCloud å¯ç”¨ â†’ ä½¿ç”¨ iCloud (~/Library/Mobile Documents/.../.workflow/)
  â””â”€ iCloud ä¸å¯ç”¨ â†’ å›é€€åˆ°æœ¬åœ°å­˜å‚¨
  â†“
è¿”å›è·¯å¾„
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- **é…ç½®åŒæ­¥**ï¼šé…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ iCloudï¼Œè‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»– macOS è®¾å¤‡
- **å·¥ä½œå†å²ä¿æŒæœ¬åœ°**ï¼š`work-_history-_dir()` å’Œ `completion-_dir()` å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œé¿å…å†²çª

**ç¯å¢ƒå˜é‡æ§åˆ¶**ï¼š
- `WORKFLOW_DISABLE_ICLOUD=1`ï¼šå¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå³ä½¿ iCloud å¯ç”¨

**æŸ¥è¯¢ API**ï¼š
- `Paths::is-_config-_in-_icloud()` - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ iCloud å­˜å‚¨
- `Paths::storage-_location()` - è·å–å­˜å‚¨ä½ç½®æè¿°
- `Paths::storage-_info()` - è·å–è¯¦ç»†å­˜å‚¨ä¿¡æ¯

**ç¤ºä¾‹**ï¼š
```rust
use workflow::base::settings::Paths;

// è‡ªåŠ¨é€‰æ‹©å­˜å‚¨ä½ç½®ï¼ˆiCloud æˆ–æœ¬åœ°ï¼‰
let config-_dir = Paths::config-_dir()?;

// æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ iCloud
if Paths::is-_config-_in-_icloud() {
    log-_message!("é…ç½®å­˜å‚¨åœ¨ iCloudï¼Œä¼šè‡ªåŠ¨åŒæ­¥");
}

// å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å­˜å‚¨
std::env::set-_var("WORKFLOW_DISABLE_ICLOUD", "1");
let local-_config-_dir = Paths::config-_dir()?;  // æ€»æ˜¯è¿”å›æœ¬åœ°è·¯å¾„
```

#### 3. defaultsï¼ˆé»˜è®¤å€¼æ¨¡å—ï¼‰

**èŒè´£**ï¼šæä¾›é…ç½®ç»“æ„ä½“çš„é»˜è®¤å€¼å®ç°å’Œè¾…åŠ©å‡½æ•°

**ä½ç½®**ï¼š`src/lib/base/settings/defaults.rs`

**ä¸»è¦å‡½æ•°**ï¼š
- `default-_log-_folder()` - é»˜è®¤æ—¥å¿—æ–‡ä»¶å¤¹åç§°ï¼ˆ"logs"ï¼‰
- `default-_download-_base-_dir()` - é»˜è®¤ä¸‹è½½åŸºç¡€ç›®å½•
- `default-_download-_base-_dir-_option()` - é»˜è®¤ä¸‹è½½åŸºç¡€ç›®å½•ï¼ˆOption ç±»å‹ï¼‰
- `default-_log-_settings()` - é»˜è®¤ LogSettings å®ä¾‹
- `default-_response-_format()` - é»˜è®¤ LLM å“åº”æ ¼å¼è·¯å¾„
- `default-_llm-_provider()` - é»˜è®¤ LLM Providerï¼ˆ"openai"ï¼‰
- `default-_llm-_model(provider)` - æ ¹æ® Provider è·å–é»˜è®¤æ¨¡å‹

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… **é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰é»˜è®¤å€¼é›†ä¸­åœ¨ä¸€ä¸ªæ¨¡å—
- âœ… **Provider ç‰¹å®šé»˜è®¤å€¼**ï¼šLLM æ¨¡å‹æ ¹æ® Provider æä¾›ä¸åŒé»˜è®¤å€¼

### è®¾è®¡æ¨¡å¼

#### 1. å•ä¾‹æ¨¡å¼

é€šè¿‡ `OnceLock` å®ç°çº¿ç¨‹å®‰å…¨çš„å…¨å±€å•ä¾‹ï¼š

```rust
pub fn get() -> &'static Settings {
    static SETTINGS: OnceLock<Settings> = OnceLock::new();
    SETTINGS.get-_or-_init(Self::load)
}
```

**ä¼˜åŠ¿**ï¼š
- é…ç½®åªåŠ è½½ä¸€æ¬¡ï¼Œæé«˜æ€§èƒ½
- çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨ä½¿ç”¨
- ç»Ÿä¸€ç®¡ç†ï¼Œæ‰€æœ‰æ¨¡å—ä½¿ç”¨åŒä¸€ä¸ªé…ç½®å®ä¾‹

#### 2. é»˜è®¤å€¼æ¨¡å¼

ä½¿ç”¨ `#[serde(default)]` å’Œ `Default` trait æä¾›é»˜è®¤å€¼ï¼š

```rust
#[derive(Debug, Clone, Default, Serialize, Deserialize)]
pub struct Settings {
    #[serde(default)]
    pub jira: JiraSettings,
    // ...
}
```

**ä¼˜åŠ¿**ï¼š
- é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–å­—æ®µç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼
- ä¸ä¸­æ–­ç¨‹åºè¿è¡Œ
- æä¾›åˆç†çš„é»˜è®¤å€¼ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

#### 3. è·¯å¾„ç»Ÿä¸€ç®¡ç†æ¨¡å¼

é€šè¿‡ `Paths` ç»“æ„ä½“ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è·¯å¾„ï¼š

```rust
pub struct Paths;

impl Paths {
    pub fn workflow-_config() -> Result<PathBuf> { ... }
    pub fn completion-_dir() -> Result<PathBuf> { ... }
    // ...
}
```

**ä¼˜åŠ¿**ï¼š
- é¿å…ç¡¬ç¼–ç è·¯å¾„
- é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤
- è‡ªåŠ¨åˆ›å»ºç›®å½•å’Œè®¾ç½®æƒé™

### é”™è¯¯å¤„ç†

#### åˆ†å±‚é”™è¯¯å¤„ç†

1. **è·¯å¾„è·å–å¤±è´¥**ï¼š
   - `HOME` ç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼šè¿”å›é”™è¯¯
   - ç›®å½•åˆ›å»ºå¤±è´¥ï¼šè¿”å›é”™è¯¯

2. **é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥**ï¼š
   - æ–‡ä»¶ä¸å­˜åœ¨ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™
   - è¯»å–å¤±è´¥ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™
   - è§£æå¤±è´¥ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™

3. **é…ç½®éªŒè¯å¤±è´¥**ï¼š
   - Jira éªŒè¯å¤±è´¥ï¼šæ˜¾ç¤ºè­¦å‘Šï¼Œä¸ä¸­æ–­æµç¨‹
   - GitHub éªŒè¯å¤±è´¥ï¼šæ˜¾ç¤ºè­¦å‘Šï¼Œä¸ä¸­æ–­æµç¨‹

#### å®¹é”™æœºåˆ¶

- **é…ç½®æ–‡ä»¶ä¸å­˜åœ¨**ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™
- **å­—æ®µç¼ºå¤±**ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™
- **TOML è§£æå¤±è´¥**ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™
- **é…ç½®éªŒè¯å¤±è´¥**ï¼šæ˜¾ç¤ºè­¦å‘Šï¼Œä¸ä¸­æ–­æµç¨‹

---

## ğŸ”„ è°ƒç”¨æµç¨‹ä¸æ•°æ®æµ

### æ•´ä½“æ¶æ„æµç¨‹

```
åº”ç”¨å¯åŠ¨æˆ–é¦–æ¬¡ä½¿ç”¨
  â†“
Settings::get() (è·å–å…¨å±€å•ä¾‹)
  â†“
Settings::load() (ä» TOML æ–‡ä»¶åŠ è½½)
  â”œâ”€ Paths::workflow-_config() (è·å–é…ç½®æ–‡ä»¶è·¯å¾„)
  â”œâ”€ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  â”œâ”€ è¯»å– TOML æ–‡ä»¶å†…å®¹
  â”œâ”€ è§£æä¸º Settings ç»“æ„ä½“
  â””â”€ ä½¿ç”¨é»˜è®¤å€¼å¡«å……ç¼ºå¤±å­—æ®µ
  â†“
ç¼“å­˜åˆ° OnceLockï¼ˆå•ä¾‹ï¼‰
  â†“
è¿”å› Settings å¼•ç”¨
```

### é…ç½®åŠ è½½æµç¨‹

```
Settings::load()
  â†“
1. Paths::workflow-_config()              # è·å–é…ç½®æ–‡ä»¶è·¯å¾„
  â†“
2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  â”œâ”€ ä¸å­˜åœ¨ â†’ è¿”å›é»˜è®¤å€¼
  â””â”€ å­˜åœ¨ â†’ ç»§ç»­
  â†“
3. æ£€æŸ¥æ–‡ä»¶æƒé™ï¼ˆUnix ç³»ç»Ÿï¼‰
  â”œâ”€ æƒé™è¿‡å®½ â†’ è­¦å‘Š
  â””â”€ ç»§ç»­
  â†“
4. è¯»å–æ–‡ä»¶å†…å®¹
  â”œâ”€ è¯»å–å¤±è´¥ â†’ è¿”å›é»˜è®¤å€¼
  â””â”€ æˆåŠŸ â†’ ç»§ç»­
  â†“
5. è§£æ TOML
  â”œâ”€ è§£æå¤±è´¥ â†’ è¿”å›é»˜è®¤å€¼
  â””â”€ æˆåŠŸ â†’ ä½¿ç”¨ #[serde(default)] å¡«å……ç¼ºå¤±å­—æ®µ
  â†“
6. è¿”å› Settings å®ä¾‹
```

### é…ç½®éªŒè¯æµç¨‹

```
Settings::verify()
  â†“
1. print-_log()                            # æ˜¾ç¤ºæ—¥å¿—é…ç½®
2. print-_llm()                            # æ˜¾ç¤º LLM é…ç½®
3. verify-_codeup()                        # æ˜¾ç¤º Codeup é…ç½®
4. verify-_jira()                          # éªŒè¯ Jira é…ç½®
  â”œâ”€ æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
  â”œâ”€ å‘é€ HTTP è¯·æ±‚éªŒè¯
  â””â”€ æ˜¾ç¤ºéªŒè¯ç»“æœ
5. verify-_github()                        # éªŒè¯ GitHub é…ç½®
  â”œâ”€ éå†æ‰€æœ‰è´¦å·
  â”œâ”€ ä½¿ç”¨ API Token éªŒè¯æ¯ä¸ªè´¦å·
  â””â”€ æ˜¾ç¤ºéªŒè¯ç»“æœ
```

---

```
workflow.toml (TOML æ–‡ä»¶)
  â†“
fs::read-_to-_string() (è¯»å–æ–‡ä»¶)
  â†“
toml::from-_str() (è§£æ TOML)
  â†“
Settings ç»“æ„ä½“ï¼ˆä½¿ç”¨ #[serde(default)] å¡«å……ç¼ºå¤±å­—æ®µï¼‰
  â†“
OnceLock ç¼“å­˜ï¼ˆå•ä¾‹ï¼‰
  â†“
Settings::get() (è¿”å›å¼•ç”¨)
```

#### é…ç½®éªŒè¯æ•°æ®æµ

```
Settings::verify()
  â†“
æ˜¾ç¤ºé…ç½®ï¼ˆprint-_log, print-_llm, verify-_codeupï¼‰
  â†“
éªŒè¯ Jiraï¼ˆverify-_jiraï¼‰
  â”œâ”€ HttpClient::global() (å‘é€ HTTP è¯·æ±‚)
  â””â”€ æ˜¾ç¤ºéªŒè¯ç»“æœ
  â†“
éªŒè¯ GitHubï¼ˆverify-_githubï¼‰
  â”œâ”€ GitHub::get-_user-_info() (éªŒè¯æ¯ä¸ªè´¦å·)
  â””â”€ æ˜¾ç¤ºéªŒè¯ç»“æœ
```

---

## ğŸ“ æ‰©å±•æ€§

### æ·»åŠ æ–°é…ç½®é¡¹

1. åœ¨ `settings.rs` ä¸­æ·»åŠ æ–°çš„é…ç½®ç»“æ„ä½“ï¼ˆå¦‚ `NewSettings`ï¼‰
2. åœ¨ `Settings` ç»“æ„ä½“ä¸­æ·»åŠ æ–°å­—æ®µï¼ˆä½¿ç”¨ `#[serde(default)]`ï¼‰
3. åœ¨ `defaults.rs` ä¸­æ·»åŠ é»˜è®¤å€¼å‡½æ•°ï¼ˆå¦‚éœ€è¦ï¼‰
4. åœ¨ `Settings::verify()` ä¸­æ·»åŠ éªŒè¯é€»è¾‘ï¼ˆå¦‚éœ€è¦ï¼‰

**ç¤ºä¾‹**ï¼š
```rust
// settings.rs
#[derive(Debug, Clone, Default, Serialize, Deserialize)]
pub struct NewSettings {
    pub key: Option<String>,
}

#[derive(Debug, Clone, Default, Serialize, Deserialize)]
pub struct Settings {
    // ...
    #[serde(default)]
    pub new: NewSettings,
}
```

### æ·»åŠ æ–°è·¯å¾„

1. åœ¨ `paths.rs` çš„ `Paths` å®ç°ä¸­æ·»åŠ æ–°æ–¹æ³•
2. ä½¿ç”¨ `config-_dir()` æˆ– `workflow-_dir()` ä½œä¸ºåŸºç¡€è·¯å¾„
3. è‡ªåŠ¨åˆ›å»ºç›®å½•å’Œè®¾ç½®æƒé™ï¼ˆå¦‚éœ€è¦ï¼‰

**ç¤ºä¾‹**ï¼š
```rust
impl Paths {
    pub fn new-_config-_file() -> Result<PathBuf> {
        Ok(Self::config-_dir()?.join("new-config.toml"))
    }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸»æ¶æ„æ–‡æ¡£](../architecture.md)
- [é…ç½®ç®¡ç†å‘½ä»¤æ¨¡å—æ¶æ„æ–‡æ¡£](../commands/config.md) - å‘½ä»¤å±‚å¦‚ä½•ä½¿ç”¨ Settings æ¨¡å—
- [LLM æ¨¡å—æ¶æ„æ–‡æ¡£](./llm.md) - LLM æ¨¡å—å¦‚ä½•ä½¿ç”¨ Settings
- [Jira æ¨¡å—æ¶æ„æ–‡æ¡£](./jira.md) - Jira æ¨¡å—å¦‚ä½•ä½¿ç”¨ Settings
- [Shell æ¨¡å—æ¶æ„æ–‡æ¡£](./SHELL_architecture.md) - Shell æ¨¡å—å¦‚ä½•ä½¿ç”¨ Paths

**æ³¨æ„**ï¼šiCloud å­˜å‚¨åŠŸèƒ½æ˜¯ Settings æ¨¡å—çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡ `Paths` ç»“æ„ä½“å®ç°ã€‚è¯¦ç»†è¯´æ˜è§æœ¬æ–‡æ¡£çš„"Pathsï¼ˆè·¯å¾„ç®¡ç†å™¨ï¼‰"ç« èŠ‚ã€‚

---

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```rust
use workflow::base::settings::Settings;

// è·å–å…¨å±€é…ç½®ï¼ˆæ¨èï¼‰
let settings = Settings::get();

// è·å– Jira é…ç½®
if let Some(email) = &settings.jira.email {
    log-_message!("Jira email: {}", email);
}

// è·å– GitHub å½“å‰è´¦å·
if let Some(account) = settings.github.get-_current-_account() {
    log-_message!("GitHub account: {}", account.name);
}

// è·å– LLM é…ç½®
log-_message!("LLM provider: {}", settings.llm.provider);
```

### ä½¿ç”¨ Paths

```rust
use workflow::base::settings::Paths;

// è·å–é…ç½®æ–‡ä»¶è·¯å¾„
let config-_path = Paths::workflow-_config()?;

// è·å– completion ç›®å½•
let completion-_dir = Paths::completion-_dir()?;

// è·å– Shell é…ç½®æ–‡ä»¶è·¯å¾„
use clap-_complete::shells::Shell;
let zshrc = Paths::config-_file(&Shell::Zsh)?;
```

### é…ç½®éªŒè¯

```rust
use workflow::base::settings::Settings;

// åŠ è½½é…ç½®ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
let settings = Settings::load();

// éªŒè¯é…ç½®
settings.verify()?;
```

---

## âœ… æ€»ç»“

Settings æ¨¡å—é‡‡ç”¨æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡ï¼š

1. **å•ä¾‹æ¨¡å¼**ï¼š`Settings::get()` å®ç°çº¿ç¨‹å®‰å…¨çš„å…¨å±€å•ä¾‹
2. **é»˜è®¤å€¼æ”¯æŒ**ï¼šä½¿ç”¨ `#[serde(default)]` å’Œ `Default` trait
3. **è·¯å¾„ç»Ÿä¸€ç®¡ç†**ï¼š`Paths` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è·¯å¾„
4. **é…ç½®éªŒè¯**ï¼šæä¾› Jira å’Œ GitHub é…ç½®éªŒè¯åŠŸèƒ½
5. **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°é…ç½®é¡¹åªéœ€æ‰©å±•ç»“æ„ä½“

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… **é«˜æ€§èƒ½**ï¼šå•ä¾‹æ¨¡å¼ï¼Œé…ç½®åªåŠ è½½ä¸€æ¬¡
- âœ… **å®¹é”™æ€§**ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–å­—æ®µç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼
- âœ… **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Rust ç±»å‹ç³»ç»Ÿä¿è¯ç±»å‹å®‰å…¨
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰è·¯å¾„é›†ä¸­ç®¡ç†ï¼Œé¿å…ç¡¬ç¼–ç 
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°é…ç½®é¡¹åªéœ€æ‰©å±•ç»“æ„ä½“
- âœ… **è·¨è®¾å¤‡åŒæ­¥**ï¼šmacOS ä¸Šæ”¯æŒ iCloud å­˜å‚¨ï¼Œè‡ªåŠ¨åŒæ­¥é…ç½®

é€šè¿‡å•ä¾‹æ¨¡å¼ã€é»˜è®¤å€¼æ”¯æŒã€è·¯å¾„ç»Ÿä¸€ç®¡ç†å’Œ iCloud å­˜å‚¨æ”¯æŒï¼Œå®ç°äº†é«˜æ€§èƒ½ã€å®¹é”™æ€§ã€æ˜“äºç»´æŠ¤å’Œè·¨è®¾å¤‡åŒæ­¥çš„ç›®æ ‡ã€‚

---

**æœ€åæ›´æ–°**: 2025-12-16
