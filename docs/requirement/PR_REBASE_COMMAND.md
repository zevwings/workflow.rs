# PR Rebase å‘½ä»¤è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° `pr rebase` å‘½ä»¤çš„è®¾è®¡ï¼Œè¯¥å‘½ä»¤ç”¨äºå°†å½“å‰åˆ†æ”¯ rebase åˆ°ç›®æ ‡åˆ†æ”¯å¹¶æ›´æ–° PR çš„ base åˆ†æ”¯ã€‚

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2024-12

---

## ä¸€ã€å‘½ä»¤æ¦‚è¿°

**å‘½ä»¤åç§°**: `pr rebase`

**åŠŸèƒ½æè¿°**: å°†å½“å‰åˆ†æ”¯ rebase åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆTARGET_BRANCHï¼‰ï¼Œå¹¶æ›´æ–°ç°æœ‰ PR çš„ base åˆ†æ”¯ã€‚ç”¨äºä¿®æ­£å½“å‰åˆ†æ”¯çš„åŸºç¡€åˆ†æ”¯ã€‚

**å‘½ä»¤æ ¼å¼**:
```bash
workflow pr rebase <TARGET_BRANCH> [OPTIONS]
```

---

## äºŒã€åŠŸèƒ½è®¾è®¡

### 2.1 æ ¸å¿ƒåŠŸèƒ½

1. **Rebase å½“å‰åˆ†æ”¯**
   - å°†å½“å‰åˆ†æ”¯ rebase åˆ° TARGET_BRANCH
   - æ”¹å˜å½“å‰åˆ†æ”¯çš„åŸºç¡€åˆ†æ”¯
   - é‡å†™æäº¤å†å²

2. **æ›´æ–° PR çš„ base åˆ†æ”¯**
   - æ£€æµ‹å½“å‰åˆ†æ”¯æ˜¯å¦æœ‰ PR
   - é€šè¿‡ API æ›´æ–° PR çš„ base åˆ†æ”¯ä¸º TARGET_BRANCH
   - æ”¯æŒä¸æ›´æ–° PRï¼ˆåªæ‰§è¡Œ rebaseï¼‰

3. **å®‰å…¨æ¨é€**
   - ä½¿ç”¨ `--force-with-lease` å¼ºåˆ¶æ¨é€
   - é¿å…è¦†ç›–è¿œç¨‹çš„æ–°æäº¤

### 2.2 å‚æ•°è®¾è®¡

**å¿…éœ€å‚æ•°**:
- `TARGET_BRANCH` - æ–°çš„åŸºç¡€åˆ†æ”¯åç§°ï¼ˆå½“å‰åˆ†æ”¯å°† rebase åˆ°è¿™ä¸ªåˆ†æ”¯ï¼‰

**å¯é€‰å‚æ•°**:
- `--pr-id <ID>` - PR IDï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨æ£€æµ‹å½“å‰åˆ†æ”¯çš„ PRï¼‰
- `--no-update-pr` - ä¸æ›´æ–° PR çš„ base åˆ†æ”¯ï¼ˆåªæ‰§è¡Œ rebaseï¼‰
- `--no-push` - ä¸æ¨é€åˆ°è¿œç¨‹ï¼ˆåª rebase åˆ°æœ¬åœ°ï¼‰
- `--dry-run` - é¢„è§ˆæ¨¡å¼ï¼Œæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œä½†ä¸å®é™…æ‰§è¡Œ

### 2.3 å·¥ä½œæµç¨‹

```
1. è·å–å½“å‰åˆ†æ”¯
2. éªŒè¯ TARGET_BRANCH å­˜åœ¨ï¼ˆæœ¬åœ°æˆ–è¿œç¨‹ï¼‰
3. æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€
   - å¦‚æœæœ‰æœªæäº¤æ›´æ”¹ï¼Œè‡ªåŠ¨ stash
4. æ‹‰å– TARGET_BRANCH æœ€æ–°ä»£ç ï¼ˆfetchï¼‰
5. æ‰§è¡Œ rebase
   - git rebase TARGET_BRANCH
   - å¦‚æœæœ‰å†²çªï¼Œæš‚åœå¹¶æç¤ºç”¨æˆ·
6. æ£€æµ‹å½“å‰åˆ†æ”¯çš„ PRï¼ˆå¦‚æœæœªæŒ‡å®š --pr-idï¼‰
7. æ›´æ–° PR çš„ base åˆ†æ”¯ï¼ˆå¦‚æœæœªæŒ‡å®š --no-update-prï¼‰
   - ä½¿ç”¨ PR API æ›´æ–° base åˆ†æ”¯
8. æ¢å¤ stashï¼ˆå¦‚æœæœ‰ï¼‰
9. å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹ï¼ˆå¦‚æœæœªæŒ‡å®š --no-pushï¼Œä½¿ç”¨ --force-with-leaseï¼‰
```

---

## ä¸‰ã€ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šä¿®æ­£é”™è¯¯çš„åŸºç¡€åˆ†æ”¯

```bash
# é”™è¯¯ï¼šä»£ç åœ¨ master ä¸Šï¼Œä½†åº”è¯¥åœ¨ develop åŸºç¡€ä¸Š
git checkout master
workflow pr rebase develop

# ç»“æœï¼š
# - å°† master rebase åˆ° develop
# - æ›´æ–° PR çš„ base åˆ†æ”¯ä¸º developï¼ˆå¦‚æœ master æœ‰ PRï¼‰
# - å¼ºåˆ¶æ¨é€
```

### åœºæ™¯ 2ï¼šåª rebaseï¼Œä¸æ›´æ–° PR

```bash
workflow pr rebase develop --no-update-pr

# ç»“æœï¼š
# - åªæ‰§è¡Œ rebase
# - ä¸æ›´æ–° PR çš„ base åˆ†æ”¯
```

### åœºæ™¯ 3ï¼šåª rebase åˆ°æœ¬åœ°ï¼Œä¸æ¨é€

```bash
workflow pr rebase develop --no-push

# ç»“æœï¼š
# - Rebase åˆ°æœ¬åœ°
# - ä¸æ¨é€åˆ°è¿œç¨‹ï¼ˆç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ¨é€ï¼‰
```

### åœºæ™¯ 4ï¼šæŒ‡å®š PR ID

```bash
workflow pr rebase develop --pr-id 123

# ç»“æœï¼š
# - Rebase å½“å‰åˆ†æ”¯
# - æ›´æ–°æŒ‡å®š PR #123 çš„ base åˆ†æ”¯
```

---

## å››ã€è¾¹ç•Œæƒ…å†µå¤„ç†

### æƒ…å†µ 1ï¼šå½“å‰åˆ†æ”¯ä¸å­˜åœ¨

**å¤„ç†æ–¹å¼**:
- æ£€æŸ¥æ˜¯å¦åœ¨ Git ä»“åº“ä¸­
- æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦å­˜åœ¨
- å¦‚æœä¸å­˜åœ¨ï¼Œæç¤ºé”™è¯¯å¹¶é€€å‡º

### æƒ…å†µ 2ï¼šç›®æ ‡åˆ†æ”¯ä¸å­˜åœ¨

**å¤„ç†æ–¹å¼**:
- æ£€æŸ¥ TARGET_BRANCH æ˜¯å¦å­˜åœ¨ï¼ˆæœ¬åœ°å’Œè¿œç¨‹ï¼‰
- å¦‚æœä¸å­˜åœ¨ï¼Œæç¤ºé”™è¯¯å¹¶é€€å‡º
- æä¾›å»ºè®®ï¼šæ£€æŸ¥åˆ†æ”¯åæ‹¼å†™

### æƒ…å†µ 3ï¼šRebase å†²çª

**å¤„ç†æ–¹å¼**:
- æš‚åœ rebase æ“ä½œ
- æ˜¾ç¤ºå†²çªæ–‡ä»¶åˆ—è¡¨
- æç¤ºç”¨æˆ·è§£å†³å†²çªï¼š
  ```
  Rebase conflict detected!
  Please resolve conflicts in:
    - file1.rs
    - file2.rs

  After resolving:
    1. git add <resolved-files>
    2. git rebase --continue
    3. workflow pr rebase --continue  # ç»§ç»­æ‰§è¡Œ
  ```
- æä¾› `--continue` é€‰é¡¹ç»§ç»­æ‰§è¡Œ
- æä¾› `--abort` é€‰é¡¹ä¸­æ­¢æ“ä½œ

### æƒ…å†µ 4ï¼šå½“å‰åˆ†æ”¯æ²¡æœ‰ PR

**å¤„ç†æ–¹å¼**:
- æ£€æµ‹åˆ°å½“å‰åˆ†æ”¯æ²¡æœ‰ PR
- å¦‚æœæŒ‡å®šäº† `--pr-id`ï¼Œä½¿ç”¨æŒ‡å®šçš„ PR
- å¦‚æœæœªæŒ‡å®šä¸”æ²¡æœ‰ PRï¼Œè·³è¿‡ PR æ›´æ–°æ­¥éª¤
- æç¤ºç”¨æˆ·ï¼š`No PR found for current branch. Skipping PR base update.`

### æƒ…å†µ 5ï¼šå·¥ä½œåŒºæœ‰æœªæäº¤æ›´æ”¹

**å¤„ç†æ–¹å¼**:
- è‡ªåŠ¨æ£€æµ‹æœªæäº¤æ›´æ”¹
- è‡ªåŠ¨ stashï¼ˆä¿å­˜æ›´æ”¹ï¼‰
- Rebase å®Œæˆåæ¢å¤ stash
- å¦‚æœ stash æ¢å¤æœ‰å†²çªï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨è§£å†³

### æƒ…å†µ 6ï¼šæ¨é€å¤±è´¥

**å¤„ç†æ–¹å¼**:
- ä½¿ç”¨ `--force-with-lease` å®‰å…¨åœ°å¼ºåˆ¶æ¨é€
- å¦‚æœæ¨é€å¤±è´¥ï¼ˆä¾‹å¦‚è¿œç¨‹æœ‰æ–°çš„æäº¤ï¼‰ï¼Œæç¤ºç”¨æˆ·ï¼š
  ```
  Push failed. Remote branch has new commits.
  Please pull and rebase again, or use 'git push --force' manually.
  ```

---

## äº”ã€å®ç°ç»†èŠ‚

### 5.1 Rebase æ“ä½œ

```rust
// ä¼ªä»£ç 
fn rebase_onto_target(target: &str) -> Result<()> {
    // 1. æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€
    // 2. Stash æœªæäº¤æ›´æ”¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
    // 3. æ‰§è¡Œ git rebase target
    // 4. å¤„ç†å†²çªï¼ˆå¦‚æœå‘ç”Ÿï¼‰
    // 5. æ¢å¤ stash
}
```

### 5.2 æ›´æ–° PR çš„ base åˆ†æ”¯

```rust
// ä¼ªä»£ç 
fn update_pr_base(pr_id: &str, new_base: &str) -> Result<()> {
    // ä½¿ç”¨ PR API æ›´æ–° base åˆ†æ”¯
    // PATCH /repos/{owner}/{repo}/pulls/{pr_number}
    // Body: { "base": new_base }
}
```

---

## å…­ã€ä¸å…¶ä»–å‘½ä»¤çš„å…³ç³»

### 6.1 ä¸ `pr port` çš„åŒºåˆ«

| ç‰¹æ€§ | `pr port` | `pr rebase` |
|------|-----------|-------------|
| **æ“ä½œæ–¹å¼** | Cherry-pick | Rebase |
| **åˆ›å»ºæ–°åˆ†æ”¯** | âœ… æ˜¯ | âŒ å¦ï¼ˆåœ¨å½“å‰åˆ†æ”¯æ“ä½œï¼‰ |
| **åˆ›å»ºæ–° PR** | âœ… æ˜¯ | âŒ å¦ï¼ˆæ›´æ–°ç°æœ‰ PRï¼‰ |
| **ä½¿ç”¨åœºæ™¯** | è·¨åˆ†æ”¯ç§»æ¤ä»£ç  | ä¿®æ­£å½“å‰åˆ†æ”¯çš„åŸºç¡€åˆ†æ”¯ |
| **ç»“æœ** | æ–°åˆ†æ”¯ + æ–° PR | ä¿®æ”¹ç°æœ‰åˆ†æ”¯ + æ›´æ–° PR base |

### 6.2 ä¸ `pr sync` çš„åŒºåˆ«

| ç‰¹æ€§ | `pr rebase` | `pr sync` |
|------|-------------|-----------|
| **æ“ä½œæ–¹å¼** | Rebase | Merge æˆ– Rebase |
| **æ›´æ–° PR base** | âœ… æ˜¯ï¼ˆæ›´æ–°ç°æœ‰ PRï¼‰ | âŒ å¦ |
| **ä½¿ç”¨åœºæ™¯** | ä¿®æ­£å½“å‰åˆ†æ”¯çš„åŸºç¡€åˆ†æ”¯ | åŒæ­¥åŸºç¡€åˆ†æ”¯æ›´æ–° |
| **å…¸å‹ç”¨æ³•** | `pr rebase develop`ï¼ˆåœ¨ master ä¸Šï¼‰ | `pr sync master`ï¼ˆåœ¨ feature åˆ†æ”¯ä¸Šï¼‰ |

### 6.3 é€‰æ‹©å»ºè®®

**ä½¿ç”¨ `pr rebase` å½“ï¼š**
- éœ€è¦ä¿®æ­£å½“å‰åˆ†æ”¯çš„åŸºç¡€åˆ†æ”¯
- éœ€è¦æ›´æ–°ç°æœ‰ PR çš„ base åˆ†æ”¯
- å½“å‰åˆ†æ”¯æœ‰ PRï¼Œä½†åŸºç¡€åˆ†æ”¯é”™è¯¯
- éœ€è¦é‡å†™æäº¤å†å²ï¼ˆä¿æŒçº¿æ€§ï¼‰

---

## ä¸ƒã€é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ

### 7.1 é”™è¯¯æ¶ˆæ¯

- **å½“å‰åˆ†æ”¯ä¸å­˜åœ¨**: `Not on a valid branch. Please checkout a branch first.`
- **ç›®æ ‡åˆ†æ”¯ä¸å­˜åœ¨**: `Target branch '{TARGET_BRANCH}' does not exist. Please check the branch name.`
- **Rebase å†²çª**: `Rebase conflict detected. Please resolve conflicts and use '--continue' to proceed.`
- **PR ä¸å­˜åœ¨**: `No PR found for current branch. Skipping PR base update.`
- **æ¨é€å¤±è´¥**: `Push failed. Remote branch has new commits. Please pull and rebase again.`

### 7.2 æˆåŠŸæ¶ˆæ¯

```
âœ“ Rebased current branch onto develop
âœ“ Updated PR #123 base branch to develop
âœ“ Pushed to remote (force-with-lease)
```

### 7.3 äº¤äº’å¼æç¤º

#### å†²çªè§£å†³æç¤º

```
âš ï¸  Conflict detected during rebase

Conflicted files:
  - src/file1.rs
  - src/file2.rs

To resolve:
  1. Edit conflicted files
  2. git add <resolved-files>
  3. workflow pr rebase --continue

To abort:
  workflow pr rebase --abort
```

---

## å…«ã€å®ç°è€ƒè™‘

### 8.1 æŠ€æœ¯å®ç°è¦ç‚¹

1. **Rebase æ“ä½œ**
   - ä½¿ç”¨ `git rebase TARGET_BRANCH`
   - å¤„ç† rebase å†²çªï¼ˆæš‚åœã€æç¤ºã€ç»§ç»­ï¼‰
   - æ”¯æŒ `--continue` å’Œ `--abort` é€‰é¡¹

2. **PR base æ›´æ–°**
   - æ£€æµ‹å½“å‰åˆ†æ”¯çš„ PRï¼ˆé€šè¿‡ APIï¼‰
   - ä½¿ç”¨ PR API æ›´æ–° base åˆ†æ”¯
   - å¤„ç† PR ä¸å­˜åœ¨çš„æƒ…å†µ

3. **å®‰å…¨æ¨é€**
   - ä½¿ç”¨ `--force-with-lease` å¼ºåˆ¶æ¨é€
   - å¤„ç†æ¨é€å¤±è´¥çš„æƒ…å†µ

4. **å·¥ä½œåŒºå¤„ç†**
   - æ£€æµ‹æœªæäº¤æ›´æ”¹
   - è‡ªåŠ¨ stash å’Œæ¢å¤

### 8.2 ä¾èµ–æ¨¡å—

- `lib/git/branch.rs` - åˆ†æ”¯æ“ä½œï¼ˆrebaseï¼Œéœ€è¦æ·»åŠ  rebase æ–¹æ³•ï¼‰
- `lib/git/stash.rs` - Stash æ“ä½œï¼ˆå·²æœ‰ï¼‰
- `lib/git/repo.rs` - ä»“åº“æ“ä½œï¼ˆfetchï¼‰
- `lib/pr/platform.rs` - PR æ“ä½œï¼ˆæ›´æ–° PR base åˆ†æ”¯ï¼Œéœ€è¦æ·»åŠ æ–¹æ³•ï¼‰

### 8.3 éœ€è¦æ–°å¢çš„ Git æ–¹æ³•

#### åœ¨ `GitBranch` ä¸­æ·»åŠ 

```rust
impl GitBranch {
    /// Rebase å½“å‰åˆ†æ”¯åˆ°ç›®æ ‡åˆ†æ”¯
    pub fn rebase_onto(target: &str) -> Result<()>;
}
```

#### åœ¨ `PlatformProvider` ä¸­æ·»åŠ 

```rust
pub trait PlatformProvider {
    /// æ›´æ–° PR çš„ base åˆ†æ”¯
    fn update_pr_base(&self, pr_id: &str, new_base: &str) -> Result<()>;
}
```

---

## ä¹ã€æµ‹è¯•åœºæ™¯

1. **æ­£å¸¸ rebase**
   - æˆåŠŸ rebase å¹¶æ›´æ–° PR base
   - æˆåŠŸå¼ºåˆ¶æ¨é€

2. **Rebase å†²çª**
   - æ¨¡æ‹Ÿå†²çª
   - éªŒè¯æš‚åœå’Œç»§ç»­æµç¨‹

3. **PR ä¸å­˜åœ¨**
   - å½“å‰åˆ†æ”¯æ²¡æœ‰ PR
   - éªŒè¯è·³è¿‡ PR æ›´æ–°

4. **å·¥ä½œåŒºæœ‰æ›´æ”¹**
   - éªŒè¯è‡ªåŠ¨ stash å’Œæ¢å¤

5. **æ¨é€å¤±è´¥**
   - æ¨¡æ‹Ÿè¿œç¨‹æœ‰æ–°æäº¤
   - éªŒè¯é”™è¯¯æç¤º

---

## åã€æœªæ¥æ‰©å±•

- **äº¤äº’å¼ rebase**: `pr rebase develop --interactive`ï¼ˆæ”¯æŒç¼–è¾‘æäº¤ï¼‰
- **è‡ªåŠ¨è§£å†³ç®€å•å†²çª**: å¯¹äºç®€å•çš„å†²çªè‡ªåŠ¨è§£å†³
- **æ‰¹é‡æ›´æ–° PR base**: æ›´æ–°å¤šä¸ª PR çš„ base åˆ†æ”¯

---

## åä¸€ã€æ€»ç»“

**`pr rebase`**:
- ç”¨é€”ï¼šä¿®æ­£å½“å‰åˆ†æ”¯çš„åŸºç¡€åˆ†æ”¯å¹¶æ›´æ–° PR
- ç‰¹ç‚¹ï¼šåœ¨å½“å‰åˆ†æ”¯æ“ä½œã€rebaseã€æ›´æ–° PR base
- åœºæ™¯ï¼šä»£ç åœ¨ master ä¸Šï¼Œä½†åº”è¯¥åœ¨ develop åŸºç¡€ä¸Š

**è®¾è®¡åŸåˆ™**:
1. **è‡ªåŠ¨åŒ–**: å°½é‡å‡å°‘æ‰‹åŠ¨æ­¥éª¤
2. **å®‰å…¨æ€§**: ä½¿ç”¨ `--force-with-lease` è€Œä¸æ˜¯ `--force`
3. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œæ“ä½œæŒ‡å¯¼
4. **çµæ´»æ€§**: æ”¯æŒå¤šç§ä½¿ç”¨åœºæ™¯å’Œé€‰é¡¹

