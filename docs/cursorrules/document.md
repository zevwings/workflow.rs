# 文档生成规则

> **⚠️ 同步提示**：此文件必须与其英文版本 `.cursor/rules/document.md` 保持同步。修改此文件时，必须立即更新对应的英文版本。

---

## 🚫 文档生成规则（强制执行）

### 核心原则

**默认禁止生成文档**：除非用户使用明确的关键词请求，否则一律不生成 `.md` 文档文件。

### ✅ 允许生成文档的情况（白名单）

**只有**用户使用以下明确关键词时才能生成文档：

**直接指令**：
- "生成文档"、"创建文档"、"写一个文档"
- "生成报告"、"创建报告"、"写一个报告"
- "保存为文档"、"保存为文件"、"输出到文件"
- "记录到文档"、"写入文档"

**明确要求**：
- "帮我创建一个...文档"
- "能否生成一份...报告"
- "请写一个...说明文档"

**例外情况**：
- 执行 `review.md` 或 `pre-commit.md` 工作流时（规则已明确，见下文）

**⚠️ 重要**：如果用户没有使用上述关键词，**一律不生成文档**！

### ❌ 禁止自动生成文档的场景（黑名单）

以下场景**严格禁止**自动生成文档，只能在聊天中提供文本响应：

**分析类请求**：
- "分析..."、"分析一下..."、"查看..."、"检查..."、"诊断..."、"排查..."
- ❌ 错误做法：自动生成 `analysis/xxx-analysis.md`
- ✅ 正确做法：在聊天中提供分析结果，询问"需要生成文档吗？"

**总结类请求**：
- "总结..."、"汇总..."、"概括..."、"梳理..."
- ❌ 错误做法：自动生成 `analysis/xxx-summary.md`
- ✅ 正确做法：在聊天中提供总结文本

**完成类请求**：
- "完成..."、"实现..."、"做..."、"处理..."
- ❌ 错误做法：认为"完成"包含"代码+报告"
- ✅ 正确做法："完成"仅指代码实现，在聊天中总结成果

**进度类请求**：
- "进展如何"、"做到哪了"、"状态如何"、"完成了什么"
- ❌ 错误做法：自动生成 `analysis/xxx-progress.md`
- ✅ 正确做法：在聊天中报告进度

**审查类请求**：
- "审查..."、"review..."、"检视..."、"看看..."
- ❌ 错误做法：自动生成 `analysis/xxx-review.md`
- ✅ 正确做法：在聊天中提供审查意见
- ⚠️ 例外：执行 `review.md` 工作流（规则已明确，见下文）

### 📋 文档生成前强制检查清单

AI 在生成**任何** `.md` 文档前，必须通过以下四关检查：

**第一关：明确请求检查**
- [ ] 用户是否使用了白名单中的明确关键词？
  - ✅ 是 → 继续下一关
  - ❌ 否 → **禁止生成**，改为聊天文本响应

**第二关：黑名单场景检查**
- [ ] 用户请求是否属于黑名单场景？
  - ❌ 是 → **禁止生成**，改为聊天文本响应
  - ✅ 否 → 继续下一关

**第三关：例外规则检查**
- [ ] 是否是 Review Workflow 自动报告？
  - ✅ 是 → 可以生成
  - ❌ 否 → 继续下一关

**第四关：二次确认**
- [ ] 如果前三关都通过，在生成前询问：
  ```
  准备生成以下文档：
  - [文档路径]

  确认要生成吗？
  ```

**只有通过全部四关，才能生成文档！**

### 📚 正确示例 vs 错误示例

**场景1：用户说"分析测试失败原因"**

❌ **错误做法**：
```
1. 运行分析
2. 自动生成 analysis/test-failure-analysis.md
3. 告诉用户："已生成分析报告"
```

✅ **正确做法**：
```
1. 运行分析
2. **在聊天中**提供分析：

   🔍 测试失败原因分析

   失败测试：27个
   主要原因：全局状态污染（set_current_dir）

   具体问题：
   - 54个测试使用了 set_current_dir
   - 某些测试没有正确恢复目录
   - 导致后续测试在错误的目录中执行

   建议修复方案：
   1. 创建 CurrentDirGuard 工具
   2. 使用 RAII 模式自动恢复
   3. 删除多余的 set_current_dir 调用

   需要我生成详细报告吗？

3. 等待用户明确回复
```

**场景2：用户说"完成Branch Sync测试"**

❌ **错误做法**（本次违规）：
```
1. 实现代码 ✅
2. 自动生成 branch-sync-complete-report.md ❌
3. 自动生成 test-failure-diagnosis.md ❌
4. 自动生成 branch-sync-final-summary.md ❌
```

✅ **正确做法**：
```
1. 实现代码 ✅
2. **在聊天中**总结：

   🎉 Branch Sync测试完成！

   ✅ 已完成：
   - GitTestEnv工具 (166行)
   - 4个测试用例
   - GitHub API Mock
   - CurrentDirGuard工具

   📊 测试结果：
   - 单独运行：✅ 全部通过
   - 完整套件：失败从27个减少到15个

   💡 发现问题并提供解决方案

   需要生成完整实施报告吗？

3. 等待用户明确回复
```

**场景3：用户说"生成测试覆盖率报告"**

✅ **正确做法**（明确关键词）：
```
1. 确认：用户使用了"生成报告"关键词 ✅
2. 不在黑名单场景 ✅
3. 直接生成 analysis/test-coverage-report.md
4. 告诉用户："已生成报告"
```

### 🔐 检查工作流报告生成规则

**特殊例外**：执行以下工作流时，**必须**自动生成报告：

- **综合深入检查**（`docs/guidelines/development/workflows/review.md`）：
  - 执行后必须自动生成 `report/review-report-{timestamp}.md`
- **提交前检查**（`docs/guidelines/development/workflows/pre-commit.md`）：
  - 执行后必须自动生成 `report/pre-commit-report-{timestamp}.md`

**时间戳格式**：`YYYY-MM-DD_HH-MM-SS`（如：`2025-12-23_22-55-15`）
**报告内容**：按照工作流文档中的报告模板生成完整检查报告
**报告位置**：所有报告文档必须保存在 `report/` 目录下

### ⚠️ 违规处理

如果 AI 违反了文档生成规则：

1. **立即停止**当前行为
2. **承认错误**："我违反了文档生成规则"
3. **说明原因**：为什么会违规
4. **提出补救**：
   - 是否删除违规文档？
   - 是否将内容整合到聊天？
5. **确保理解**：复述规则，确认以后不再犯

**示例**：
```
🚨 我犯了一个严重错误！

违规行为：自动生成了24个analysis文档
违反规则：未经明确请求就生成文档

原因分析：
- 误以为"完成任务"包含"生成报告"
- 没有检查用户是否使用明确关键词
- 违反了黑名单场景规则

建议补救：
1. 删除这24个违规文档
2. 保留代码实现
3. 今后严格遵守四关检查清单

需要我立即删除这些文档吗？
```

### 🔒 执行保证

这些规则是**强制性**的，不是建议。AI 必须严格遵守，不得以"方便用户"、"完成任务"、"提供完整方案"等理由绕过。

## 📁 文档分类与存储

**核心原则**：**所有生成的文档文件，根据文档类型自动归类到对应目录；如果无法确定类型，优先检查是否包含"分析"等关键词，匹配则存放到 `analysis/`，否则默认存放到 `docs/requirements/`。**

**重要规则**：文档文件根据类型存放在对应目录，禁止在项目根目录或其他位置随意创建文档文件。

### 文档分类表

| 文档类型 | 目录 | 命名模式 | 关键词（保留中文关键词） |
|---------|------|---------|-------------------------|
| 架构设计文档 | `docs/architecture/` | `{TOPIC}.md` | 架构、架构设计、Architecture、模块架构、系统设计 |
| 开发指南和规范文档 | `docs/guidelines/` | `{TOPIC}.md` | 指南、规范、Guidelines、开发规范、测试规范、文档规范 |
| 版本迁移文档 | `docs/migration/` | `{TOPIC}.md` | 迁移、Migration、版本升级、配置迁移 |
| TODO 文档 | `docs/requirements/` | `{TOPIC}.md` | TODO、待办、待实现、计划 |
| 需求文档 | `docs/requirements/` | `{TOPIC}.md` | 需求、需求分析、功能需求、需求文档 |
| 技术分析文档 | `analysis/` | `{TOPIC}.md` | 分析、ANALYSIS、问题分析、技术分析、测试分析、代码分析、性能分析、架构分析、设计分析、代码审查分析、问题诊断 |
| 分析报告文档 | `report/` | `{TOPIC}.md` | 分析报告、检查报告、代码分析、质量报告（from pre-commit.md） |

**注意**：需求分析、功能说明、实现计划等未明确分类的文档，默认存放到 `docs/requirements/` 目录。

### 文档存放决策流程

1. 检查用户是否明确指定了文档类型或存放位置
2. 如果指定了类型，根据上述分类规则自动归类
3. **重要限制**：
   - **分析文档**（`analysis/`）：**必须**用户明确指明需要生成分析文档时才生成，不能根据关键词自动判断
   - **需求文档**（`docs/requirements/` 中的需求文档）：**必须**用户明确指明需要生成需求文档时才生成，不能根据关键词自动判断
4. 如果未指定类型，检查文档内容中的关键词：
   - 包含"TODO"、"待办"、"待实现"、"计划"、"需求"、"需求分析"、"功能需求"、"需求文档"等关键词 → `docs/requirements/`
   - 其他未明确分类的文档 → `docs/requirements/`
5. 如果无法确定类型，默认存放到 `docs/requirements/`

### 文档命名规范

所有文档都使用 `{TOPIC}.md` 格式。

**重要**：
- 主题名称使用 `kebab-case` 格式（例如：`test-coverage.md`、`jira.md`）

请参考上方的**文档分类表**查看文档类型分类和存储位置。

### 创建新文档时的注意事项

- **文档编写指南**：使用模板创建新文档（参考 `docs/guidelines/document.md`）
  - 根据文档类型选择合适的模板（架构文档、指南文档、需求文档、检查工作流文档、开发工作流文档、检查指南文档）
  - 遵循文档编写规范和章节检查清单
- **文档时间戳**：在文档末尾添加"最后更新"时间戳（参考 `docs/guidelines/document-timestamp.md`）
  - 格式：`**最后更新**: YYYY-MM-DD`
  - 位置：文档末尾，分隔线之后
  - **重要**：每次更新文档内容时，必须同步更新文档末尾的时间戳为当前日期
- **文档规范**：确保文档遵循项目的文档编写规范

---

**最后更新**: 2025-12-25

