# 文档编写指南

> 本文档提供统一的架构文档编写指南和模板，用于创建新的模块架构文档。

---

## 📋 模板说明

### 使用场景

- 创建新的 Lib 层模块架构文档
- 创建新的命令层架构文档
- 更新现有文档时参考

### 章节说明

- **必选章节**：所有文档必须包含
- **推荐章节**：建议包含（出现率 > 80%）
- **可选章节**：根据模块特性选择性添加

---

## 📝 模板说明

项目提供两种模板，分别适用于不同类型的架构文档：

### 模板类型

1. **Lib 层模块模板** (`MODULE.template`)
   - 适用于：`lib/` 下的核心业务逻辑模块
   - 特点：关注核心组件、设计原则、架构设计
   - 示例：`pr.md`、`git.md`、`jira.md`

2. **命令层模块模板** (`COMMAND.template`)
   - 适用于：`commands/` 下的命令封装层模块
   - 特点：关注命令说明、调用流程、用户交互
   - 示例：`pr.md`、`LOG_COMMAND_architecture.md`、`JIRA_COMMAND_architecture.md`、`config.md`

### 快速使用

#### Lib 层模块文档

```bash
# 复制 Lib 层模板
cp docs/guidelines/templates/MODULE.template do../architecture/{module}.md

# 然后编辑文件，替换所有 {占位符}
```

#### 命令层模块文档

```bash
# 复制命令层模板
cp docs/guidelines/templates/COMMAND.template docs/architecture/commands/{MODULE}_COMMAND_architecture.md

# 然后编辑文件，替换所有 {占位符}
```

### 模板预览

<details>
<summary>点击展开查看完整模板</summary>

```markdown
# {模块名} 模块架构文档

## 📋 概述

{模块功能描述，包括模块定位、主要功能、设计目标等}

**注意**：{可选，如果有需要说明的注意事项}

**模块统计：**
- 总代码行数：约 XXX 行
- 文件数量：X 个
- 主要组件：X 个（...）
- {其他统计信息}

---

## 📁 模块结构

### 核心模块文件

```
{文件树结构，包含文件路径和行数}
```

### 依赖模块

- **`lib/xxx/`**：{依赖说明}
- **`lib/yyy/`**：{依赖说明}

### 模块集成

- **`lib/xxx/`**：{集成说明}
  - `Method::xxx()` - {方法说明}
- **`lib/yyy/`**：{集成说明}
  - `Method::yyy()` - {方法说明}

---

## 🏗️ 架构设计

### 设计原则

1. **原则1**：{说明}
2. **原则2**：{说明}
3. **原则3**：{说明}
...

### 核心组件

#### 1. {组件名} ({文件路径})

**职责**：{职责说明}

**主要方法**：
- `method1()` - {说明}
- `method2()` - {说明}

**关键特性**：
- {特性1}
- {特性2}

**使用场景**：
- {场景1}
- {场景2}

#### 2. {组件名} ({文件路径})

{同上}

### 设计模式

#### 1. {模式名}

{模式说明}

**优势**：
- {优势1}
- {优势2}

#### 2. {模式名}

{同上}

### 错误处理

#### 分层错误处理

1. **层级1**：{错误类型}
2. **层级2**：{错误类型}

#### 容错机制

- **场景1**：{处理方式}
- **场景2**：{处理方式}

---

## 🔄 调用流程与数据流

### 整体架构流程

```
{流程图或文字描述}
```

或使用 Mermaid 图表：

```mermaid
flowchart LR
    A[起点] --> B[处理]
    B --> C[终点]
```

### 典型调用示例

#### 1. {场景1}

```
{调用流程}
```

#### 2. {场景2}

```
{调用流程}
```

### 数据流

```
{数据流向图或 Mermaid 图表}
```

---

## 📝 扩展性（可选）

### 添加新功能

1. {步骤1}
2. {步骤2}

**示例**：
```rust
// 示例代码
pub fn new-_feature() -> Result<()> {
    // 实现
}
```

---

## 📚 相关文档

- [主架构文档](../architecture/architecture.md)
- [{相关 Lib 模块}架构文档](../architecture/{module}.md) - Lib 层模块
- [{相关命令模块}命令模块架构文档](../architecture/commands/{MODULE}_COMMAND_architecture.md) - 命令层模块（如适用）

---

## 📋 使用示例

### 基本使用

```rust
use workflow::{Module};

// 基本使用示例
let result = Module::method()?;
```

### {场景}使用

```rust
// 场景使用示例
```

---

## ✅ 总结

{模块名}模块采用清晰的{设计模式}设计：

1. **特性1**：{说明}
2. **特性2**：{说明}

**设计优势**：
- ✅ {优势1}
- ✅ {优势2}

{可选：当前实现状态、配置说明等}
```

</details>

---

## 🎯 可选章节

根据模块特性，可以添加以下可选章节：

### 使用场景

```markdown
## 🔄 使用场景

### {场景名}

1. **场景描述**：
   - {步骤1}
   - {步骤2}
```

### 设计决策

```markdown
## 💡 设计决策

### 为什么{设计选择}？

- **原因**：{原因说明}
- **好处**：{好处说明}
- **代价**：{代价说明}
```

### 代码质量特性

```markdown
## 🎨 代码质量特性

### 已实现的优化

1. **优化1**：
   - {说明}
```

### 安全性考虑

```markdown
## 🔒 安全性考虑

### {安全方面}

- **{方面1}**：{说明}
```

### 实现细节

```markdown
## 🔧 实现细节

### {细节名称}

{详细说明}
```

### 模块依赖关系

```markdown
## 📊 模块依赖关系

```
{依赖关系图}
```
```

---

## 📋 章节检查清单

创建或更新文档时，使用以下清单：

### Lib 层模块文档（MODULE.template）

#### 必选章节

- [ ] 📋 概述（包含模块统计）
- [ ] 📁 模块结构（包含文件树、依赖和模块集成）
- [ ] 🏗️ 架构设计（包含设计原则和核心组件）
- [ ] 📚 相关文档（至少 2-3 个链接）

#### 推荐章节

- [ ] 🏗️ 架构设计（包含设计模式、错误处理）
- [ ] 🔄 调用流程与数据流（包含整体流程、典型示例和数据流）
- [ ] 📋 使用示例（至少 2 个示例）
- [ ] ✅ 总结（包含设计优势）

#### 可选章节

- [ ] 📝 扩展性（包含添加新功能的步骤）

### 命令层模块文档（COMMAND.template）

#### 必选章节

- [ ] 📋 概述（包含模块统计）
- [ ] 📁 相关文件（包含 CLI 入口层、命令封装层、依赖模块）
- [ ] 🔄 调用流程（包含整体架构流程和命令分发流程）
- [ ] 命令详细说明（至少 1 个命令，包含相关文件、调用流程、功能说明、关键步骤）
- [ ] 📚 相关文档（至少 2-3 个链接）

#### 推荐章节

- [ ] 📊 数据流（至少 1 个命令的数据流）
- [ ] 🔗 与其他模块的集成
- [ ] 🎯 设计模式（至少 1 个模式）
- [ ] 🔍 错误处理（包含分层处理和容错机制）
- [ ] 📝 扩展性（包含添加新命令的步骤）
- [ ] 📋 使用示例（至少 2 个命令的示例）
- [ ] ✅ 总结（包含设计优势）

#### 可选章节

- [ ] 其他扩展场景说明

### 格式检查

- [ ] 使用统一的 emoji 图标
- [ ] 使用统一的代码块格式
- [ ] 使用统一的列表格式
- [ ] 使用统一的分隔线（`---`）
- [ ] 添加"最后更新"时间戳（格式：`**最后更新**: YYYY-MM-DD`）

---

## 📅 文档时间戳

### 问题说明

在生成文档时，AI 助手（如 Cursor）可能会在文档末尾添加"最后更新"时间戳，但时间可能不正确（时区、格式等问题）。

### 解决方案

项目提供了专门的日期时间工具函数，用于生成正确格式的文档时间戳。

### 使用方法

#### 在 Rust 代码中使用

```rust
use workflow::base::util::date::format-_last-_updated;

// 生成"最后更新"时间戳（格式：YYYY-MM-DD）
let timestamp = format-_last-_updated();
// 输出示例：2025-12-09
```

#### 在文档中使用（推荐格式）

在 Markdown 文档末尾添加时间戳时，使用以下格式：

```markdown
---

**最后更新**: 2025-12-09
```

或者：

```markdown
---

*最后更新: 2025-12-09*
```

### 对于 AI 助手（Cursor/Claude 等）

**重要提示**：当生成或更新文档时，请在文档末尾添加"最后更新"时间戳。

#### 推荐做法

1. **使用当前日期**：使用当前本地日期（格式：`YYYY-MM-DD`）
2. **格式统一**：使用以下格式之一：
   - `**最后更新**: YYYY-MM-DD`
   - `*最后更新: YYYY-MM-DD*`
3. **位置**：放在文档末尾，分隔线之后

#### 获取当前日期的方法

**命令行方式**：

- **Unix/macOS/Linux**：
  ```bash
  date +%Y-%m-%d
  # 输出：2025-12-09
  ```

- **Windows PowerShell**：
  ```powershell
  Get-Date -Format "yyyy-MM-dd"
  # 输出：2025-12-09
  ```

- **Windows CMD**：
  ```cmd
  powershell -Command "Get-Date -Format 'yyyy-MM-dd'"
  ```

**代码方式**：

在 Rust 代码中使用：
```rust
use workflow::base::util::date::format-_last-_updated;

let timestamp = format-_last-_updated();
// 输出：2025-12-09
```

### 高级用法

如果需要更多控制，可以使用其他函数：

```rust
use workflow::base::util::date::{
    format-_document-_timestamp, format-_last-_updated-_with-_time, DateFormat, Timezone,
};

// 只生成日期（本地时区）
let date = format-_document-_timestamp(DateFormat::DateOnly, Timezone::Local);

// 生成日期和时间（本地时区）
let datetime = format-_last-_updated-_with-_time();

// 使用 UTC 时区
let utc-_date = format-_document-_timestamp(DateFormat::DateOnly, Timezone::Utc);

// ISO 8601 格式
let iso = format-_document-_timestamp(DateFormat::Iso8601, Timezone::Local);
```

### 支持的格式

| 格式 | 函数 | 输出示例 |
|------|------|----------|
| 日期（YYYY-MM-DD） | `format-_last-_updated()` | `2025-12-09` |
| 日期时间（YYYY-MM-DD HH:MM:SS） | `format-_last-_updated-_with-_time()` | `2025-12-09 14:30:00` |
| ISO 8601 | `format-_document-_timestamp(DateFormat::Iso8601, ...)` | `2025-12-09T14:30:00+08:00` |

### 注意事项

1. **时区**：默认使用本地时区（`Timezone::Local`）
2. **格式一致性**：建议在项目中统一使用 `YYYY-MM-DD` 格式
3. **自动更新**：时间戳不会自动更新，需要在编辑文档时手动更新

---

## 📊 文档长度参考

### Lib 层模块文档

- **最小文档**：包含必选章节 + 部分推荐章节，约 250-350 行
- **标准文档**：包含必选章节 + 所有推荐章节，约 400-600 行
- **完整文档**：包含所有章节 + 可选章节，约 600-900 行

### 命令层模块文档

- **最小文档**：包含必选章节 + 部分推荐章节，约 300-450 行
- **标准文档**：包含必选章节 + 所有推荐章节，约 500-800 行
- **完整文档**：包含所有章节 + 可选章节，约 800-1200 行

---

## 🔗 相关文档

- [Lib 层模板文件](./templates/MODULE.template) - Lib 层模块架构文档模板
- [命令层模板文件](./templates/COMMAND.template) - 命令层模块架构文档模板
- [主架构文档](../architecture/architecture.md) - 总体架构设计文档

---

*模板版本：2.0*
*最后更新: 2025-12-09*

---

## 📝 更新说明

### v2.0 简化更新

模板已简化，主要改进：

1. **合并重复章节**：
   - 删除独立的"模块职责"章节（内容已整合到"核心组件"中）
   - 将"与其他模块的集成"合并到"模块结构"中

2. **整合相关章节**：
   - 将"设计模式"和"错误处理"作为"架构设计"的子章节
   - 将"数据流"合并到"调用流程"中

3. **优化结构**：
   - 添加"模块统计"到概述部分
   - 将"扩展性"标记为可选章节
   - 在"核心组件"中添加"使用场景"字段

简化后的模板减少了约 15% 的内容，同时保持了所有必要信息，结构更加清晰。

---

**最后更新**: 2025-12-18
