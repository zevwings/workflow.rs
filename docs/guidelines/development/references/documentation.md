# 文档规范

> 本文档定义了 Workflow CLI 项目的文档规范和最佳实践，所有贡献者都应遵循这些规范。

---

## 📋 目录

- [概述](#-概述)
- [公共 API 文档](#-公共-api-文档)
- [文档注释格式](#-文档注释格式)
- [内部文档](#-内部文档)
- [文档同步要求](#-文档同步要求)
- [相关文档](#-相关文档)

---

## 📋 概述

本文档定义了文档规范，包括公共 API 文档、文档注释格式和文档同步要求。

### 核心原则

- **完整性**：所有公共 API 必须添加文档注释
- **同步性**：代码变更必须同步更新文档
- **一致性**：文档格式保持一致

### 使用场景

- 编写公共 API 时参考
- 代码审查时检查
- 文档更新时使用

---

## 公共 API 文档

所有公共函数、结构体、枚举、Trait 必须添加文档注释：

```rust
/// 下载指定 JIRA ticket 的日志文件
///
/// # 参数
///
/// * `ticket_id` - JIRA ticket ID（如 "PROJ-123"）
///
/// # 返回
///
/// 返回下载的日志文件字节数据
///
/// # 错误
///
/// 如果下载失败，返回错误信息
///
/// # 示例
///
/// ```rust
/// use workflow::jira::logs::JiraLogs;
///
/// let logs = JiraLogs::new()?;
/// let data = logs.download_from_jira("PROJ-123")?;
/// ```
pub fn download_from_jira(&self, ticket_id: &str) -> Result<Vec<u8>> {
    // 实现
}
```

---

## 文档注释格式

- 使用 `///` 为公共项添加文档
- 使用 `//!` 为模块添加文档
- 包含参数说明、返回值说明、错误说明、使用示例

---

## 内部文档

对于复杂的实现逻辑，添加内部注释：

```rust
// 使用指数退避策略进行重试
// 初始延迟 1 秒，每次重试延迟翻倍，最大延迟 60 秒
let delay = (1 << retry_count).min(60);
```

---

## 文档同步要求

为确保架构文档与代码实现始终保持一致，所有代码变更必须同步更新相关文档。

### 基本原则

**核心原则**：代码变更与文档更新必须同步进行，PR 必须包含相关文档的更新。

### 具体要求

1. **新增模块时**：
   - **必须**同步创建对应的架构文档
   - 文档位置：
     - 模块架构文档 → `docs/architecture/{module}.md`（包含 Lib 层和 Commands 层两部分）
   - 文档内容：参考 [文档编写指南](../../document.md) 创建完整的架构文档
   - 更新索引：更新 `docs/README.md` 中的文档索引（如适用）

2. **重构模块时**：
   - **必须**同步更新对应的架构文档
   - 更新内容：
     - 模块结构变化
     - API 接口变更
     - 功能描述更新
     - 依赖关系变化
   - 验证一致性：使用 [架构文档审查指南](./review-architecture-consistency.md) 验证文档与代码的一致性

3. **API 变更时**：
   - **必须**更新文档中的接口描述
   - 更新内容：
     - 函数签名变更
     - 参数类型或名称变更
     - 返回值类型变更
     - 错误类型变更
   - 更新位置：对应的架构文档中的"API 接口"或"核心组件"章节

4. **功能变更时**：
   - **必须**更新文档中的功能说明
   - 更新内容：
     - 功能描述更新
     - 使用示例更新（如适用）
     - 配置项说明更新（如适用）
   - 更新位置：对应的架构文档中的"功能描述"章节

5. **配置变更时**：
   - **必须**更新文档中的配置项说明
   - 更新内容：
     - 配置项新增或删除
     - 配置项类型、默认值、必填性变更
   - 更新位置：
     - 架构文档中的配置说明
     - README.md 中的配置说明（如适用）
     - 迁移文档（如有破坏性变更）

6. **命令变更时**：
   - **必须**更新 README.md 中的命令清单
   - 更新内容：
     - 新增命令
     - 命令参数变更
     - 命令行为变更
   - 验证完整性：确保所有命令都在命令清单中列出

### PR 要求

**重要**：所有 PR 必须包含相关文档的更新。

- **新增模块的 PR**：必须包含新模块的架构文档
- **重构模块的 PR**：必须包含架构文档的更新
- **API 变更的 PR**：必须包含接口描述的更新
- **功能变更的 PR**：必须包含功能说明的更新
- **配置变更的 PR**：必须包含配置说明的更新
- **命令变更的 PR**：必须包含 README.md 的更新

**代码审查时**：审查者应检查 PR 是否包含必要的文档更新（见 [代码审查规范](../code-review.md)）。

### 文档检查

在提交 PR 前，使用以下方法检查文档是否已同步更新：

1. **使用检查清单**：
   - 参考 [代码审查规范](../code-review.md) 中的"文档更新检查"项
   - 确保所有相关文档都已更新

2. **使用检查指南**：
   - 参考 [架构文档审查指南](./review-architecture-consistency.md) 进行系统化检查
   - 验证文档与代码的一致性

3. **快速验证**：
   ```bash
   # 检查新增的文件是否有对应的架构文档
   # 检查修改的模块是否有架构文档更新
   git diff master --name-only | grep -E "\.(rs|md)$"
   ```

---

## 🔍 故障排除

### 问题 1：文档未同步更新

**症状**：代码变更后未更新相关文档

**解决方案**：

1. 使用文档检查清单逐项检查
2. 使用架构文档审查指南验证文档一致性
3. 确保 PR 包含所有必要的文档更新

### 问题 2：文档格式不一致

**症状**：文档格式不符合规范

**解决方案**：

1. 参考文档编写指南使用标准格式
2. 使用文档模板创建新文档
3. 检查现有文档格式并统一

---

## 📚 相关文档

### 开发规范

- [代码审查规范](../code-review.md) - 代码审查规范（包含文档更新检查项）

### 检查工作流

- [架构文档审查指南](./review-architecture-consistency.md) - 详细的架构文档检查方法和流程

### 其他指南

- [文档编写指南](../../document.md) - 架构文档编写规范和模板

---

## ✅ 检查清单

使用本规范时，请确保：

- [ ] 所有公共 API 已添加文档注释
- [ ] 文档注释格式正确
- [ ] 代码变更已同步更新文档
- [ ] PR 包含所有必要的文档更新

---

**最后更新**: 2025-12-23

