# 架构文档与代码一致性检查指南

> 专为 AI 助手设计的架构文档与代码一致性检查指南，提供系统化的架构文档与代码一致性检查方法，确保架构文档始终与代码实现保持同步。检查范围包括 docs/architecture/ 目录下的所有架构文档。

## 🧭 导航说明

### 📚 相关检查指南

本文档专注于**架构文档与代码一致性检查**，深入检查架构文档中描述的内容是否与实际代码实现保持一致。

**何时使用本文档**：
- 🔍 **深入检查**架构文档与代码实现的一致性
- 🔍 检查架构文档中描述的模块结构是否与实际代码结构一致
- 🔍 检查架构文档中描述的 API 接口是否与实际代码实现一致
- 🔍 检查架构文档中描述的功能是否与实际代码实现一致
- 🔍 检查架构文档中描述的配置项是否与实际配置结构一致
- 🔍 检查架构文档中描述的依赖关系是否与实际代码依赖一致
- 🔍 检查架构文档中描述的错误处理是否与实际代码实现一致

**何时使用 [文档完整性检查指南](./review-document-completeness.md)**：
- ✅ 检查 README.md 是否完整和准确
- ✅ 检查 CHANGELOG.md 是否更新
- ✅ 检查 docs/ 目录结构是否符合规范
- ✅ 检查文档之间的链接是否正确
- ✅ 检查文档是否有重复或冲突内容
- ✅ 检查文档位置是否正确
- ✅ **快速检查**架构文档是否存在（但不深入检查与代码的一致性）

**检查流程建议**：
1. **第一步**：使用 [文档完整性检查指南](./review-document-completeness.md) 进行文档完整性检查（确保文档存在且格式正确）
2. **第二步**：如果涉及架构文档（`docs/architecture/`），使用本文档进行深入的一致性检查

**文档关系**：
- 📄 [文档完整性检查指南](./review-document-completeness.md) - 检查文档的完整性、格式、链接等（通用文档检查）
- 🏗️ **本文档** - 检查架构文档与代码的一致性（专门的架构文档检查）

---

## 🎯 核心原则

**检查重点**：确保架构文档与代码实现的一致性。

**关键目标**：
- ✅ 模块结构一致性：架构文档中描述的模块结构与实际代码结构一致
- ✅ API 接口一致性：文档中描述的 API 接口与实际代码实现一致
- ✅ 功能描述一致性：文档中描述的功能与实际代码实现一致
- ✅ 配置项一致性：文档中描述的配置项与实际配置结构一致
- ✅ 依赖关系一致性：文档中描述的模块依赖关系与实际代码依赖一致
- ✅ 错误处理一致性：文档中描述的错误处理与实际代码实现一致

---

## 📋 目录

- [检查概述](#-检查概述)
- [检查步骤](#-检查步骤)
- [模块结构检查](#1-模块结构检查)
- [模块统计检查](#2-模块统计检查)
- [API 接口检查](#3-api-接口检查)
- [功能描述检查](#4-功能描述检查)
- [依赖关系检查](#5-依赖关系检查)
- [错误处理检查](#6-错误处理检查)
- [检查报告生成](#-检查报告生成)
- [快速检查清单](#-快速检查清单)

---

## 🎯 检查目标

架构文档检查旨在确保：

1. **结构一致性**：架构文档中描述的模块结构与实际代码结构一致
2. **接口一致性**：文档中描述的 API 接口与实际代码实现一致
3. **功能一致性**：文档中描述的功能与实际代码实现一致
4. **配置一致性**：文档中描述的配置项与实际配置结构一致
5. **依赖一致性**：文档中描述的模块依赖关系与实际代码依赖一致
6. **错误处理一致性**：文档中描述的错误处理与实际代码实现一致

### 检查范围

- **模块架构文档**：`docs/architecture/` 目录下的所有模块架构文档（包含 Lib 层和 Commands 层两部分）
- **总体架构文档**：`docs/architecture/architecture.md`

### 检查原则

1. **系统性**：按照标准流程逐步检查，不遗漏任何环节
2. **全面性**：检查架构文档的各个方面（结构、API、功能、配置等）
3. **准确性**：基于实际代码进行检查，确保文档准确
4. **可操作性**：检查结果应提供明确的改进建议

---

## 🔄 检查流程

按照以下步骤依次完成架构文档检查：

### 第一步：模块结构检查

检查架构文档中描述的模块结构与实际代码结构是否一致。

**对应章节**：[模块结构检查](#1-模块结构检查)

### 第二步：模块统计检查

检查架构文档中的统计信息（代码行数、文件数量等）是否准确。

**对应章节**：[模块统计检查](#2-模块统计检查)

### 第三步：API 接口检查

检查架构文档中描述的公共 API 接口是否与实际代码实现一致。

**对应章节**：[API 接口检查](#3-api-接口检查)

### 第四步：功能描述检查

检查架构文档中描述的功能是否与实际代码实现一致。

**对应章节**：[功能描述检查](#4-功能描述检查)

### 第五步：依赖关系检查

检查架构文档中描述的模块依赖关系是否与实际代码依赖一致。

**对应章节**：[依赖关系检查](#5-依赖关系检查)

### 第六步：错误处理检查

检查架构文档中描述的错误处理是否与实际代码实现一致。

**对应章节**：[错误处理检查](#6-错误处理检查)

### 最后：生成检查报告

完成所有检查后，生成检查报告文档。

**对应章节**：[检查报告生成](#-检查报告生成)

---

## 1. 模块结构检查

### 1.1 检查项

- [ ] **文件列表一致性**：文档中列出的文件列表与实际目录结构匹配
- [ ] **目录结构图准确性**：文档中的目录结构图（如有）是否准确
- [ ] **新增文件记录**：是否有新增文件未在文档中记录
- [ ] **删除文件清理**：是否有已删除文件仍在文档中记录

### 1.2 检查方法

#### 步骤 1：获取实际代码文件列表

```bash
# 检查 Lib 层模块
MODULE=pr
find src/lib/$MODULE -name "*.rs" -type f | grep -v mod.rs | sort

# 检查命令层模块
COMMAND=pr
find src/commands/$COMMAND -name "*.rs" -type f | grep -v mod.rs | sort
```

#### 步骤 2：对比文档中的文件列表

1. 读取架构文档中的"模块结构"章节
2. 提取文档中列出的文件列表
3. 与实际代码文件列表对比
4. 检查是否有遗漏或多余的文件

#### 步骤 3：验证目录结构图

如果文档中包含目录结构图（如 Mermaid 图或文本树状图）：
1. 验证结构图中的路径是否与实际目录结构一致
2. 检查结构图中的文件是否都存在
3. 检查是否有新增文件未在结构图中显示

### 1.3 检查通过标准

- 文档中的文件列表与实际代码文件列表一致（允许 ±5% 误差）
- 新增或删除的文件已在文档中更新
- 目录结构图（如有）准确反映实际目录结构

### 1.4 常见问题

**问题 1**：新增文件未在文档中记录

**解决方法**：
1. 在架构文档的"模块结构"章节中添加新文件
2. 更新目录结构图（如有）
3. 检查是否需要更新其他相关章节

**问题 2**：已删除文件仍在文档中记录

**解决方法**：
1. 从架构文档中删除已不存在的文件
2. 更新目录结构图（如有）
3. 检查是否有其他文档引用了该文件

---

## 2. 模块统计检查

### 2.1 检查项

- [ ] **代码行数准确性**：文档中的代码行数统计是否准确（允许 ±10% 误差）
- [ ] **文件数量准确性**：文档中的文件数量统计是否准确
- [ ] **主要组件完整性**：文档中列出的主要组件/结构体列表是否完整
- [ ] **依赖关系准确性**：文档中描述的依赖关系是否准确

### 2.2 检查方法

#### 步骤 1：统计实际代码行数

```bash
# 统计模块代码行数
MODULE=pr
find src/lib/$MODULE -name "*.rs" -type f | xargs wc -l | tail -1
```

#### 步骤 2：统计文件数量

```bash
# 统计模块文件数量
MODULE=pr
find src/lib/$MODULE -name "*.rs" -type f | wc -l
```

#### 步骤 3：对比文档中的统计信息

1. 读取架构文档中的"模块统计"章节（通常在文档开头）
2. 提取文档中记录的代码行数和文件数量
3. 与实际统计结果对比
4. 检查误差是否在允许范围内（代码行数 ±10%，文件数量完全一致）

#### 步骤 4：验证主要组件列表

1. 提取代码中的主要公共结构体、枚举、Trait 定义
2. 对比文档中列出的主要组件列表
3. 检查是否有遗漏的重要组件

### 2.3 检查通过标准

- 代码行数统计误差在 ±10% 以内
- 文件数量统计完全一致
- 主要组件列表包含所有重要的公共 API

### 2.4 常见问题

**问题**：代码行数统计不准确

**解决方法**：
1. 重新统计代码行数
2. 更新架构文档中的统计信息
3. 注意：代码行数可能因格式化等原因略有变化，允许 ±10% 误差

---

## 3. API 接口检查

### 3.1 检查项

- [ ] **公共 API 描述准确性**：文档中描述的公共 API 接口是否准确
- [ ] **函数签名一致性**：文档中的函数签名是否与代码实现一致
- [ ] **参数说明完整性**：文档中的参数说明是否完整
- [ ] **返回值说明准确性**：文档中的返回值说明是否准确

### 3.2 检查方法

#### 步骤 1：提取代码中的公共 API

```bash
# 提取公共函数和结构体
MODULE=pr
grep -r "pub fn\|pub struct\|pub enum\|pub trait" src/lib/$MODULE/ | head -20
```

#### 步骤 2：对比文档中的 API 描述

1. 读取架构文档中的"API 接口"或"核心组件"章节
2. 提取文档中描述的公共 API 列表
3. 与代码中的公共 API 对比
4. 检查函数签名、参数类型、返回值类型是否一致

#### 步骤 3：验证 API 文档完整性

1. 检查所有公共 API 是否都在文档中有描述
2. 检查文档中的 API 是否都存在于代码中
3. 验证参数说明和返回值说明是否完整

### 3.3 检查通过标准

- 所有公共 API 都在文档中有描述
- 函数签名、参数、返回值与代码实现完全一致
- 参数说明和返回值说明完整

### 3.4 常见问题

**问题 1**：API 接口变更后文档未更新

**解决方法**：
1. 更新架构文档中的 API 描述
2. 更新示例代码（如有）
3. 检查是否有其他文档引用了该 API

**问题 2**：新增公共 API 未在文档中说明

**解决方法**：
1. 在架构文档中添加新 API 的描述
2. 包含函数签名、参数说明、返回值说明
3. 添加使用示例（如适用）

---

## 4. 功能描述检查

### 4.1 检查项

- [ ] **功能描述一致性**：文档中的功能描述是否与实际实现一致
- [ ] **示例代码可运行性**：文档中的示例代码是否可以编译运行
- [ ] **配置项说明准确性**：文档中的配置项说明是否准确

### 4.2 检查方法

#### 步骤 1：功能实现验证

1. 读取架构文档中的"功能描述"或"核心功能"章节
2. 检查文档中描述的功能是否在代码中实现
3. 验证功能的实现方式是否与文档描述一致
4. 检查是否有新增功能未在文档中说明

#### 步骤 2：示例代码验证

如果文档中包含示例代码：
1. 检查示例代码的语法是否正确
2. 验证示例代码的逻辑是否合理
3. 尝试编译示例代码（如果可能）

#### 步骤 3：配置项对比

1. 分析配置相关的结构体定义（如 `Settings` 结构）
2. 对比架构文档中的配置说明
3. 检查配置项的类型、默认值、必填性是否一致

### 4.3 检查通过标准

- 功能描述与实际实现一致
- 示例代码语法正确，逻辑合理
- 配置项说明与代码结构一致

### 4.4 常见问题

**问题 1**：功能描述与实际实现不一致

**解决方法**：
1. 更新架构文档中的功能描述
2. 确保描述准确反映实际实现
3. 检查是否有功能变更未在文档中说明

**问题 2**：配置项新增或删除后文档未同步

**解决方法**：
1. 更新架构文档中的配置说明
2. 更新 README.md 中的配置说明（如适用）
3. 检查是否有迁移文档需要更新

---

## 5. 依赖关系检查

### 5.1 检查项

- [ ] **模块依赖准确性**：文档中描述的模块依赖关系是否准确
- [ ] **外部依赖一致性**：文档中列出的外部依赖是否与实际 Cargo.toml 一致

### 5.2 检查方法

#### 步骤 1：分析代码依赖

```bash
# 查找 use 语句（排除 crate:: 内部依赖）
grep -r "^use " src/lib/{MODULE}/ | grep -v "crate::"
```

#### 步骤 2：对比文档中的依赖关系图

1. 读取架构文档中的"依赖关系"或"模块集成"章节
2. 提取文档中描述的模块依赖关系
3. 与代码中的实际依赖对比
4. 检查模块间的实际依赖是否与文档描述一致

#### 步骤 3：验证外部依赖列表

1. 读取架构文档中的"依赖模块"或"外部依赖"章节
2. 提取文档中列出的外部依赖（第三方库）
3. 对比 `Cargo.toml` 中的依赖列表
4. 检查是否有新增或删除的依赖未在文档中说明

### 5.3 检查通过标准

- 模块依赖关系与代码实现一致
- 外部依赖列表与 Cargo.toml 一致

### 5.4 常见问题

**问题**：模块重构后依赖关系图未更新

**解决方法**：
1. 更新架构文档中的依赖关系图
2. 更新模块结构说明
3. 检查相关模块的文档是否需要更新

---

## 6. 错误处理检查

### 6.1 检查项

- [ ] **错误类型一致性**：文档中描述的错误类型是否与代码实现一致
- [ ] **错误处理流程准确性**：文档中描述的错误处理流程是否准确

### 6.2 检查方法

#### 步骤 1：检查错误类型定义

```bash
# 查找错误类型定义
grep -r "pub.*Error\|pub.*Result" src/lib/{MODULE}/
```

#### 步骤 2：对比文档中的错误处理描述

1. 读取架构文档中的"错误处理"章节
2. 提取文档中描述的错误类型和处理流程
3. 与代码中的错误类型定义和处理逻辑对比
4. 检查错误处理流程是否与文档描述一致

### 6.3 检查通过标准

- 错误类型与代码实现一致
- 错误处理流程与文档描述一致

### 6.4 常见问题

**问题**：错误处理逻辑变更后文档未更新

**解决方法**：
1. 更新架构文档中的错误处理描述
2. 确保描述准确反映实际实现
3. 检查是否有错误类型变更未在文档中说明

---

## 📊 检查报告生成

### 报告结构

检查报告应包含以下部分：

```markdown
# 架构文档一致性检查报告

**检查日期**：YYYY-MM-DD HH:MM:SS
**检查人员**：AI Assistant
**检查范围**：架构文档与代码一致性检查
**检查类型**：定期审查 / 发布前检查 / PR 检查

---

## 检查概览

**检查完成度**：100%
**总体一致性评估**：良好 / 需要改进 / 严重不一致

**关键发现**：
- 模块结构一致性：✅ 通过 / ⚠️ 需要更新 / ❌ 不一致
- API 接口一致性：✅ 通过 / ⚠️ 需要更新 / ❌ 不一致
- 功能描述一致性：✅ 通过 / ⚠️ 需要更新 / ❌ 不一致
- 配置项一致性：✅ 通过 / ⚠️ 需要更新 / ❌ 不一致

---

## 详细检查结果

### 1. 模块结构检查

**状态**：✅ 通过 / ⚠️ 需要更新 / ❌ 不一致

**发现的问题**：
1. [问题描述]
   - **位置**：[文档路径]
   - **优先级**：高/中/低
   - **修复建议**：[具体建议]

### 2. 模块统计检查

[类似格式...]

---

## 问题汇总

### P0（必须修复）
[问题列表]

### P1（建议修复）
[问题列表]

### P2（可选修复）
[问题列表]

---

## 改进建议

[改进建议列表]

---

**最后更新**：YYYY-MM-DD
```

### 报告位置

检查报告应保存到 `report/` 目录下，文件名格式为：

```
report/REVIEW_ARCHITECTURE_DOC_{timestamp}.md
```

其中 `{timestamp}` 为当前日期和时间，格式为 `YYYY-MM-DD_HH-MM-SS`（如：`2025-12-18_19-14-08`）。

### 生成带时间戳的文件名

在 Rust 代码中：
```rust
use workflow::base::util::date::format-_filename-_timestamp;

let timestamp = format-_filename-_timestamp();
let report-_path = format!("report/REVIEW_ARCHITECTURE_DOC_{}.md", timestamp);
```

在命令行中：
```bash
# Unix/macOS/Linux
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
echo "report/REVIEW_ARCHITECTURE_DOC_${TIMESTAMP}.md"

# Windows PowerShell
$timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
Write-Host "report/REVIEW_ARCHITECTURE_DOC_${timestamp}.md"
```

---

## ✅ 快速检查清单

### 模块结构检查

- [ ] 文档中的文件列表与实际目录结构匹配
- [ ] 目录结构图（如有）准确
- [ ] 新增文件已在文档中记录
- [ ] 已删除文件已从文档中移除

### 模块统计检查

- [ ] 代码行数统计准确（允许 ±10% 误差）
- [ ] 文件数量统计准确
- [ ] 主要组件列表完整
- [ ] 依赖关系描述准确

### API 接口检查

- [ ] 公共 API 描述准确
- [ ] 函数签名与代码一致
- [ ] 参数说明完整
- [ ] 返回值说明准确

### 功能描述检查

- [ ] 功能描述与实际实现一致
- [ ] 示例代码可运行（如适用）
- [ ] 配置项说明准确

### 依赖关系检查

- [ ] 模块依赖关系准确
- [ ] 外部依赖列表与 Cargo.toml 一致

### 错误处理检查

- [ ] 错误类型与代码一致
- [ ] 错误处理流程准确

---

## 🛠️ 快速检查命令

### 模块结构检查

```bash
# 检查 Lib 层模块
MODULE=pr
find src/lib/$MODULE -name "*.rs" -type f | grep -v mod.rs | sort

# 检查命令层模块
COMMAND=pr
find src/commands/$COMMAND -name "*.rs" -type f | grep -v mod.rs | sort
```

### 代码行数统计

```bash
# 统计模块代码行数
MODULE=pr
find src/lib/$MODULE -name "*.rs" -type f | xargs wc -l | tail -1
```

### 公共 API 提取

```bash
# 提取公共函数和结构体
MODULE=pr
grep -r "pub fn\|pub struct\|pub enum\|pub trait" src/lib/$MODULE/ | head -20
```

### 依赖关系分析

```bash
# 查找 use 语句（排除 crate:: 内部依赖）
grep -r "^use " src/lib/{MODULE}/ | grep -v "crate::"
```

---

## 🎯 检查优先级

### 高优先级（必须检查）

- ✅ 公共 API 接口的一致性
- ✅ 核心模块的结构变化
- ✅ 配置项的变更
- ✅ 新增模块的文档创建

### 中优先级（建议检查）

- ⚠️ 内部模块的依赖关系
- ⚠️ 功能实现的细节变化
- ⚠️ 错误处理的更新

### 低优先级（可选检查）

- ℹ️ 内部实现细节的变化
- ℹ️ 代码注释的更新
- ℹ️ 统计信息的更新

---

## 📚 相关文档

- [文档完整性检查指南](./review-document-completeness.md) - 详细的文档完整性检查方法和流程
- [文档编写指南](../../document.md) - 架构文档编写规范和模板
- [代码审查规范](../../development/code-review.md) - 代码审查规范和审查清单
- [开发规范索引](../../development/README.md) - 开发规范总览
- [架构文档检查工具 TODO](../../../requirements/doc-check.md) - 自动化检查工具实施计划
- [提交前检查指南](../workflows/pre-commit.md) - 提交前检查清单
- [深入检查指南](../workflows/review.md) - 综合深入检查流程

---

## ⚠️ 常见问题

### 1. 新增模块未在架构文档中说明

**问题**：代码中新增了模块，但架构文档中没有说明。

**解决方法**：
1. 创建对应的架构文档（参考 `document.md`）
2. 更新总体架构文档（`architecture.md`）
3. 更新文档索引（`docs/README.md`）

### 2. API 接口变更后文档未更新

**问题**：代码中的 API 接口已变更，但架构文档中仍使用旧的接口描述。

**解决方法**：
1. 更新架构文档中的 API 描述
2. 更新示例代码（如有）
3. 检查是否有其他文档引用了该 API

### 3. 配置项新增或删除后文档未同步

**问题**：配置结构已变更，但架构文档中的配置说明未更新。

**解决方法**：
1. 更新架构文档中的配置说明
2. 更新 README.md 中的配置说明（如适用）
3. 检查是否有迁移文档需要更新

### 4. 模块重构后依赖关系图未更新

**问题**：模块依赖关系已变更，但架构文档中的依赖关系图未更新。

**解决方法**：
1. 更新架构文档中的依赖关系图
2. 更新模块结构说明
3. 检查相关模块的文档是否需要更新

---

**最后更新**: 2025-12-23
