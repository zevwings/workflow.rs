# 依赖管理规范

> 本文档定义了 Workflow CLI 项目的依赖管理规范和最佳实践，所有贡献者都应遵循这些规范。

---

## 📋 目录

- [概述](#-概述)
- [添加依赖](#-添加依赖)
- [依赖原则](#-依赖原则)
- [依赖更新频率要求](#-依赖更新频率要求)
- [依赖版本锁定规则](#-依赖版本锁定规则)
- [依赖安全漏洞处理流程](#-依赖安全漏洞处理流程)
- [相关文档](#-相关文档)

---

## 📋 概述

本文档定义了依赖管理规范，包括添加依赖、依赖更新和依赖安全漏洞处理。

### 核心原则

- **最小化依赖**：只添加必要的依赖
- **版本管理**：使用语义化版本，避免使用 `*` 通配符
- **定期更新**：定期更新依赖以修复安全漏洞
- **安全检查**：新增依赖前检查安全漏洞

### 使用场景

- 添加新依赖时参考
- 更新依赖时使用
- 处理安全漏洞时参考

---

## 添加依赖

使用 `cargo add` 添加依赖：

```bash
# 添加依赖
cargo add serde --features derive

# 添加开发依赖
cargo add --dev mockito
```

---

## 依赖原则

- **最小化依赖**：只添加必要的依赖
- **版本管理**：使用语义化版本，避免使用 `*` 通配符
- **功能标志**：使用 feature flags 控制可选功能
- **定期更新**：定期更新依赖到最新稳定版本

---

## 依赖更新频率要求

### 定期检查依赖更新

1. **检查频率**：
   - 每月检查一次依赖更新
   - 使用 `cargo outdated` 检查过时的依赖
   - 关注主要版本更新和安全补丁

2. **更新优先级**：
   - **安全补丁**：最高优先级，应立即更新
   - **补丁版本更新**：可以自动更新（如 `1.2.3` → `1.2.4`）
   - **次版本更新**：需要测试验证（如 `1.2.3` → `1.3.0`）
   - **主版本更新**：需要全面评估和测试（如 `1.2.3` → `2.0.0`）

3. **更新策略**：
   - 补丁版本更新：可以自动更新，风险较低
   - 次版本更新：需要运行测试套件验证
   - 主版本更新：需要全面评估、测试和可能的代码修改

### 安全漏洞依赖的紧急更新流程

1. **检测漏洞**：
   - 使用 `cargo audit` 检查安全漏洞
   - 关注 RustSec 安全公告
   - 关注依赖库的安全公告

2. **评估影响**：
   - 评估漏洞的严重程度（Critical、High、Medium、Low）
   - 评估漏洞对项目的影响范围
   - 评估漏洞是否被实际利用

3. **紧急更新**：
   - 发现安全漏洞时，应立即更新到修复版本
   - 如果无法立即更新，评估风险并制定缓解措施
   - 安全漏洞更新应优先于其他更新

4. **验证和发布**：
   - 运行完整测试套件
   - 进行安全测试（如适用）
   - 更新 CHANGELOG.md 记录安全更新

---

## 依赖版本锁定规则

### 何时使用精确版本

以下情况应使用精确版本：

1. **关键依赖**：
   - 核心功能依赖：使用精确版本确保稳定性（如 `serde = "1.0"`）
   - 安全关键依赖：使用精确版本避免意外更新（如加密库）

2. **已知兼容性问题**：
   - 如果依赖有已知的兼容性问题，使用精确版本锁定
   - 如果依赖的更新会导致破坏性变更，使用精确版本

3. **生产环境稳定性**：
   - 生产环境使用的依赖应使用精确版本
   - 避免在生产环境中使用版本范围

### 何时允许版本范围

以下情况可以使用版本范围：

1. **非关键依赖**：
   - 非核心功能依赖可以使用版本范围（如 `serde = "1.0"` 允许 `1.0.x` 的补丁更新）
   - 工具类依赖可以使用更宽松的版本范围

2. **开发依赖**：
   - 开发依赖可以使用更宽松的版本范围
   - 测试依赖可以使用版本范围

3. **功能标志依赖**：
   - 可选功能的依赖可以使用版本范围
   - 不影响核心功能的依赖可以使用版本范围

### 版本范围格式

Rust/Cargo 支持的版本范围格式：

- `"1.0"` - 允许 `1.0.x` 的补丁更新（推荐用于大多数依赖）
- `"^1.0"` - 允许 `1.x.x` 的次版本更新（语义化版本，等同于 `"1.0"`）
- `"~1.0.0"` - 允许 `1.0.x` 的补丁更新（精确到次版本）
- `"1.0.0"` - 精确版本，不允许更新（用于关键依赖）
- `"*"` - 允许任何版本（不推荐，仅用于特殊情况）

**推荐做法**：
- 大多数依赖使用 `"1.0"` 格式（允许补丁更新）
- 关键依赖使用精确版本 `"1.0.0"`
- 避免使用 `"*"` 通配符

---

## 依赖安全漏洞处理流程

### 发现安全漏洞时的处理流程

1. **检测漏洞**：
   - 使用 `cargo audit` 检查安全漏洞
   - 关注 [RustSec Advisory Database](https://rustsec.org/) 安全公告
   - 关注依赖库的官方安全公告

2. **评估影响**：
   - 评估漏洞的严重程度（Critical、High、Medium、Low）
   - 评估漏洞对项目的影响范围
   - 评估漏洞是否被实际利用

3. **制定更新计划**：
   - 查找修复版本（检查依赖的更新日志）
   - 评估更新对代码的影响
   - 评估更新是否会导致破坏性变更
   - 制定测试计划

4. **执行更新**：
   - 更新依赖到修复版本
   - 运行测试确保功能正常
   - 如果更新导致破坏性变更，需要修改代码
   - 提交更新并添加清晰的提交信息（使用 `chore` 或 `security` 类型）

5. **验证和发布**：
   - 运行完整测试套件（`cargo test`）
   - 进行安全测试（如适用）
   - 更新 CHANGELOG.md 记录安全更新
   - 如果漏洞严重，考虑发布安全补丁版本

### 依赖更新的测试要求

1. **补丁版本更新**：
   - 运行完整测试套件
   - 确保所有测试通过

2. **次版本更新**：
   - 运行完整测试套件
   - 进行集成测试
   - 检查是否有破坏性变更

3. **主版本更新**：
   - 运行完整测试套件
   - 进行全面测试（单元测试、集成测试）
   - 检查 API 变更和破坏性变更
   - 更新代码以适配新版本（如需要）

4. **安全漏洞更新**：
   - 运行完整测试套件
   - 进行回归测试
   - 验证安全漏洞已修复
   - 进行安全测试（如适用）

---

## 🔍 故障排除

### 问题 1：依赖版本冲突

**症状**：依赖版本冲突导致编译失败

**解决方案**：

1. 检查依赖版本是否兼容
2. 更新依赖到兼容版本
3. 使用 `cargo tree` 查看依赖树

### 问题 2：安全漏洞无法更新

**症状**：依赖存在安全漏洞但无法更新

**解决方案**：

1. 评估风险并制定缓解措施
2. 考虑使用替代依赖
3. 如果风险可接受，等待修复版本

---

## 📚 相关文档

### 开发规范

- [安全性规则](./security.md) - 安全性规则（包含依赖安全检查）

### 工具支持

- [cargo-audit](https://github.com/rustsec/rustsec/tree/main/cargo-audit) - 依赖安全检查工具
- [cargo-outdated](https://github.com/kbknapp/cargo-outdated) - 依赖更新检查工具

---

## ✅ 检查清单

使用本规范时，请确保：

- [ ] 只添加必要的依赖
- [ ] 使用语义化版本管理
- [ ] 新增依赖前已检查安全漏洞（`cargo audit`）
- [ ] 定期更新依赖以修复安全漏洞
- [ ] 安全补丁已及时更新

---

**最后更新**: 2025-12-23

