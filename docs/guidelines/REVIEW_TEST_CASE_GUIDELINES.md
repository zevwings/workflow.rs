# 测试用例检查指南

> 本文档定义了如何检查测试用例的覆盖情况、合理性和完整性，用于指导 AI 进行测试用例检查。

---

## 📋 目录

- [检查目标](#-检查目标)
- [检查步骤](#-检查步骤)
- [检查内容](#-检查内容)
  - [1. 测试覆盖情况检查](#1-测试覆盖情况检查)
  - [2. 测试用例合理性检查](#2-测试用例合理性检查)
  - [3. 缺失测试用例检查](#3-缺失测试用例检查)
- [检查方法](#-检查方法)
- [检查报告格式](#-检查报告格式)
- [参考文档](#-参考文档)

---

## 🎯 检查目标

检查测试用例的三个核心方面：

1. **测试覆盖情况**：检查哪些模块/功能已有测试，哪些缺失
2. **测试用例合理性**：检查现有测试是否合理、规范、有效
3. **缺失测试用例**：识别需要补充的测试用例

---

## 🚀 检查步骤

按照以下步骤依次完成检查：

### 第一步：收集测试信息

1. **扫描测试目录结构**
   - 列出 `tests/` 目录下的所有测试文件
   - 列出源代码中 `#[cfg(test)]` 模块的单元测试
   - 记录测试文件与源代码模块的对应关系

2. **扫描源代码结构**
   - 列出 `src/lib/` 目录下的所有模块
   - 列出 `src/commands/` 目录下的所有命令
   - 识别公共 API 和关键业务逻辑

3. **统计测试数据**
   - 统计测试文件数量
   - 统计测试用例数量（估算）
   - 统计单元测试模块数量

### 第二步：检查测试覆盖情况

1. **模块覆盖检查**
   - 检查每个 `lib/` 模块是否有对应的测试
   - 检查每个 `commands/` 命令是否有对应的测试
   - 标记已覆盖、部分覆盖、完全缺失的模块

2. **功能覆盖检查**
   - 检查每个模块的主要功能是否有测试
   - 检查公共函数是否有测试
   - 检查关键业务逻辑是否有测试

3. **覆盖率评估**
   - 估算总体覆盖率
   - 估算核心模块覆盖率
   - 估算工具模块覆盖率

### 第三步：检查测试用例合理性

1. **测试工具使用检查**
   - 检查是否使用了合适的测试工具（`rstest`、`pretty_assertions`、`insta`、`mockito` 等）
   - 检查测试工具使用是否规范

2. **测试结构检查**
   - 检查测试是否遵循 AAA 模式（Arrange-Act-Assert）
   - 检查测试组织是否合理（模块分组、命名规范）
   - 检查测试数据管理是否规范（fixtures、快照）

3. **测试内容检查**
   - 检查是否包含成功路径测试
   - 检查是否包含错误路径测试
   - 检查是否包含边界条件测试
   - 检查是否包含集成测试

### 第四步：识别缺失的测试用例

1. **缺失模块测试识别**
   - 识别完全没有测试的模块
   - 识别测试文件存在但为空的模块
   - 识别部分子模块缺少测试的情况

2. **缺失功能测试识别**
   - 识别主要功能缺少测试的情况
   - 识别公共函数缺少测试的情况
   - 识别关键业务逻辑缺少测试的情况

3. **缺失测试类型识别**
   - 识别缺少错误路径测试的情况
   - 识别缺少边界条件测试的情况
   - 识别缺少集成测试的情况

### 第五步：生成检查报告

根据检查结果生成结构化的检查报告。

**对应章节**：[检查报告格式](#-检查报告格式)

---

## 📝 检查内容

### 1. 测试覆盖情况检查

#### 1.1 模块覆盖检查

**检查项**：

- [ ] **已覆盖的模块**：列出所有有完整测试的模块
  - 检查测试文件是否存在
  - 检查测试文件是否包含实际测试用例
  - 检查测试是否覆盖主要功能

- [ ] **部分覆盖的模块**：列出测试不完整的模块
  - 检查测试文件是否存在但为空
  - 检查是否只覆盖了部分子模块
  - 检查是否只覆盖了部分功能

- [ ] **完全缺失的模块**：列出完全没有测试的模块
  - 检查是否有对应的测试文件
  - 检查是否有单元测试

**检查方法**：

1. 遍历 `src/lib/` 目录，列出所有模块
2. 检查 `tests/` 目录是否有对应的测试文件
3. 检查测试文件是否包含实际测试代码（不只是注释）
4. 检查源代码中是否有 `#[cfg(test)]` 模块

**示例输出**：

```markdown
#### Base 模块 (`lib/base/`)
- ✅ `base/llm_client.rs` - LLM 客户端测试
- ✅ `base/logger.rs` - 日志功能测试
- ⚠️ `base/http.rs` - 测试文件存在但为空
- ❌ `base/alias/config.rs` - 无测试文件
```

#### 1.2 功能覆盖检查

**检查项**：

- [ ] **公共函数覆盖**：检查公共函数是否有测试
  - 列出所有公共函数
  - 检查是否有对应的测试用例

- [ ] **关键业务逻辑覆盖**：检查关键业务逻辑是否有测试
  - 识别关键业务逻辑（如 PR 创建、Jira 集成、Git 操作等）
  - 检查是否有对应的测试用例

- [ ] **错误处理覆盖**：检查错误处理逻辑是否有测试
  - 检查错误路径是否有测试
  - 检查错误消息是否正确

**检查方法**：

1. 读取源代码文件，识别公共函数（`pub fn`）
2. 检查测试文件中是否有对应的测试用例
3. 使用代码搜索工具查找测试用例

**示例输出**：

```markdown
#### Git 模块功能覆盖
- ✅ `GitRepo::is_git_repo()` - 有测试
- ✅ `GitBranch::create()` - 有测试
- ❌ `GitBranch::merge()` - 无测试
- ❌ `GitStash::push()` - 无测试
```

#### 1.3 覆盖率评估

**检查项**：

- [ ] **总体覆盖率估算**：估算整体测试覆盖率
- [ ] **核心模块覆盖率**：估算核心模块（Git、Commit、PR 等）的覆盖率
- [ ] **工具模块覆盖率**：估算工具模块的覆盖率
- [ ] **CLI 层覆盖率**：估算 CLI 命令层的覆盖率

**评估标准**：

- 🟢 **良好** (80%+)：覆盖率 >= 80%
- 🟡 **中等** (60-79%)：覆盖率 60-79%
- 🔴 **不足** (< 60%)：覆盖率 < 60%

**检查方法**：

1. 统计有测试的模块数量 vs 总模块数量
2. 统计有测试的函数数量 vs 总函数数量（估算）
3. 根据测试文件数量和测试用例数量估算覆盖率

**示例输出**：

```markdown
### 覆盖率评估
- **总体覆盖率估算**: 🟡 约 50-60%
- **核心模块覆盖率**: 🔴 约 40-50%（Git、Commit 等核心模块缺失）
- **工具模块覆盖率**: 🟡 约 60-70%
- **CLI 层覆盖率**: 🟢 约 75-80%
```

---

### 2. 测试用例合理性检查

#### 2.1 测试工具使用检查

**检查项**：

- [ ] **参数化测试**：检查是否使用 `rstest` 进行参数化测试
  - 查找 `#[rstest]` 标记的测试
  - 检查参数化测试是否合理

- [ ] **断言工具**：检查是否使用 `pretty_assertions` 提供清晰的错误输出
  - 查找 `use pretty_assertions::assert_eq;` 等导入
  - 检查是否在关键测试中使用

- [ ] **快照测试**：检查是否使用 `insta` 进行快照测试
  - 查找 `insta::assert_json_snapshot!` 等调用
  - 检查快照文件是否管理规范

- [ ] **Mock 测试**：检查是否使用 `mockito` 进行 HTTP API Mock 测试
  - 查找 `mockito` 相关代码
  - 检查 Mock 服务器设置是否规范

**检查方法**：

1. 搜索测试文件中的测试工具使用情况
2. 检查测试工具使用是否符合规范（参考 `TESTING_GUIDELINES.md`）

**示例输出**：

```markdown
### 测试工具使用情况
- ✅ **参数化测试**: 使用 `rstest` 进行参数化测试，减少代码重复
- ✅ **断言工具**: 使用 `pretty_assertions` 提供清晰的错误输出
- ✅ **快照测试**: 使用 `insta` 进行快照测试（LLM 响应）
- ✅ **Mock 测试**: 使用 `mockito` 进行 HTTP API Mock 测试
```

#### 2.2 测试结构检查

**检查项**：

- [ ] **AAA 模式**：检查测试是否遵循 Arrange-Act-Assert 模式
  - 检查测试是否有清晰的准备、执行、断言阶段
  - 检查测试结构是否清晰

- [ ] **测试组织**：检查测试组织是否合理
  - 检查是否使用模块分组组织相关测试
  - 检查测试命名是否规范（`test_` 前缀）
  - 检查测试目录结构是否与源代码对应

- [ ] **测试数据管理**：检查测试数据管理是否规范
  - 检查是否使用 `tests/fixtures/` 目录存放测试数据
  - 检查是否使用共享测试工具（`tests/common/`）
  - 检查快照文件是否管理规范

**检查方法**：

1. 读取测试文件，检查测试结构
2. 检查测试命名规范
3. 检查测试数据管理方式

**示例输出**：

```markdown
### 测试结构
- ✅ **AAA 模式**: 大部分测试遵循 Arrange-Act-Assert 模式
- ✅ **模块化组织**: 测试目录结构与源代码对应
- ✅ **共享工具**: `tests/common/` 提供共享测试工具
- ✅ **测试数据**: 使用 `tests/fixtures/` 目录存放测试数据
```

#### 2.3 测试内容检查

**检查项**：

- [ ] **成功路径测试**：检查是否包含成功路径测试
  - 检查主要功能是否有成功路径测试
  - 检查测试是否验证了预期结果

- [ ] **错误路径测试**：检查是否包含错误路径测试
  - 检查是否有错误情况测试（网络错误、文件系统错误、权限错误等）
  - 检查错误消息是否正确

- [ ] **边界条件测试**：检查是否包含边界条件测试
  - 检查是否有空输入/输出测试
  - 检查是否有最大/最小长度测试
  - 检查是否有特殊字符测试
  - 检查是否有 Unicode 字符处理测试

- [ ] **集成测试**：检查是否包含集成测试
  - 检查是否有端到端的工作流测试
  - 检查是否有模块间交互测试

**检查方法**：

1. 读取测试文件，分析测试内容
2. 检查测试是否覆盖成功路径、错误路径、边界条件
3. 检查是否有集成测试文件

**示例输出**：

```markdown
### 测试内容合理性
#### 正面示例
1. **参数解析测试**: CLI 命令的参数解析测试完整
2. **边界条件测试**: 部分测试包含边界条件
3. **错误处理测试**: 部分测试包含错误情况
4. **集成测试**: 有端到端的工作流测试

#### 需要改进的地方
1. **错误路径测试不足**: 部分测试主要关注成功路径，错误处理测试较少
2. **边界条件测试不完整**: 某些模块缺少边界条件测试
3. **并发测试缺失**: 虽然有并发执行器，但缺少并发场景测试
```

---

### 3. 缺失测试用例检查

#### 3.1 缺失模块测试识别

**检查项**：

- [ ] **完全缺失的模块**：识别完全没有测试的模块
  - 列出所有没有测试文件的模块
  - 列出所有没有单元测试的模块

- [ ] **测试文件为空的模块**：识别测试文件存在但为空的模块
  - 检查测试文件是否只包含注释
  - 检查测试文件是否没有实际测试代码

- [ ] **部分子模块缺失测试**：识别部分子模块缺少测试的情况
  - 检查模块的主要子模块是否有测试
  - 检查关键功能是否有测试

**检查方法**：

1. 对比源代码模块列表和测试文件列表
2. 检查测试文件内容，识别空文件
3. 检查模块的子模块测试覆盖情况

**示例输出**：

```markdown
### 缺失模块测试
#### 完全缺失的模块 ❌
- ❌ **Template 模块** (`lib/template/`)
  - 无测试文件
  - 缺少测试的子模块:
    - `template/config.rs` - 模板配置
    - `template/engine.rs` - 模板引擎
    - `template/vars.rs` - 模板变量

#### 测试文件为空的模块 ⚠️
- ⚠️ **Git 模块** (`lib/git/`)
  - 测试文件存在但为空: `tests/git/mod.rs` 只有注释，没有实际测试
  - 缺少测试的子模块:
    - `git/branch.rs` - 分支管理操作
    - `git/commit.rs` - 提交管理
```

#### 3.2 缺失功能测试识别

**检查项**：

- [ ] **主要功能缺失测试**：识别主要功能缺少测试的情况
  - 列出每个模块的主要功能
  - 检查是否有对应的测试用例

- [ ] **公共函数缺失测试**：识别公共函数缺少测试的情况
  - 列出所有公共函数
  - 检查是否有对应的测试用例

- [ ] **关键业务逻辑缺失测试**：识别关键业务逻辑缺少测试的情况
  - 识别关键业务逻辑（如 PR 创建、Jira 集成、Git 操作等）
  - 检查是否有对应的测试用例

**检查方法**：

1. 读取源代码文件，识别主要功能和公共函数
2. 检查测试文件中是否有对应的测试用例
3. 使用代码搜索工具查找测试用例

**示例输出**：

```markdown
### 缺失功能测试
#### Git 模块 (`lib/git/`)
需要添加的测试：
1. **分支管理** (`git/branch.rs`)
   - 创建分支
   - 切换分支
   - 合并分支（不同策略）
   - 删除分支
   - 获取默认分支
   - 分支存在性检查

2. **提交管理** (`git/commit.rs`)
   - 提交状态检查
   - 暂存文件
   - 创建提交
   - 获取提交信息
   - Worktree 状态检查
```

#### 3.3 缺失测试类型识别

**检查项**：

- [ ] **错误路径测试缺失**：识别缺少错误路径测试的情况
  - 检查每个公共函数是否有错误情况测试
  - 检查是否有网络错误、文件系统错误、权限错误等测试

- [ ] **边界条件测试缺失**：识别缺少边界条件测试的情况
  - 检查是否有空输入/输出测试
  - 检查是否有最大/最小长度测试
  - 检查是否有特殊字符测试

- [ ] **集成测试缺失**：识别缺少集成测试的情况
  - 检查是否有端到端的工作流测试
  - 检查是否有模块间交互测试

**检查方法**：

1. 分析现有测试内容，识别缺失的测试类型
2. 检查是否有错误路径测试、边界条件测试、集成测试

**示例输出**：

```markdown
### 缺失测试类型
#### 错误路径测试缺失
- 部分测试主要关注成功路径，错误处理测试较少
- 需要为每个公共函数添加错误情况测试
- 需要测试网络错误、文件系统错误、权限错误等

#### 边界条件测试缺失
- 某些模块缺少边界条件测试
- 需要添加空输入/输出测试
- 需要添加最大/最小长度测试
- 需要添加特殊字符测试
```

---

## 🔍 检查方法

### 自动化检查工具

1. **代码搜索工具**
   - 使用 `grep` 搜索测试文件
   - 使用 `codebase_search` 进行语义搜索
   - 使用 `glob_file_search` 查找测试文件

2. **文件读取工具**
   - 使用 `read_file` 读取测试文件内容
   - 使用 `list_dir` 列出目录结构

3. **统计分析**
   - 统计测试文件数量
   - 统计测试用例数量（估算）
   - 统计模块覆盖情况

### 手动检查项

1. **测试内容分析**
   - 阅读测试代码，分析测试覆盖范围
   - 检查测试是否合理、有效

2. **测试质量评估**
   - 评估测试工具使用是否规范
   - 评估测试结构是否合理
   - 评估测试内容是否完整

---

## 📊 检查报告格式

检查报告应包含以下部分：

### 1. 执行摘要

- 总体情况（测试文件数、测试用例数、覆盖率评估）
- 主要发现（优点、问题、改进建议）

### 2. 测试覆盖情况分析

- 已覆盖的模块
- 部分覆盖的模块
- 完全缺失的模块
- 覆盖率统计表

### 3. 测试用例合理性分析

- 测试工具使用情况
- 测试结构合理性
- 测试内容合理性
- 测试命名规范

### 4. 缺失的测试用例

- 高优先级缺失测试（核心模块）
- 中优先级缺失测试（工具模块）
- 低优先级缺失测试（命令层补充）

### 5. 测试质量改进建议

- 测试覆盖改进建议
- 测试组织改进建议
- 测试工具改进建议

### 6. 优先级行动计划

- 阶段 1: 核心模块测试（高优先级）
- 阶段 2: 工具模块测试（中优先级）
- 阶段 3: Commands 层测试补充（低优先级）
- 阶段 4: 测试质量提升（持续改进）

### 7. 结论

- 总体评估
- 主要问题
- 改进建议

**参考示例**：`report/TEST_COVERAGE_REPORT.md`

---

## 📚 参考文档

- [测试规范指南](./TESTING_GUIDELINES.md) - 测试组织规范和最佳实践
- [开发规范指南](./DEVELOPMENT_GUIDELINES.md) - 包含测试规范的基础内容
- [提交前检查指南](./PRE_COMMIT_GUIDELINES.md) - 包含测试用例检查的简要说明

---

**最后更新**: 2025-12-16
